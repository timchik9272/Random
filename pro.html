<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<title>MiniMessenger Pro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js"></script>
<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root{--bg:#0a0a0a;--bg-light:#1a1a1a;--accent:#00b4d8;--accent-hover:#0096c7;--text:#f8f9fa;--gray:#adb5bd;--success:#28a745;--error:#dc3545;--radius:16px;--shadow:0 4px 12px rgba(0,0,0,0.3);}
*{box-sizing:border-box}
body{margin:0;font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;height:100vh;display:flex;flex-direction:column;}
.screen{display:none;flex-direction:column;height:100vh;animation:fadeIn 0.3s ease;}
.active{display:flex;}
@keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
input,textarea,button{border:none;border-radius:var(--radius);font-size:15px;transition:all 0.2s ease;}
input,textarea{background:var(--bg-light);color:var(--text);padding:12px;}
input:focus,textarea:focus{outline:none;box-shadow:0 0 0 2px var(--accent);background:#222;}
button{background:var(--accent);color:#fff;padding:12px 16px;font-weight:500;margin:6px 0;cursor:pointer;position:relative;overflow:hidden;}
button:hover{background:var(--accent-hover);transform:translateY(-1px);}
button:disabled{opacity:0.6;cursor:not-allowed;}
.ripple{position:absolute;border-radius:50%;background:var(--accent);transform:scale(0);animation:ripple 0.6s linear;}
@keyframes ripple{to{transform:scale(20);opacity:0;}}
nav{display:flex;align-items:center;gap:12px;padding:12px;background:var(--bg);position:sticky;top:0;z-index:10;border-bottom:1px solid #333;box-shadow:var(--shadow);}
.chat-list,.messages{flex:1;overflow-y:auto;}
.chat-list{height:calc(100vh - 64px);}
.chat-item{padding:16px;border-bottom:1px solid #333;cursor:pointer;display:flex;align-items:center;gap:12px;transition:all 0.2s ease;}
.chat-item:hover{background:#222;}
.chat-item .info{flex:1;display:flex;flex-direction:column;gap:4px;}
.chat-item .last{display:flex;justify-content:space-between;align-items:center;font-size:13px;color:var(--gray);}
.chat-item .avatar{width:48px;height:48px;border-radius:50%;object-fit:cover;flex-shrink:0;}
.unread-badge{background:var(--accent);color:#fff;border-radius:50%;min-width:24px;height:24px;display:flex;justify-content:center;align-items:center;font-size:12px;font-weight:600;}
.msg{margin:8px 12px;padding:12px 16px;border-radius:var(--radius);max-width:80%;position:relative;border:1px solid #333;word-wrap:break-word;animation:slideIn 0.3s ease;opacity:0;}
.msg.animate{opacity:1;}
@keyframes slideIn{from{opacity:0;transform:translateX(20px);}to{opacity:1;transform:translateX(0);}}
.msg.me{background:linear-gradient(135deg,var(--accent),var(--accent-hover));margin-left:auto;color:#fff;border:none;box-shadow:var(--shadow);}
.msg.other{background:var(--bg-light);color:var(--text);}
.msg.deleted{font-style:italic;color:var(--gray);background:transparent;border-style:dashed;text-align:center;}
.msg .reply-to{font-size:13px;color:var(--gray);margin-bottom:8px;border-left:3px solid var(--accent);padding-left:10px;cursor:pointer;display:block;transition:background 0.2s;}
.reply-to:hover{background:#333;border-radius:8px;}
.time{display:block;font-size:12px;margin-top:8px;text-align:right;}
.me .time{color:#fff;} .other .time{color:var(--gray);}
img.msg-img{max-width:100%;border-radius:var(--radius);margin-top:8px;display:block;box-shadow:var(--shadow);}
.input-box{display:flex;flex-direction:column;gap:8px;padding:12px;background:var(--bg);border-top:1px solid #333;position:sticky;bottom:0;}
.input-row{display:flex;gap:8px;align-items:flex-end;}
.input-box textarea{flex:1;min-height:48px;max-height:160px;padding:12px;border-radius:12px;resize:none;color:var(--text);background:var(--bg-light);line-height:1.4;}
.send-btn,.img-btn{width:48px;height:48px;border-radius:50%;display:flex;justify-content:center;align-items:center;font-size:18px;background:var(--accent);color:#fff;border:none;cursor:pointer;transition:all 0.2s;}
#preview img{max-width:160px;border-radius:var(--radius);margin:8px;box-shadow:var(--shadow);}
.context-menu{position:absolute;background:var(--bg-light);border:1px solid #444;border-radius:12px;display:none;flex-direction:column;z-index:1000;box-shadow:var(--shadow);}
.context-menu button{background:none;border:none;color:var(--text);padding:12px 16px;text-align:left;cursor:pointer;transition:background 0.2s;}
.context-menu button:hover{background:#333;}
.ticks{font-size:14px;margin-left:6px;color:var(--gray);}
.typing-status{font-size:13px;color:var(--accent);animation:typingPulse 1.5s infinite;}
@keyframes typingPulse{0%,100%{opacity:1;}50%{opacity:0.5;}}
.unread-sep{display:flex;justify-content:center;align-items:center;margin:12px 0;color:var(--accent);font-size:14px;font-weight:500;border-top:1px dashed var(--gray);border-bottom:1px dashed var(--gray);padding:8px 0;background:#111;border-radius:8px;position:relative;}
.reply-preview{display:flex;align-items:center;gap:10px;padding:12px;border-radius:12px;background:#222;margin:8px 12px;border:1px solid #444;}
.reply-preview .meta{font-size:13px;color:var(--gray);flex:1;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;}
.reply-preview .meta strong{color:var(--text);font-weight:600;margin-right:8px;}
.reply-preview .cancel{cursor:pointer;padding:8px;border-radius:10px;background:#333;transition:background 0.2s;}
.reply-preview .cancel:hover{background:#444;}
.highlight{background:rgba(0,180,216,0.4) !important;box-shadow:0 0 15px rgba(0,180,216,0.6) !important;transform:translateY(-2px);transition:all .4s ease;}
.success-text { position: absolute; top: -25px; left: 0; color: var(--success); font-size: 13px; white-space: nowrap; background:#111;padding:4px 8px;border-radius:6px; }
.loader{display:inline-block;width:20px;height:20px;border:2px solid var(--gray);border-top:2px solid var(--accent);border-radius:50%;animation:spin 1s linear infinite;}
@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
.error-msg{color:var(--error);font-size:12px;margin-top:4px;}
@media (max-width:520px){.msg{max-width:90%;}nav h2{font-size:18px;margin:0;}}
#scroll-down-btn{position:fixed;bottom:90px;right:20px;width:44px;height:44px;border-radius:50%;background:var(--accent);color:#fff;display:none;z-index:10;cursor:pointer;border:none;transition:all 0.2s;}
#scroll-down-btn:hover{transform:scale(1.05);}
#scroll-down-btn i{font-size:20px;}
.call-btn{background:transparent;color:var(--text);font-size:20px;padding:6px;border-radius:50%;cursor:pointer;transition:background 0.2s;}
.call-btn:hover{background:#333;}
.nav-avatar{width:36px;height:36px;border-radius:50%;margin-left:auto;object-fit:cover;}
#profile-avatar{width:90px;height:90px;border-radius:50%;margin-bottom:16px;object-fit:cover;box-shadow:var(--shadow);}
.user-item{padding:16px;border-bottom:1px solid #333;display:flex;justify-content:space-between;align-items:center;gap:12px;transition:background 0.2s;}
.user-item:hover{background:#222;}
.user-item .info{flex:1;}
.user-item button{background:var(--error);margin-left:8px;padding:8px 12px;border-radius:8px;}
.user-item button.unban{background:var(--success);}
.search-input{position:relative;}
.search-input i{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--gray);}
.search-input input{padding-left:36px;}
</style>
</head>
<body>

<!-- Вход -->
<div id="login-screen" class="screen active">
  <h2 style="padding:16px;text-align:center;">Добро пожаловать в MiniMessenger Pro</h2>
  <div style="padding:16px;flex:1;display:flex;flex-direction:column;justify-content:center;">
    <input id="login-email" placeholder="&#x1F4E7; Email" style="margin-bottom:12px;"><br>
    <input id="login-password" type="password" placeholder="&#x1F512; Пароль" style="margin-bottom:12px;"><br>
    <div id="login-error" class="error-msg" style="display:none;"></div>
    <button onclick="signIn()" style="margin-bottom:8px;">Войти</button>
    <button style="background:var(--bg-light)" onclick="showRegister()">Создать аккаунт</button>
    <div style="text-align:center;margin-top:24px;color:var(--gray);font-size:13px;">Авторизация защищена Supabase</div>
  </div>
</div>

<!-- Регистрация -->
<div id="register-screen" class="screen">
  <nav><button onclick="showLogin()"><i class="fa fa-arrow-left"></i></button><h2>Регистрация</h2></nav>
  <div style="padding:16px;">
    <input id="reg-email" placeholder="&#x1F4E7; Email"><br><br>
    <input id="reg-password" type="password" placeholder="&#x1F512; Пароль (минимум 6 символов)"><br><br>
    <input id="reg-username" placeholder="&#x1F464; Username"><br><br>
    <div id="reg-error" class="error-msg" style="display:none;"></div>
    <button onclick="signUp()">Зарегистрироваться</button>
    <button style="background:var(--bg-light)" onclick="showLogin()">Назад</button>
  </div>
</div>

<!-- Главный экран -->
<div id="main-screen" class="screen">
  <nav><h2>Чаты</h2>
    <div id="main-nav-buttons">
      <button onclick="openSearch()" title="Новый чат"><i class="fa fa-plus"></i></button>
      <button onclick="openSettings()" title="Настройки"><i class="fa fa-gear"></i></button>
    </div>
  </nav>
  <div class="search-input" style="padding:0 16px 12px 16px;">
    <i class="fa fa-search"></i>
    <input id="chat-search" placeholder="Поиск по чатам..." oninput="debounceSearchChats(this.value)">
  </div>
  <div class="chat-list" id="chat-list">
    <div class="loader" style="display:block;margin:100px auto;"></div> <!-- Лоадер -->
  </div>
</div>

<!-- Новый чат -->
<div id="search-screen" class="screen">
  <nav><button onclick="backToMain()"><i class="fa fa-arrow-left"></i></button><h2>Новый чат</h2></nav>
  <div style="padding:16px">
    <input id="search-username" class="search-input" placeholder="&#x1F50E; Введите username для поиска" style="width:100%;"><br><br>
    <div id="search-error" class="error-msg" style="display:none;"></div>
    <button onclick="searchUser()">Создать чат</button>
    <div id="search-results" style="margin-top:16px;"></div>
  </div>
</div>

<!-- Чат -->
<div id="chat-screen" class="screen">
  <nav style="gap:12px;">
    <button onclick="backToMain()"><i class="fa fa-arrow-left"></i></button>
    <div style="display:flex;flex-direction:column;flex:1;">
      <div style="display:flex;align-items:center;gap:8px;">
        <h2 id="chat-username" style="margin:0;"></h2>
        <a id="call-link" target="_blank" style="display:none;"><button class="call-btn" title="Голосовой звонок"><i class="fa fa-phone"></i></button></a>
      </div>
      <div id="chat-status" style="color:var(--gray);font-size:13px;"></div>
      <div id="typing-status" class="typing-status"></div>
    </div>
    <img id="chat-avatar" class="nav-avatar" src="" style="display:none;">
  </nav>
  <div class="messages" id="messages">
    <div class="loader" style="display:block;margin:100px auto;"></div> <!-- Лоадер -->
  </div>
  <div id="preview"></div>
  <div id="reply-preview-container" style="padding:0 12px;display:none;">
    <div id="reply-preview" class="reply-preview">
      <div class="meta"><strong id="reply-username"></strong><span id="reply-text"></span></div>
      <div class="cancel" title="Отменить ответ" onclick="cancelReply()"><i class="fa fa-times"></i></div>
    </div>
  </div>
  <div class="input-box">
    <div class="input-row">
      <textarea id="msg-input" placeholder="&#x1F4AC; Сообщение..." autofocus></textarea>
      <button class="img-btn" onclick="triggerImageUpload()" title="Отправить фото"><i class="fa fa-image"></i></button>
      <button class="send-btn" onclick="sendMessage()" title="Отправить (Enter)" disabled id="send-btn"><i class="fa fa-paper-plane"></i></button>
    </div>
  </div>
  <button id="scroll-down-btn" onclick="scrollToBottom()" title="Вниз"><i class="fa fa-arrow-down"></i></button>
</div>

<!-- Настройки -->
<div id="settings-screen" class="screen">
  <nav><button onclick="backToMain()"><i class="fa fa-arrow-left"></i></button><h2>Профиль</h2></nav>
  <div style="padding:16px;text-align:center;flex:1;display:flex;flex-direction:column;justify-content:center;gap:16px;">
    <img id="profile-avatar" src="" style="display:none;">
    <button onclick="triggerAvatarUpload()" style="background:var(--bg-light)">📸 Загрузить аватар</button>
    <button onclick="deleteAvatar()" style="background:var(--error);display:none;" id="delete-avatar-btn">🗑️ Удалить аватар</button>
    <div id="profile-info" style="text-align:left;background:var(--bg-light);padding:16px;border-radius:var(--radius);"></div><br>
    <button onclick="deleteAccount()" style="background:var(--error)">🗑️ Удалить аккаунт</button>
    <button onclick="logout()" style="background:var(--bg-light)">🚪 Выйти</button>
  </div>
</div>

<!-- Админ панель -->
<div id="admin-screen" class="screen">
  <nav><button onclick="backToMain()"><i class="fa fa-arrow-left"></i></button><h2>Админ панель</h2></nav>
  <div id="user-list" style="flex:1;overflow-y:auto;padding:16px;"></div>
</div>

<div id="context-menu" class="context-menu"></div>
<input type="file" id="file-input" style="display:none;" accept="image/*">
<input type="file" id="avatar-input" style="display:none;" accept="image/*">

<script>
/* ------------------ Инициализация сервисов ------------------ */
const supabase = window.supabase.createClient(
  "https://zmewwzlzujsrhstjehrp.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InptZXd3emx6dWpzcmhzdGplahrwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5NjM4MDksImV4cCI6MjA3MTUzOTgwOX0.kBBXwlCEl5szgK4vKgaPBhPOVYmoFzly2TXR-fI8D24"
);
uploadcare.start({ publicKey:"c12f2c3e134f56024db8" });

window.OneSignalDeferred = window.OneSignalDeferred || [];
OneSignalDeferred.push(async function(OneSignal) {
  await OneSignal.init({
    appId: "2e324874-a45f-4a70-ac36-130ef8af56a7",
    safari_web_id: "web.onesignal.auto.0d123f70-12e5-49b1-a758-f1abcc853120",
    notifyButton: { enable: true },
    allowLocalhostAsSecureOrigin: true, // Для локального тестирования
  });
  // Обработка подписки
  OneSignal.User.PushSubscription.addEventListener('change', async (event) => {
    if (currentUser) {
      const onesignalId = event.current.optedIn ? OneSignal.User.onesignalId : null;
      await supabase.from('profiles').update({ OneSignal_ID: onesignalId }).eq('id', currentUser.id);
    }
  });
  if (OneSignal.User.PushSubscription.optedIn && currentUser) {
    await supabase.from('profiles').update({ OneSignal_ID: OneSignal.User.onesignalId }).eq('id', currentUser.id);
  } else if (!OneSignal.User.PushSubscription.optedIn && currentUser) {
    await supabase.from('profiles').update({ OneSignal_ID: null }).eq('id', currentUser.id);
  }
});

/* ------------------ Состояние приложения ------------------ */
let currentUser = null;
let currentChat = null;
let currentChatOtherId = null;
let msgSubscription = null;
let chatSubscription = null;
let profileSubscription = null;
let selectedMessageId = null;
let selectedSender = null;
let selectedImageUrl = null;
let replyToMessage = null;
let selfChatId = null;
let chatSnapshot = null;
let loadedMessages = [];
let oldestMessageId = null;
let loadingMore = false;
let isAdmin = false;
let searchTimeout = null;

/* ------------------ WebView интеграция ------------------ */
function notifyWebViewUser(user) {
  window.webViewStringChange = user ? JSON.stringify({ userId: user.id, username: user.user_metadata.username, email: user.email }) : '';
  const event = new CustomEvent('webViewUserChange', { detail: window.webViewStringChange });
  window.dispatchEvent(event);
}

/* ------------------ UI утилиты ------------------ */
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}
function showLogin() { showScreen('login-screen'); notifyWebViewUser(null); }
function showRegister() { showScreen('register-screen'); }
function showMain() { loadChats(); showScreen('main-screen'); }
function openSettings() { loadProfile(); showScreen('settings-screen'); }
function openSearch() { showScreen('search-screen'); document.getElementById('search-username').focus(); }
function openAdmin() { loadUsers(); showScreen('admin-screen'); }

// Лоадер
function showLoader(elementId, show = true) {
  const el = document.getElementById(elementId);
  el.innerHTML = show ? '<div class="loader" style="margin:100px auto;display:block;"></div>' : '';
}

// Обработка ошибок
function showError(id, msg) {
  const errorEl = document.getElementById(id);
  errorEl.textContent = msg;
  errorEl.style.display = 'block';
  setTimeout(() => errorEl.style.display = 'none', 5000);
}

// Debounce для поиска
function debounceSearchChats(value) {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => filterChats(value), 300);
}

function filterChats(query) {
  const items = document.querySelectorAll('.chat-item');
  items.forEach(item => {
    const name = item.querySelector('.info > div').textContent.toLowerCase();
    item.style.display = name.includes(query.toLowerCase()) ? 'flex' : 'none';
  });
}

/* ------------------ Аутентификация ------------------ */
async function validateForm(inputs) {
  for (let input of inputs) {
    if (!input.value.trim()) return false;
  }
  if (document.getElementById('reg-password').value.length < 6) return false;
  return true;
}

async function signUp() {
  const email = document.getElementById('reg-email').value.trim();
  const password = document.getElementById('reg-password').value;
  const username = document.getElementById('reg-username').value.trim();
  if (!validateForm([document.getElementById('reg-email'), document.getElementById('reg-password'), document.getElementById('reg-username')])) {
    showError('reg-error', 'Заполните все поля. Пароль минимум 6 символов.');
    return;
  }
  showLoader('reg-error', false); // Скрыть ошибки
  const { data, error } = await supabase.auth.signUp({ email, password, options: { data: { username } } });
  if (error) {
    showError('reg-error', error.message);
    return;
  }
  await supabase.from('profiles').insert([{ id: data.user.id, email, username, status: 'онлайн', typing: false, current_chat: null, avatar_url: null, ban: false, OneSignal_ID: null }]);
  alert('✅ Подтвердите email и войдите!');
  showLogin();
}

async function signIn() {
  const email = document.getElementById('login-email').value.trim();
  const password = document.getElementById('login-password').value;
  if (!validateForm([document.getElementById('login-email'), document.getElementById('login-password')])) {
    showError('login-error', 'Введите email и пароль.');
    return;
  }
  showLoader('login-error', false);
  const { data, error } = await supabase.auth.signInWithPassword({ email, password });
  if (error) {
    showError('login-error', error.message);
    return;
  }
  currentUser = data.user;
  const { data: profile } = await supabase.from('profiles').select('*').eq('id', currentUser.id).single();
  if (profile.ban) {
    await supabase.auth.signOut();
    showError('login-error', 'Вы забанены.');
    return;
  }
  isAdmin = profile.email === 'timtimych18@mail.ru';
  if (isAdmin) {
    document.getElementById('main-nav-buttons').innerHTML += `<button onclick="openAdmin()" title="Админ"><i class="fa fa-user-shield"></i></button>`;
  }
  await supabase.from('profiles').update({ status: 'онлайн', current_chat: null }).eq('id', currentUser.id);
  OneSignalDeferred.push(async (OneSignal) => {
    const onesignalId = OneSignal.User.PushSubscription.optedIn ? OneSignal.User.onesignalId : null;
    await supabase.from('profiles').update({ OneSignal_ID: onesignalId }).eq('id', currentUser.id);
  });
  notifyWebViewUser(currentUser);
  showMain();
  subscribeChats();
  subscribeProfile();
}

async function logout() {
  if (currentUser) {
    const nowTime = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    const nowDate = new Date().toLocaleDateString('ru-RU');
    await supabase.from('profiles').update({ status: `был(а) в ${nowTime} ${nowDate}`, typing: false, current_chat: null, OneSignal_ID: null }).eq('id', currentUser.id);
    await supabase.auth.signOut();
    currentUser = null;
    isAdmin = false;
    notifyWebViewUser(null);
  }
  showLogin();
}

async function loadProfile() {
  if (!currentUser) return;
  const { data } = await supabase.from('profiles').select('*').eq('id', currentUser.id).single();
  document.getElementById('profile-info').innerHTML = `
    <strong>Username:</strong> ${data.username}<br>
    <strong>Email:</strong> ${data.email}<br>
    <strong>Статус:</strong> ${data.status}<br>
    <strong>ID:</strong> ${data.id}
  `;
  const avatar = document.getElementById('profile-avatar');
  const deleteBtn = document.getElementById('delete-avatar-btn');
  if (data.avatar_url) {
    avatar.src = data.avatar_url;
    avatar.style.display = 'block';
    deleteBtn.style.display = 'block';
  } else {
    avatar.style.display = 'none';
    deleteBtn.style.display = 'none';
  }
}

async function deleteAccount() {
  if (!currentUser || !confirm('Удалить аккаунт безвозвратно? Все данные потеряются.')) return;
  await supabase.from('profiles').delete().eq('id', currentUser.id);
  await supabase.auth.signOut();
  currentUser = null;
  notifyWebViewUser(null);
  showLogin();
}

async function deleteAvatar() {
  if (!currentUser) return;
  await supabase.from('profiles').update({ avatar_url: null }).eq('id', currentUser.id);
  loadProfile();
}

function triggerAvatarUpload() {
  document.getElementById('avatar-input').click();
}
document.getElementById('avatar-input').addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  uploadcare.fileFrom('object', file).done(async (info) => {
    const { error } = await supabase.from('profiles').update({ avatar_url: info.cdnUrl }).eq('id', currentUser.id);
    if (error) showError('profile-info', 'Ошибка загрузки аватара: ' + error.message);
    else loadProfile();
  });
});

/* ------------------ Утилиты ------------------ */
function escapeHtml(text) { const d = document.createElement('div'); d.textContent = text; return d.innerHTML; }
function formatTimeShort(d) { return new Date(d).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); }
function formatDateTime(d) { const D = new Date(d); return D.toLocaleDateString('ru-RU') + ' ' + D.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); }

// Анимация typewriter (улучшена)
function typeWriter(element, text, delay, callback) {
  let i = 0;
  element.innerHTML = '';
  function type() {
    if (i < text.length) {
      element.innerHTML += text.charAt(i);
      i++;
      setTimeout(type, delay);
    } else if (callback) callback();
  }
  type();
}
function typeErase(element, text, delay, callback) {
  let i = text.length;
  function erase() {
    if (i > 0) {
      element.innerHTML = text.substring(0, i - 1);
      i--;
      setTimeout(erase, delay);
    } else if (callback) callback();
  }
  erase();
}

/* ------------------ Поиск и создание чата ------------------ */
async function searchUser() {
  const input = document.getElementById('search-username').value.trim();
  if (!input) { showError('search-error', 'Введите username'); return; }
  const { data: userProfile, error } = await supabase.from('profiles').select('id,username').ilike('username', `%${input}%`).limit(5);
  if (error) { showError('search-error', 'Ошибка поиска: ' + error.message); return; }
  if (!userProfile || userProfile.length === 0) { showError('search-error', 'Пользователь не найден'); return; }

  // Показать результаты
  const results = document.getElementById('search-results');
  results.innerHTML = '';
  userProfile.forEach(profile => {
    if (profile.id === currentUser.id) return; // Пропустить себя
    const div = document.createElement('div');
    div.className = 'chat-item';
    div.innerHTML = `<div class="info"><div>${profile.username}</div></div><button onclick="createChat(${profile.id}, '${profile.username}')">Создать чат</button>`;
    results.appendChild(div);
  });
}

async function createChat(otherId, otherName) {
  const { data: existing } = await supabase.from('chats')
    .select('id')
    .or(`and(user1.eq.${currentUser.id},user2.eq.${otherId}),and(user1.eq.${otherId},user2.eq.${currentUser.id})`)
    .limit(1);
  let chatId;
  if (existing && existing.length > 0) {
    chatId = existing[0].id;
  } else {
    const { data: newChat, error } = await supabase.from('chats').insert([{ user1: currentUser.id, user2: otherId }]).select('id').single();
    if (error) { showError('search-error', error.message); return; }
    chatId = newChat.id;
  }
  openChat(chatId, otherName, otherId);
  showMain(); // Вернуться назад
}

/* ------------------ Список чатов (оптимизировано с лоадером) ------------------ */
async function loadChats() {
  if (!currentUser) return;
  showLoader('chat-list');
  const { data: chats } = await supabase.from('chats').select('*').or(`user1.eq.${currentUser.id},user2.eq.${currentUser.id}`);
  if (!chats) return;
  const promises = chats.map(async chat => {
    const otherId = (chat.user1 === currentUser.id) ? chat.user2 : chat.user1;
    const isSelf = otherId === currentUser.id;
    let chatName = 'Избранное';
    let avatar = null;
    if (isSelf) {
      const { data: profile } = await supabase.from('profiles').select('avatar_url').eq('id', currentUser.id).single();
      avatar = profile?.avatar_url || null;
    } else {
      const { data: profile } = await supabase.from('profiles').select('username,avatar_url').eq('id', otherId).single();
      chatName = profile?.username || 'Unknown';
      avatar = profile?.avatar_url || null;
    }
    const { data: msgs } = await supabase.from('messages').select('id,content,image_url,created_at,read').eq('chat_id', chat.id).order('created_at', { ascending: false }).limit(1);
    let lastMsgText = '', lastMsgImg = false, lastTime = '', lastCreated = 0;
    if (msgs && msgs.length > 0) {
      lastMsgText = msgs[0].content || '';
      lastMsgImg = !!msgs[0].image_url;
      lastCreated = new Date(msgs[0].created_at).getTime();
      const d = new Date(msgs[0].created_at);
      const today = new Date();
      if (d.toDateString() === today.toDateString()) {
        lastTime = d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      } else {
        lastTime = d.toLocaleDateString('ru-RU') + ' ' + d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      }
    }
    const { data: unread } = await supabase.from('messages').select('id').eq('chat_id', chat.id).eq('read', false).neq('sender', currentUser.id);
    const unreadCount = (unread || []).length;
    return { chatId: chat.id, otherId, chatName, avatar, lastMsgText, lastMsgImg, lastTime, unreadCount, lastCreated };
  });

  const chatData = await Promise.all(promises);
  const newSnapshot = {};
  chatData.forEach(c => newSnapshot[c.chatId] = `${c.lastCreated}::${c.unreadCount}`);
  const snapshotJson = JSON.stringify(newSnapshot);
  if (chatSnapshot === snapshotJson) return; // Кэш
  chatSnapshot = snapshotJson;

  chatData.sort((a, b) => new Date(b.lastCreated) - new Date(a.lastCreated));
  const list = document.getElementById('chat-list');
  list.innerHTML = '';
  for (const c of chatData) {
    const div = document.createElement('div'); div.className = 'chat-item';
    if (c.avatar) {
      const avatarImg = document.createElement('img'); avatarImg.className = 'avatar'; avatarImg.src = c.avatar; avatarImg.onerror = () => avatarImg.src = ''; // Fallback
      div.appendChild(avatarImg);
    }
    const info = document.createElement('div'); info.className = 'info';
    const name = document.createElement('div'); name.innerText = c.chatName; name.style.fontWeight = '600';
    const last = document.createElement('div'); last.className = 'last';
    const msgTxt = (c.lastMsgImg ? "🖼️ " : "") + (c.lastMsgText ? escapeHtml(c.lastMsgText.slice(0, 50)) + '...' : "");
    last.innerHTML = `<span style="overflow:hidden;white-space:nowrap;text-overflow:ellipsis;display:inline-block;max-width:200px">${msgTxt}</span><span>${escapeHtml(c.lastTime || '')}</span>`;
    info.appendChild(name); info.appendChild(last);
    div.appendChild(info);
    if (c.unreadCount > 0) {
      const badge = document.createElement('div'); badge.className = 'unread-badge'; badge.innerText = c.unreadCount > 99 ? '99+' : c.unreadCount;
      div.appendChild(badge);
    }
    div.onclick = () => openChat(c.chatId, c.chatName, c.otherId, c.avatar);
    list.appendChild(div);
  }
  showLoader('chat-list', false);
}

function subscribeChats() {
  if (chatSubscription) supabase.removeChannel(chatSubscription);
  chatSubscription = supabase
    .channel('chats-global')
    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'chats' }, () => loadChats())
    .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'chats' }, () => loadChats())
    .on('postgres_changes', { event: 'DELETE', schema: 'public', table: 'chats' }, () => loadChats())
    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, () => loadChats())
    .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'messages' }, () => loadChats())
    .subscribe();
}

function subscribeProfile() {
  if (profileSubscription) supabase.removeChannel(profileSubscription);
  profileSubscription = supabase.channel('profile-' + currentUser.id)
    .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'profiles', filter: `id=eq.${currentUser.id}` }, payload => {
      if (payload.new.ban) {
        supabase.auth.signOut();
        alert('Вы забанены');
        showLogin();
      }
    }).subscribe();
}

/* ------------------ Чат и сообщения ------------------ */
async function openChat(chatId, otherName, otherId, otherAvatar = null) {
  currentChat = chatId;
  currentChatOtherId = otherId;
  const isSelf = otherId === currentUser.id;
  document.getElementById('chat-username').innerText = isSelf ? 'Избранное' : (otherName || 'Чат');
  document.getElementById('chat-status').innerText = '';
  document.getElementById('typing-status').innerText = '';
  const callLink = document.getElementById('call-link');
  if (!isSelf) {
    callLink.href = `https://super-random.netlify.app/test/call?chat_id=${encodeURIComponent(chatId)}`;
    callLink.style.display = 'block';
  } else {
    callLink.style.display = 'none';
  }
  const chatAvatar = document.getElementById('chat-avatar');
  if (otherAvatar) {
    chatAvatar.src = otherAvatar;
    chatAvatar.style.display = 'block';
  } else if (isSelf) {
    const { data: profile } = await supabase.from('profiles').select('avatar_url').eq('id', currentUser.id).single();
    if (profile?.avatar_url) {
      chatAvatar.src = profile.avatar_url;
      chatAvatar.style.display = 'block';
    } else {
      chatAvatar.style.display = 'none';
    }
  } else {
    chatAvatar.style.display = 'none';
  }
  showScreen('chat-screen');
  try { await supabase.from('profiles').update({ current_chat: chatId }).eq('id', currentUser.id); } catch (e) { console.error(e); }
  loadedMessages = [];
  oldestMessageId = null;
  showLoader('messages');
  await loadMessages(true);

  if (msgSubscription) supabase.removeChannel(msgSubscription);
  msgSubscription = supabase.channel('room-' + chatId)
    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages', filter: `chat_id=eq.${chatId}` }, payload => {
      renderMessage(payload.new, true);
      loadChats();
    })
    .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'messages', filter: `chat_id=eq.${chatId}` }, payload => {
      renderMessage(payload.new, false);
      loadChats();
    })
    .subscribe();

  if (otherId && !isSelf) {
    if (window.statusChannelOther) supabase.removeChannel(window.statusChannelOther);
    window.statusChannelOther = supabase.channel('status-' + otherId)
      .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'profiles', filter: `id=eq.${otherId}` }, p => {
        const st = formatStatus(p.new);
        document.getElementById('chat-status').innerText = st;
        document.getElementById('typing-status').innerText = p.new.typing ? 'печатает' + '.'.repeat((Date.now() / 500) % 4 || 1) : '';
      }).subscribe();
    const { data: profile } = await supabase.from('profiles').select('*').eq('id', otherId).single();
    if (profile) document.getElementById('chat-status').innerText = formatStatus(profile);
  } else {
    document.getElementById('chat-status').innerText = '';
  }
  await supabase.from('messages').update({ read: true }).eq('chat_id', chatId).neq('sender', currentUser.id).eq('read', false);
  const box = document.getElementById('messages');
  box.onscroll = () => {
    if (box.scrollTop === 0 && !loadingMore && oldestMessageId) loadMoreMessages();
    toggleScrollDownBtn();
  };
  showLoader('messages', false);
  document.getElementById('msg-input').focus();
}

async function loadMessages(initial = false) {
  if (!currentChat) return;
  const limit = 50;
  let query = supabase.from('messages').select('*').eq('chat_id', currentChat);
  if (initial) {
    query = query.order('created_at', { ascending: false }).limit(limit);
  } else {
    query = query.lt('id', oldestMessageId).order('created_at', { ascending: false }).limit(limit);
  }
  const { data } = await query;
  if (!data || data.length === 0) return;

  const messages = data.reverse();
  if (!initial) {
    loadedMessages = messages.concat(loadedMessages);
  } else {
    loadedMessages = messages;
  }
  if (messages.length > 0) oldestMessageId = messages[0].id;

  const box = document.getElementById('messages');
  if (initial) box.innerHTML = '';

  let firstUnreadId = null;
  for (const msg of loadedMessages) {
    if (!msg.read && msg.sender !== currentUser.id) { firstUnreadId = msg.id; break; }
  }

  for (const msg of messages) {
    if (firstUnreadId && msg.id === firstUnreadId) {
      const sep = document.createElement('div');
      sep.className = 'unread-sep';
      sep.id = 'unread-sep';
      sep.innerText = 'Новые сообщения';
      if (initial) box.appendChild(sep); else box.insertBefore(sep, box.firstChild);
    }
    await renderMessage(msg, false, initial ? 'append' : 'prepend');
  }

  if (initial) {
    if (firstUnreadId) {
      const sep = document.getElementById('unread-sep');
      if (sep) {
        sep.scrollIntoView({ behavior: 'smooth', block: 'start' });
        const firstEl = document.getElementById('msg-' + firstUnreadId);
        if (firstEl) {
          firstEl.classList.add('highlight');
          setTimeout(() => firstEl.classList.remove('highlight'), 3000);
        }
      }
    } else {
      box.scrollTop = box.scrollHeight;
    }
  }
}

async function loadMoreMessages() {
  loadingMore = true;
  const currentScrollHeight = document.getElementById('messages').scrollHeight;
  await loadMessages(false);
  document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight - currentScrollHeight;
  loadingMore = false;
}

function toggleScrollDownBtn() {
  const box = document.getElementById('messages');
  const btn = document.getElementById('scroll-down-btn');
  if (box.scrollTop + box.clientHeight < box.scrollHeight - 50) {
    btn.style.display = 'flex';
  } else {
    btn.style.display = 'none';
  }
}

function scrollToBottom() {
  const box = document.getElementById('messages');
  box.scrollTop = box.scrollHeight;
  toggleScrollDownBtn();
}

async function renderMessage(msg, scroll = true, mode = 'append') {
  const box = document.getElementById('messages');
  let div = document.getElementById('msg-' + msg.id);
  const isMe = msg.sender === currentUser.id;

  if (!div) {
    div = document.createElement('div');
    div.id = 'msg-' + msg.id;
    div.className = 'msg ' + (isMe ? 'me' : 'other');
    div.oncontextmenu = (e) => { e.preventDefault(); showContextMenu(e, msg.id, msg.sender, msg.image_url); };
    if (mode === 'prepend') box.insertBefore(div, box.firstChild); else box.appendChild(div);
    setTimeout(() => div.classList.add('animate'), 10); // Анимация появления
  } else {
    div.className = 'msg ' + (isMe ? 'me' : 'other');
  }

  if (msg.is_deleted) {
    div.className = 'msg deleted';
    div.innerText = 'Сообщение удалено';
    if (scroll) box.scrollTop = box.scrollHeight;
    return;
  }

  let htmlParts = [];
  if (msg.reply_to) {
    try {
      const { data: orig } = await supabase.from('messages').select('id,sender,content,image_url').eq('id', msg.reply_to).single();
      if (orig) {
        const username = await getUsernameById(orig.sender);
        let snippet = orig.content && orig.content.trim().length > 0 ? orig.content.trim().slice(0, 120) : (orig.image_url ? '[Фото]' : '[Сообщение]');
        const headerHTML = `<div class="reply-to" data-reply-id="${orig.id}" title="Перейти к сообщению">Ответ @${escapeHtml(username)}: ${escapeHtml(snippet)}</div>`;
        htmlParts.push(headerHTML);
      } else {
        htmlParts.push('<div class="reply-to" title="Сообщение удалено">Ответ: (удалено)</div>');
      }
    } catch (e) {
      htmlParts.push('<div class="reply-to">Ответ (недоступно)</div>');
    }
  }

  if (msg.content) htmlParts.push(`<div>${escapeHtml(msg.content)}</div>`);
  if (msg.image_url) htmlParts.push(`<img src="${escapeHtml(msg.image_url)}" class="msg-img" onerror="this.style.display='none'">`);

  let ticks = '';
  if (isMe) {
    if (currentChat === selfChatId) ticks = '<span class="ticks">✓✓</span>';
    else ticks = msg.read ? '<span class="ticks">✓✓</span>' : '<span class="ticks">✓</span>';
  }

  htmlParts.push(`<span class="time">${formatTimeShort(msg.created_at)} ${ticks}</span>`);
  div.innerHTML = htmlParts.join('');

  const replyElems = div.querySelectorAll('.reply-to');
  replyElems.forEach(el => {
    const rid = el.getAttribute('data-reply-id');
    el.style.cursor = 'pointer';
    el.onclick = (ev) => {
      ev.stopPropagation();
      if (rid) {
        const target = document.getElementById('msg-' + rid);
        if (target) {
          target.scrollIntoView({ behavior: 'smooth', block: 'center' });
          target.classList.add('highlight');
          setTimeout(() => target.classList.remove('highlight'), 2000);
        }
      }
    };
  });

  if (scroll) box.scrollTop = box.scrollHeight;
  toggleScrollDownBtn();
}

async function sendMessage() {
  const text = document.getElementById('msg-input').value.trim();
  if (!text && !selectedImageUrl) return;
  if (!currentChat) return;
  const payload = {
    chat_id: currentChat,
    sender: currentUser.id,
    content: text || null,
    image_url: selectedImageUrl || null,
    reply_to: replyToMessage ? replyToMessage.id : null,
    read: false
  };
  const { data: inserted, error: insErr } = await supabase.from('messages').insert([payload]).select('*').single();
  if (insErr) { alert('Ошибка отправки: ' + insErr.message); return; }

  // Пуш-уведомление (улучшено с заголовком)
  let pushSuccess = false;
  let senderUsername = currentUser.user_metadata?.username || 'пользователь';
  if (currentChatOtherId && currentChat !== selfChatId) {
    try {
      const { data: otherProfile } = await supabase.from('profiles').select('OneSignal_ID').eq('id', currentChatOtherId).single();
      if (otherProfile && otherProfile.OneSignal_ID) {
        const notificationText = text.substring(0, 100) || (selectedImageUrl ? 'Фото' : 'Сообщение');
        const response = await fetch('https://api.onesignal.com/notifications', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Basic os_v2_app_fyzeq5fel5fhblbwcmhprl2wu6lmvbhhg2yusnurzqbdl26s4nvjpkdyi5ku5j6m7yp24ajpxutjl6vxfh5gdrfqcvd2f3zblof5vya'
          },
          body: JSON.stringify({
            app_id: "2e324874-a45f-4a70-ac36-130ef8af56a7",
            include_aliases: { onesignal_id: [otherProfile.OneSignal_ID] },
            target_channel: "push",
            headings: { en: `Сообщение от ${senderUsername}` },
            contents: { en: notificationText },
            sound: "default", // Звук
            name: "New Message"
          })
        });
        pushSuccess = response.ok;
      }
    } catch (e) {
      console.error('Ошибка пуша:', e);
    }
  }

  await renderMessage(inserted, true);

  // Анимация успеха (улучшена)
  if (pushSuccess) {
    const msgDiv = document.getElementById('msg-' + inserted.id);
    if (msgDiv) {
      const successDiv = document.createElement('div');
      successDiv.className = 'success-text';
      msgDiv.style.position = 'relative';
      msgDiv.appendChild(successDiv);
      const successText = "✓ Доставлено!";
      typeWriter(successDiv, successText, 30, () => {
        setTimeout(() => typeErase(successDiv, successText, 30, () => {
          if (successDiv.parentNode) successDiv.parentNode.removeChild(successDiv);
        }), 1500);
      });
    }
  }

  if (currentChat === selfChatId) {
    await supabase.from('messages').update({ read: true }).eq('id', inserted.id);
  } else if (currentChatOtherId) {
    try {
      const { data: otherProfile } = await supabase.from('profiles').select('current_chat').eq('id', currentChatOtherId).single();
      if (otherProfile && otherProfile.current_chat === currentChat) {
        await supabase.from('messages').update({ read: true }).eq('id', inserted.id);
      }
    } catch (e) { console.error(e); }
  }

  document.getElementById('msg-input').value = '';
  document.getElementById('send-btn').disabled = true;
  selectedImageUrl = null;
  replyToMessage = null;
  document.getElementById('preview').innerHTML = '';
  hideReplyPreview();
}

function triggerImageUpload() {
  document.getElementById('file-input').click();
}
document.getElementById('file-input').addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;
  uploadcare.fileFrom('object', file).done(info => {
    selectedImageUrl = info.cdnUrl;
    document.getElementById('preview').innerHTML = `<img src="${escapeHtml(selectedImageUrl)}" title="Отправить фото">`;
    document.getElementById('send-btn').disabled = false;
  });
});

// Ввод в textarea
document.getElementById('msg-input').addEventListener('input', async () => {
  if (!currentUser) return;
  document.getElementById('send-btn').disabled = document.getElementById('msg-input').value.trim() === '' && !selectedImageUrl;
  await supabase.from('profiles').update({ typing: true }).eq('id', currentUser.id);
  clearTimeout(window.typingTimeout);
  window.typingTimeout = setTimeout(async () => {
    await supabase.from('profiles').update({ typing: false }).eq('id', currentUser.id);
  }, 2000);
});
document.getElementById('msg-input').addEventListener('keydown', async (e) => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
});

// Контекстное меню
async function showContextMenu(e, msgId, senderId, imageUrl) {
  selectedMessageId = msgId; selectedSender = senderId;
  const menu = document.getElementById('context-menu');
  menu.innerHTML = '';

  const copyBtn = document.createElement('button');
  copyBtn.innerText = '📋 Копировать';
  copyBtn.onclick = copyMessage;
  menu.appendChild(copyBtn);

  const replyBtn = document.createElement('button');
  replyBtn.innerText = '💬 Ответить';
  replyBtn.onclick = replyMessage;
  menu.appendChild(replyBtn);

  if (senderId === currentUser.id) {
    const deleteBtn = document.createElement('button');
    deleteBtn.innerText = '🗑️ Удалить';
    deleteBtn.style.color = 'var(--error)';
    deleteBtn.onclick = confirmDelete;
    menu.appendChild(deleteBtn);
  }

  if (imageUrl) {
    const downloadBtn = document.createElement('button');
    downloadBtn.innerText = '⬇️ Скачать';
    downloadBtn.onclick = downloadMessageImage;
    menu.appendChild(downloadBtn);
  }

  menu.style.left = e.pageX + 'px';
  menu.style.top = e.pageY + 'px';
  menu.style.display = 'flex';
}

function copyMessage() {
  if (!selectedMessageId) return;
  const el = document.getElementById('msg-' + selectedMessageId);
  if (el) navigator.clipboard.writeText(el.innerText || '').then(() => alert('Скопировано!'));
  selectedMessageId = null;
  document.getElementById('context-menu').style.display = 'none';
}

async function confirmDelete() {
  if (!selectedMessageId || !currentUser || selectedSender !== currentUser.id) {
    alert('Можно удалять только свои сообщения');
    document.getElementById('context-menu').style.display = 'none';
    return;
  }
  if (!confirm('Удалить сообщение?')) return;
  const { data, error } = await supabase.from('messages')
    .update({ is_deleted: true })
    .eq('id', selectedMessageId)
    .eq('sender', currentUser.id)
    .select('*')
    .single();
  if (error) {
    alert('Ошибка: ' + error.message);
    return;
  }
  if (data) await renderMessage(data, false);
  selectedMessageId = null;
  document.getElementById('context-menu').style.display = 'none';
}

async function downloadMessageImage() {
  if (!selectedMessageId) return;
  const { data } = await supabase.from('messages').select('image_url').eq('id', selectedMessageId).single();
  if (data && data.image_url) {
    const a = document.createElement('a');
    a.href = data.image_url;
    a.download = `message_${Date.now()}.jpg`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }
  document.getElementById('context-menu').style.display = 'none';
}

async function replyMessage() {
  if (!selectedMessageId) return;
  document.getElementById('context-menu').style.display = 'none';
  const { data: msg } = await supabase.from('messages').select('*').eq('id', selectedMessageId).single();
  if (!msg) return;
  const uname = await getUsernameById(msg.sender);
  const text = (msg.content || '').split('\n')[0].slice(0, 180);
  replyToMessage = { id: selectedMessageId, text, username: uname };
  showReplyPreview(replyToMessage);
}

function showReplyPreview(replyObj) {
  const container = document.getElementById('reply-preview-container');
  document.getElementById('reply-username').innerText = '@' + (replyObj.username || 'user');
  document.getElementById('reply-text').innerText = ': ' + (replyObj.text || '');
  container.style.display = 'block';
  const preview = document.getElementById('reply-preview');
  preview.onclick = (e) => {
    e.stopPropagation();
    const target = document.getElementById('msg-' + replyObj.id);
    if (target) {
      target.scrollIntoView({ behavior: 'smooth', block: 'center' });
      target.classList.add('highlight');
      setTimeout(() => target.classList.remove('highlight'), 2000);
    } else {
      alert('Исходное сообщение не загружено.');
    }
  };
}

function hideReplyPreview() {
  document.getElementById('reply-preview-container').style.display = 'none';
  document.getElementById('reply-preview').onclick = null;
}

function cancelReply() {
  replyToMessage = null;
  hideReplyPreview();
}

async function getUsernameById(id) {
  if (!id) return 'Unknown';
  const { data } = await supabase.from('profiles').select('username').eq('id', id).single();
  return data?.username || 'Unknown';
}

function formatStatus(profile) {
  if (!profile) return '';
  if (profile.typing) return 'печатает...';
  return profile.status || 'оффлайн';
}

/* ------------------ Админ ------------------ */
async function loadUsers() {
  const { data: users } = await supabase.from('profiles').select('*').order('username');
  const list = document.getElementById('user-list');
  list.innerHTML = '';
  if (!users) return;
  users.forEach(user => {
    if (user.id === currentUser.id) return; // Пропустить себя
    const div = document.createElement('div'); div.className = 'user-item';
    const info = document.createElement('div'); info.className = 'info';
    info.innerHTML = `<strong>${user.username}</strong><br><small>${user.email}</small><br><small>Статус: ${user.status}</small>`;
    div.appendChild(info);
    const banBtn = document.createElement('button');
    banBtn.innerText = user.ban ? 'Разбанить' : 'Забанить';
    banBtn.className = user.ban ? 'unban' : '';
    banBtn.onclick = () => toggleBan(user.id, user.ban);
    div.appendChild(banBtn);
    list.appendChild(div);
  });
}

async function toggleBan(userId, currentBan) {
  if (!confirm(` ${currentBan ? 'Разбанить' : 'Забанить'} пользователя?`)) return;
  await supabase.from('profiles').update({ ban: !currentBan }).eq('id', userId);
  loadUsers();
}

/* ------------------ Инициализация ------------------ */
window.addEventListener('load', async () => {
  const { data: { session } } = await supabase.auth.getSession();
  if (session) {
    currentUser = session.user;
    const { data: profile } = await supabase.from('profiles').select('*').eq('id', currentUser.id).single();
    if (profile.ban) {
      await supabase.auth.signOut();
      alert('Вы забанены');
      showLogin();
      return;
    }
    isAdmin = profile.email === 'timtimych18@mail.ru';
    if (isAdmin) {
      document.getElementById('main-nav-buttons').innerHTML += `<button onclick="openAdmin()" title="Админ"><i class="fa fa-user-shield"></i></button>`;
    }
    OneSignalDeferred.push(async (OneSignal) => {
      const onesignalId = OneSignal.User.PushSubscription.optedIn ? OneSignal.User.onesignalId : null;
      await supabase.from('profiles').update({ OneSignal_ID: onesignalId }).eq('id', currentUser.id);
    });
    notifyWebViewUser(currentUser);
    showMain();
    subscribeChats();
    subscribeProfile();
  }
});

window.addEventListener('beforeunload', async () => {
  if (currentUser) {
    const nowTime = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    const nowDate = new Date().toLocaleDateString('ru-RU');
    await supabase.from('profiles').update({ status: `был(а) в ${nowTime} ${nowDate}`, typing: false, current_chat: null }).eq('id', currentUser.id);
    notifyWebViewUser(null);
  }
});

document.addEventListener('visibilitychange', async () => {
  if (document.hidden && currentUser) {
    const nowTime = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    const nowDate = new Date().toLocaleDateString('ru-RU');
    await supabase.from('profiles').update({ status: `был(а) в ${nowTime} ${nowDate}`, typing: false, current_chat: null }).eq('id', currentUser.id);
    notifyWebViewUser(null);
  }
});

function backToMain() {
  if (msgSubscription) supabase.removeChannel(msgSubscription);
  if (window.statusChannelOther) supabase.removeChannel(window.statusChannelOther);
  if (currentUser) supabase.from('profiles').update({ current_chat: null }).eq('id', currentUser.id);
  currentChat = null;
  currentChatOtherId = null;
  showMain();
}

window.onclick = () => { document.getElementById('context-menu').style.display = 'none'; };

// Self-chat ID
(async function detectSelfChatId() {
  const origLoad = loadChats;
  loadChats = async function () {
    await origLoad();
    const { data: existing } = await supabase.from('chats').select('id').or(`and(user1.eq.${currentUser.id},user2.eq.${currentUser.id})`).limit(1);
    selfChatId = existing && existing.length > 0 ? existing[0].id : null;
  };
})();
</script>
</body>
</html>
