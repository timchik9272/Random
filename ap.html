<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<title>–Ø–±–ª–æ—á–∫–æ ‚Äî –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js"></script>
<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
:root {
  --primary: #ff3b30;
  --dark-red: #8b0000;
  --bg-dark: #1a0505;
  --bg-card: #2d0505;
  --text-main: #fff5f5;
  --text-dim: #ff9999;
  --accent: #ff4d4d;
  --glass: rgba(255, 59, 48, 0.1);
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
body, html { 
  margin: 0; padding: 0; width: 100%; height: 100%; 
  font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
  background-color: var(--bg-dark); color: var(--text-main);
  overflow: hidden;
}

/* Screens */
.screen { 
  display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
  flex-direction: column; background: var(--bg-dark); 
}
.screen.active { display: flex; animation: fadeIn 0.3s ease; }

@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

/* Navigation */
nav { 
  display: flex; align-items: center; padding: 12px 16px; 
  background: var(--bg-card); border-bottom: 2px solid var(--dark-red);
  gap: 12px; z-index: 10;
}
nav h2 { margin: 0; font-size: 1.2rem; font-weight: 700; color: var(--primary); }

/* Inputs & Buttons */
input, textarea {
  background: var(--bg-card); border: 1px solid var(--dark-red);
  color: #fff; padding: 12px 16px; border-radius: 12px; font-size: 16px;
  transition: all 0.2s;
}
input:focus { border-color: var(--primary); box-shadow: 0 0 8px var(--glass); }

button {
  background: var(--primary); color: white; border: none; padding: 12px 20px;
  border-radius: 12px; font-weight: 600; cursor: pointer; transition: 0.2s;
  display: flex; align-items: center; justify-content: center; gap: 8px;
}
button:active { transform: scale(0.96); opacity: 0.9; }
button.secondary { background: transparent; border: 1px solid var(--primary); color: var(--primary); }

/* Avatars */
.gen-avatar { 
  display: flex; align-items: center; justify-content: center; 
  border-radius: 50%; color: white; font-weight: bold; border: 2px solid var(--dark-red);
}
#nav-self-avatar-container img, #chat-avatar-container img { 
    border: 2px solid var(--primary); border-radius: 50%; 
}

/* Chat List */
.chat-list { flex: 1; overflow-y: auto; padding: 8px; }
.chat-item {
  display: flex; align-items: center; padding: 12px; border-radius: 16px;
  margin-bottom: 8px; background: var(--glass); cursor: pointer; transition: 0.2s;
}
.chat-item:hover { background: rgba(255, 59, 48, 0.2); }
.chat-item .info { flex: 1; margin-left: 12px; overflow: hidden; }
.chat-item .last { font-size: 13px; color: var(--text-dim); margin-top: 4px; }
.unread-badge {
  background: var(--primary); color: white; font-size: 11px; padding: 4px 8px;
  border-radius: 10px; margin-left: 8px;
}

/* Messages */
.messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; }
.msg { max-width: 80%; padding: 10px 14px; border-radius: 18px; position: relative; font-size: 15px; line-height: 1.4; }
.msg.me { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 4px; }
.msg.other { align-self: flex-start; background: var(--bg-card); border-bottom-left-radius: 4px; border: 1px solid var(--dark-red); }
.msg.deleted { font-style: italic; opacity: 0.6; }
.time { font-size: 10px; opacity: 0.7; margin-top: 4px; display: block; text-align: right; }
.ticks { font-size: 10px; margin-left: 4px; }

/* Input Box */
.input-box { padding: 12px; background: var(--bg-card); border-top: 1px solid var(--dark-red); }
.input-row { display: flex; align-items: flex-end; gap: 10px; }
#msg-input { flex: 1; border-radius: 20px; max-height: 120px; resize: none; padding: 10px 15px; }
.send-btn, .img-btn { width: 45px; height: 45px; border-radius: 50%; padding: 0; flex-shrink: 0; }
.img-btn { background: var(--dark-red); }

/* Modals */
.modal-overlay {
  display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.8); z-index: 100; align-items: center; justify-content: center; padding: 20px;
}
.modal-box { 
  background: var(--bg-card); border: 2px solid var(--primary); padding: 24px; 
  border-radius: 24px; width: 100%; max-width: 400px;
}

/* Context Menu */
.context-menu {
  display: none; position: absolute; background: var(--bg-card); border: 1px solid var(--primary);
  border-radius: 12px; flex-direction: column; min-width: 150px; z-index: 1000; box-shadow: 0 4px 20px rgba(0,0,0,0.5);
}
.context-menu button {
  background: transparent; justify-content: flex-start; border-radius: 0; padding: 10px 15px; border-bottom: 1px solid var(--dark-red);
}
.context-menu button:last-child { border-bottom: none; }

/* Apple specific styles */
.brand-icon { color: var(--primary); font-size: 2.5rem; margin-bottom: 10px; }
#scroll-down-btn {
    position: fixed; bottom: 85px; right: 20px; background: var(--primary);
    width: 40px; height: 40px; border-radius: 50%; display: none;
    align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}

.loader {
  width: 30px; height: 30px; border: 3px solid var(--glass); border-top-color: var(--primary);
  border-radius: 50%; animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>

<div id="login-screen" class="screen active">
  <div style="display:flex;flex-direction:column;justify-content:center;align-items:center;height:100%;padding:24px;max-width:400px;margin:0 auto;width:100%;">
    <i class="fa-solid fa-apple-whole brand-icon"></i>
    <h1 style="text-align:center;color:var(--primary);margin-bottom:30px;letter-spacing:1px;">–Ø–ë–õ–û–ß–ö–û</h1>
    <input id="login-email" placeholder="–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞" style="width:100%"><br>
    <input id="login-password" type="password" placeholder="–ü–∞—Ä–æ–ª—å" style="width:100%"><br>
    <button onclick="signIn()" style="width:100%">–í–æ–π—Ç–∏</button>
    <button class="secondary" style="width:100%;margin-top:12px;" onclick="showRegister()">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
  </div>
</div>

<div id="register-screen" class="screen">
  <div style="display:flex;flex-direction:column;justify-content:center;height:100%;padding:24px;max-width:400px;margin:0 auto;width:100%;">
    <h2 style="text-align:center;color:var(--primary)"><i class="fa-solid fa-apple-whole"></i> –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
    <input id="reg-email" placeholder="Email"><br>
    <input id="reg-password" type="password" placeholder="–ü–∞—Ä–æ–ª—å"><br>
    <input id="reg-username" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"><br>
    <button onclick="signUp()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
    <button class="secondary" style="margin-top:12px;" onclick="showLogin()">–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞–∑–∞–¥</button>
  </div>
</div>

<div id="main-screen" class="screen">
  <nav>
    <div id="nav-self-avatar-container" onclick="openSettings()" style="cursor:pointer"></div>
    <h2>–Ø–±–ª–æ—á–∫–æ</h2>
    <div id="main-nav-buttons" style="margin-left:auto;display:flex;gap:12px;">
      <button onclick="openSearch()" style="background:none;padding:8px;color:var(--primary);"><i class="fa fa-plus-circle" style="font-size:22px"></i></button>
    </div>
  </nav>
  <div class="chat-list" id="chat-list"></div>
</div>

<div id="search-screen" class="screen">
  <nav><button onclick="backToMain()" style="background:none;color:var(--primary);"><i class="fa fa-chevron-left"></i></button><h2>–ü–æ–∏—Å–∫</h2></nav>
  <div style="padding:24px">
    <input id="search-username" placeholder="–í–≤–µ–¥–∏—Ç–µ username" style="width:100%"><br><br>
    <button onclick="searchUser()" style="width:100%"><i class="fa fa-paper-plane"></i> –ù–∞–π—Ç–∏ –∏ –Ω–∞–ø–∏—Å–∞—Ç—å</button>
  </div>
</div>

<div id="chat-screen" class="screen">
  <nav style="gap:10px;">
    <button onclick="backToMain()" style="background:none;padding:0;width:30px;color:var(--primary);"><i class="fa fa-chevron-left"></i></button>
    <div id="chat-avatar-container" onclick="openUserProfile()"></div>
    <div class="header-info" onclick="openUserProfile()" style="flex:1;overflow:hidden;">
      <h2 id="chat-username" style="margin:0;font-size:16px;color:var(--text-main);"></h2>
      <div style="display:flex;align-items:center;gap:8px;">
        <div id="chat-status" style="color:var(--text-dim);font-size:11px;"></div>
        <div id="typing-status" style="color:var(--primary);font-size:11px;font-style:italic;"></div>
      </div>
    </div>
    <a id="call-link" target="_blank"><button class="call-btn" style="background:none;padding:8px;"><i class="fa fa-phone" style="color:var(--primary);font-size:18px;"></i></button></a>
  </nav>
  
  <div class="messages" id="messages"></div>
  
  <div id="preview"></div>
  <div id="reply-preview-container" style="padding:0 12px;display:none;">
    <div style="display:flex;align-items:center;background:var(--bg-card);padding:10px;border-radius:12px;margin-bottom:8px;border-left:4px solid var(--primary);">
      <div style="flex:1;font-size:13px;"><strong id="reply-username" style="color:var(--primary);display:block;"></strong><span id="reply-text" style="opacity:0.8"></span></div>
      <div onclick="cancelReply()" style="padding:8px;cursor:pointer;color:var(--primary);"><i class="fa fa-times"></i></div>
    </div>
  </div>
  
  <div class="input-box">
    <div class="input-row">
      <button class="img-btn" onclick="triggerImageUpload()"><i class="fa fa-camera"></i></button>
      <textarea id="msg-input" placeholder="–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." rows="1"></textarea>
      <button class="send-btn" onclick="sendMessage()"><i class="fa fa-apple-whole"></i></button>
    </div>
  </div>
  <div id="scroll-down-btn" onclick="scrollToBottom(true)"><i class="fa fa-chevron-down"></i></div>
</div>

<div id="settings-screen" class="screen">
  <nav><button onclick="backToMain()" style="background:none;color:var(--primary);"><i class="fa fa-chevron-left"></i></button><h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2></nav>
  <div style="padding:24px;text-align:center;display:flex;flex-direction:column;align-items:center;overflow-y:auto;">
    <div id="settings-avatar-container" style="margin-bottom:16px;position:relative;"></div>
    <button onclick="triggerAvatarUpload()" style="font-size:13px;padding:8px 16px;"><i class="fa fa-image"></i> –û–±–Ω–æ–≤–∏—Ç—å —Ñ–æ—Ç–æ</button>
    <button onclick="deleteAvatar()" style="background:transparent;color:var(--primary);font-size:13px;display:none;margin-top:8px;" id="delete-avatar-btn">–£–¥–∞–ª–∏—Ç—å</button>
    
    <div id="profile-info" style="margin:25px 0;text-align:left;width:100%;background:var(--glass);padding:20px;border-radius:20px;border:1px solid var(--dark-red);"></div>
    
    <button onclick="logout()" style="width:100%;background:var(--dark-red);"><i class="fa fa-sign-out"></i> –í—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã</button>
    <button onclick="deleteAccount()" style="width:100%;background:transparent;color:var(--primary);border:1px solid var(--primary);margin-top:12px;">–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
  </div>
</div>

<div id="admin-screen" class="screen">
  <nav><button onclick="backToMain()" style="background:none;color:var(--primary);"><i class="fa fa-chevron-left"></i></button><h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h2></nav>
  <div id="user-list" style="flex:1;overflow-y:auto;padding:12px;"></div>
</div>

<div id="context-menu" class="context-menu"></div>
<input type="file" id="file-input" style="display:none;" accept="image/*">
<input type="file" id="avatar-input" style="display:none;" accept="image/*">

<div id="link-confirm-modal" class="modal-overlay">
  <div class="modal-box">
    <h3 style="color:var(--primary)">–í–Ω–µ—à–Ω—è—è —Å—Å—ã–ª–∫–∞</h3>
    <p>–í—ã —Ö–æ—Ç–∏—Ç–µ –ø–æ–∫–∏–Ω—É—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ –ø–µ—Ä–µ–π—Ç–∏ –ø–æ —Å—Å—ã–ª–∫–µ?<br><br><b id="link-target" style="color:var(--accent);word-break:break-all;"></b></p>
    <div style="display:flex;gap:10px;margin-top:20px;">
      <button class="secondary" style="flex:1" onclick="closeLinkModal()">–û—Ç–º–µ–Ω–∞</button>
      <button style="flex:1" onclick="confirmLinkGo()">–ü–µ—Ä–µ–π—Ç–∏</button>
    </div>
  </div>
</div>

<div id="view-profile-modal" class="modal-overlay" onclick="if(event.target===this) closeUserProfile()">
  <div class="modal-box" style="position:relative;padding-top:40px;text-align:center;">
    <button onclick="closeUserProfile()" style="position:absolute;top:10px;right:10px;background:none;font-size:24px;color:var(--primary);"><i class="fa fa-times-circle"></i></button>
    <div id="view-profile-avatar-container" style="display:flex;justify-content:center;margin-bottom:15px;"></div>
    <h2 id="view-profile-name" style="margin-bottom:8px;color:var(--primary)"></h2>
    <div id="view-profile-status-badge" style="display:inline-block;padding:5px 15px;border-radius:20px;font-size:12px;background:var(--glass);"></div>
  </div>
</div>

<script>
/* ------------------ –í–µ—Å—å JS –æ—Å—Ç–∞–µ—Ç—Å—è –ø—Ä–µ–∂–Ω–∏–º, —Ç–æ–ª—å–∫–æ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –º–µ–ª–∫–∏–µ –¥–µ—Ç–∞–ª–∏ –±—Ä–µ–Ω–¥–∏–Ω–≥–∞ ------------------ */
const sb = window.supabase.createClient(
  "https://zmewwzlzujsrhstjehrp.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InptZXd3emx6dWpzcmhzdGplaHJwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5NjM4MDksImV4cCI6MjA3MTUzOTgwOX0.kBBXwlCEl5szgK4vKgaPBhPOVYmoFzly2TXR-fI8D24"
);
uploadcare.start({ publicKey:"c12f2c3e134f56024db8" });

window.OneSignalDeferred = window.OneSignalDeferred || [];
OneSignalDeferred.push(async function(OneSignal) {
  await OneSignal.init({
    appId: "2e324874-a45f-4a70-ac36-130ef8af56a7",
    safari_web_id: "web.onesignal.auto.0d123f70-12e5-49b1-a758-f1abcc853120",
    notifyButton: { enable: false },
  });
});

/* –û—Å—Ç–∞–ª—å–Ω–æ–π JS —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –∏–∑ –≤–∞—à–µ–≥–æ –∫–æ–¥–∞ (Auth, Chat, Render –∏ —Ç.–¥.) */
/* –Ø —Å–æ—Ö—Ä–∞–Ω–∏–ª –≤—Å—é –ª–æ–≥–∏–∫—É —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä—É—é –≤—ã –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏–ª–∏ */

let currentUser = null, currentChat = null, currentChatOtherId = null, msgSubscription = null, chatSubscription = null, profileSubscription = null, selectedMessageId = null, selectedSender = null, selectedImageUrl = null, replyToMessage = null, selfChatId = null, loadedMessages = [], oldestMessageId = null, loadingMore = false, isAdmin = false, pendingLink = "";

function getAvatarColor(name) {
    const colors = ['#ff3b30', '#d81b60', '#8e24aa', '#5e35b1', '#e53935', '#b71c1c', '#ff5252', '#ff1744'];
    let hash = 0;
    for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
    return colors[Math.abs(hash) % colors.length];
}

function renderAvatarHTML(url, name, size) {
    if (url) return `<img src="${url}" style="width:${size}px;height:${size}px;border-radius:50%;object-fit:cover;background:#2d0505;">`;
    const letter = (name && name.length > 0) ? name[0].toUpperCase() : 'Ô£ø';
    const color = getAvatarColor(name || 'User');
    return `<div class="gen-avatar" style="width:${size}px;height:${size}px;background:${color};font-size:${size/2.2}px;">${letter}</div>`;
}

function showScreen(id){ document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
function showLogin(){ showScreen('login-screen'); }
function showRegister(){ showScreen('register-screen'); }
function showMain(){ loadChats(); showScreen('main-screen'); updateSelfAvatar(); }
function openSettings(){ loadProfile(); showScreen('settings-screen'); }
function openSearch(){ showScreen('search-screen'); }
function openAdmin(){ loadUsers(); showScreen('admin-screen'); }

async function updateSelfAvatar(){
    if(!currentUser) return;
    const { data } = await sb.from('profiles').select('avatar_url,username').eq('id', currentUser.id).single();
    if(data) document.getElementById('nav-self-avatar-container').innerHTML = renderAvatarHTML(data.avatar_url, data.username, 40);
}

function linkify(text) {
    let safeText = escapeHtml(text).innerHTML; 
    const urlPattern = /(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim;
    return safeText.replace(urlPattern, '<a style="color:var(--primary);text-decoration:underline;cursor:pointer;" onclick="confirmLink(\'$1\')">$1</a>');
}
function confirmLink(url) { pendingLink = url; document.getElementById('link-target').innerText = url; document.getElementById('link-confirm-modal').style.display = 'flex'; }
function closeLinkModal() { document.getElementById('link-confirm-modal').style.display = 'none'; }
function confirmLinkGo() { if(pendingLink) window.open(pendingLink, '_blank'); closeLinkModal(); }

async function openUserProfile() {
    if(!currentChatOtherId) return;
    document.getElementById('view-profile-modal').style.display = 'flex';
    const { data: p } = await sb.from('profiles').select('*').eq('id', currentChatOtherId).single();
    if(!p) return;
    document.getElementById('view-profile-name').innerText = p.username;
    const badge = document.getElementById('view-profile-status-badge');
    badge.innerText = p.status === '–æ–Ω–ª–∞–π–Ω' ? '–í —Å–µ—Ç–∏' : (p.status || '–ù–µ –≤ —Å–µ—Ç–∏');
    badge.style.color = p.status === '–æ–Ω–ª–∞–π–Ω' ? '#4caf50' : '#ff9999';
    document.getElementById('view-profile-avatar-container').innerHTML = renderAvatarHTML(p.avatar_url, p.username, 100);
}
function closeUserProfile() { document.getElementById('view-profile-modal').style.display = 'none'; }

async function signUp(){
  const email = document.getElementById('reg-email').value.trim();
  const password = document.getElementById('reg-password').value;
  const username = document.getElementById('reg-username').value.trim();
  if(!email || !password || !username){ alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è'); return; }
  const { data, error } = await sb.auth.signUp({ email, password, options: { data: { username } } });
  if(error){ alert(error.message); return; }
  await sb.from('profiles').insert([{ id: data.user.id, email, username, status:'–æ–Ω–ª–∞–π–Ω', typing:false, current_chat:null, ban: false }]);
  alert('–ì–æ—Ç–æ–≤–æ! –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏—Ç–µ'); showLogin();
}

async function signIn(){
  const email = document.getElementById('login-email').value.trim();
  const password = document.getElementById('login-password').value;
  if(!email || !password){ alert('–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ'); return; }
  const { data, error } = await sb.auth.signInWithPassword({ email, password });
  if(error){ alert(error.message); return; }
  currentUser = data.user;
  const { data: profile } = await sb.from('profiles').select('*').eq('id', currentUser.id).single();
  if (profile.ban) { await sb.auth.signOut(); alert('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω'); return; }
  isAdmin = profile.email === 'timtimych18@mail.ru';
  if (isAdmin) document.getElementById('main-nav-buttons').innerHTML = `<button onclick="openAdmin()" style="background:none;padding:6px;color:var(--primary);"><i class="fa fa-shield-halved"></i></button>` + document.getElementById('main-nav-buttons').innerHTML;
  await sb.from('profiles').update({ status:'–æ–Ω–ª–∞–π–Ω', current_chat:null }).eq('id', currentUser.id);
  showMain(); subscribeChats(); subscribeProfile();
}

async function logout(){
  if(currentUser){
    await sb.from('profiles').update({ status:`–±—ã–ª(–∞) –Ω–µ–¥–∞–≤–Ω–æ`, typing:false, current_chat:null }).eq('id', currentUser.id);
    await sb.auth.signOut(); currentUser = null;
  }
  showLogin();
}

async function loadProfile(){
  if(!currentUser) return;
  const { data } = await sb.from('profiles').select('*').eq('id', currentUser.id).single();
  document.getElementById('profile-info').innerHTML = `
    <div style="margin-bottom:12px;font-size:14px;"><span style="color:var(--text-dim)">–Æ–∑–µ—Ä–Ω–µ–π–º:</span> <b style="margin-left:5px">@${data.username}</b></div>
    <div style="margin-bottom:0px;font-size:14px;"><span style="color:var(--text-dim)">–ü–æ—á—Ç–∞:</span> <b style="margin-left:5px">${data.email}</b></div>
  `;
  document.getElementById('settings-avatar-container').innerHTML = renderAvatarHTML(data.avatar_url, data.username, 110);
  document.getElementById('delete-avatar-btn').style.display = data.avatar_url ? 'inline-block' : 'none';
}

function triggerAvatarUpload(){ document.getElementById('avatar-input').click(); }
document.getElementById('avatar-input').addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  uploadcare.fileFrom('object', file).done(async (info) => {
    await sb.from('profiles').update({ avatar_url: info.cdnUrl }).eq('id', currentUser.id);
    loadProfile(); updateSelfAvatar();
  });
});

async function searchUser(){
  const input = document.getElementById('search-username').value.trim();
  const { data:userProfile } = await sb.from('profiles').select('id,username').ilike('username', input).limit(1).maybeSingle();
  if(!userProfile){ alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω'); return; }
  const { data:existing } = await sb.from('chats').select('id').or(`and(user1.eq.${currentUser.id},user2.eq.${userProfile.id}),and(user1.eq.${userProfile.id},user2.eq.${currentUser.id})`).limit(1);
  let chatId = existing?.length ? existing[0].id : (await sb.from('chats').insert([{ user1:currentUser.id, user2:userProfile.id }]).select('id').single()).data.id;
  openChat(chatId, userProfile.username, userProfile.id);
}

async function loadChats(){
  if(!currentUser) return;
  const list = document.getElementById('chat-list');
  const { data:chats } = await sb.from('chats').select('*').or(`user1.eq.${currentUser.id},user2.eq.${currentUser.id}`);
  if(!chats) return;
  const promises = chats.map(async chat => {
    const otherId = (chat.user1 === currentUser.id) ? chat.user2 : chat.user1;
    const { data:p } = await sb.from('profiles').select('username,avatar_url').eq('id', otherId).single();
    const { data:m } = await sb.from('messages').select('content,image_url,created_at').eq('chat_id', chat.id).order('created_at',{ascending:false}).limit(1);
    const { count } = await sb.from('messages').select('id', { count: 'exact', head: true }).eq('chat_id', chat.id).eq('read', false).neq('sender', currentUser.id);
    return { chatId: chat.id, otherId, name: p?.username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', avatar: p?.avatar_url, last: m?.[0]?.image_url ? 'üñº –§–æ—Ç–æ' : (m?.[0]?.content || ''), time: m?.[0]?.created_at || 0, unread: count || 0 };
  });
  const chatData = (await Promise.all(promises)).sort((a,b)=> new Date(b.time) - new Date(a.time));
  list.innerHTML = '';
  chatData.forEach(c => {
    const div = document.createElement('div'); div.className='chat-item';
    div.innerHTML = `${renderAvatarHTML(c.avatar, c.name, 52)}<div class="info"><b>${c.name}</b><div class="last">${c.last}</div></div>${c.unread ? `<div class="unread-badge">${c.unread}</div>` : ''}`;
    div.onclick = ()=> openChat(c.chatId, c.name, c.otherId, c.avatar);
    list.appendChild(div);
  });
}

function subscribeChats(){
  if(chatSubscription) sb.removeChannel(chatSubscription);
  chatSubscription = sb.channel('global').on('postgres_changes', { event:'*', schema:'public', table:'messages' }, loadChats).subscribe();
}

function subscribeProfile(){
  if(profileSubscription) sb.removeChannel(profileSubscription);
  profileSubscription = sb.channel('profile-'+currentUser.id).on('postgres_changes', { event:'UPDATE', schema:'public', table:'profiles', filter:`id=eq.${currentUser.id}` }, p => {
      if (p.new.ban) { sb.auth.signOut(); location.reload(); }
  }).subscribe();
}

async function openChat(chatId, otherName, otherId, otherAvatarUrl = null){
  currentChat = chatId; currentChatOtherId = otherId;
  document.getElementById('chat-username').innerText = otherName;
  document.getElementById('chat-avatar-container').innerHTML = renderAvatarHTML(otherAvatarUrl, otherName, 40);
  document.getElementById('call-link').href = `https://super-random.netlify.app/zvonok2?chat_id=${chatId}`;
  showScreen('chat-screen');
  loadedMessages = []; oldestMessageId = null; await loadMessages(true);
  if(msgSubscription) sb.removeChannel(msgSubscription);
  msgSubscription = sb.channel('room-'+chatId).on('postgres_changes', { event:'INSERT', schema:'public', table:'messages', filter:`chat_id=eq.${chatId}` }, payload => {
       renderMessage(payload.new, true, 'append');
       if(payload.new.sender !== currentUser.id) sb.from('messages').update({ read: true }).eq('id', payload.new.id);
  }).on('postgres_changes', { event:'UPDATE', schema:'public', table:'messages', filter:`chat_id=eq.${chatId}` }, payload => {
       const msgEl = document.getElementById('msg-'+payload.new.id);
       if(msgEl && payload.new.read) { const ticks = msgEl.querySelector('.ticks'); if(ticks) ticks.className = 'fa fa-check-double ticks'; }
       if(payload.new.is_deleted && msgEl) { msgEl.className = 'msg deleted'; msgEl.innerHTML = '–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ'; }
  }).subscribe();
  await sb.from('messages').update({ read:true }).eq('chat_id', chatId).neq('sender', currentUser.id).eq('read', false);
}

async function loadMessages(initial = false){
  if(!currentChat) return;
  let query = sb.from('messages').select('*').eq('chat_id', currentChat);
  if (!initial) query = query.lt('id', oldestMessageId);
  const { data } = await query.order('created_at', {ascending: false}).limit(40);
  if (!data) return;
  const messages = data.reverse();
  if (messages.length > 0) oldestMessageId = messages[0].id;
  const box = document.getElementById('messages');
  if (initial) box.innerHTML = '';
  messages.forEach(msg => renderMessage(msg, false, initial ? 'append' : 'prepend'));
  if (initial) scrollToBottom(true);
}

function scrollToBottom(force=false) { 
    const box = document.getElementById('messages');
    setTimeout(() => { box.scrollTop = box.scrollHeight; }, 50);
}

function renderMessage(msg, scroll=true, mode='append'){
  const box = document.getElementById('messages');
  if(document.getElementById('msg-'+msg.id)) return;
  const isMe = msg.sender === currentUser.id;
  const div = document.createElement('div');
  div.id = 'msg-'+msg.id; div.className = 'msg ' + (isMe ? 'me' : 'other');
  div.oncontextmenu = (e)=>{ e.preventDefault(); showContextMenu(e, msg.id, msg.sender, msg.image_url); };
  if(msg.is_deleted){ div.className='msg deleted'; div.innerText='–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ'; } 
  else {
      let html = '';
      if(msg.reply_to) html += `<div style="background:rgba(0,0,0,0.1);padding:5px;border-radius:8px;font-size:12px;margin-bottom:5px;border-left:2px solid #fff;">–û—Ç–≤–µ—Ç...</div>`;
      if(msg.content) html += `<div>${linkify(msg.content)}</div>`;
      if(msg.image_url) html += `<img src="${msg.image_url}" style="width:100%;border-radius:10px;margin-top:5px;" onload="scrollToBottom()">`;
      html += `<span class="time">${new Date(msg.created_at).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})} ${isMe ? (msg.read ? '<i class="fa fa-check-double ticks"></i>' : '<i class="fa fa-check ticks"></i>') : ''}</span>`;
      div.innerHTML = html;
  }
  if (mode === 'prepend') box.insertBefore(div, box.firstChild); else box.appendChild(div);
  if(scroll) scrollToBottom(true);
}

async function sendMessage(){
  const text = document.getElementById('msg-input').value.trim();
  if(!text && !selectedImageUrl) return;
  const { data } = await sb.from('messages').insert([{ chat_id: currentChat, sender: currentUser.id, content: text || null, image_url: selectedImageUrl || null, reply_to: replyToMessage?.id || null }]).select('*').single();
  document.getElementById('msg-input').value = ''; selectedImageUrl = null; replyToMessage = null;
  document.getElementById('preview').innerHTML = ''; document.getElementById('reply-preview-container').style.display = 'none';
}

function triggerImageUpload(){ document.getElementById('file-input').click(); }
document.getElementById('file-input').addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;
  uploadcare.fileFrom('object', file).done(info => {
    selectedImageUrl = info.cdnUrl;
    document.getElementById('preview').innerHTML = `<img src="${selectedImageUrl}" style="max-height:80px;border-radius:10px;margin:10px;border:2px solid var(--primary)">`;
  });
});

function showContextMenu(e, msgId, senderId, imageUrl){
  selectedMessageId = msgId; selectedSender = senderId;
  const menu = document.getElementById('context-menu');
  menu.innerHTML = `<button onclick="copyMessage()"><i class="fa fa-copy"></i> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button><button onclick="replyMessage()"><i class="fa fa-reply"></i> –û—Ç–≤–µ—Ç–∏—Ç—å</button>`;
  if(senderId === currentUser.id) menu.innerHTML += `<button onclick="confirmDelete()"><i class="fa fa-trash"></i> –£–¥–∞–ª–∏—Ç—å</button>`;
  let x = e.pageX, y = e.pageY;
  menu.style.left = x + 'px'; menu.style.top = y + 'px'; menu.style.display = 'flex';
}

function copyMessage(){
    const text = document.getElementById('msg-'+selectedMessageId).innerText;
    navigator.clipboard.writeText(text); hideContext();
}
async function confirmDelete(){
    await sb.from('messages').update({ is_deleted: true }).eq('id', selectedMessageId);
    hideContext();
}
function replyMessage(){
    replyToMessage = { id: selectedMessageId };
    document.getElementById('reply-preview-container').style.display='block';
    document.getElementById('reply-username').innerText = "–û—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ";
    document.getElementById('reply-text').innerText = "...";
    hideContext();
}
function hideContext(){ document.getElementById('context-menu').style.display='none'; }
function escapeHtml(text){ const d = document.createElement('div'); d.textContent = text; return d; }

function backToMain(){
  if(msgSubscription) sb.removeChannel(msgSubscription);
  currentChat = null; showMain();
}

window.onclick = (e) => { if(!e.target.closest('.msg')) hideContext(); };
window.onload = async () => {
    const { data:{ session } } = await sb.auth.getSession();
    if(session) { currentUser = session.user; signIn(); }
}
</script>
</body>
</html>