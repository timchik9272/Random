<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Remote Control WebRTC</title>
    <style>
        body { font-family: sans-serif; background: #222; color: #fff; margin: 0; padding: 0; display: flex; flex-direction: column; align-items: center; }
        
        /* –í–∏–¥–µ–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
        #media { position: relative; width: 100%; max-width: 1280px; border-bottom: 2px solid #444; cursor: crosshair; }
        video { width: 100%; display: block; background: #000; }
        
        /* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        .controls { padding: 10px; width: 100%; max-width: 600px; box-sizing: border-box; }
        
        /* –°–µ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ */
        .grid-keys { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .grid-arrows { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; max-width: 200px; margin: 0 auto 20px auto; }
        
        button { padding: 15px; font-size: 16px; background: #444; color: white; border: none; border-radius: 8px; active: background: #666; cursor: pointer; touch-action: manipulation; }
        button:active { background: #007bff; }
        
        .input-group { display: flex; gap: 10px; margin-bottom: 20px; }
        input { flex: 1; padding: 10px; border-radius: 5px; border: none; }
        
        .status { margin-top: 10px; color: #aaa; font-size: 12px; }
    </style>
</head>
<body>

<div id="media">
    <video id="video" autoplay playsinline muted></video>
</div>

<div class="controls">
    <div class="input-group">
        <input type="text" id="TextInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç (RU/EN)...">
        <button onclick="sendText()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>

    <div class="grid-arrows">
        <div></div>
        <button onclick="sendKey('up')">‚¨ÜÔ∏è</button>
        <div></div>
        <button onclick="sendKey('left')">‚¨ÖÔ∏è</button>
        <button onclick="sendKey('down')">‚¨áÔ∏è</button>
        <button onclick="sendKey('right')">‚û°Ô∏è</button>
    </div>

    <div class="grid-keys">
        <button onclick="sendKey('enter')">Enter</button>
        <button onclick="sendKey('backspace')">Bksp</button>
        <button onclick="sendKey('space')">Space</button>
        <button onclick="sendKey('esc')">Esc</button>
        <button onclick="sendKey('tab')">Tab</button>
        <button onclick="sendKey('win')">Win</button>
        <button style="background:#007bff" onclick="sendClick()">CLICK</button>
    </div>

    <button onclick="start()" style="width:100%; background: #28a745; margin-top:10px;">üî¥ –ü–û–î–ö–õ–Æ–ß–ò–¢–¨–°–Ø (START)</button>
    <div class="status" id="status">–û—Ç–∫–ª—é—á–µ–Ω–æ</div>
</div>

<script>
    const pc = new RTCPeerConnection();
    const videoEl = document.getElementById('video');

    // 1. –ó–∞–ø—É—Å–∫ WebRTC
    async function start() {
        document.getElementById('status').innerText = "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...";
        
        // –ü–æ–ª—É—á–∞–µ–º –≤–∏–¥–µ–æ —Ç—Ä–µ–∫–∏
        pc.addTransceiver('video', {direction: 'recvonly'});
        
        // –°–æ–∑–¥–∞–µ–º offer
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);

        // –ñ–¥–µ–º –ø–æ–∫–∞ —Å–æ–±–µ—Ä—É—Ç—Å—è ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã
        await new Promise((resolve) => {
            if (pc.iceGatheringState === 'complete') {
                resolve();
            } else {
                const checkState = () => {
                    if (pc.iceGatheringState === 'complete') {
                        pc.removeEventListener('icegatheringstatechange', checkState);
                        resolve();
                    }
                };
                pc.addEventListener('icegatheringstatechange', checkState);
            }
        });

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º offer –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        const response = await fetch('/offer', {
            method: 'POST',
            body: JSON.stringify({
                sdp: pc.localDescription.sdp,
                type: pc.localDescription.type,
            }),
            headers: {'Content-Type': 'application/json'}
        });

        // –ü–æ–ª—É—á–∞–µ–º answer
        const answer = await response.json();
        await pc.setRemoteDescription(answer);
        document.getElementById('status').innerText = "–ü–æ–¥–∫–ª—é—á–µ–Ω–æ! –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –≤–∏–¥–µ–æ –¥–ª—è –∫–ª–∏–∫–∞.";
    }

    // –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–æ—Ç–æ–∫–∞ ‚Äî –≤—Å—Ç–∞–≤–ª—è–µ–º –≤ <video>
    pc.ontrack = function(evt) {
        if (evt.track.kind === 'video') {
            videoEl.srcObject = evt.streams[0];
        }
    };

    // 2. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ú–´–®–¨–Æ
    // –õ–æ–≥–∏–∫–∞: –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –≤–∏–¥–µ–æ, –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–æ—Ä–º–∞–ª–∏–∑—É—é—Ç—Å—è (0.0 - 1.0) –∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —Å–µ—Ä–≤–µ—Ä—É
    videoEl.addEventListener('click', (e) => {
        const rect = videoEl.getBoundingClientRect();
        const x = (e.clientX - rect.left) / rect.width;
        const y = (e.clientY - rect.top) / rect.height;
        
        // –°–Ω–∞—á–∞–ª–∞ –¥–≤–∏–≥–∞–µ–º
        fetch('/control', {
            method: 'POST',
            body: JSON.stringify({ type: 'mousemove', x: x, y: y }),
            headers: {'Content-Type': 'application/json'}
        });
        
        // –ü–æ—Ç–æ–º –∫–ª–∏–∫–∞–µ–º (—á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É, —á—Ç–æ–±—ã –º—ã—à—å —É—Å–ø–µ–ª–∞ –¥–æ–µ—Ö–∞—Ç—å)
        setTimeout(() => {
            fetch('/control', {
                method: 'POST',
                body: JSON.stringify({ type: 'click' }),
                headers: {'Content-Type': 'application/json'}
            });
        }, 100);
    });

    // 3. –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–ª–∞–≤–∏—à
    function sendKey(keyName) {
        fetch('/control', {
            method: 'POST',
            body: JSON.stringify({ type: 'keypress', key: keyName }),
            headers: {'Content-Type': 'application/json'}
        });
    }

    function sendClick() {
        fetch('/control', {
            method: 'POST',
            body: JSON.stringify({ type: 'click' }),
            headers: {'Content-Type': 'application/json'}
        });
    }

    // 4. –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞
    function sendText() {
        const text = document.getElementById('TextInput').value;
        if (!text) return;
        fetch('/control', {
            method: 'POST',
            body: JSON.stringify({ type: 'text', text: text }),
            headers: {'Content-Type': 'application/json'}
        });
        document.getElementById('TextInput').value = '';
    }
</script>

</body>
</html>
