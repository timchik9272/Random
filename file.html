<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>P2P Transfer Clean</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    :root {
      --bg: #0a0a0a;
      --card-bg: #141414;
      --accent: #00e5ff;
      --text-main: #ffffff;
      --text-muted: #888888;
      --border: #2a2a2a;
      --radius: 12px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
    
    body {
      background: var(--bg);
      color: var(--text-main);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }

    /* –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ô–ù–ï–† (–§–∏–∫—Å–∏—Ä—É–µ–º —à–∏—Ä–∏–Ω—É, —á—Ç–æ–±—ã –Ω–µ —Ä–∞–∑—ä–µ–∑–∂–∞–ª–æ—Å—å) */
    .app-shell {
      width: 100%;
      max-width: 420px; /* –û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –¥–ª—è "—É—Ç–∏–ª–∏—Ç—ã" */
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      display: flex;
      flex-direction: column;
      gap: 20px;
      overflow: hidden; /* –û–±—Ä–µ–∑–∞–µ–º –≤—Å—ë, —á—Ç–æ –ø—ã—Ç–∞–µ—Ç—Å—è –≤—ã–ª–µ–∑—Ç–∏ */
    }

    h1 { font-size: 14px; text-transform: uppercase; color: var(--text-muted); text-align: center; letter-spacing: 2px; margin-bottom: 10px; }

    /* –í–í–û–î –ö–û–î–ê */
    .code-display {
      font-size: 48px; font-family: 'Courier New', monospace; 
      color: var(--accent); text-align: center; font-weight: bold;
      margin: 10px 0; letter-spacing: 4px; cursor: pointer;
    }

    input.input-code {
      width: 100%; background: #000; border: 1px solid var(--border);
      border-radius: var(--radius); color: #fff; font-size: 32px;
      text-align: center; padding: 15px; font-family: monospace;
      transition: border 0.2s;
    }
    input.input-code:focus { border-color: var(--accent); }

    /* –ö–ù–û–ü–ö–ò */
    .btn {
      width: 100%; padding: 16px; border-radius: var(--radius); border: none;
      font-size: 15px; font-weight: 600; cursor: pointer; transition: 0.2s;
      display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    .btn-primary { background: var(--accent); color: #000; }
    .btn-primary:active { opacity: 0.8; transform: scale(0.98); }
    
    .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-muted); }
    .btn-outline:hover { border-color: #555; color: #fff; }

    /* –ö–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞ - –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–∞—è */
    .btn-exit { 
      background: #222; color: #ccc; margin-top: 10px; 
      border: 1px solid transparent;
    }
    .btn-exit:hover { background: #333; color: #fff; border-color: #444; }

    /* –†–ê–ë–û–ß–ê–Ø –ó–û–ù–ê */
    #workspace { display: none; flex-direction: column; gap: 15px; }

    textarea {
      width: 100%; height: 80px; background: #080808; border: 1px solid var(--border);
      border-radius: var(--radius); color: #ddd; padding: 12px; resize: none; font-size: 14px;
    }
    textarea:focus { border-color: #444; }

    /* DROP ZONE */
    .drop-zone {
      border: 2px dashed #333; border-radius: var(--radius); padding: 25px;
      text-align: center; cursor: pointer; transition: 0.2s; background: rgba(255,255,255,0.02);
    }
    .drop-zone:hover, .drop-zone.active { border-color: var(--accent); background: rgba(0, 229, 255, 0.05); }
    .drop-zone i { font-size: 24px; color: var(--text-muted); margin-bottom: 8px; display: block; }
    .drop-zone p { font-size: 13px; color: var(--text-muted); }

    /* –°–ü–ò–°–û–ö –§–ê–ô–õ–û–í (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—ã–ª–µ–∑–∞–Ω–∏—è) */
    .file-list { display: flex; flex-direction: column; gap: 8px; max-height: 300px; overflow-y: auto; }
    
    .file-card {
      background: #1a1a1a; padding: 10px 14px; border-radius: 8px;
      border: 1px solid #2a2a2a; display: flex; flex-direction: column; gap: 6px;
    }
    
    .file-header { display: flex; justify-content: space-between; align-items: center; overflow: hidden; }
    
    /* –û–±—Ä–µ–∑–∞–µ–º –¥–ª–∏–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç */
    .file-name { 
      font-size: 13px; white-space: nowrap; overflow: hidden; 
      text-overflow: ellipsis; max-width: 75%; color: #eee;
    }
    
    .file-btn { color: var(--accent); text-decoration: none; font-size: 14px; }
    
    .progress-track { width: 100%; height: 4px; background: #333; border-radius: 2px; overflow: hidden; }
    .progress-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.2s linear; }

  </style>
</head>
<body>

  <div class="app-shell">
    <h1>P2P Transfer</h1>

    <div id="screen-login">
      <button class="btn btn-primary" onclick="createRoom()">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
      
      <div style="display: flex; align-items: center; gap: 10px; margin: 20px 0;">
        <div style="height: 1px; background: #333; flex: 1;"></div>
        <span style="font-size: 12px; color: #555;">–ò–õ–ò –í–í–ï–î–ò–¢–ï –ö–û–î</span>
        <div style="height: 1px; background: #333; flex: 1;"></div>
      </div>

      <input type="number" id="input-room" class="input-code" placeholder="00000" oninput="if(value.length>5)value=value.slice(0,5)">
      <button class="btn btn-outline" onclick="joinRoom()" style="margin-top: 15px;">–í–æ–π—Ç–∏</button>
    </div>

    <div id="screen-wait" style="display: none; text-align: center;">
      <p style="color: #666; font-size: 13px;">–°–æ–æ–±—â–∏—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É:</p>
      <div class="code-display" id="display-code" onclick="copyCode()">-----</div>
      <p id="status-msg" style="color: var(--accent); font-size: 12px; margin-bottom: 20px;">–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...</p>
      <button class="btn btn-exit" onclick="location.reload()">–û—Ç–º–µ–Ω–∞</button>
    </div>

    <div id="workspace">
      <textarea id="text-buffer" placeholder="–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏..." oninput="sendText()"></textarea>

      <div class="drop-zone" id="drop-zone">
        <i class="fa fa-cloud-upload-alt"></i>
        <p>–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤</p>
        <input type="file" id="file-input" multiple style="display: none;">
      </div>

      <div id="file-list" class="file-list"></div>

      <button class="btn btn-exit" onclick="terminateSession()">
        <i class="fa fa-power-off"></i> –ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–µ–∞–Ω—Å
      </button>
    </div>
  </div>

  <script>
    const supabaseClient = supabase.createClient(
      "https://zmewwzlzujsrhstjehrp.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InptZXd3emx6dWpzcmhzdGplaHJwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5NjM4MDksImV4cCI6MjA3MTUzOTgwOX0.kBBXwlCEl5szgK4vKgaPBhPOVYmoFzly2TXR-fI8D24"
    );

    let pc, dc, channel, roomId, isOfferer;
    const servers = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
    let activeFiles = {};

    // --- –ù–ê–í–ò–ì–ê–¶–ò–Ø ---
    function showScreen(id) {
      ['screen-login', 'screen-wait', 'workspace'].forEach(s => document.getElementById(s).style.display = 'none');
      document.getElementById(id).style.display = (id === 'workspace') ? 'flex' : 'block';
    }

    function createRoom() {
      roomId = Math.floor(10000 + Math.random() * 90000).toString();
      isOfferer = true;
      document.getElementById('display-code').innerText = roomId;
      showScreen('screen-wait');
      initSignaling();
    }

    function joinRoom() {
      roomId = document.getElementById('input-room').value;
      if (roomId.length !== 5) return;
      isOfferer = false;
      document.getElementById('display-code').innerText = roomId;
      document.getElementById('status-msg').innerText = "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...";
      showScreen('screen-wait');
      initSignaling();
    }

    function copyCode() {
      navigator.clipboard.writeText(roomId);
      // –í–∏–∑—É–∞–ª—å–Ω—ã–π –æ—Ç–∫–ª–∏–∫ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å, –Ω–æ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ
    }

    // --- LOGIC ---
    async function initSignaling() {
      channel = supabaseClient.channel(`room_${roomId}`);
      channel.on('broadcast', { event: 'signal' }, ({ payload }) => handleSignal(payload))
             .subscribe(status => {
               if (status === 'SUBSCRIBED' && !isOfferer) sendSignal({ type: 'ready' });
             });
    }

    async function sendSignal(payload) { await channel.send({ type: 'broadcast', event: 'signal', payload }); }

    function handleSignal(sig) {
      if (sig.type === 'ready' && isOfferer) startWebRTC();
      if (sig.type === 'bye') location.reload();
      if (sig.type === 'offer') {
        startWebRTC();
        pc.setRemoteDescription(new RTCSessionDescription(sig.sdp));
        pc.createAnswer().then(a => { pc.setLocalDescription(a); sendSignal({ type: 'answer', sdp: a }); });
      }
      if (sig.type === 'answer') pc.setRemoteDescription(new RTCSessionDescription(sig.sdp));
      if (sig.type === 'candidate') pc.addIceCandidate(new RTCIceCandidate(sig.cand));
    }

    async function terminateSession() {
      await sendSignal({ type: 'bye' });
      location.reload();
    }

    function startWebRTC() {
      pc = new RTCPeerConnection(servers);
      const config = { ordered: true };
      
      if (isOfferer) {
        dc = pc.createDataChannel("chat", config);
        setupDC();
        pc.createOffer().then(o => { pc.setLocalDescription(o); sendSignal({ type: 'offer', sdp: o }); });
      } else {
        pc.ondatachannel = e => { dc = e.channel; setupDC(); };
      }
      pc.onicecandidate = e => { if (e.candidate) sendSignal({ type: 'candidate', cand: e.candidate }); };
      pc.onconnectionstatechange = () => {
        if (pc.connectionState === 'connected') showScreen('workspace');
      };
    }

    // --- DATA HANDLING ---
    function setupDC() {
      dc.bufferedAmountLowThreshold = 65536; // 64KB trigger
      dc.onmessage = e => {
        if (typeof e.data === 'string') {
          const msg = JSON.parse(e.data);
          if (msg.type === 'text') document.getElementById('text-buffer').value = msg.val;
          if (msg.type === 'f-start') {
            activeFiles[msg.id] = { ...msg, chunks: [], received: 0 };
            uiAddFile(msg.id, msg.name, false);
          }
          if (msg.type === 'f-end') uiFinishFile(msg.id);
        } else {
          // Binary chunk
          const head = new Uint8Array(e.data.slice(0, 8));
          const id = new TextDecoder().decode(head).trim();
          const chunk = e.data.slice(8);
          const f = activeFiles[id];
          if (f) {
            f.chunks.push(chunk);
            f.received += chunk.byteLength;
            uiUpdateProgress(id, (f.received / f.size) * 100);
          }
        }
      };
    }

    function sendText() {
      const val = document.getElementById('text-buffer').value;
      if (dc?.readyState === 'open') dc.send(JSON.stringify({ type: 'text', val }));
    }

    // --- FILE TRANSFER ENGINE ---
    async function sendFiles(files) {
      for (let file of files) {
        const fid = Math.random().toString(36).substr(2, 8);
        uiAddFile(fid, file.name, true, file);
        
        dc.send(JSON.stringify({ type: 'f-start', id: fid, name: file.name, size: file.size }));
        
        const CHUNK = 16384 * 4; // 64KB
        const idBytes = new TextEncoder().encode(fid.padEnd(8)); // 8 bytes ID
        let offset = 0;

        while (offset < file.size) {
          if (dc.bufferedAmount > 1000000) {
            await new Promise(r => dc.onbufferedamountlow = r);
          }
          const slice = await file.slice(offset, offset + CHUNK).arrayBuffer();
          const packet = new Uint8Array(8 + slice.byteLength);
          packet.set(idBytes);
          packet.set(new Uint8Array(slice), 8);
          
          dc.send(packet);
          offset += slice.byteLength;
          uiUpdateProgress(fid, (offset / file.size) * 100);
        }
        dc.send(JSON.stringify({ type: 'f-end', id: fid }));
        uiUpdateProgress(fid, 100); // Ensure full bar
      }
    }

    // --- UI HELPERS ---
    function uiAddFile(id, name, isOwner, fileBlob = null) {
      const div = document.createElement('div');
      div.className = 'file-card';
      div.id = `f-${id}`;
      div.innerHTML = `
        <div class="file-header">
          <div class="file-name" title="${name}">${isOwner ? 'üì§' : 'üì•'} ${name}</div>
          <a href="#" class="file-btn" id="dl-${id}" style="display:none"><i class="fa fa-download"></i></a>
        </div>
        <div class="progress-track"><div class="progress-fill" id="p-${id}"></div></div>
      `;
      document.getElementById('file-list').prepend(div);
      
      if (isOwner && fileBlob) {
        const btn = div.querySelector(`#dl-${id}`);
        btn.style.display = 'block';
        btn.href = URL.createObjectURL(fileBlob);
        btn.download = name;
      }
    }

    function uiUpdateProgress(id, perc) {
      const bar = document.getElementById(`p-${id}`);
      if (bar) bar.style.width = perc + '%';
    }

    function uiFinishFile(id) {
      const f = activeFiles[id];
      const blob = new Blob(f.chunks);
      const url = URL.createObjectURL(blob);
      const btn = document.querySelector(`#f-${id} #dl-${id}`);
      if (btn) {
        btn.style.display = 'block';
        btn.href = url;
        btn.download = f.name;
      }
      uiUpdateProgress(id, 100);
    }

    // --- DRAG & DROP & EVENTS ---
    const dz = document.getElementById('drop-zone');
    const fi = document.getElementById('file-input');

    dz.onclick = () => fi.click();
    fi.onchange = e => sendFiles(e.target.files);

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
      dz.addEventListener(e, ev => { ev.preventDefault(); ev.stopPropagation(); });
    });
    dz.addEventListener('dragover', () => dz.classList.add('active'));
    dz.addEventListener('dragleave', () => dz.classList.remove('active'));
    dz.addEventListener('drop', ev => {
      dz.classList.remove('active');
      sendFiles(ev.dataTransfer.files);
    });

  </script>
</body>
</html>