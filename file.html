<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>P2P Transfer Ultra</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    :root {
      --bg: #050505;
      --card: #121212;
      --accent: #00f2ff;
      --text: #ffffff;
      --border: #333;
      --btn-bg: #1e1e1e;
      --danger: #ff3b30;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', -apple-system, sans-serif;
      display: flex; justify-content: center; align-items: center; min-height: 100vh;
    }

    .container { width: 95%; max-width: 480px; }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 24px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.8);
    }

    h1 { font-size: 14px; text-transform: uppercase; letter-spacing: 3px; text-align: center; margin-bottom: 25px; opacity: 0.4; }

    /* –í–•–û–î */
    .big-code { 
      font-size: 60px; font-family: monospace; color: var(--accent); 
      text-align: center; margin: 20px 0; font-weight: bold;
    }
    
    input#room-input {
      width: 100%; background: #000; border: 2px solid var(--border);
      border-radius: 16px; color: var(--accent); font-size: 40px;
      text-align: center; padding: 12px; outline: none; margin-bottom: 20px;
    }

    .btn {
      width: 100%; padding: 18px; border-radius: 16px; border: none;
      font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s;
      display: flex; align-items: center; justify-content: center; gap: 10px;
      margin-top: 10px;
    }
    .btn-primary { background: var(--accent); color: #000; }
    .btn-secondary { background: var(--btn-bg); color: var(--text); border: 1px solid #444; }
    .btn-danger { background: rgba(255, 59, 48, 0.1); color: var(--danger); border: 1px solid var(--danger); }
    .btn:hover { filter: brightness(1.2); }

    /* –†–ê–ë–û–ß–ê–Ø –ó–û–ù–ê */
    #main-ui { display: none; flex-direction: column; gap: 20px; }

    textarea {
      width: 100%; height: 100px; background: #000; border: 1px solid var(--border);
      border-radius: 14px; color: #fff; padding: 15px; resize: none; font-size: 15px; outline: none;
    }

    .drop-zone {
      border: 2px dashed #444; border-radius: 20px; padding: 30px;
      text-align: center; cursor: pointer; color: #888; transition: 0.3s;
    }
    .drop-zone.active { border-color: var(--accent); background: rgba(0, 242, 255, 0.05); color: var(--accent); }

    /* –§–ê–ô–õ–´ */
    .file-item {
      background: #000; border-radius: 14px; padding: 15px; margin-top: 10px;
      border: 1px solid var(--border);
    }
    .file-info { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; }
    .progress-bg { width: 100%; height: 6px; background: #222; border-radius: 3px; overflow: hidden; }
    .progress-bar { height: 100%; background: var(--accent); width: 0%; transition: 0.1s; }
  </style>
</head>
<body>

  <div class="container">
    <div class="card">
      <h1>P2P Transfer</h1>

      <div id="setup-screen">
        <div id="initial-actions">
          <button class="btn btn-primary" onclick="createRoom()">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
          <div style="text-align: center; margin: 15px; font-size: 11px; opacity: 0.3;">–ò–õ–ò</div>
          <input type="number" id="room-input" placeholder="00000" oninput="if(value.length>5)value=value.slice(0,5)">
          <button class="btn btn-secondary" onclick="joinRoom()">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
        </div>

        <div id="waiting-area" style="display: none; text-align: center;">
          <p style="opacity: 0.5;">–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã:</p>
          <div class="big-code" id="active-code">-----</div>
          <p id="wait-msg">–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...</p>
          <button class="btn btn-secondary" onclick="location.reload()">–û—Ç–º–µ–Ω–∞</button>
        </div>
      </div>

      <div id="main-ui">
        <textarea id="text-data" placeholder="–¢–µ–∫—Å—Ç –∏–ª–∏ —Å—Å—ã–ª–∫–∏..." oninput="sendText()"></textarea>

        <div class="drop-zone" id="drop-zone">
          <i class="fa fa-file-export" style="font-size: 24px; margin-bottom: 10px;"></i>
          <p>–ù–∞–∂–º–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã</p>
          <input type="file" id="file-input" multiple style="display: none;">
        </div>

        <div id="file-list"></div>
        
        <button class="btn btn-danger" onclick="terminateSession()">–ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–µ–∞–Ω—Å –¥–ª—è –≤—Å–µ—Ö</button>
      </div>
    </div>
  </div>

  <script>
    const supabaseClient = supabase.createClient(
      "https://zmewwzlzujsrhstjehrp.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InptZXd3emx6dWpzcmhzdGplaHJwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5NjM4MDksImV4cCI6MjA3MTUzOTgwOX0.kBBXwlCEl5szgK4vKgaPBhPOVYmoFzly2TXR-fI8D24"
    );

    let pc, dc, channel, roomId, isOfferer;
    const servers = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
    let activeFiles = {};

    // --- –°–ò–ì–ù–ê–õ–ò–ù–ì ---

    function createRoom() {
      roomId = Math.floor(10000 + Math.random() * 90000).toString();
      isOfferer = true;
      document.getElementById('initial-actions').style.display = 'none';
      document.getElementById('waiting-area').style.display = 'block';
      document.getElementById('active-code').innerText = roomId;
      initSignaling();
    }

    function joinRoom() {
      roomId = document.getElementById('room-input').value;
      if (roomId.length !== 5) return;
      isOfferer = false;
      document.getElementById('initial-actions').style.display = 'none';
      document.getElementById('waiting-area').style.display = 'block';
      document.getElementById('active-code').innerText = roomId;
      initSignaling();
    }

    async function initSignaling() {
      channel = supabaseClient.channel(`p2p_${roomId}`);
      channel
        .on('broadcast', { event: 'signal' }, ({ payload }) => handleSignal(payload))
        .subscribe(status => {
          if (status === 'SUBSCRIBED' && !isOfferer) sendSignal({ type: 'ready' });
        });
    }

    async function terminateSession() {
      await sendSignal({ type: 'end-session' });
      location.reload();
    }

    // --- WebRTC ---

    function startWebRTC() {
      pc = new RTCPeerConnection(servers);
      if (isOfferer) {
        dc = pc.createDataChannel("data", { bufferedAmountLowThreshold: 65536 });
        setupDC();
        pc.createOffer().then(o => { pc.setLocalDescription(o); sendSignal({ type: 'offer', sdp: o }); });
      } else {
        pc.ondatachannel = e => { dc = e.channel; dc.bufferedAmountLowThreshold = 65536; setupDC(); };
      }
      pc.onicecandidate = e => { if (e.candidate) sendSignal({ type: 'candidate', cand: e.candidate }); };
      pc.onconnectionstatechange = () => {
        if (pc.connectionState === 'connected') {
          document.getElementById('setup-screen').style.display = 'none';
          document.getElementById('main-ui').style.display = 'flex';
        }
      };
    }

    async function sendSignal(payload) { await channel.send({ type: 'broadcast', event: 'signal', payload }); }

    function handleSignal(sig) {
      if (sig.type === 'ready' && isOfferer) startWebRTC();
      if (sig.type === 'end-session') location.reload();
      if (sig.type === 'offer') {
        startWebRTC();
        pc.setRemoteDescription(new RTCSessionDescription(sig.sdp));
        pc.createAnswer().then(a => { pc.setLocalDescription(a); sendSignal({ type: 'answer', sdp: a }); });
      }
      if (sig.type === 'answer') pc.setRemoteDescription(new RTCSessionDescription(sig.sdp));
      if (sig.type === 'candidate') pc.addIceCandidate(new RTCIceCandidate(sig.cand));
    }

    // --- –ü–ï–†–ï–î–ê–ß–ê –î–ê–ù–ù–´–• ---

    function setupDC() {
      dc.onmessage = e => {
        if (typeof e.data === 'string') {
          const m = JSON.parse(e.data);
          if (m.type === 'text') document.getElementById('text-data').value = m.val;
          if (m.type === 'file-start') {
            activeFiles[m.id] = { name: m.name, size: m.size, chunks: [], received: 0 };
            createFileUI(m.id, m.name, false);
          }
          if (m.type === 'file-end') finalizeFile(m.id);
        } else {
          const id = new TextDecoder().decode(e.data.slice(0, 8)).trim();
          const chunk = e.data.slice(8);
          const f = activeFiles[id];
          if (f) {
            f.chunks.push(chunk);
            f.received += chunk.byteLength;
            updateProgress(id, (f.received / f.size) * 100);
          }
        }
      };
    }

    function sendText() {
      const val = document.getElementById('text-data').value;
      if (dc?.readyState === 'open') dc.send(JSON.stringify({ type: 'text', val }));
    }

    // --- –§–ê–ô–õ–û–í–´–ô –ú–û–¢–û–† (–û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–û) ---

    async function sendFiles(files) {
      for (let f of files) {
        const fileId = Math.random().toString(36).substring(2, 10);
        createFileUI(fileId, f.name, true, f);
        dc.send(JSON.stringify({ type: 'file-start', id: fileId, name: f.name, size: f.size }));

        const chunkSize = 65536; // 64KB
        const idUint8 = new TextEncoder().encode(fileId.padEnd(8));
        let offset = 0;

        const sendChunk = async () => {
          while (offset < f.size) {
            // Flow Control: –∂–¥–µ–º, –µ—Å–ª–∏ –±—É—Ñ–µ—Ä –∑–∞–±–∏—Ç (–±–æ–ª—å—à–µ 1–ú–±)
            if (dc.bufferedAmount > 1048576) {
              await new Promise(r => dc.onbufferedamountlow = r);
            }

            const chunk = await f.slice(offset, offset + chunkSize).arrayBuffer();
            const combined = new Uint8Array(8 + chunk.byteLength);
            combined.set(idUint8);
            combined.set(new Uint8Array(chunk), 8);
            
            dc.send(combined);
            offset += chunk.byteLength;
            updateProgress(fileId, (offset / f.size) * 100);
          }
          dc.send(JSON.stringify({ type: 'file-end', id: fileId }));
        };

        sendChunk();
      }
    }

    function createFileUI(id, name, isOwner, fileObj = null) {
      const div = document.createElement('div');
      div.className = 'file-item';
      div.id = `file-${id}`;
      div.innerHTML = `
        <div class="file-info">
          <span>${isOwner ? 'üì§' : 'üì•'} ${name}</span>
          <a href="#" id="dl-${id}" style="display:none; color:var(--accent);"><i class="fa fa-download"></i></a>
        </div>
        <div class="progress-bg"><div class="progress-bar" id="pb-${id}"></div></div>
      `;
      document.getElementById('file-list').prepend(div);
      if (isOwner) {
        const btn = div.querySelector(`#dl-${id}`);
        btn.style.display = 'block'; btn.href = URL.createObjectURL(fileObj); btn.download = name;
      }
    }

    function updateProgress(id, percent) {
      const bar = document.getElementById(`pb-${id}`);
      if (bar) bar.style.width = percent + '%';
    }

    function finalizeFile(id) {
      const f = activeFiles[id];
      const blob = new Blob(f.chunks);
      const url = URL.createObjectURL(blob);
      const btn = document.getElementById(`dl-${id}`);
      btn.style.display = 'block'; btn.href = url; btn.download = f.name;
    }

    // --- EVENTS ---
    const dz = document.getElementById('drop-zone');
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
      dz.addEventListener(e, x => { x.preventDefault(); x.stopPropagation(); });
    });
    dz.addEventListener('dragover', () => dz.classList.add('active'));
    dz.addEventListener('dragleave', () => dz.classList.remove('active'));
    dz.addEventListener('drop', x => {
      dz.classList.remove('active');
      sendFiles(x.dataTransfer.files);
    });
    dz.onclick = () => document.getElementById('file-input').click();
    document.getElementById('file-input').onchange = e => sendFiles(e.target.files);
  </script>
</body>
</html>