<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>SHARE FILE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    :root {
      --bg: #000000;
      --accent: #00e5ff;
      --text: #ffffff;
      --muted: #666666;
      --panel: #0a0a0a;
    }

    /* ПРИМЕНЯЕМ МОНОШИРИННЫЙ ШРИФТ ВЕЗДЕ */
    * { 
      box-sizing: border-box; 
      margin: 0; padding: 0; 
      outline: none; 
      font-family: 'Courier New', Courier, monospace; 
      -webkit-tap-highlight-color: transparent; 
    }
    
    body {
      background: var(--bg);
      color: var(--text);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }

    .app-shell {
      width: 100%;
      max-width: 400px;
      display: flex;
      flex-direction: column;
      gap: 25px;
      /* РАМКА И ТЕНЬ УДАЛЕНЫ */
    }

    h1 { 
      font-size: 16px; 
      text-align: center; 
      letter-spacing: 5px; 
      color: var(--muted); 
    }

    /* КОД И ПОЛЕ ВВОДА */
    .code-view {
      font-size: 54px; 
      color: var(--accent); 
      text-align: center; 
      font-weight: bold;
      letter-spacing: 6px;
    }

    input.input-code {
      width: 100%; 
      background: transparent; 
      border: none;
      border-bottom: 2px solid #222; 
      color: var(--accent); 
      font-size: 42px;
      text-align: center; 
      padding: 10px;
      transition: border-color 0.3s;
    }
    input.input-code:focus { border-bottom-color: var(--accent); }

    /* УБИРАЕМ СТРЕЛОЧКИ У ПОЛЯ NUMBER */
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type=number] {
      -moz-appearance: textfield;
    }

    /* КНОПКИ */
    .btn {
      width: 100%; 
      padding: 18px; 
      border-radius: 4px; 
      border: none;
      font-size: 14px; 
      font-weight: bold; 
      cursor: pointer; 
      text-transform: uppercase;
      letter-spacing: 2px;
      transition: 0.2s;
    }
    .btn-primary { background: var(--accent); color: #000; }
    .btn-outline { background: transparent; color: var(--muted); border: 1px solid #222; }
    .btn-exit { background: transparent; color: #444; border: 1px solid #111; margin-top: 10px; }
    .btn:active { transform: scale(0.98); opacity: 0.8; }

    /* РАБОЧАЯ ЗОНА */
    #workspace { display: none; flex-direction: column; gap: 20px; }

    textarea {
      width: 100%; height: 100px; background: #050505; border: 1px solid #111;
      color: #fff; padding: 15px; resize: none; font-size: 14px;
    }

    .drop-zone {
      border: 1px dashed #222; padding: 30px;
      text-align: center; cursor: pointer; color: var(--muted);
    }
    .drop-zone:hover { border-color: var(--accent); color: var(--accent); }

    /* ФАЙЛЫ */
    .file-item {
      background: #050505; padding: 12px; border-bottom: 1px solid #111;
      display: flex; flex-direction: column; gap: 8px;
    }
    .file-row { display: flex; justify-content: space-between; align-items: center; }
    .file-name { font-size: 13px; color: #aaa; }
    .dl-link { color: var(--accent); text-decoration: none; font-weight: bold; }

    .progress-track { width: 100%; height: 2px; background: #111; }
    .progress-fill { height: 100%; background: var(--accent); width: 0%; transition: 0.1s; }

  </style>
</head>
<body>

  <div class="app-shell">
    <h1>SHARE FILE</h1>

    <div id="screen-login">
      <button class="btn btn-primary" onclick="createRoom()">CREATE ROOM</button>
      <div style="text-align:center; margin: 20px; font-size:10px; color:#333;">OR ENTER CODE</div>
      <input type="number" id="input-room" class="input-code" placeholder="00000" oninput="if(value.length>5)value=value.slice(0,5)">
      <button class="btn btn-outline" onclick="joinRoom()" style="margin-top: 20px;">JOIN</button>
    </div>

    <div id="screen-wait" style="display: none; text-align: center;">
      <div class="code-view" id="display-code" onclick="copyCode()">-----</div>
      <p id="status-msg" style="font-size: 11px; color: var(--muted); margin-top: 10px;">WAITING FOR PEER...</p>
      <button class="btn btn-exit" onclick="location.reload()" style="margin-top: 30px;">CANCEL</button>
    </div>

    <div id="workspace">
      <textarea id="text-buffer" placeholder="Type something..." oninput="sendText()"></textarea>

      <div class="drop-zone" id="drop-zone">
        <i class="fa fa-plus"></i><br><br>ADD FILES
        <input type="file" id="file-input" multiple style="display: none;">
      </div>

      <div id="file-list"></div>

      <button class="btn btn-exit" onclick="terminateSession()">CLOSE SESSION</button>
    </div>
  </div>

  <script>
    const supabaseClient = supabase.createClient(
      "https://zmewwzlzujsrhstjehrp.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InptZXd3emx6dWpzcmhzdGplaHJwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5NjM4MDksImV4cCI6MjA3MTUzOTgwOX0.kBBXwlCEl5szgK4vKgaPBhPOVYmoFzly2TXR-fI8D24"
    );

    let pc, dc, channel, roomId, isOfferer;
    const servers = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
    let activeFiles = {};

    // СОКРАЩЕНИЕ ИМЕНИ ФАЙЛА
    function formatFileName(name) {
      if (name.length <= 16) return name;
      const extIndex = name.lastIndexOf('.');
      const ext = extIndex !== -1 ? name.substring(extIndex) : '';
      const base = extIndex !== -1 ? name.substring(0, extIndex) : name;
      // Берем начало имени, ставим троеточие и расширение
      return base.substring(0, 10) + "..." + ext;
    }

    function showScreen(id) {
      document.getElementById('screen-login').style.display = 'none';
      document.getElementById('screen-wait').style.display = 'none';
      document.getElementById('workspace').style.display = 'none';
      document.getElementById(id).style.display = (id === 'workspace') ? 'flex' : 'block';
    }

    function createRoom() {
      roomId = Math.floor(10000 + Math.random() * 90000).toString();
      isOfferer = true;
      document.getElementById('display-code').innerText = roomId;
      showScreen('screen-wait');
      initSignaling();
    }

    function joinRoom() {
      roomId = document.getElementById('input-room').value;
      if (roomId.length !== 5) return;
      isOfferer = false;
      document.getElementById('display-code').innerText = roomId;
      showScreen('screen-wait');
      initSignaling();
    }

    async function initSignaling() {
      channel = supabaseClient.channel(`room_${roomId}`);
      channel.on('broadcast', { event: 'signal' }, ({ payload }) => handleSignal(payload))
             .subscribe(status => {
               if (status === 'SUBSCRIBED' && !isOfferer) sendSignal({ type: 'ready' });
             });
    }

    async function sendSignal(payload) { await channel.send({ type: 'broadcast', event: 'signal', payload }); }

    function handleSignal(sig) {
      if (sig.type === 'ready' && isOfferer) startWebRTC();
      if (sig.type === 'bye') location.reload();
      if (sig.type === 'offer') {
        startWebRTC();
        pc.setRemoteDescription(new RTCSessionDescription(sig.sdp));
        pc.createAnswer().then(a => { pc.setLocalDescription(a); sendSignal({ type: 'answer', sdp: a }); });
      }
      if (sig.type === 'answer') pc.setRemoteDescription(new RTCSessionDescription(sig.sdp));
      if (sig.type === 'candidate') pc.addIceCandidate(new RTCIceCandidate(sig.cand));
    }

    async function terminateSession() { await sendSignal({ type: 'bye' }); location.reload(); }

    function startWebRTC() {
      pc = new RTCPeerConnection(servers);
      if (isOfferer) {
        dc = pc.createDataChannel("data", { ordered: true });
        setupDC();
        pc.createOffer().then(o => { pc.setLocalDescription(o); sendSignal({ type: 'offer', sdp: o }); });
      } else {
        pc.ondatachannel = e => { dc = e.channel; setupDC(); };
      }
      pc.onicecandidate = e => { if (e.candidate) sendSignal({ type: 'candidate', cand: e.candidate }); };
      pc.onconnectionstatechange = () => { if (pc.connectionState === 'connected') showScreen('workspace'); };
    }

    function setupDC() {
      dc.bufferedAmountLowThreshold = 65536;
      dc.onmessage = e => {
        if (typeof e.data === 'string') {
          const m = JSON.parse(e.data);
          if (m.type === 'text') document.getElementById('text-buffer').value = m.val;
          if (m.type === 'f-start') {
            activeFiles[m.id] = { ...m, chunks: [], received: 0 };
            uiAddFile(m.id, m.name, false);
          }
          if (m.type === 'f-end') uiFinishFile(m.id);
        } else {
          const id = new TextDecoder().decode(e.data.slice(0, 8)).trim();
          const chunk = e.data.slice(8);
          if (activeFiles[id]) {
            activeFiles[id].chunks.push(chunk);
            activeFiles[id].received += chunk.byteLength;
            uiUpdProg(id, (activeFiles[id].received / activeFiles[id].size) * 100);
          }
        }
      };
    }

    function sendText() {
      const val = document.getElementById('text-buffer').value;
      if (dc?.readyState === 'open') dc.send(JSON.stringify({ type: 'text', val }));
    }

    async function sendFiles(files) {
      for (let file of files) {
        const fid = Math.random().toString(36).substr(2, 8);
        uiAddFile(fid, file.name, true, file);
        dc.send(JSON.stringify({ type: 'f-start', id: fid, name: file.name, size: file.size }));
        const CHUNK = 65536;
        const idB = new TextEncoder().encode(fid.padEnd(8));
        let off = 0;
        while (off < file.size) {
          if (dc.bufferedAmount > 1000000) await new Promise(r => dc.onbufferedamountlow = r);
          const s = await file.slice(off, off + CHUNK).arrayBuffer();
          const p = new Uint8Array(8 + s.byteLength);
          p.set(idB); p.set(new Uint8Array(s), 8);
          dc.send(p);
          off += s.byteLength;
          uiUpdProg(fid, (off / file.size) * 100);
        }
        dc.send(JSON.stringify({ type: 'f-end', id: fid }));
      }
    }

    function uiAddFile(id, name, isOwner, fileBlob = null) {
      const div = document.createElement('div');
      div.className = 'file-item';
      div.id = `f-${id}`;
      // ПРИМЕНЯЕМ ФОРМАТ ИМЕНИ
      const shortName = formatFileName(name);
      div.innerHTML = `
        <div class="file-row">
          <div class="file-name">${isOwner ? 'UP' : 'DN'}: ${shortName}</div>
          <a href="#" class="dl-link" id="dl-${id}" style="display:none">GET</a>
        </div>
        <div class="progress-track"><div class="progress-fill" id="p-${id}"></div></div>
      `;
      document.getElementById('file-list').prepend(div);
      if (isOwner) {
        const a = div.querySelector(`#dl-${id}`);
        a.style.display = 'block'; a.href = URL.createObjectURL(fileBlob); a.download = name;
      }
    }

    function uiUpdProg(id, p) { 
      const b = document.getElementById(`p-${id}`); 
      if (b) b.style.width = p + '%'; 
    }

    function uiFinishFile(id) {
      const f = activeFiles[id];
      const url = URL.createObjectURL(new Blob(f.chunks));
      const a = document.querySelector(`#f-${id} #dl-${id}`);
      if (a) { a.style.display = 'block'; a.href = url; a.download = f.name; }
      uiUpdProg(id, 100);
    }

    const dz = document.getElementById('drop-zone');
    const fi = document.getElementById('file-input');
    dz.onclick = () => fi.click();
    fi.onchange = e => sendFiles(e.target.files);
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
      dz.addEventListener(e, ev => { ev.preventDefault(); ev.stopPropagation(); });
    });
    dz.addEventListener('drop', ev => { sendFiles(ev.dataTransfer.files); });
  </script>
</body>
</html>