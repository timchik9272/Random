<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>P2P Transfer Elite</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    :root {
      --bg: #080808;
      --card: #121212;
      --accent: #00f2ff;
      --text: #e0e0e0;
      --border: #222;
      --success: #00ff88;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      display: flex; justify-content: center; align-items: center; min-height: 100vh;
      overflow-x: hidden;
    }

    .container { width: 95%; max-width: 500px; z-index: 10; }

    /* –ì–õ–ê–í–ù–ê–Ø –ü–ê–ù–ï–õ–¨ */
    .glass-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 28px;
      padding: 35px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    }

    h1 { font-size: 18px; font-weight: 400; letter-spacing: 4px; text-align: center; margin-bottom: 30px; opacity: 0.5; }

    /* –≠–ö–†–ê–ù –í–•–û–î–ê */
    .big-code { 
      font-size: 72px; font-family: 'Courier New', monospace; color: var(--accent); 
      text-align: center; margin: 20px 0; font-weight: bold; cursor: pointer;
      text-shadow: 0 0 20px rgba(0, 242, 255, 0.3);
    }
    
    input#room-input {
      width: 100%; background: #000; border: 2px solid var(--border);
      border-radius: 18px; color: var(--accent); font-size: 50px;
      text-align: center; font-family: monospace; padding: 15px; outline: none;
      margin-bottom: 20px; transition: 0.3s;
    }
    input#room-input:focus { border-color: var(--accent); }

    .btn {
      width: 100%; padding: 20px; border-radius: 18px; border: none;
      font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.3s;
      display: flex; align-items: center; justify-content: center; gap: 12px;
      text-transform: uppercase; letter-spacing: 1px;
    }
    .btn-primary { background: var(--accent); color: #000; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 242, 255, 0.4); }
    .btn-secondary { background: transparent; color: var(--text); border: 1px solid var(--border); margin-top: 15px; }

    /* –†–ê–ë–û–ß–ò–ô –ò–ù–¢–ï–†–§–ï–ô–° */
    #main-ui { display: none; flex-direction: column; gap: 20px; }

    .status-bar { font-size: 12px; display: flex; align-items: center; gap: 8px; margin-bottom: 10px; opacity: 0.8; }
    .dot { width: 8px; height: 8px; border-radius: 50%; background: #555; }
    .dot.online { background: var(--success); box-shadow: 0 0 10px var(--success); }

    textarea {
      width: 100%; height: 100px; background: #000; border: 1px solid var(--border);
      border-radius: 15px; color: #fff; padding: 15px; resize: none; font-size: 15px; outline: none;
    }

    /* –ó–û–ù–ê –§–ê–ô–õ–û–í */
    .drop-zone {
      border: 2px dashed var(--border); border-radius: 20px; padding: 40px 20px;
      text-align: center; cursor: pointer; transition: 0.3s; color: #666;
    }
    .drop-zone.active { border-color: var(--accent); background: rgba(0, 242, 255, 0.05); color: var(--accent); }
    .drop-zone i { font-size: 30px; margin-bottom: 10px; }

    /* –°–ü–ò–°–û–ö –§–ê–ô–õ–û–í */
    .file-item {
      background: #1a1a1a; border-radius: 15px; padding: 15px; margin-top: 10px;
      border: 1px solid var(--border); position: relative; overflow: hidden;
    }
    .file-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .file-name { font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 70%; }
    .file-btn { color: var(--accent); text-decoration: none; font-size: 18px; }
    
    .progress-bg { width: 100%; height: 4px; background: #000; border-radius: 2px; overflow: hidden; }
    .progress-bar { height: 100%; background: var(--accent); width: 0%; transition: 0.1s; }
  </style>
</head>
<body>

  <div class="container">
    <div class="glass-card">
      <h1>P2P TRANSFER</h1>

      <div id="setup-screen">
        <div id="initial-actions">
          <button class="btn btn-primary" onclick="createRoom()"><i class="fa fa-plus"></i> –°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
          <div style="text-align: center; margin: 20px; opacity: 0.3; font-size: 12px;">–ò–õ–ò –í–í–ï–î–ò–¢–ï –ö–û–î</div>
          <input type="number" id="room-input" placeholder="00000" oninput="if(value.length>5)value=value.slice(0,5)">
          <button class="btn btn-secondary" onclick="joinRoom()">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
        </div>

        <div id="waiting-area" style="display: none; text-align: center;">
          <p style="opacity: 0.5; font-size: 13px;">–ö–æ–¥ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:</p>
          <div class="big-code" id="active-code" onclick="copyCode()">-----</div>
          <div class="status-bar" style="justify-content: center;">
            <div class="dot"></div> <span id="wait-msg">–û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Å—Ç—è...</span>
          </div>
          <button class="btn btn-secondary" onclick="location.reload()">–û—Ç–º–µ–Ω–∞</button>
        </div>
      </div>

      <div id="main-ui">
        <div class="status-bar">
          <div class="dot online"></div> <span>–ó–∞—â–∏—â–µ–Ω–Ω–æ–µ P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</span>
        </div>

        <div style="margin-bottom: 20px;">
          <textarea id="text-data" placeholder="–û–±—â–∏–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –±—É—Ñ–µ—Ä (—Å—Å—ã–ª–∫–∏, –∑–∞–º–µ—Ç–∫–∏...)" oninput="sendText()"></textarea>
        </div>

        <div class="drop-zone" id="drop-zone">
          <i class="fa fa-cloud-arrow-up"></i>
          <p>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã –∏–ª–∏ –∫–ª–∏–∫–Ω–∏—Ç–µ</p>
          <input type="file" id="file-input" multiple style="display: none;">
        </div>

        <div id="file-list"></div>
        
        <button class="btn btn-secondary" style="margin-top: 20px;" onclick="location.reload()">–ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–µ–∞–Ω—Å</button>
      </div>
    </div>
  </div>

  <script>
    const supabaseClient = supabase.createClient(
      "https://zmewwzlzujsrhstjehrp.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InptZXd3emx6dWpzcmhzdGplaHJwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5NjM4MDksImV4cCI6MjA3MTUzOTgwOX0.kBBXwlCEl5szgK4vKgaPBhPOVYmoFzly2TXR-fI8D24"
    );

    let pc, dc, channel, roomId, isOfferer;
    const servers = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
    let activeFiles = {}; // –î–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞

    // --- –õ–û–ì–ò–ö–ê –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø ---

    function createRoom() {
      roomId = Math.floor(10000 + Math.random() * 90000).toString();
      isOfferer = true;
      document.getElementById('initial-actions').style.display = 'none';
      document.getElementById('waiting-area').style.display = 'block';
      document.getElementById('active-code').innerText = roomId;
      initSignaling();
    }

    function joinRoom() {
      roomId = document.getElementById('room-input').value;
      if (roomId.length !== 5) return alert("–í–≤–µ–¥–∏—Ç–µ 5 —Ü–∏—Ñ—Ä");
      isOfferer = false;
      document.getElementById('initial-actions').style.display = 'none';
      document.getElementById('waiting-area').style.display = 'block';
      document.getElementById('active-code').innerText = roomId;
      document.getElementById('wait-msg').innerText = "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...";
      initSignaling();
    }

    function copyCode() {
      navigator.clipboard.writeText(roomId);
      alert("–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω");
    }

    async function initSignaling() {
      channel = supabaseClient.channel(`room_${roomId}`);
      channel
        .on('broadcast', { event: 'signal' }, ({ payload }) => handleSignal(payload))
        .subscribe(status => {
          if (status === 'SUBSCRIBED' && !isOfferer) sendSignal({ type: 'ready' });
        });
    }

    // --- WebRTC ---

    function startWebRTC() {
      pc = new RTCPeerConnection(servers);
      if (isOfferer) {
        dc = pc.createDataChannel("data");
        setupDC();
        pc.createOffer().then(o => { pc.setLocalDescription(o); sendSignal({ type: 'offer', sdp: o }); });
      } else {
        pc.ondatachannel = e => { dc = e.channel; setupDC(); };
      }
      pc.onicecandidate = e => { if (e.candidate) sendSignal({ type: 'candidate', cand: e.candidate }); };
      pc.onconnectionstatechange = () => {
        if (pc.connectionState === 'connected') {
          document.getElementById('setup-screen').style.display = 'none';
          document.getElementById('main-ui').style.display = 'flex';
        }
      };
    }

    async function sendSignal(payload) { await channel.send({ type: 'broadcast', event: 'signal', payload }); }

    function handleSignal(sig) {
      if (sig.type === 'ready' && isOfferer) startWebRTC();
      if (sig.type === 'offer') {
        startWebRTC();
        pc.setRemoteDescription(new RTCSessionDescription(sig.sdp));
        pc.createAnswer().then(a => { pc.setLocalDescription(a); sendSignal({ type: 'answer', sdp: a }); });
      }
      if (sig.type === 'answer') pc.setRemoteDescription(new RTCSessionDescription(sig.sdp));
      if (sig.type === 'candidate') pc.addIceCandidate(new RTCIceCandidate(sig.cand));
    }

    // --- –ü–ï–†–ï–î–ê–ß–ê –î–ê–ù–ù–´–• ---

    function setupDC() {
      dc.onmessage = e => {
        if (typeof e.data === 'string') {
          const m = JSON.parse(e.data);
          if (m.type === 'text') document.getElementById('text-data').value = m.val;
          if (m.type === 'file-start') {
            activeFiles[m.id] = { name: m.name, size: m.size, chunks: [], received: 0 };
            createFileUI(m.id, m.name, false);
          }
          if (m.type === 'file-end') finalizeFile(m.id);
        } else {
          // –ü–æ–ª—É—á–µ–Ω–∏–µ —á–∞–Ω–∫–∞ (–ø–µ—Ä–≤—ã–µ 32 –±–∞–π—Ç–∞ - ID —Ñ–∞–π–ª–∞ –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏)
          const id = new TextDecoder().decode(e.data.slice(0, 8)).trim();
          const chunk = e.data.slice(8);
          const f = activeFiles[id];
          if (f) {
            f.chunks.push(chunk);
            f.received += chunk.byteLength;
            updateProgress(id, (f.received / f.size) * 100);
          }
        }
      };
    }

    function sendText() {
      const val = document.getElementById('text-data').value;
      if (dc?.readyState === 'open') dc.send(JSON.stringify({ type: 'text', val }));
    }

    // --- –§–ê–ô–õ–û–í–´–ô –î–í–ò–ñ–û–ö ---

    async function sendFiles(files) {
      for (let f of files) {
        const fileId = Math.random().toString(36).substring(2, 10); // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞
        createFileUI(fileId, f.name, true, f);
        
        dc.send(JSON.stringify({ type: 'file-start', id: fileId, name: f.name, size: f.size }));

        const chunkSize = 16000; // ~16KB
        const idUint8 = new TextEncoder().encode(fileId.padEnd(8)); // –§–∏–∫—Å–∏—Ä—É–µ–º ID –≤ 8 –±–∞–π—Ç–∞—Ö

        for (let i = 0; i < f.size; i += chunkSize) {
          const chunk = await f.slice(i, i + chunkSize).arrayBuffer();
          // –°–∫–ª–µ–∏–≤–∞–µ–º ID –∏ –¥–∞–Ω–Ω—ã–µ, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∞—Ç–µ–ª—å –∑–Ω–∞–ª, –∫–∞–∫–æ–º—É —Ñ–∞–π–ª—É –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç —á–∞–Ω–∫
          const combined = new Uint8Array(idUint8.length + chunk.byteLength);
          combined.set(idUint8);
          combined.set(new Uint8Array(chunk), idUint8.length);
          
          dc.send(combined);
          updateProgress(fileId, (i / f.size) * 100);
        }
        
        dc.send(JSON.stringify({ type: 'file-end', id: fileId }));
        updateProgress(fileId, 100);
      }
    }

    function createFileUI(id, name, isOwner, fileObj = null) {
      const div = document.createElement('div');
      div.className = 'file-item';
      div.id = `file-${id}`;
      div.innerHTML = `
        <div class="file-info">
          <span class="file-name">${isOwner ? 'üì§' : 'üì•'} ${name}</span>
          <a href="#" class="file-btn" id="dl-${id}" style="display:none;"><i class="fa fa-download"></i></a>
        </div>
        <div class="progress-bg"><div class="progress-bar" id="pb-${id}"></div></div>
      `;
      document.getElementById('file-list').prepend(div);

      if (isOwner && fileObj) {
        // –£ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –∫–Ω–æ–ø–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Å—Ä–∞–∑—É
        const btn = div.querySelector(`#dl-${id}`);
        btn.style.display = 'block';
        btn.href = URL.createObjectURL(fileObj);
        btn.download = name;
      }
    }

    function updateProgress(id, percent) {
      const bar = document.getElementById(`pb-${id}`);
      if (bar) bar.style.width = percent + '%';
    }

    function finalizeFile(id) {
      const f = activeFiles[id];
      const blob = new Blob(f.chunks);
      const url = URL.createObjectURL(blob);
      const btn = document.getElementById(`dl-${id}`);
      if (btn) {
        btn.style.display = 'block';
        btn.href = url;
        btn.download = f.name;
      }
      updateProgress(id, 100);
    }

    // --- DRAG & DROP ---

    const dz = document.getElementById('drop-zone');
    
    // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –±—Ä–∞—É–∑–µ—Ä–∞ (–æ—Ç–∫—Ä—ã—Ç–∏–µ —Ñ–∞–π–ª–∞)
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(evt => {
      dz.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); }, false);
    });

    dz.addEventListener('dragover', () => dz.classList.add('active'));
    dz.addEventListener('dragleave', () => dz.classList.remove('active'));
    dz.addEventListener('drop', e => {
      dz.classList.remove('active');
      const files = e.dataTransfer.files;
      if (files.length > 0) sendFiles(files);
    });

    dz.addEventListener('click', () => document.getElementById('file-input').click());
    document.getElementById('file-input').onchange = e => sendFiles(e.target.files);

  </script>
</body>
</html>