<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>SHARE FILE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    :root {
      --bg: #000000;
      --card-bg: #000000;
      --accent: #00e5ff;
      --text: #ffffff;
      --muted: #666666;
      --border: #222222;
    }

    /* ВЕЗДЕ ОДИНАКОВЫЙ ШРИФТ */
    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0; 
      outline: none; 
      font-family: 'Courier New', Courier, monospace; /* Тот самый шрифт */
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      background: var(--bg);
      color: var(--text);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }

    /* УБРАНА РАМКА У КОНТЕЙНЕРА */
    .app-shell {
      width: 100%;
      max-width: 400px;
      background: var(--card-bg);
      display: flex;
      flex-direction: column;
      gap: 25px;
    }

    h1 { 
      font-size: 18px; 
      color: var(--text); 
      text-align: center; 
      letter-spacing: 5px; 
      font-weight: bold;
    }

    /* УБИРАЕМ СТРЕЛКИ У INPUT */
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type=number] {
      -moz-appearance: textfield;
    }

    .code-display {
      font-size: 56px; 
      color: var(--accent); 
      text-align: center; 
      font-weight: bold;
      margin: 10px 0; 
      letter-spacing: 6px;
    }

    input.input-code {
      width: 100%; 
      background: #000; 
      border: 2px solid var(--border);
      border-radius: 0px; 
      color: var(--accent); 
      font-size: 40px;
      text-align: center; 
      padding: 15px;
      transition: border 0.3s;
    }
    input.input-code:focus { border-color: var(--accent); }

    .btn {
      width: 100%; 
      padding: 18px; 
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
      font-size: 14px; 
      font-weight: bold; 
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 2px;
      transition: 0.2s;
    }
    .btn-primary { border-color: var(--accent); color: var(--accent); }
    .btn:active { background: var(--accent); color: #000; }

    #workspace { display: none; flex-direction: column; gap: 20px; }

    textarea {
      width: 100%; 
      height: 100px; 
      background: #000; 
      border: 1px solid var(--border);
      color: #fff; 
      padding: 12px; 
      resize: none; 
      font-size: 14px;
    }

    .drop-zone {
      border: 2px dashed var(--border); 
      padding: 30px;
      text-align: center; 
      cursor: pointer;
    }
    .drop-zone p { font-size: 12px; color: var(--muted); margin-top: 10px; }

    /* ФАЙЛЫ */
    .file-list { display: flex; flex-direction: column; gap: 12px; }
    
    .file-card {
      background: #000; 
      padding: 12px; 
      border-bottom: 1px solid var(--border);
      display: flex; 
      flex-direction: column; 
      gap: 8px;
    }
    
    .file-header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
    }
    
    .file-name { 
      font-size: 13px; 
      color: #eee;
    }
    
    .file-btn { color: var(--accent); text-decoration: none; font-size: 16px; }
    
    .progress-track { width: 100%; height: 2px; background: #222; }
    .progress-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.2s; }

  </style>
</head>
<body>

  <div class="app-shell">
    <h1>SHARE FILE</h1>

    <div id="screen-login">
      <button class="btn btn-primary" onclick="createRoom()">CREATE ROOM</button>
      <div style="text-align: center; margin: 20px 0; font-size: 11px; color: var(--muted);">ENTER CODE BELOW</div>
      <input type="number" id="input-room" class="input-code" placeholder="00000" oninput="if(value.length>5)value=value.slice(0,5)">
      <button class="btn" onclick="joinRoom()" style="margin-top: 20px;">JOIN</button>
    </div>

    <div id="screen-wait" style="display: none; text-align: center;">
      <p style="color: var(--muted); font-size: 12px;">ROOM CODE:</p>
      <div class="code-display" id="display-code">-----</div>
      <p id="status-msg" style="color: var(--accent); font-size: 11px; margin-bottom: 25px;">WAITING FOR PEER...</p>
      <button class="btn" onclick="location.reload()">CANCEL</button>
    </div>

    <div id="workspace">
      <textarea id="text-buffer" placeholder="Type something..." oninput="sendText()"></textarea>

      <div class="drop-zone" id="drop-zone">
        <i class="fa fa-upload" style="color: var(--accent)"></i>
        <p>SELECT OR DROP FILES</p>
        <input type="file" id="file-input" multiple style="display: none;">
      </div>

      <div id="file-list" class="file-list"></div>

      <button class="btn" onclick="terminateSession()" style="color: #666; border-color: #333;">
        CLOSE SESSION
      </button>
    </div>
  </div>

  <script>
    const supabaseClient = supabase.createClient(
      "https://zmewwzlzujsrhstjehrp.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InptZXd3emx6dWpzcmhzdGplaHJwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5NjM4MDksImV4cCI6MjA3MTUzOTgwOX0.kBBXwlCEl5szgK4vKgaPBhPOVYmoFzly2TXR-fI8D24"
    );

    let pc, dc, channel, roomId, isOfferer;
    const servers = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
    let activeFiles = {};

    // --- СОКРАЩЕНИЕ ИМЕНИ ---
    function formatFileName(name) {
      if (name.length <= 20) return name;
      const parts = name.split('.');
      const ext = parts.length > 1 ? parts.pop() : '';
      const base = parts.join('.');
      return base.substring(0, 12) + '... .' + ext;
    }

    function showScreen(id) {
      ['screen-login', 'screen-wait', 'workspace'].forEach(s => document.getElementById(s).style.display = 'none');
      document.getElementById(id).style.display = (id === 'workspace') ? 'flex' : 'block';
    }

    function createRoom() {
      roomId = Math.floor(10000 + Math.random() * 90000).toString();
      isOfferer = true;
      document.getElementById('display-code').innerText = roomId;
      showScreen('screen-wait');
      initSignaling();
    }

    function joinRoom() {
      roomId = document.getElementById('input-room').value;
      if (roomId.length !== 5) return;
      isOfferer = false;
      document.getElementById('display-code').innerText = roomId;
      showScreen('screen-wait');
      initSignaling();
    }

    async function initSignaling() {
      channel = supabaseClient.channel(`room_${roomId}`);
      channel.on('broadcast', { event: 'signal' }, ({ payload }) => handleSignal(payload))
             .subscribe(status => {
               if (status === 'SUBSCRIBED' && !isOfferer) sendSignal({ type: 'ready' });
             });
    }

    async function sendSignal(payload) { await channel.send({ type: 'broadcast', event: 'signal', payload }); }

    function handleSignal(sig) {
      if (sig.type === 'ready' && isOfferer) startWebRTC();
      if (sig.type === 'bye') location.reload();
      if (sig.type === 'offer') {
        startWebRTC();
        pc.setRemoteDescription(new RTCSessionDescription(sig.sdp));
        pc.createAnswer().then(a => { pc.setLocalDescription(a); sendSignal({ type: 'answer', sdp: a }); });
      }
      if (sig.type === 'answer') pc.setRemoteDescription(new RTCSessionDescription(sig.sdp));
      if (sig.type === 'candidate') pc.addIceCandidate(new RTCIceCandidate(sig.cand));
    }

    async function terminateSession() {
      await sendSignal({ type: 'bye' });
      location.reload();
    }

    function startWebRTC() {
      pc = new RTCPeerConnection(servers);
      if (isOfferer) {
        dc = pc.createDataChannel("data", { ordered: true });
        setupDC();
        pc.createOffer().then(o => { pc.setLocalDescription(o); sendSignal({ type: 'offer', sdp: o }); });
      } else {
        pc.ondatachannel = e => { dc = e.channel; setupDC(); };
      }
      pc.onicecandidate = e => { if (e.candidate) sendSignal({ type: 'candidate', cand: e.candidate }); };
      pc.onconnectionstatechange = () => {
        if (pc.connectionState === 'connected') showScreen('workspace');
      };
    }

    function setupDC() {
      dc.bufferedAmountLowThreshold = 65536;
      dc.onmessage = e => {
        if (typeof e.data === 'string') {
          const msg = JSON.parse(e.data);
          if (msg.type === 'text') document.getElementById('text-buffer').value = msg.val;
          if (msg.type === 'f-start') {
            activeFiles[msg.id] = { ...msg, chunks: [], received: 0 };
            uiAddFile(msg.id, msg.name, false);
          }
          if (msg.type === 'f-end') uiFinishFile(msg.id);
        } else {
          const head = new TextDecoder().decode(e.data.slice(0, 8)).trim();
          const chunk = e.data.slice(8);
          const f = activeFiles[head];
          if (f) {
            f.chunks.push(chunk);
            f.received += chunk.byteLength;
            uiUpdateProgress(head, (f.received / f.size) * 100);
          }
        }
      };
    }

    function sendText() {
      const val = document.getElementById('text-buffer').value;
      if (dc?.readyState === 'open') dc.send(JSON.stringify({ type: 'text', val }));
    }

    async function sendFiles(files) {
      for (let file of files) {
        const fid = Math.random().toString(36).substr(2, 8);
        uiAddFile(fid, file.name, true, file);
        dc.send(JSON.stringify({ type: 'f-start', id: fid, name: file.name, size: file.size }));
        const CHUNK = 65536;
        const idBytes = new TextEncoder().encode(fid.padEnd(8));
        let offset = 0;
        while (offset < file.size) {
          if (dc.bufferedAmount > 1000000) await new Promise(r => dc.onbufferedamountlow = r);
          const slice = await file.slice(offset, offset + CHUNK).arrayBuffer();
          const packet = new Uint8Array(8 + slice.byteLength);
          packet.set(idBytes); packet.set(new Uint8Array(slice), 8);
          dc.send(packet);
          offset += slice.byteLength;
          uiUpdateProgress(fid, (offset / file.size) * 100);
        }
        dc.send(JSON.stringify({ type: 'f-end', id: fid }));
      }
    }

    function uiAddFile(id, name, isOwner, fileBlob = null) {
      const div = document.createElement('div');
      div.className = 'file-card';
      div.id = `f-${id}`;
      div.innerHTML = `
        <div class="file-header">
          <div class="file-name">${isOwner ? '>' : '<'} ${formatFileName(name)}</div>
          <a href="#" class="file-btn" id="dl-${id}" style="display:none"><i class="fa fa-download"></i></a>
        </div>
        <div class="progress-track"><div class="progress-fill" id="p-${id}"></div></div>
      `;
      document.getElementById('file-list').prepend(div);
      if (isOwner && fileBlob) {
        const btn = div.querySelector(`#dl-${id}`);
        btn.style.display = 'block'; btn.href = URL.createObjectURL(fileBlob); btn.download = name;
        uiUpdateProgress(id, 100);
      }
    }

    function uiUpdateProgress(id, perc) {
      const bar = document.getElementById(`p-${id}`);
      if (bar) bar.style.width = perc + '%';
    }

    function uiFinishFile(id) {
      const f = activeFiles[id];
      const blob = new Blob(f.chunks);
      const url = URL.createObjectURL(blob);
      const btn = document.querySelector(`#f-${id} #dl-${id}`);
      if (btn) { btn.style.display = 'block'; btn.href = url; btn.download = f.name; }
      uiUpdateProgress(id, 100);
    }

    const dz = document.getElementById('drop-zone');
    const fi = document.getElementById('file-input');
    dz.onclick = () => fi.click();
    fi.onchange = e => sendFiles(e.target.files);
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
      dz.addEventListener(e, ev => { ev.preventDefault(); ev.stopPropagation(); });
    });
    dz.addEventListener('drop', ev => { sendFiles(ev.dataTransfer.files); });
  </script>
</body>
</html>