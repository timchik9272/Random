<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>P2P Transfer Fix</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    :root { --bg: #0a0a0a; --accent: #00ff88; --panel: #161616; --text: #eee; }
    body { background: var(--bg); color: var(--text); font-family: monospace; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
    .card { background: var(--panel); padding: 30px; border-radius: 20px; width: 90%; max-width: 450px; border: 1px solid #333; text-align: center; }
    
    /* –ö–æ–¥ –∏ –í–≤–æ–¥ */
    .code-box { font-size: 50px; color: var(--accent); margin: 20px 0; letter-spacing: 5px; font-weight: bold; }
    input { width: 100%; background: #000; border: 2px solid #333; color: var(--accent); font-size: 40px; text-align: center; padding: 10px; border-radius: 12px; outline: none; margin-bottom: 15px; }
    
    .btn { width: 100%; padding: 18px; border-radius: 12px; border: none; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; margin-top: 10px; }
    .btn-main { background: var(--accent); color: #000; }
    .btn-sec { background: transparent; color: #888; border: 1px solid #333; }
    
    /* –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–µ—Ä–µ–¥–∞—á–∏ */
    #transfer-ui { display: none; flex-direction: column; gap: 15px; }
    textarea { width: 100%; height: 100px; background: #000; color: #fff; border: 1px solid #333; border-radius: 10px; padding: 10px; resize: none; }
    .drop-zone { border: 2px dashed #333; padding: 30px; border-radius: 10px; cursor: pointer; }
    
    /* –õ–æ–≥–∏ –æ—Ç–ª–∞–¥–∫–∏ */
    #debug-log { font-size: 10px; color: #555; text-align: left; margin-top: 20px; max-height: 60px; overflow-y: auto; border-top: 1px solid #222; padding-top: 10px; }
  </style>
</head>
<body>

  <div class="card">
    <div id="setup-screen">
      <h2 style="font-weight: 200; opacity: 0.6;">P2P TRANSFER</h2>
      
      <div id="main-menu">
        <button class="btn btn-main" onclick="createRoom()">–°–û–ó–î–ê–¢–¨</button>
        <p style="margin: 15px 0; color: #444;">–ò–õ–ò</p>
        <input type="number" id="room-input" placeholder="00000" oninput="if(value.length>5)value=value.slice(0,5)">
        <button class="btn btn-sec" onclick="joinRoom()">–í–û–ô–¢–ò</button>
      </div>

      <div id="wait-area" style="display: none;">
        <p>–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã:</p>
        <div class="code-box" id="active-code">-----</div>
        <p id="conn-status" style="color: var(--accent); font-size: 12px;">–û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Å—Ç—è...</p>
        <button class="btn btn-sec" onclick="location.reload()">–û–¢–ú–ï–ù–ê</button>
      </div>
    </div>

    <div id="transfer-ui">
      <div style="text-align: left; font-size: 11px; color: var(--accent); margin-bottom: 5px;">–û–ë–©–ò–ô –¢–ï–ö–°–¢:</div>
      <textarea id="text-data" placeholder="–¢–µ–∫—Å—Ç –ø–æ—è–≤–∏—Ç—Å—è —É –æ–±–æ–∏—Ö..." oninput="sendText()"></textarea>
      
      <div class="drop-zone" onclick="document.getElementById('file-input').click()">
        –§–ê–ô–õ–´ (–ö–ª–∏–∫ / Drop)
        <input type="file" id="file-input" multiple style="display: none;">
      </div>
      <div id="file-list" style="text-align: left; font-size: 12px; margin-top: 10px;"></div>
      <button class="btn btn-sec" onclick="location.reload()">–í–´–ô–¢–ò</button>
    </div>

    <div id="debug-log">–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞...</div>
  </div>

  <script>
    const SB_URL = "https://zmewwzlzujsrhstjehrp.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InptZXd3emx6dWpzcmhzdGplaHJwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5NjM4MDksImV4cCI6MjA3MTUzOTgwOX0.kBBXwlCEl5szgK4vKgaPBhPOVYmoFzly2TXR-fI8D24";
    const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

    let pc, dc, channel, roomId, isOfferer = false;
    const ice = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

    function log(msg) {
      const d = document.getElementById('debug-log');
      d.innerHTML += `> ${msg}<br>`;
      d.scrollTop = d.scrollHeight;
      console.log(msg);
    }

    // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---

    function createRoom() {
      roomId = Math.floor(10000 + Math.random() * 90000).toString();
      isOfferer = true;
      showWaitArea();
      initSignaling();
    }

    function joinRoom() {
      roomId = document.getElementById('room-input').value;
      if (roomId.length !== 5) return alert("5 —Ü–∏—Ñ—Ä!");
      isOfferer = false;
      showWaitArea();
      initSignaling();
    }

    function showWaitArea() {
      document.getElementById('main-menu').style.display = 'none';
      document.getElementById('wait-area').style.display = 'block';
      document.getElementById('active-code').innerText = roomId;
    }

    async function initSignaling() {
      log(`–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–∞–Ω–∞–ª—É: ${roomId}`);
      channel = supabaseClient.channel(`room_${roomId}`, { config: { broadcast: { ack: true } } });

      channel
        .on('broadcast', { event: 'signal' }, ({ payload }) => handleSignal(payload))
        .subscribe(async (status) => {
          if (status === 'SUBSCRIBED') {
            log("–í—ã –≤ —Å–µ—Ç–∏. –ñ–¥–µ–º –ø–∞—Ä—Ç–Ω–µ—Ä–∞...");
            if (!isOfferer) {
              // –ì–æ—Å—Ç—å –∑–∞—à–µ–ª ‚Äî —Å–æ–æ–±—â–∞–µ—Ç –æ–± —ç—Ç–æ–º –°–æ–∑–¥–∞—Ç–µ–ª—é
              log("–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...");
              sendSignal({ type: 'join-ready' });
            }
          }
        });
    }

    // --- WebRTC –õ–û–ì–ò–ö–ê ---

    function startWebRTC() {
      log("–ó–∞–ø—É—Å–∫ WebRTC...");
      pc = new RTCPeerConnection(ice);

      if (isOfferer) {
        dc = pc.createDataChannel("transfer");
        setupDC();
      } else {
        pc.ondatachannel = (e) => {
          dc = e.channel;
          setupDC();
        };
      }

      pc.onicecandidate = (e) => {
        if (e.candidate) sendSignal({ type: 'candidate', cand: e.candidate });
      };

      pc.onconnectionstatechange = () => {
        log(`–°—Ç–∞—Ç—É—Å —Å–≤—è–∑–∏: ${pc.connectionState}`);
        if (pc.connectionState === 'connected') {
          document.getElementById('setup-screen').style.display = 'none';
          document.getElementById('transfer-ui').style.display = 'flex';
        }
      };
    }

    async function handleSignal(sig) {
      if (sig.type === 'join-ready' && isOfferer) {
        log("–ì–æ—Å—Ç—å –Ω–∞–π–¥–µ–Ω! –ù–∞—á–∏–Ω–∞—é —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...");
        startWebRTC();
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        sendSignal({ type: 'offer', sdp: offer });
      } 
      else if (sig.type === 'offer' && !isOfferer) {
        log("–ü–æ–ª—É—á–µ–Ω Offer...");
        startWebRTC();
        await pc.setRemoteDescription(new RTCSessionDescription(sig.sdp));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        sendSignal({ type: 'answer', sdp: answer });
      } 
      else if (sig.type === 'answer' && isOfferer) {
        log("–ü–æ–ª—É—á–µ–Ω Answer...");
        await pc.setRemoteDescription(new RTCSessionDescription(sig.sdp));
      } 
      else if (sig.type === 'candidate' && pc) {
        await pc.addIceCandidate(new RTCIceCandidate(sig.cand));
      }
    }

    async function sendSignal(payload) {
      await channel.send({ type: 'broadcast', event: 'signal', payload });
    }

    // --- DATA CHANNEL ---

    function setupDC() {
      dc.onopen = () => log("P2P –ö–∞–Ω–∞–ª –æ—Ç–∫—Ä—ã—Ç!");
      dc.onmessage = (e) => {
        if (typeof e.data === 'string') {
          const msg = JSON.parse(e.data);
          if (msg.type === 'text') document.getElementById('text-data').value = msg.val;
          if (msg.type === 'file-start') { window.chunks = []; window.fInfo = msg; }
          if (msg.type === 'file-end') finalizeFile();
        } else {
          window.chunks.push(e.data);
        }
      };
    }

    function sendText() {
      const val = document.getElementById('text-data').value;
      if (dc && dc.readyState === 'open') {
        dc.send(JSON.stringify({ type: 'text', val }));
      }
    }

    // –§–∞–π–ª—ã
    document.getElementById('file-input').onchange = async (e) => {
      const files = e.target.files;
      for (let f of files) {
        log(`–û—Ç–ø—Ä–∞–≤–∫–∞: ${f.name}`);
        dc.send(JSON.stringify({ type: 'file-start', name: f.name, size: f.size }));
        const slice = 16384;
        for (let i = 0; i < f.size; i += slice) {
          const chunk = await f.slice(i, i + slice).arrayBuffer();
          dc.send(chunk);
        }
        dc.send(JSON.stringify({ type: 'file-end' }));
        addFileRow(f.name, null, true);
      }
    };

    function finalizeFile() {
      const b = new Blob(window.chunks);
      const url = URL.createObjectURL(b);
      addFileRow(window.fInfo.name, url, false);
      log(`–ü–æ–ª—É—á–µ–Ω —Ñ–∞–π–ª: ${window.fInfo.name}`);
    }

    function addFileRow(name, url, isSent) {
      const row = document.createElement('div');
      row.style.margin = "5px 0";
      row.innerHTML = `${isSent ? 'üì§' : 'üì•'} ${name} ${url ? `<a href="${url}" download="${name}" style="color:var(--accent)">[–°–ö–ê–ß–ê–¢–¨]</a>` : ''}`;
      document.getElementById('file-list').prepend(row);
    }
  </script>
</body>
</html>