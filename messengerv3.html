<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<title>MiniMessenger v2.0</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js"></script>
<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
:root{--bg:#0e0e0e;--bg-light:#1e1e1e;--accent:#0088cc;--text:#fff;--gray:#888;--radius:14px;--danger:#e53935;}
*{box-sizing:border-box}
body{margin:0;font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;height:100vh;display:flex;flex-direction:column;overflow:hidden;}
.screen{display:none;flex-direction:column;height:100vh;width:100%;}
.active{display:flex;}
input,textarea,button{border:none;border-radius:var(--radius);font-size:15px;outline:none;}
input,textarea{background:var(--bg-light);color:var(--text);padding:12px;transition:0.2s;}
input:focus,textarea:focus{box-shadow:0 0 0 2px var(--accent);}
button{background:var(--accent);color:#fff;padding:12px;font-weight:600;margin:6px 0;cursor:pointer;transition:transform 0.1s, opacity 0.2s;}
button:active{transform:scale(0.98);}
button:hover{opacity:0.9;}

/* Navigation */
nav{display:flex;align-items:center;gap:12px;padding:10px 16px;background:rgba(14,14,14,0.95);backdrop-filter:blur(10px);position:sticky;top:0;z-index:20;border-bottom:1px solid #222;height:60px;}
nav h2{margin:0;font-size:18px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

/* Chat List */
.chat-list,.messages{flex:1;overflow-y:auto;scroll-behavior:smooth;}
.chat-list{padding-bottom:80px;} 
.chat-item{padding:14px;border-bottom:1px solid #222;cursor:pointer;display:flex;justify-content:space-between;align-items:center;transition:background 0.2s;}
.chat-item:hover{background:#161616;}
.chat-item .info{display:flex;flex-direction:column;flex:1;min-width:0;}
.chat-item .last{display:flex;justify-content:space-between;align-items:center;margin-top:6px;font-size:13px;color:var(--gray);}
.chat-item .avatar{width:48px;height:48px;border-radius:50%;margin-right:14px;object-fit:cover;background:#222;}
.unread-badge{background:var(--accent);color:#fff;border-radius:12px;min-width:24px;height:24px;display:flex;justify-content:center;align-items:center;font-size:11px;padding:0 8px;font-weight:bold;}

/* Messages */
.msg{margin:6px 12px;padding:10px 16px;border-radius:18px;max-width:80%;position:relative;border:1px solid transparent;word-wrap:break-word;line-height:1.4;}
.msg.me{background:var(--accent);margin-left:auto;color:#fff;border-bottom-right-radius:4px;}
.msg.other{background:var(--bg-light);color:var(--text);border-bottom-left-radius:4px;border-color:#2a2a2a;}
.msg.deleted{font-style:italic;color:var(--gray);background:transparent;border:1px dashed #333;}
.msg .reply-to{font-size:12px;color:rgba(255,255,255,0.7);margin-bottom:6px;border-left:2px solid rgba(255,255,255,0.5);padding-left:8px;cursor:pointer;display:block;}
.msg.other .reply-to{color:var(--gray);border-color:var(--gray);}
.msg a {color:#8ad4ff; text-decoration:underline; cursor:pointer;}
.msg.other a {color:#4db6ac;}

.time{display:block;font-size:10px;margin-top:4px;text-align:right;opacity:0.8;}
img.msg-img{max-width:100%;border-radius:12px;margin-top:6px;display:block;cursor:pointer;}

/* Input Area */
.input-box{display:flex;flex-direction:column;gap:6px;padding:10px;background:var(--bg);border-top:1px solid #222;position:sticky;bottom:0;z-index:20;}
.input-row{display:flex;gap:8px;align-items:flex-end;}
.input-box textarea{flex:1;min-height:44px;max-height:120px;padding:12px;border-radius:22px;resize:none;color:var(--text);background:var(--bg-light);border:1px solid #333;}
.send-btn,.img-btn{width:44px;height:44px;border-radius:50%;display:flex;justify-content:center;align-items:center;font-size:18px;background:var(--accent);color:#fff;border:none;cursor:pointer;flex-shrink:0;}
.img-btn{background:var(--bg-light);color:var(--gray);}
.img-btn:hover{color:var(--text);}

/* UI Elements */
.context-menu{position:absolute;background:rgba(30,30,30,0.95);backdrop-filter:blur(10px);border:1px solid #444;border-radius:12px;display:none;flex-direction:column;z-index:1000;box-shadow:0 8px 24px rgba(0,0,0,0.5);overflow:hidden;}
.context-menu button{background:none;border:none;color:var(--text);padding:12px 16px;text-align:left;cursor:pointer;margin:0;font-weight:normal;border-radius:0;}
.context-menu button:hover{background:var(--accent);}
.ticks{font-size:12px;margin-left:4px;}
.typing-status{font-size:12px;color:var(--accent);height:14px;}
.highlight{background:rgba(0,136,204,0.3) !important;box-shadow:0 0 15px rgba(0,136,204,0.3) !important;transform:scale(1.02);transition:all .3s ease;}
.success-text { position: absolute; top: -25px; left: 0; color: #4caf50; font-size: 12px; white-space: nowrap; font-weight:bold; text-shadow: 0 1px 2px #000; }
#scroll-down-btn{position:fixed;bottom:90px;right:20px;width:40px;height:40px;border-radius:50%;background:var(--bg-light);border:1px solid #444;color:var(--text);display:none;z-index:15;cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,0.3);}

/* Loader */
.loader-container {display:flex;justify-content:center;align-items:center;padding:20px;width:100%;}
.loader {width:32px;height:32px;border:3px solid var(--bg-light);border-bottom-color:var(--accent);border-radius:50%;display:inline-block;animation:rotation 1s linear infinite;}
@keyframes rotation {0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)}}

/* Modal Overlay */
.modal-overlay {position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);backdrop-filter:blur(5px);z-index:2000;display:none;justify-content:center;align-items:center;}
.modal-box {background:#1e1e1e;padding:24px;border-radius:16px;max-width:320px;width:90%;text-align:center;box-shadow:0 10px 40px rgba(0,0,0,0.5);border:1px solid #333;}
.modal-box h3 {margin-top:0;margin-bottom:12px;}
.modal-box p {color:#aaa;font-size:14px;margin-bottom:20px;word-break:break-all;}
.modal-actions {display:flex;gap:10px;justify-content:center;}
.btn-cancel {background:#333;color:#ccc;}

/* Profile View Modal specific */
.profile-modal-img {width:100px;height:100px;border-radius:50%;object-fit:cover;margin-bottom:16px;border:3px solid var(--accent);background:#000;}
.profile-stat-row {text-align:left;margin:10px 0;font-size:14px;color:#ccc;border-bottom:1px solid #333;padding-bottom:8px;}
.profile-stat-row span {color:var(--gray);font-size:12px;display:block;}

/* Header Clickable */
.header-info { cursor:pointer; padding: 4px 8px; border-radius:8px; transition: background 0.2s; }
.header-info:hover { background: rgba(255,255,255,0.05); }

@media (max-width:520px){.msg{max-width:88%;} .modal-box{width:85%;}}
</style>
</head>
<body>

<div id="login-screen" class="screen active">
  <div style="display:flex;flex-direction:column;justify-content:center;height:100%;padding:24px;max-width:400px;margin:0 auto;width:100%;">
    <h1 style="text-align:center;color:var(--accent);margin-bottom:30px;"><i class="fa fa-comments"></i> MiniMessenger</h1>
    <input id="login-email" placeholder="Email"><br>
    <input id="login-password" type="password" placeholder="–ü–∞—Ä–æ–ª—å"><br>
    <button onclick="signIn()">–í–æ–π—Ç–∏</button>
    <button style="background:transparent;border:1px solid #333;color:var(--gray)" onclick="showRegister()">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
  </div>
</div>

<div id="register-screen" class="screen">
  <div style="display:flex;flex-direction:column;justify-content:center;height:100%;padding:24px;max-width:400px;margin:0 auto;width:100%;">
    <h2 style="text-align:center">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
    <input id="reg-email" placeholder="Email"><br>
    <input id="reg-password" type="password" placeholder="–ü–∞—Ä–æ–ª—å"><br>
    <input id="reg-username" placeholder="Username"><br>
    <button onclick="signUp()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
    <button style="background:transparent;color:var(--gray)" onclick="showLogin()">–ù–∞–∑–∞–¥</button>
  </div>
</div>

<div id="main-screen" class="screen">
  <nav>
    <img id="nav-self-avatar" class="avatar" style="width:32px;height:32px;border-radius:50%;object-fit:cover;background:#333;" onclick="openSettings()">
    <h2>–ß–∞—Ç—ã</h2>
    <div id="main-nav-buttons" style="margin-left:auto;display:flex;gap:12px;">
      <button onclick="openSearch()" style="background:none;padding:6px;margin:0;color:#fff;"><i class="fa fa-plus" style="font-size:18px"></i></button>
    </div>
  </nav>
  <div class="chat-list" id="chat-list">
    <div class="loader-container"><span class="loader"></span></div>
  </div>
</div>

<div id="search-screen" class="screen">
  <nav><button onclick="backToMain()" style="background:none;padding:0;margin:0;"><i class="fa fa-arrow-left"></i></button><h2>–ù–æ–≤—ã–π —á–∞—Ç</h2></nav>
  <div style="padding:12px">
    <input id="search-username" placeholder="–í–≤–µ–¥–∏—Ç–µ username –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" style="width:100%"><br><br>
    <button onclick="searchUser()" style="width:100%">–ù–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ</button>
  </div>
</div>

<div id="chat-screen" class="screen">
  <nav style="gap:10px;">
    <button onclick="backToMain()" style="background:none;padding:0;margin:0;width:30px;"><i class="fa fa-arrow-left"></i></button>
    <img id="chat-avatar" class="nav-avatar" src="" style="width:36px;height:36px;border-radius:50%;object-fit:cover;" onclick="openUserProfile()">
    <div class="header-info" onclick="openUserProfile()" style="display:flex;flex-direction:column;flex:1;overflow:hidden;">
      <h2 id="chat-username" style="margin:0;font-size:16px;"></h2>
      <div style="display:flex;align-items:center;gap:6px;">
        <div id="chat-status" style="color:var(--gray);font-size:12px;"></div>
        <div id="typing-status" class="typing-status"></div>
      </div>
    </div>
    <a id="call-link" target="_blank"><button class="call-btn" style="background:none;padding:8px;"><i class="fa fa-phone" style="color:var(--text)"></i></button></a>
  </nav>
  
  <div class="messages" id="messages">
    </div>
  
  <div id="preview"></div>
  <div id="reply-preview-container" style="padding:0 12px;display:none;">
    <div id="reply-preview" class="reply-preview" style="display:flex;align-items:center;background:#222;padding:8px;border-radius:8px;margin-bottom:8px;border-left:3px solid var(--accent);">
      <div class="meta" style="flex:1;font-size:13px;color:#ccc;"><strong id="reply-username" style="color:var(--accent);display:block;margin-bottom:2px;"></strong><span id="reply-text"></span></div>
      <div class="cancel" onclick="cancelReply()" style="padding:8px;cursor:pointer;"><i class="fa fa-times"></i></div>
    </div>
  </div>
  
  <div class="input-box">
    <div class="input-row">
      <button class="img-btn" onclick="triggerImageUpload()"><i class="fa fa-image"></i></button>
      <textarea id="msg-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>
      <button class="send-btn" onclick="sendMessage()"><i class="fa fa-paper-plane"></i></button>
    </div>
  </div>
  <button id="scroll-down-btn" onclick="scrollToBottom()"><i class="fa fa-arrow-down"></i></button>
</div>

<div id="settings-screen" class="screen">
  <nav><button onclick="backToMain()" style="background:none;padding:0;"><i class="fa fa-arrow-left"></i></button><h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2></nav>
  <div style="padding:24px;text-align:center;display:flex;flex-direction:column;align-items:center;">
    <img id="profile-avatar" src="" style="width:100px;height:100px;border-radius:50%;object-fit:cover;margin-bottom:16px;background:#222;">
    <button onclick="triggerAvatarUpload()" style="background:var(--bg-light);font-size:13px;padding:8px 16px;">–ò–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ</button>
    <button onclick="deleteAvatar()" style="background:transparent;color:#e53935;font-size:13px;display:none;margin-top:-6px;" id="delete-avatar-btn">–£–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ</button>
    
    <div id="profile-info" style="margin:20px 0;text-align:left;width:100%;background:var(--bg-light);padding:16px;border-radius:12px;"></div>
    
    <button onclick="logout()" style="width:100%;background:#333;margin-top:auto;">–í—ã–π—Ç–∏</button>
    <button onclick="deleteAccount()" style="width:100%;background:transparent;color:#e53935;border:1px solid #e53935;margin-top:12px;">–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
  </div>
</div>

<div id="admin-screen" class="screen">
  <nav><button onclick="backToMain()" style="background:none;padding:0;"><i class="fa fa-arrow-left"></i></button><h2>–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</h2></nav>
  <div id="user-list" style="flex:1;overflow-y:auto;padding:12px;"></div>
</div>

<div id="context-menu" class="context-menu"></div>

<input type="file" id="file-input" style="display:none;" accept="image/*">
<input type="file" id="avatar-input" style="display:none;" accept="image/*">

<div id="link-confirm-modal" class="modal-overlay">
  <div class="modal-box">
    <h3>–ü–µ—Ä–µ—Ö–æ–¥ –ø–æ —Å—Å—ã–ª–∫–µ</h3>
    <p>–í—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ –≤–Ω–µ—à–Ω–∏–π —Å–∞–π—Ç:<br><br><b id="link-target" style="color:var(--accent)"></b></p>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeLinkModal()">–û—Ç–º–µ–Ω–∞</button>
      <button onclick="confirmLinkGo()">–ü–µ—Ä–µ–π—Ç–∏</button>
    </div>
  </div>
</div>

<div id="view-profile-modal" class="modal-overlay">
  <div class="modal-box" style="text-align:left;position:relative;">
    <button onclick="closeUserProfile()" style="position:absolute;top:10px;right:10px;background:none;padding:5px;font-size:18px;color:#fff;"><i class="fa fa-times"></i></button>
    <div style="text-align:center;">
        <img id="view-profile-img" class="profile-modal-img" src="">
        <h3 id="view-profile-name" style="margin-bottom:4px;"></h3>
        <span id="view-profile-status-badge" style="font-size:12px;color:var(--accent);"></span>
    </div>
    <div style="margin-top:20px;">
        <div class="profile-stat-row">
            <span>Email</span>
            <div id="view-profile-email"></div>
        </div>
        <div class="profile-stat-row">
            <span>–°—Ç–∞—Ç—É—Å</span>
            <div id="view-profile-statustext"></div>
        </div>
        <div class="profile-stat-row">
            <span>ID</span>
            <div id="view-profile-id" style="font-family:monospace;font-size:12px;color:#666;"></div>
        </div>
    </div>
  </div>
</div>

<script>
/* ------------------ Config ------------------ */
const supabase = window.supabase.createClient(
  "https://zmewwzlzujsrhstjehrp.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InptZXd3emx6dWpzcmhzdGplaHJwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5NjM4MDksImV4cCI6MjA3MTUzOTgwOX0.kBBXwlCEl5szgK4vKgaPBhPOVYmoFzly2TXR-fI8D24"
);
uploadcare.start({ publicKey:"c12f2c3e134f56024db8" });

window.OneSignalDeferred = window.OneSignalDeferred || [];
OneSignalDeferred.push(async function(OneSignal) {
  await OneSignal.init({
    appId: "2e324874-a45f-4a70-ac36-130ef8af56a7",
    safari_web_id: "web.onesignal.auto.0d123f70-12e5-49b1-a758-f1abcc853120",
    notifyButton: { enable: true },
  });
  OneSignal.User.PushSubscription.addEventListener('change', async (event) => {
    if (currentUser) {
      const onesignalId = event.current.optedIn ? OneSignal.User.onesignalId : null;
      await supabase.from('profiles').update({ OneSignal_ID: onesignalId }).eq('id', currentUser.id);
    }
  });
});

/* ------------------ State ------------------ */
let currentUser = null;
let currentChat = null;
let currentChatOtherId = null;
let msgSubscription = null;
let chatSubscription = null;
let profileSubscription = null;
let selectedMessageId = null;
let selectedSender = null;
let selectedImageUrl = null;
let replyToMessage = null;
let selfChatId = null;
let chatSnapshot = null;
let loadedMessages = [];
let oldestMessageId = null;
let loadingMore = false;
let isAdmin = false;
let pendingLink = ""; // For link confirmation

/* ------------------ WebView Integration ------------------ */
function notifyWebViewUser(user) {
  window.webViewStringChange = user ? JSON.stringify({ userId: user.id, username: user.user_metadata.username, email: user.email }) : '';
  const event = new CustomEvent('webViewUserChange', { detail: window.webViewStringChange });
  window.dispatchEvent(event);
}

/* ------------------ UI helpers ------------------ */
function showScreen(id){ 
    document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); 
    document.getElementById(id).classList.add('active'); 
}
function showLogin(){ showScreen('login-screen'); notifyWebViewUser(null); }
function showRegister(){ showScreen('register-screen'); }
function showMain(){ loadChats(); showScreen('main-screen'); updateSelfAvatar(); }
function openSettings(){ loadProfile(); showScreen('settings-screen'); }
function openSearch(){ showScreen('search-screen'); }
function openAdmin(){ loadUsers(); showScreen('admin-screen'); }

async function updateSelfAvatar(){
    if(!currentUser) return;
    const { data } = await supabase.from('profiles').select('avatar_url').eq('id', currentUser.id).single();
    if(data && data.avatar_url) document.getElementById('nav-self-avatar').src = data.avatar_url;
}

/* ------------------ Link Handling ------------------ */
function linkify(text) {
    // 1. –°–Ω–∞—á–∞–ª–∞ —ç—Å–∫–µ–π–ø–∏–º –≤–µ—Å—å —Ç–µ–∫—Å—Ç, —á—Ç–æ–±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å XSS
    let safeText = escapeHtml(text).innerHTML; 
    // 2. –ò—â–µ–º URL –≤ —É–∂–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ–º —Ç–µ–∫—Å—Ç–µ –∏ –∑–∞–º–µ–Ω—è–µ–º –Ω–∞ —Ç–µ–≥–∏ <a>
    const urlPattern = /(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim;
    return safeText.replace(urlPattern, '<a onclick="confirmLink(\'$1\')">$1</a>');
}

function confirmLink(url) {
    pendingLink = url;
    document.getElementById('link-target').innerText = url.length > 50 ? url.substring(0,47)+'...' : url;
    document.getElementById('link-confirm-modal').style.display = 'flex';
}
function closeLinkModal() {
    document.getElementById('link-confirm-modal').style.display = 'none';
    pendingLink = "";
}
function confirmLinkGo() {
    if(pendingLink) window.open(pendingLink, '_blank');
    closeLinkModal();
}

/* ------------------ Profile Viewing ------------------ */
async function openUserProfile() {
    if(!currentChatOtherId) return; // Self chat or not loaded
    const targetId = currentChatOtherId;
    
    // Show modal with loading state first
    document.getElementById('view-profile-modal').style.display = 'flex';
    document.getElementById('view-profile-name').innerText = "–ó–∞–≥—Ä—É–∑–∫–∞...";
    document.getElementById('view-profile-img').src = "";
    
    const { data: p, error } = await supabase.from('profiles').select('*').eq('id', targetId).single();
    if(error || !p) {
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å");
        closeUserProfile();
        return;
    }

    document.getElementById('view-profile-name').innerText = p.username;
    document.getElementById('view-profile-email').innerText = p.email; // Privacy concern? Maybe hide
    document.getElementById('view-profile-statustext').innerText = p.status || "–ù–µ—Ç —Å—Ç–∞—Ç—É—Å–∞";
    document.getElementById('view-profile-id').innerText = p.id;
    document.getElementById('view-profile-status-badge').innerText = p.status === '–æ–Ω–ª–∞–π–Ω' ? '‚Ä¢ –í —Å–µ—Ç–∏' : '‚Ä¢ –ù–µ –≤ —Å–µ—Ç–∏';
    document.getElementById('view-profile-status-badge').style.color = p.status === '–æ–Ω–ª–∞–π–Ω' ? '#00ff00' : '#888';
    
    if(p.avatar_url) document.getElementById('view-profile-img').src = p.avatar_url;
    else document.getElementById('view-profile-img').src = "https://via.placeholder.com/100?text=" + p.username[0];
}

function closeUserProfile() {
    document.getElementById('view-profile-modal').style.display = 'none';
}

/* ------------------ Auth ------------------ */
async function signUp(){
  const email = document.getElementById('reg-email').value.trim();
  const password = document.getElementById('reg-password').value;
  const username = document.getElementById('reg-username').value.trim();
  if(!email || !password || !username){ alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è'); return; }
  const { data, error } = await supabase.auth.signUp({ email, password, options: { data: { username } } });
  if(error){ alert(error.message); return; }
  await supabase.from('profiles').insert([{ id: data.user.id, email, username, status:'–æ–Ω–ª–∞–π–Ω', typing:false, current_chat:null, avatar_url: null, ban: false, OneSignal_ID: null }]);
  alert('–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ email –∏ –≤–æ–π–¥–∏—Ç–µ'); showLogin();
}
async function signIn(){
  const email = document.getElementById('login-email').value.trim();
  const password = document.getElementById('login-password').value;
  if(!email || !password){ alert('–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å'); return; }
  const { data, error } = await supabase.auth.signInWithPassword({ email, password });
  if(error){ alert(error.message); return; }
  currentUser = data.user;
  const { data: profile } = await supabase.from('profiles').select('*').eq('id', currentUser.id).single();
  if (profile.ban) { await supabase.auth.signOut(); alert('–í—ã –∑–∞–±–∞–Ω–µ–Ω—ã'); return; }
  
  isAdmin = profile.email === 'timtimych18@mail.ru';
  if (isAdmin) {
    if(!document.getElementById('btn-admin')) {
        document.getElementById('main-nav-buttons').innerHTML = `<button id="btn-admin" onclick="openAdmin()" style="background:none;padding:6px;color:#fff;"><i class="fa fa-user-shield"></i></button>` + document.getElementById('main-nav-buttons').innerHTML;
    }
  }
  await supabase.from('profiles').update({ status:'–æ–Ω–ª–∞–π–Ω', current_chat:null }).eq('id', currentUser.id);
  
  // Update OneSignal
  OneSignalDeferred.push(async (OneSignal) => {
    if (OneSignal.User.PushSubscription.optedIn) {
      await supabase.from('profiles').update({ OneSignal_ID: OneSignal.User.onesignalId }).eq('id', currentUser.id);
    }
  });
  
  notifyWebViewUser(currentUser);
  showMain();
  subscribeChats();
  subscribeProfile();
}
async function logout(){
  if(currentUser){
    const nowTime = new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    const nowDate = new Date().toLocaleDateString('ru-RU');
    await supabase.from('profiles').update({ status:`–±—ã–ª(–∞) –≤ ${nowTime} ${nowDate}`, typing:false, current_chat:null, OneSignal_ID: null }).eq('id', currentUser.id);
    await supabase.auth.signOut();
    currentUser = null;
    isAdmin = false;
    notifyWebViewUser(null);
  }
  showLogin();
}
async function loadProfile(){
  if(!currentUser) return;
  const { data } = await supabase.from('profiles').select('*').eq('id', currentUser.id).single();
  document.getElementById('profile-info').innerHTML = `
    <div style="margin-bottom:8px"><b>Username:</b> ${escapeHtml(data.username).innerHTML}</div>
    <div style="margin-bottom:8px"><b>Email:</b> ${escapeHtml(data.email).innerHTML}</div>
    <div><b>–°—Ç–∞—Ç—É—Å:</b> ${escapeHtml(data.status).innerHTML}</div>
  `;
  const avatar = document.getElementById('profile-avatar');
  const deleteBtn = document.getElementById('delete-avatar-btn');
  if (data.avatar_url) {
    avatar.src = data.avatar_url;
    deleteBtn.style.display = 'inline-block';
  } else {
    avatar.src = "https://via.placeholder.com/100?text="+data.username[0];
    deleteBtn.style.display = 'none';
  }
}
async function deleteAccount(){
  if(!currentUser) return;
  if(!confirm('–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ?')) return;
  await supabase.from('profiles').delete().eq('id', currentUser.id);
  await supabase.auth.signOut();
  currentUser = null;
  notifyWebViewUser(null);
  showLogin();
}
async function deleteAvatar(){
  if(!currentUser) return;
  await supabase.from('profiles').update({ avatar_url: null }).eq('id', currentUser.id);
  loadProfile();
}
function triggerAvatarUpload(){ document.getElementById('avatar-input').click(); }
document.getElementById('avatar-input').addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  uploadcare.fileFrom('object', file).done(async (info) => {
    const { error } = await supabase.from('profiles').update({ avatar_url: info.cdnUrl }).eq('id', currentUser.id);
    if(error) alert('–û—à–∏–±–∫–∞: ' + error.message);
    else loadProfile();
  });
});

/* ------------------ Misc helpers ------------------ */
function escapeHtml(text){ const d = document.createElement('div'); d.textContent = text; return d; }
function formatTimeShort(d){ return new Date(d).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }

/* ------------------ Search / create chat ------------------ */
async function searchUser(){
  const input = document.getElementById('search-username').value.trim();
  if(!input){ alert('–í–≤–µ–¥–∏—Ç–µ username'); return; }
  const { data:userProfile, error } = await supabase.from('profiles').select('id,username').ilike('username', input).limit(1).maybeSingle();
  if(error || !userProfile){ alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω'); return; }
  
  const otherId = userProfile.id;
  let chatId = null;

  if(otherId === currentUser.id){
    const { data:existing } = await supabase.from('chats').select('id').or(`and(user1.eq.${currentUser.id},user2.eq.${currentUser.id})`).limit(1);
    if(existing?.length) chatId = existing[0].id;
    else {
        const { data:newC } = await supabase.from('chats').insert([{ user1:currentUser.id, user2:currentUser.id }]).select('id').single();
        chatId = newC.id;
    }
    openChat(chatId, '–ò–∑–±—Ä–∞–Ω–Ω–æ–µ', currentUser.id);
  } else {
    const { data:existing } = await supabase.from('chats').select('id').or(`and(user1.eq.${currentUser.id},user2.eq.${otherId}),and(user1.eq.${otherId},user2.eq.${currentUser.id})`).limit(1);
    if(existing?.length) chatId = existing[0].id;
    else {
      const { data:newC, error:cErr } = await supabase.from('chats').insert([{ user1:currentUser.id, user2:otherId }]).select('id').single();
      if(cErr){ alert(cErr.message); return; }
      chatId = newC.id;
    }
    openChat(chatId, userProfile.username, otherId);
  }
}

/* ------------------ Chat list ------------------ */
async function loadChats(){
  if(!currentUser) return;
  const list = document.getElementById('chat-list');
  // Show loader only if empty
  if(list.children.length === 0 || list.innerHTML.includes('loader')) {
      list.innerHTML = '<div class="loader-container"><span class="loader"></span></div>';
  }

  const { data:chats } = await supabase.from('chats').select('*').or(`user1.eq.${currentUser.id},user2.eq.${currentUser.id}`);
  if(!chats) return;

  const promises = chats.map(async chat => {
    const otherId = (chat.user1 === currentUser.id) ? chat.user2 : chat.user1;
    const isSelf = otherId === currentUser.id;
    let chatName = 'Unknown', avatar = null;
    
    if(isSelf){ 
        chatName = '–ò–∑–±—Ä–∞–Ω–Ω–æ–µ'; 
        const { data:profile } = await supabase.from('profiles').select('avatar_url').eq('id', currentUser.id).single();
        avatar = profile?.avatar_url;
    } else {
        const { data:profile } = await supabase.from('profiles').select('username,avatar_url').eq('id', otherId).single();
        chatName = profile?.username || 'Unknown';
        avatar = profile?.avatar_url;
    }

    const { data:msgs } = await supabase.from('messages').select('content,image_url,created_at,read').eq('chat_id', chat.id).order('created_at',{ascending:false}).limit(1);
    let lastMsgText = '', lastMsgImg=false, lastTime = '', lastCreated = 0;
    
    if(msgs && msgs.length>0){
      lastMsgText = msgs[0].content || '';
      lastMsgImg = !!msgs[0].image_url;
      lastCreated = msgs[0].created_at;
      const d = new Date(msgs[0].created_at);
      const today = new Date();
      if(d.toDateString() === today.toDateString()) lastTime = d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
      else lastTime = d.toLocaleDateString('ru-RU');
    }

    const { count } = await supabase.from('messages').select('id', { count: 'exact', head: true }).eq('chat_id', chat.id).eq('read', false).neq('sender', currentUser.id);
    
    return { chatId: chat.id, otherId, chatName, avatar, lastMsgText, lastMsgImg, lastTime, unreadCount: count || 0, lastCreated };
  });

  const chatData = await Promise.all(promises);
  chatData.sort((a,b)=> new Date(b.lastCreated) - new Date(a.lastCreated));
  
  list.innerHTML = '';
  for(const c of chatData){
    const div = document.createElement('div'); div.className='chat-item';
    
    const avatarImg = document.createElement('img'); avatarImg.className='avatar';
    avatarImg.src = c.avatar || (`https://via.placeholder.com/48?text=${c.chatName[0]}`);
    
    const info = document.createElement('div'); info.className='info';
    const name = document.createElement('div'); name.innerText = c.chatName; name.style.fontWeight='600';
    const last = document.createElement('div'); last.className = 'last';
    const msgTxt = (c.lastMsgImg ? "üñº –§–æ—Ç–æ" : "") + (c.lastMsgText ? (c.lastMsgImg ? " " : "") + c.lastMsgText : "");
    
    last.innerHTML = `<span style="overflow:hidden;white-space:nowrap;text-overflow:ellipsis;display:inline-block;max-width:180px">${escapeHtml(msgTxt).innerHTML}</span><span>${escapeHtml(c.lastTime||'').innerHTML}</span>`;
    info.appendChild(name); info.appendChild(last);
    
    div.appendChild(avatarImg);
    div.appendChild(info);
    if(c.unreadCount>0){ 
        const badge = document.createElement('div'); 
        badge.className='unread-badge'; 
        badge.innerText = c.unreadCount; 
        div.appendChild(badge); 
    }
    div.onclick = ()=> openChat(c.chatId, c.chatName, c.otherId, c.avatar);
    list.appendChild(div);
  }

  // Detect self chat ID
  const selfChat = chatData.find(c => c.otherId === currentUser.id);
  selfChatId = selfChat ? selfChat.chatId : null;
}

function subscribeChats(){
  if(chatSubscription) supabase.removeChannel(chatSubscription);
  chatSubscription = supabase.channel('chats-global')
    .on('postgres_changes', { event:'*', schema:'public', table:'chats' }, loadChats)
    .on('postgres_changes', { event:'*', schema:'public', table:'messages' }, loadChats)
    .subscribe();
}

function subscribeProfile(){
  if(profileSubscription) supabase.removeChannel(profileSubscription);
  profileSubscription = supabase.channel('profile-'+currentUser.id)
    .on('postgres_changes', { event:'UPDATE', schema:'public', table:'profiles', filter:`id=eq.${currentUser.id}` }, payload => {
      if (payload.new.ban) { supabase.auth.signOut(); alert('–í—ã –∑–∞–±–∞–Ω–µ–Ω—ã'); showLogin(); }
    }).subscribe();
}

/* ------------------ Open chat ------------------ */
async function openChat(chatId, otherName, otherId, otherAvatar = null){
  currentChat = chatId;
  currentChatOtherId = otherId;
  const isSelf = otherId === currentUser.id;
  
  document.getElementById('chat-username').innerText = isSelf ? '–ò–∑–±—Ä–∞–Ω–Ω–æ–µ' : (otherName || '–ß–∞—Ç');
  document.getElementById('chat-status').innerText = '';
  document.getElementById('typing-status').innerText = '';
  document.getElementById('call-link').style.display = isSelf ? 'none' : 'block';
  if(!isSelf) document.getElementById('call-link').href = `https://super-random.netlify.app/test/call?chat_id=${encodeURIComponent(chatId)}`;
  
  // Set Chat Avatar
  const chatAvatar = document.getElementById('chat-avatar');
  if (otherAvatar) chatAvatar.src = otherAvatar;
  else if (isSelf) {
      const { data } = await supabase.from('profiles').select('avatar_url').eq('id', currentUser.id).single();
      chatAvatar.src = data?.avatar_url || `https://via.placeholder.com/36?text=Me`;
  } else {
      chatAvatar.src = `https://via.placeholder.com/36?text=${otherName?otherName[0]:'U'}`;
  }
  
  showScreen('chat-screen');
  
  // Update UI immediately to show loader
  document.getElementById('messages').innerHTML = '<div class="loader-container"><span class="loader"></span></div>';

  try{ await supabase.from('profiles').update({ current_chat: chatId }).eq('id', currentUser.id); } catch(e){}
  
  loadedMessages = [];
  oldestMessageId = null;
  await loadMessages(true);

  // Subscribe to messages
  if(msgSubscription) supabase.removeChannel(msgSubscription);
  msgSubscription = supabase.channel('room-'+chatId)
    .on('postgres_changes', { event:'INSERT', schema:'public', table:'messages', filter:`chat_id=eq.${chatId}` }, p => renderMessage(p.new, true))
    .on('postgres_changes', { event:'UPDATE', schema:'public', table:'messages', filter:`chat_id=eq.${chatId}` }, p => renderMessage(p.new, false))
    .subscribe();

  // Subscribe to status
  if(otherId && !isSelf){
    if(window.statusChannelOther) supabase.removeChannel(window.statusChannelOther);
    window.statusChannelOther = supabase.channel('status-'+otherId)
      .on('postgres_changes', { event:'UPDATE', schema:'public', table:'profiles', filter:`id=eq.${otherId}` }, p=>{
        document.getElementById('chat-status').innerText = formatStatus(p.new);
        document.getElementById('typing-status').innerText = p.new.typing ? '–ø–µ—á–∞—Ç–∞–µ—Ç...' : '';
      }).subscribe();
    const { data:profile } = await supabase.from('profiles').select('*').eq('id', otherId).single();
    if(profile) document.getElementById('chat-status').innerText = formatStatus(profile);
  }

  // Mark as read
  await supabase.from('messages').update({ read:true }).eq('chat_id', chatId).neq('sender', currentUser.id).eq('read', false);
  
  const box = document.getElementById('messages');
  box.onscroll = () => {
    if (box.scrollTop === 0 && !loadingMore && oldestMessageId) loadMoreMessages();
    toggleScrollDownBtn();
  };
}

async function loadMessages(initial = false){
  if(!currentChat) return;
  const limit = 50;
  let query = supabase.from('messages').select('*').eq('chat_id', currentChat);
  if (!initial) query = query.lt('id', oldestMessageId);
  query = query.order('created_at', {ascending: false}).limit(limit);
  
  const { data } = await query;
  if (!data) return;

  const messages = data.reverse();
  if (!initial) loadedMessages = messages.concat(loadedMessages);
  else loadedMessages = messages;

  if (messages.length > 0) oldestMessageId = messages[0].id;

  const box = document.getElementById('messages');
  if (initial) box.innerHTML = ''; // Clear loader

  let firstUnreadId = null;
  if(initial) {
      const unread = loadedMessages.find(m => !m.read && m.sender !== currentUser.id);
      if(unread) firstUnreadId = unread.id;
  }

  for(const msg of messages){
    if(firstUnreadId && msg.id === firstUnreadId){
      const sep = document.createElement('div'); sep.className = 'unread-sep'; sep.id='unread-sep'; sep.innerText='–ù–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è';
      sep.style.textAlign='center';sep.style.color='var(--accent)';sep.style.fontSize='12px';sep.style.margin='10px 0';
      initial ? box.appendChild(sep) : box.insertBefore(sep, box.firstChild);
    }
    await renderMessage(msg, false, initial ? 'append' : 'prepend');
  }

  if (initial) {
    if(firstUnreadId){
        document.getElementById('unread-sep')?.scrollIntoView({ behavior:'auto', block:'center' });
    } else {
        box.scrollTop = box.scrollHeight;
    }
  }
}

async function loadMoreMessages() {
  loadingMore = true;
  const box = document.getElementById('messages');
  const h = box.scrollHeight;
  await loadMessages(false);
  box.scrollTop = box.scrollHeight - h;
  loadingMore = false;
}

function toggleScrollDownBtn() {
  const box = document.getElementById('messages');
  const btn = document.getElementById('scroll-down-btn');
  if (box.scrollTop + box.clientHeight < box.scrollHeight - 100) btn.style.display = 'flex';
  else btn.style.display = 'none';
}
function scrollToBottom() { document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight; }

async function renderMessage(msg, scroll=true, mode='append'){
  const box = document.getElementById('messages');
  let div = document.getElementById('msg-'+msg.id);
  const isMe = msg.sender === currentUser.id;

  if(!div){
    div = document.createElement('div');
    div.id = 'msg-'+msg.id;
    div.className = 'msg ' + (isMe ? 'me' : 'other');
    div.oncontextmenu = (e)=>{ e.preventDefault(); showContextMenu(e, msg.id, msg.sender, msg.image_url); };
    mode === 'prepend' ? box.insertBefore(div, box.firstChild) : box.appendChild(div);
  } else {
    div.className = 'msg ' + (isMe ? 'me' : 'other');
  }

  if(msg.is_deleted){
    div.className='msg deleted'; div.innerText='–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ';
    return;
  }

  let html = '';
  if(msg.reply_to){
      // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –ª—É—á—à–µ –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å —é–∑–µ—Ä–Ω–µ–π–º—ã, –∑–¥–µ—Å—å –¥–µ–ª–∞–µ–º –¥–æ–ø—É—â–µ–Ω–∏–µ
      const r = loadedMessages.find(m=>m.id === msg.reply_to);
      let rText = r ? (r.content || (r.image_url ? '–§–æ—Ç–æ' : '...')) : '...';
      html += `<div class="reply-to" onclick="scrollToMsg(${msg.reply_to})">–û—Ç–≤–µ—Ç: ${escapeHtml(rText.substring(0,50)).innerHTML}</div>`;
  }

  // --- LINK PARSING APPLIED HERE ---
  if(msg.content) html += `<div>${linkify(msg.content)}</div>`;
  if(msg.image_url) html += `<img src="${escapeHtml(msg.image_url).innerHTML}" class="msg-img" onclick="window.open(this.src)">`;

  let ticks = '';
  if(isMe){
    ticks = (currentChat === selfChatId || msg.read) ? '<i class="fa fa-check-double ticks"></i>' : '<i class="fa fa-check ticks"></i>';
  }
  
  html += `<span class="time">${formatTimeShort(msg.created_at)} ${ticks}</span>`;
  div.innerHTML = html;

  if(scroll) scrollToBottom();
}

function scrollToMsg(id){
    const el = document.getElementById('msg-'+id);
    if(el){ el.scrollIntoView({behavior:'smooth', block:'center'}); el.classList.add('highlight'); setTimeout(()=>el.classList.remove('highlight'),1000); }
}

async function sendMessage(){
  const text = document.getElementById('msg-input').value.trim();
  if(!text && !selectedImageUrl) return;
  if(!currentChat) return;
  const payload = {
    chat_id: currentChat, sender: currentUser.id, content: text || null,
    image_url: selectedImageUrl || null, reply_to: replyToMessage?.id || null, read: false
  };
  
  // Optimistic UI for text messages could be added here, but Supabase is fast enough usually
  const { data:inserted, error } = await supabase.from('messages').insert([payload]).select('*').single();
  if(error){ alert('–û—à–∏–±–∫–∞: '+error.message); return; }

  // Push Logic
  if (currentChatOtherId && currentChat !== selfChatId) {
    try {
      const { data: other } = await supabase.from('profiles').select('OneSignal_ID').eq('id', currentChatOtherId).single();
      if (other?.OneSignal_ID) {
        fetch('https://api.onesignal.com/notifications', {
          method: 'POST',
          headers: { 'Content-Type':'application/json', 'Authorization':'Basic os_v2_app_fyzeq5fel5fhblbwcmhprl2wu6lmvbhhg2yusnurzqbdl26s4nvjpkdyi5ku5j6m7yp24ajpxutjl6vxfh5gdrfqcvd2f3zblof5vya' },
          body: JSON.stringify({
            app_id: "2e324874-a45f-4a70-ac36-130ef8af56a7",
            include_aliases: { onesignal_id: [other.OneSignal_ID] },
            target_channel: "push",
            headings: { en: currentUser.user_metadata?.username || '–°–æ–æ–±—â–µ–Ω–∏–µ' },
            contents: { en: text || (selectedImageUrl ? '–§–æ—Ç–æ' : '–°–æ–æ–±—â–µ–Ω–∏–µ') }
          })
        });
      }
    } catch(e){}
  }

  // Animation Success
  const msgDiv = document.getElementById('msg-'+inserted.id);
  if(msgDiv){
      const s = document.createElement('div'); s.className='success-text'; s.innerText='–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ';
      msgDiv.appendChild(s);
      setTimeout(()=>s.remove(), 2000);
  }

  // Reset Input
  document.getElementById('msg-input').value = '';
  selectedImageUrl = null; replyToMessage = null;
  document.getElementById('preview').innerHTML = '';
  document.getElementById('reply-preview-container').style.display = 'none';
}

function triggerImageUpload(){ document.getElementById('file-input').click(); }
document.getElementById('file-input').addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;
  uploadcare.fileFrom('object', file).done(info => {
    selectedImageUrl = info.cdnUrl;
    document.getElementById('preview').innerHTML = `<img src="${selectedImageUrl}" style="max-height:100px;border-radius:10px;margin:10px">`;
  });
});

/* ------------------ Context Menu & Actions ------------------ */
async function showContextMenu(e, msgId, senderId, imageUrl){
  selectedMessageId = msgId; selectedSender = senderId;
  const menu = document.getElementById('context-menu');
  menu.innerHTML = `<button onclick="copyMessage()"><i class="fa fa-copy"></i> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button><button onclick="replyMessage()"><i class="fa fa-reply"></i> –û—Ç–≤–µ—Ç–∏—Ç—å</button>`;
  if(senderId === currentUser.id) menu.innerHTML += `<button onclick="confirmDelete()"><i class="fa fa-trash"></i> –£–¥–∞–ª–∏—Ç—å</button>`;
  if(imageUrl) menu.innerHTML += `<button onclick="downloadImage('${imageUrl}')"><i class="fa fa-download"></i> –°–∫–∞—á–∞—Ç—å</button>`;
  
  // Position adjustment
  let x = e.pageX, y = e.pageY;
  if(y + 150 > window.innerHeight) y -= 150; 
  if(x + 150 > window.innerWidth) x -= 150;
  
  menu.style.left = x + 'px'; menu.style.top = y + 'px'; menu.style.display = 'flex';
}
function copyMessage(){
    const el = document.getElementById('msg-'+selectedMessageId);
    if(el) navigator.clipboard.writeText(el.innerText);
    hideContext();
}
async function confirmDelete(){
    if(!selectedMessageId) return;
    await supabase.from('messages').update({ is_deleted: true }).eq('id', selectedMessageId).eq('sender', currentUser.id);
    hideContext();
}
function replyMessage(){
    const el = document.getElementById('msg-'+selectedMessageId);
    if(!el) return;
    replyToMessage = { id: selectedMessageId };
    document.getElementById('reply-preview-container').style.display='block';
    document.getElementById('reply-username').innerText = "–û—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ";
    document.getElementById('reply-text').innerText = el.innerText.substring(0,30)+'...';
    hideContext();
}
function cancelReply(){ replyToMessage = null; document.getElementById('reply-preview-container').style.display='none'; }
function hideContext(){ document.getElementById('context-menu').style.display='none'; }
window.onclick = (e) => { if(!e.target.closest('.msg')) hideContext(); };

document.getElementById('msg-input').addEventListener('input', async ()=>{
  if(!currentUser) return;
  await supabase.from('profiles').update({ typing:true }).eq('id', currentUser.id);
  clearTimeout(window.typingTimeout);
  window.typingTimeout = setTimeout(async ()=> await supabase.from('profiles').update({ typing:false }).eq('id', currentUser.id), 1500);
});

/* ------------------ Admin ------------------ */
async function loadUsers(){
  const { data:users } = await supabase.from('profiles').select('*');
  const list = document.getElementById('user-list');
  list.innerHTML = '';
  users.forEach(u => {
    const d = document.createElement('div'); d.style.padding='10px'; d.style.borderBottom='1px solid #333';
    d.innerHTML = `<div><b>${escapeHtml(u.username).innerHTML}</b> (${u.email})</div><div style="font-size:12px;color:var(--gray)">ID: ${u.id}</div>`;
    const btn = document.createElement('button');
    btn.innerText = u.ban ? '–†–∞–∑–±–∞–Ω–∏—Ç—å' : '–ó–∞–±–∞–Ω–∏—Ç—å';
    btn.style.background = u.ban ? 'green' : 'red';
    btn.onclick = async () => { await supabase.from('profiles').update({ ban: !u.ban }).eq('id', u.id); loadUsers(); };
    d.appendChild(btn);
    list.appendChild(d);
  });
}
function formatStatus(p){ return p ? (p.typing ? '–ø–µ—á–∞—Ç–∞–µ—Ç...' : (p.status || '')) : ''; }

window.addEventListener('load', async ()=>{
  const { data:{ session } } = await supabase.auth.getSession();
  if(session){ 
    currentUser = session.user; 
    const { data: profile } = await supabase.from('profiles').select('*').eq('id', currentUser.id).single();
    if(profile.ban){ await supabase.auth.signOut(); showLogin(); return; }
    
    isAdmin = profile.email === 'timtimych18@mail.ru';
    if (isAdmin) document.getElementById('main-nav-buttons').innerHTML = `<button id="btn-admin" onclick="openAdmin()" style="background:none;padding:6px;color:#fff;"><i class="fa fa-user-shield"></i></button>` + document.getElementById('main-nav-buttons').innerHTML;
    
    OneSignalDeferred.push(async (OneSignal) => {
      if (OneSignal.User.PushSubscription.optedIn) await supabase.from('profiles').update({ OneSignal_ID: OneSignal.User.onesignalId }).eq('id', currentUser.id);
    });
    
    notifyWebViewUser(currentUser);
    showMain(); subscribeChats(); subscribeProfile();
  }
});
function backToMain(){
  if(msgSubscription) supabase.removeChannel(msgSubscription);
  if(window.statusChannelOther) supabase.removeChannel(window.statusChannelOther);
  if(currentUser) supabase.from('profiles').update({ current_chat:null }).eq('id', currentUser.id);
  currentChat = null;
  showMain();
}
</script>
</body>
</html>
