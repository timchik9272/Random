<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Messenger</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    :root {
      --bg-dark: #121212;
      --bg-light: #1E1E1E;
      --accent: #3B82F6;
      --text: #E5E5E5;
      --radius: 12px;
    }
    body {
      margin:0; font-family:sans-serif;
      background:var(--bg-dark); color:var(--text);
      height:100vh; display:flex; flex-direction:column;
    }
    header {
      padding:12px; background:var(--bg-light);
      text-align:center; font-size:20px; font-weight:bold;
    }
    .screen { display:none; flex:1; flex-direction:column; }
    .active { display:flex; }
    input, button {
      padding:14px 20px; font-size:16px; margin:8px 0;
      border-radius:var(--radius); border:none;
    }
    input { width:100%; box-sizing:border-box; }
    button {
      background:var(--accent); color:white; font-weight:bold;
      cursor:pointer;
    }
    button:active { opacity:0.7; }
    #chat-list, #messages { flex:1; overflow-y:auto; padding:10px; }
    .chat-item {
      padding:14px; background:var(--bg-light);
      margin:6px 0; border-radius:var(--radius);
      cursor:pointer;
    }
    .msg {
      padding:10px; margin:6px 0; border-radius:var(--radius);
      max-width:70%;
      word-wrap:break-word;
    }
    .me { background:var(--accent); align-self:flex-end; }
    .other { background:#333; align-self:flex-start; }
    .deleted { font-style:italic; opacity:0.6; }
    #msg-input-area {
      display:flex; padding:10px; background:var(--bg-light);
    }
    #msg-input {
      flex:1; padding:10px; border-radius:var(--radius);
      border:none; font-size:16px;
    }
    #send-btn {
      margin-left:8px; padding:0 16px; font-size:16px;
    }
    .context-menu {
      position:absolute;
      background:var(--bg-light);
      border:1px solid #333;
      border-radius:8px;
      display:none;
      flex-direction:column;
      z-index:1000;
      min-width:140px;
    }
    .context-menu button {
      background:none; border:none; color:var(--text);
      padding:12px 16px; text-align:left; width:100%;
      font-size:15px;
    }
    .context-menu button:hover { background:#222; }
  </style>
</head>
<body>
  <header id="header">Messenger</header>

  <!-- Login/Register -->
  <div id="auth-screen" class="screen active">
    <div style="padding:20px; flex:1; display:flex; flex-direction:column; justify-content:center;">
      <h2>Вход / Регистрация</h2>
      <input id="email" type="email" placeholder="Email">
      <input id="password" type="password" placeholder="Пароль">
      <button onclick="signIn()">Войти</button>
      <button onclick="signUp()">Регистрация</button>
    </div>
  </div>

  <!-- Chat list -->
  <div id="chat-screen" class="screen">
    <div style="padding:10px;">
      <button onclick="showNewChat()">+ Новый чат</button>
      <button onclick="showSettings()">⚙️ Настройки</button>
    </div>
    <div id="chat-list"></div>
  </div>

  <!-- Messages -->
  <div id="messages-screen" class="screen">
    <div id="messages"></div>
    <div id="msg-input-area">
      <input id="msg-input" placeholder="Введите сообщение...">
      <button id="send-btn" onclick="sendMessage()">➤</button>
    </div>
  </div>

  <!-- Settings -->
  <div id="settings-screen" class="screen">
    <div style="padding:20px;">
      <h3>Настройки</h3>
      <p id="user-info"></p>
      <button onclick="logout()">Выйти</button>
    </div>
  </div>

  <!-- New Chat -->
  <div id="newchat-screen" class="screen">
    <div style="padding:20px;">
      <h3>Новый чат</h3>
      <input id="newchat-username" placeholder="Введите юзернейм">
      <button onclick="createChat()">Создать</button>
      <button onclick="backToChats()">Назад</button>
    </div>
  </div>

  <!-- Context Menu -->
  <div id="context-menu" class="context-menu">
    <button id="copy-btn" onclick="copyMessage()">Копировать</button>
    <button id="delete-btn" onclick="confirmDelete()">Удалить сообщение</button>
  </div>

<script>
const supabase = window.supabase.createClient(
  "https://zmewwzlzujsrhstjehrp.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InptZXd3emx6dWpzcmhzdGplaHJwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5NjM4MDksImV4cCI6MjA3MTUzOTgwOX0.kBBXwlCEl5szgK4vKgaPBhPOVYmoFzly2TXR-fI8D24"
);

let currentUser=null;
let currentChat=null;
let selectedMessageId=null;
let selectedMessageSender=null;

function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

async function signIn(){
  const {error, data} = await supabase.auth.signInWithPassword({
    email:document.getElementById('email').value,
    password:document.getElementById('password').value
  });
  if(error){alert(error.message);return;}
  currentUser=data.user;
  afterLogin();
}

async function signUp(){
  const {error, data} = await supabase.auth.signUp({
    email:document.getElementById('email').value,
    password:document.getElementById('password').value
  });
  if(error){alert(error.message);return;}
  alert("Подтвердите email перед входом");
}

async function afterLogin(){
  const {data:{user}}=await supabase.auth.getUser();
  currentUser=user;
  if(!currentUser){showScreen('auth-screen');return;}
  loadChats();
  showScreen('chat-screen');
}

async function logout(){
  await supabase.auth.signOut();
  currentUser=null;
  showScreen('auth-screen');
}

async function loadChats(){
  const {data}=await supabase.from('chats')
    .select('*')
    .or(`user1.eq.${currentUser.id},user2.eq.${currentUser.id}`);
  renderChatList(data||[]);
}

function renderChatList(chats){
  const list=document.getElementById('chat-list');
  list.innerHTML="";
  chats.forEach(c=>{
    let otherId=(c.user1===currentUser.id)?c.user2:c.user1;
    let item=document.createElement('div');
    item.className='chat-item';
    item.innerText=c.id===`fav-${currentUser.id}`?'Избранное':otherId;
    item.onclick=()=>openChat(c);
    list.appendChild(item);
  });
}

function showSettings(){
  document.getElementById('user-info').innerText="Ваш ID: "+currentUser.id;
  showScreen('settings-screen');
}
function showNewChat(){ showScreen('newchat-screen'); }
function backToChats(){ showScreen('chat-screen'); }

async function createChat(){
  const uname=document.getElementById('newchat-username').value.trim();
  if(!uname)return;
  if(uname===currentUser.email){alert("Нельзя создать чат с самим собой");return;}
  // проверка существует ли чат
  const {data:users}=await supabase.from('profiles').select('id').eq('username',uname);
  if(!users||users.length===0){alert("Пользователь не найден");return;}
  const other=users[0].id;
  let {data:existing}=await supabase.from('chats')
    .select('*')
    .or(`and(user1.eq.${currentUser.id},user2.eq.${other}),and(user1.eq.${other},user2.eq.${currentUser.id})`);
  if(existing&&existing.length){alert("Чат уже существует");return;}
  await supabase.from('chats').insert([{user1:currentUser.id,user2:other}]);
  loadChats();
  showScreen('chat-screen');
}

async function openChat(chat){
  currentChat=chat;
  document.getElementById('messages').innerHTML="";
  showScreen('messages-screen');
  loadMessages(chat.id);
  subscribeMessages(chat.id);
}

async function loadMessages(chatId){
  const {data}=await supabase.from('messages').select('*').eq('chat',chatId).order('created_at',{ascending:true});
  (data||[]).forEach(renderMessage);
}

function renderMessage(msg){
  const box=document.getElementById('messages');
  let div=document.getElementById('msg-'+msg.id);
  if(!div){
    div=document.createElement('div');
    div.id='msg-'+msg.id;
    div.className='msg '+(msg.sender===currentUser.id?'me':'other');
    div.oncontextmenu=(e)=>{e.preventDefault();showContextMenu(e,msg.id,msg.sender);};
    let pressTimer;
    div.addEventListener("touchstart",(e)=>{
      pressTimer=setTimeout(()=>showContextMenu(e.touches[0],msg.id,msg.sender),600);
    });
    div.addEventListener("touchend",()=>clearTimeout(pressTimer));
    box.appendChild(div);
  }
  if(msg.is_deleted){
    div.className='msg deleted';
    div.innerText='Сообщение удалено';
  }else{
    div.innerText=msg.content;
  }
  box.scrollTop=box.scrollHeight;
}

async function sendMessage(){
  if(!currentChat)return;
  const input=document.getElementById('msg-input');
  let text=input.value.trim();
  if(!text)return;
  input.value="";
  await supabase.from('messages').insert([{chat:currentChat.id,sender:currentUser.id,content:text}]);
}

function subscribeMessages(chatId){
  supabase.channel('msgs'+chatId)
    .on('postgres_changes',{event:'INSERT',schema:'public',table:'messages',filter:`chat=eq.${chatId}`},payload=>renderMessage(payload.new))
    .on('postgres_changes',{event:'UPDATE',schema:'public',table:'messages',filter:`chat=eq.${chatId}`},payload=>renderMessage(payload.new))
    .subscribe();
}

function showContextMenu(e,msgId,senderId){
  selectedMessageId=msgId;
  selectedMessageSender=senderId;
  const menu=document.getElementById('context-menu');
  const deleteBtn=document.getElementById('delete-btn');
  if(senderId!==currentUser.id){
    deleteBtn.style.display="none";
  }else{
    deleteBtn.style.display="block";
  }
  menu.style.left=e.pageX+'px';
  menu.style.top=e.pageY+'px';
  menu.style.display='flex';
}
window.onclick=()=>{document.getElementById('context-menu').style.display='none';};

async function confirmDelete(){
  if(!selectedMessageId)return;
  await supabase.from('messages')
    .update({is_deleted:true})
    .eq('id',selectedMessageId)
    .eq('sender',currentUser.id);
  selectedMessageId=null;
}

function copyMessage(){
  if(!selectedMessageId)return;
  const el=document.getElementById('msg-'+selectedMessageId);
  if(el){
    navigator.clipboard.writeText(el.innerText);
  }
  selectedMessageId=null;
}

afterLogin();
</script>
</body>
</html>
