<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>MiniMessenger</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
:root { --bg:#0e0e0e; --bg-light:#1e1e1e; --accent:#0088cc; --text:#fff; --gray:#888; --radius:14px;}
body{margin:0;font-family:sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}
.screen{display:none;flex-direction:column;height:100vh;}
.active{display:flex;}
input,textarea,button{border:none;border-radius:var(--radius);font-size:15px;}
input,textarea{background:var(--bg-light);color:var(--text);padding:10px;}
button{background:var(--accent);color:#fff;padding:10px 12px;font-weight:bold;margin:6px 0;}
nav{display:flex;align-items:center;gap:12px;padding:8px;background:var(--bg);position:sticky;top:0;z-index:10;border-bottom:1px solid #222;}
.chat-list,.messages{flex:1;overflow-y:auto;}
.chat-item{padding:12px;border-bottom:1px solid #222;cursor:pointer;display:flex;justify-content:space-between;align-items:center;}
.chat-item .info{display:flex;flex-direction:column;flex:1;}
.chat-item .last{display:flex;justify-content:space-between;align-items:center;margin-top:4px;font-size:13px;color:var(--gray);}
.unread-badge{background:var(--accent);color:#fff;border-radius:50%;min-width:22px;height:22px;display:flex;justify-content:center;align-items:center;font-size:12px;}
.msg{margin:6px 10px;padding:10px 14px;border-radius:var(--radius);max-width:75%;position:relative;border:1px solid #222;word-wrap:break-word;}
.msg.me{background:var(--accent);margin-left:auto;}
.msg.other{background:var(--bg-light);}
.msg.deleted{font-style:italic;color:var(--gray);}
.msg .reply-to{font-size:13px;color:var(--gray);margin-bottom:6px;border-left:2px solid var(--gray);padding-left:8px;cursor:pointer;display:block;}
.time{display:block;font-size:12px;margin-top:6px;text-align:right;}
.me .time{color:#fff;} .other .time{color:var(--gray);}
img.msg-img,video.msg-video{max-width:100%;border-radius:var(--radius);margin-top:6px;display:block;cursor:pointer;}
.input-box{display:flex;flex-direction:column;gap:6px;padding:8px;background:var(--bg);border-top:1px solid #222;position:sticky;bottom:0;}
.input-row{display:flex;gap:6px;align-items:flex-end;}
.input-box textarea{flex:1;min-height:44px;max-height:140px;padding:12px;border-radius:12px;resize:none;}
.send-btn,.img-btn{width:44px;height:44px;border-radius:50%;display:flex;justify-content:center;align-items:center;font-size:16px;background:var(--accent);color:#fff;border:none;cursor:pointer;}
#preview img,#preview video{max-width:140px;border-radius:var(--radius);margin:6px;cursor:pointer;}
.context-menu{position:absolute;background:var(--bg-light);border:1px solid #333;border-radius:8px;display:none;flex-direction:column;z-index:1000;}
.context-menu button{background:none;border:none;color:var(--text);padding:10px 14px;text-align:left;}
.context-menu button:hover{background:#222;}
.ticks{font-size:14px;margin-left:4px;}
.typing-status{font-size:12px;color:var(--gray);}
.unread-separator{text-align:center;color:var(--accent);font-size:13px;margin:10px 0;border-top:1px dashed var(--gray);border-bottom:1px dashed var(--gray);padding:4px 0;}
.reply-preview{display:flex;align-items:center;gap:8px;padding:8px;border-radius:10px;background:#111;margin-bottom:6px;border:1px solid #222;}
.reply-preview .meta{font-size:13px;color:var(--gray);flex:1;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;}
.reply-preview .meta strong{color:var(--gray);font-weight:600;margin-right:6px;}
.reply-preview .cancel{cursor:pointer;padding:6px;border-radius:8px;background:#222;}
.reply-preview .cancel:hover{background:#333;}
.reply-to:hover{background:rgba(255,255,255,0.02);border-radius:8px;padding:6px;}
.modal-bg{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);display:none;justify-content:center;align-items:center;z-index:2000;}
.modal-content{position:relative;max-width:90%;max-height:90%;display:flex;flex-direction:column;align-items:center;}
.modal-content img,.modal-content video{max-width:100%;max-height:80vh;border-radius:12px;}
.modal-close{position:absolute;top:10px;right:10px;font-size:24px;color:#fff;cursor:pointer;}
.modal-download{position:absolute;bottom:10px;right:10px;font-size:20px;color:#fff;cursor:pointer;background:#222;padding:6px;border-radius:6px;}
</style>
</head>
<body>

<!-- Вход -->
<div id="login-screen" class="screen active">
  <h2 style="padding:12px">Вход</h2>
  <div style="padding:12px">
    <input id="login-email" placeholder="Email"><br><br>
    <input id="login-password" type="password" placeholder="Пароль"><br><br>
    <button onclick="signIn()">Войти</button>
    <button style="background:var(--bg-light)" onclick="showRegister()">Создать аккаунт</button>
  </div>
</div>

<!-- Регистрация -->
<div id="register-screen" class="screen">
  <h2 style="padding:12px">Регистрация</h2>
  <div style="padding:12px">
    <input id="reg-email" placeholder="Email"><br><br>
    <input id="reg-password" type="password" placeholder="Пароль"><br><br>
    <input id="reg-username" placeholder="Username"><br><br>
    <button onclick="signUp()">Зарегистрироваться</button>
    <button style="background:var(--bg-light)" onclick="showLogin()">Назад</button>
  </div>
</div>

<!-- Главный экран -->
<div id="main-screen" class="screen">
  <nav><h2>Чаты</h2>
    <div>
      <button onclick="openSearch()"><i class="fa fa-plus"></i></button>
      <button onclick="openSettings()"><i class="fa fa-gear"></i></button>
    </div>
  </nav>
  <div class="chat-list" id="chat-list"></div>
</div>

<!-- Новый чат -->
<div id="search-screen" class="screen">
  <nav><button onclick="backToMain()"><i class="fa fa-arrow-left"></i></button><h2>Новый чат</h2></nav>
  <div style="padding:12px"><input id="search-username" placeholder="Введите username"><br><br><button onclick="searchUser()">Создать чат</button></div>
</div>

<!-- Чат -->
<div id="chat-screen" class="screen">
  <nav style="gap:12px;">
    <button onclick="backToMain()"><i class="fa fa-arrow-left"></i></button>
    <div style="display:flex;flex-direction:column;">
      <h2 id="chat-username" style="margin:0;"></h2>
      <div id="chat-status" style="color:var(--gray);font-size:13px;"></div>
      <div id="typing-status" class="typing-status"></div>
    </div>
  </nav>
  <div class="messages" id="messages"></div>
  <div id="preview"></div>
  <div id="reply-preview-container" style="padding:0 8px;display:none;">
    <div id="reply-preview" class="reply-preview">
      <div class="meta"><strong id="reply-username"></strong><span id="reply-text"></span></div>
      <div class="cancel" title="Отменить ответ" onclick="cancelReply()"><i class="fa fa-times"></i></div>
    </div>
  </div>
  <div class="input-box">
    <div class="input-row">
      <textarea id="msg-input" placeholder="Сообщение..."></textarea>
      <button class="img-btn" onclick="chooseFile('image')" title="Отправить картинку"><i class="fa fa-image"></i></button>
      <button class="img-btn" onclick="chooseFile('video')" title="Отправить видео"><i class="fa fa-video"></i></button>
      <button class="send-btn" onclick="sendMessage()" title="Отправить"><i class="fa fa-paper-plane"></i></button>
    </div>
  </div>
</div>

<!-- Настройки -->
<div id="settings-screen" class="screen">
  <nav><button onclick="backToMain()"><i class="fa fa-arrow-left"></i></button><h2>Настройки</h2></nav>
  <div style="padding:12px"><div id="profile-info"></div><br>
    <button onclick="deleteAccount()" style="background:#c00">Удалить аккаунт</button>
    <button onclick="logout()" style="background:var(--bg-light)">Выйти</button></div>
</div>

<!-- Контекстное меню -->
<div id="context-menu" class="context-menu">
  <button onclick="copyMessage()">Копировать</button>
  <button onclick="confirmDelete()">Удалить</button>
  <button onclick="replyMessage()">Ответить</button>
</div>

<!-- Модальное окно для медиа -->
<div class="modal-bg" id="media-modal">
  <div class="modal-content">
    <span class="modal-close" onclick="closeMediaModal()">&times;</span>
    <a class="modal-download" id="media-download" href="#" download><i class="fa fa-download"></i></a>
    <img id="modal-img" style="display:none;">
    <video id="modal-video" style="display:none;" controls></video>
  </div>
</div>

<script>
const supabase = window.supabase.createClient(
  "https://zmewwzlzujsrhstjehrp.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InptZXd3emx6dWpzcmhzdGplaHJwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5NjM4MDksImV4cCI6MjA3MTUzOTgwOX0.kBBXwlCEl5szgK4vKgaPBhPOVYmoFzly2TXR-fI8D24"
);
uploadcare.start({ publicKey:"c12f2c3e134f56024db8" });

let currentUser=null,currentChat=null,msgSubscription=null,chatSubscription=null;
let selectedMessageId=null,selectedSender=null,selectedMediaUrl=null,replyToMessage=null;

/* --- Экраны --- */
function showScreen(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');}
function showLogin(){showScreen('login-screen');}
function showRegister(){showScreen('register-screen');}
function showMain(){loadChats();showScreen('main-screen');}
function openSettings(){loadProfile();showScreen('settings-screen');}
function openSearch(){showScreen('search-screen');}
function backToMain(){if(msgSubscription) supabase.removeChannel(msgSubscription);showMain();}

/* --- Аутентификация --- */
async function signUp(){
  const email=document.getElementById('reg-email').value,password=document.getElementById('reg-password').value,username=document.getElementById('reg-username').value;
  const { data,error }=await supabase.auth.signUp({ email,password,options:{ data:{username} }});
  if(error){alert(error.message);return;}
  await supabase.from('profiles').insert([{ id:data.user.id,email,username,status:'онлайн',typing:false }]);
  alert("Подтвердите email и войдите");showLogin();
}
async function signIn(){
  const email=document.getElementById('login-email').value,password=document.getElementById('login-password').value;
  const { data,error }=await supabase.auth.signInWithPassword({ email,password });
  if(error){alert(error.message);return;}
  currentUser=data.user;
  await supabase.from('profiles').update({status:'онлайн'}).eq('id',currentUser.id);
  showMain();subscribeChats();
}
async function logout(){
  await supabase.from('profiles').update({status:`был(а) в ${new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})} ${new Date().toLocaleDateString('ru-RU')}`,typing:false}).eq('id',currentUser.id);
  await supabase.auth.signOut();currentUser=null;showLogin();
}
async function loadProfile(){
  const { data }=await supabase.from('profiles').select('*').eq('id',currentUser.id).single();
  document.getElementById('profile-info').innerText=`Username: ${data.username}\nEmail: ${data.email}\nСтатус: ${data.status}`;
}
async function deleteAccount(){await supabase.from('profiles').delete().eq('id',currentUser.id);logout();}

/* --- Чаты --- */
async function loadChats(){
  const { data:chats }=await supabase.from('chats').select('*').or(`user1.eq.${currentUser.id},user2.eq.${currentUser.id}`);
  const list=document.getElementById('chat-list');list.innerHTML='';
  if(!chats) return;
  let chatData=[];
  for(const chat of chats){
    let chatName=""; let otherId=null;
    if(chat.user1===chat.user2){chatName="Избранное"; otherId=currentUser.id;}
    else{otherId=chat.user1===currentUser.id?chat.user2:chat.user1; const { data:profile }=await supabase.from('profiles').select('username').eq('id',otherId).single();chatName=profile?.username || 'Unknown';}
    const { data:msgs }=await supabase.from('messages').select('*').eq('chat_id',chat.id).order('created_at',{ascending:false}).limit(1);
    let lastMsgText="",lastMsgImg=false,lastTime="";
    if(msgs && msgs.length>0){
      lastMsgText=msgs[0].content||"";
      lastMsgImg=!!msgs[0].image_url;
      const d=new Date(msgs[0].created_at); const today=new Date();
      if(d.toDateString()===today.toDateString()){lastTime=d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});}
      else{lastTime=d.toLocaleDateString('ru-RU');}
    }
    const { data:unread }=await supabase.from('messages').select('*').eq('chat_id',chat.id).eq('read',false).neq('sender',currentUser.id);
    const unreadCount=(unread||[]).length;
    chatData.push({chatId:chat.id,chatName,lastMsgText,lastMsgImg,lastTime,unreadCount,lastCreated:msgs[0]?.created_at||0,otherId});
  }
  chatData.sort((a,b)=>new Date(b.lastCreated)-new Date(a.lastCreated));
  for(const c of chatData){
    const div=document.createElement('div');div.className='chat-item';
    const info=document.createElement('div');info.className='info';
    const name=document.createElement('div');name.innerText=c.chatName;
    const last=document.createElement('div');last.className='last';
    let msgTxt=(c.lastMsgImg?"🖼":"")+(c.lastMsgText?" "+c.lastMsgText:"");
    last.innerHTML=`<span style="overflow:hidden;white-space:nowrap;text-overflow:ellipsis;display:inline-block;max-width:180px">${msgTxt}</span><span>${c.lastTime}</span>`;
    info.appendChild(name);info.appendChild(last);div.appendChild(info);
    if(c.unreadCount>0){const badge=document.createElement('div');badge.className='unread-badge';badge.innerText=c.unreadCount;div.appendChild(badge);}
    div.onclick=()=>openChat(c.chatId,c.chatName,c.otherId);
    list.appendChild(div);
  }
}
function subscribeChats(){if(chatSubscription) supabase.removeChannel(chatSubscription);chatSubscription=supabase.channel('chats-r').on('postgres_changes',{event:'INSERT',schema:'public',table:'chats'},()=>loadChats()).subscribe();}

/* --- Медиа --- */
function chooseFile(type){
  uploadcare.openDialog(null,{publicKey:"c12f2c3e134f56024db8",imagesOnly:type==='image',multiple:false,previewStep:true}).done(file=>{
    file.done(info=>{
      selectedMediaUrl=info.cdnUrl;
      const preview=document.getElementById('preview');
      preview.innerHTML=type==='image'?`<img src="${selectedMediaUrl}">`:`<video src="${selectedMediaUrl}" controls></video>`;
    });
  });
}
function openMediaModal(url,type){
  const modal=document.getElementById('media-modal');
  const img=document.getElementById('modal-img'); const video=document.getElementById('modal-video'); const dl=document.getElementById('media-download');
  img.style.display='none'; video.style.display='none';
  if(type==='image'){img.src=url; img.style.display='block';}
  else{video.src=url; video.style.display='block'; video.play();}
  dl.href=url;
  modal.style.display='flex';
}
function closeMediaModal(){const modal=document.getElementById('media-modal'); modal.style.display='none'; const video=document.getElementById('modal-video'); video.pause();}
</script>

</body>
</html>
