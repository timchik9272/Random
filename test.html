<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>MiniMessenger ‚Äî —É–ª—É—á—à–µ–Ω–æ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
:root { --bg:#0e0e0e; --bg-light:#1e1e1e; --accent:#0088cc; --text:#fff; --gray:#888; --radius:14px; --reply-bg:#17202a; --highlight:#2a4a5a; }
body{margin:0;font-family:sans-serif;background:var(--bg);color:var(--text);}
.screen{display:none;flex-direction:column;height:100vh;}
.active{display:flex;}
input,textarea,button{border:none;border-radius:var(--radius);font-size:15px;}
input,textarea{background:var(--bg-light);color:var(--text);padding:10px;}
button{background:var(--accent);color:#fff;padding:10px 12px;font-weight:bold;margin:6px 0;}
nav{display:flex;align-items:center;gap:12px;justify-content:space-between;padding:8px;background:var(--bg);position:sticky;top:0;z-index:10;border-bottom:1px solid #222;}
.chat-list,.messages{flex:1;overflow-y:auto;}
.chat-item{padding:12px;border-bottom:1px solid #222;cursor:pointer;display:flex;justify-content:space-between;align-items:center;}
.chat-item .info{display:flex;flex-direction:column;flex:1;}
.chat-item .last{display:flex;justify-content:space-between;align-items:center;margin-top:4px;font-size:13px;color:var(--gray);}
.unread-badge{background:var(--accent);color:#fff;border-radius:50%;min-width:22px;height:22px;display:flex;justify-content:center;align-items:center;font-size:12px;}
.msg{margin:6px 10px;padding:10px 14px;border-radius:var(--radius);max-width:75%;position:relative;border:1px solid #222;word-break:break-word;}
.msg.me{background:var(--accent);margin-left:auto;color:#fff;}
.msg.other{background:var(--bg-light);}
.msg.deleted{font-style:italic;color:var(--gray);background:transparent;border:0;padding:6px 10px;}
.msg .reply-to{font-size:12px;color:var(--accent);margin-bottom:6px;border-left:2px solid var(--accent);padding-left:8px;}
.reply-header{background:var(--reply-bg);padding:6px 8px;border-radius:10px;margin-bottom:8px;font-size:13px;display:flex;align-items:center;gap:8px;}
.reply-header span.small{font-size:12px;color:var(--gray);}
.time{display:block;font-size:12px;margin-top:6px;text-align:right;}
.me .time{color:#fff;} .other .time{color:var(--gray);}
img.msg-img{max-width:100%;border-radius:var(--radius);margin-top:6px;display:block;}
.input-box{display:flex;flex-direction:column;gap:6px;padding:8px;background:var(--bg);border-top:1px solid #222;position:sticky;bottom:0;}
.input-row{display:flex;gap:6px;}
.input-box textarea{flex:1;min-height:44px;max-height:140px;padding:10px;border-radius:12px;}
.send-btn,.img-btn{width:44px;height:44px;border-radius:50%;display:flex;justify-content:center;align-items:center;font-size:16px;background:var(--accent);color:#fff;border:0;}
#preview img{max-width:140px;border-radius:var(--radius);margin:6px;}
.context-menu{position:absolute;background:var(--bg-light);border:1px solid #333;border-radius:8px;display:none;flex-direction:column;z-index:1000;}
.context-menu button{background:none;border:none;color:var(--text);padding:10px 14px;text-align:left;}
.context-menu button:hover{background:#222;}
.ticks{font-size:14px;margin-left:4px;}
.typing-status{font-size:12px;color:var(--gray);}
.unread-separator{text-align:center;color:var(--accent);font-size:13px;margin:10px 0;border-top:1px dashed var(--gray);border-bottom:1px dashed var(--gray);padding:4px 0;}
.reply-preview{background:var(--reply-bg);padding:8px;border-radius:10px;display:flex;align-items:center;justify-content:space-between;gap:8px;}
.reply-preview .left{display:flex;gap:8px;align-items:center;}
.reply-preview .meta{font-size:13px;color:var(--text);max-width:75% ;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.reply-preview .cancel{cursor:pointer;padding:6px;border-radius:8px;background:#2a2a2a;}
.highlight{box-shadow:0 0 0 3px rgba(0,136,204,0.12);animation:flash 2s;}
@keyframes flash{0%{background:var(--highlight)}30%{background:transparent}60%{background:var(--highlight)}100%{background:transparent}}
.small-muted{font-size:12px;color:var(--gray);}
</style>
</head>
<body>

<!-- –í—Ö–æ–¥ -->
<div id="login-screen" class="screen active">
  <h2 style="padding:12px">–í—Ö–æ–¥</h2>
  <div style="padding:12px">
    <input id="login-email" placeholder="Email"><br><br>
    <input id="login-password" type="password" placeholder="–ü–∞—Ä–æ–ª—å"><br><br>
    <button onclick="signIn()">–í–æ–π—Ç–∏</button>
    <button style="background:var(--bg-light)" onclick="showRegister()">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
  </div>
</div>

<!-- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è -->
<div id="register-screen" class="screen">
  <h2 style="padding:12px">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
  <div style="padding:12px">
    <input id="reg-email" placeholder="Email"><br><br>
    <input id="reg-password" type="password" placeholder="–ü–∞—Ä–æ–ª—å"><br><br>
    <input id="reg-username" placeholder="Username"><br><br>
    <button onclick="signUp()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
    <button style="background:var(--bg-light)" onclick="showLogin()">–ù–∞–∑–∞–¥</button>
  </div>
</div>

<!-- –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω -->
<div id="main-screen" class="screen">
  <nav><h2>–ß–∞—Ç—ã</h2>
    <div>
      <button onclick="openSearch()"><i class="fa fa-plus"></i></button>
      <button onclick="openSettings()"><i class="fa fa-gear"></i></button>
    </div>
  </nav>
  <div class="chat-list" id="chat-list"></div>
</div>

<!-- –ù–æ–≤—ã–π —á–∞—Ç -->
<div id="search-screen" class="screen">
  <nav><button onclick="backToMain()"><i class="fa fa-arrow-left"></i></button><h2>–ù–æ–≤—ã–π —á–∞—Ç</h2></nav>
  <div style="padding:12px"><input id="search-username" placeholder="–í–≤–µ–¥–∏—Ç–µ username"><br><br><button onclick="searchUser()">–°–æ–∑–¥–∞—Ç—å —á–∞—Ç</button></div>
</div>

<!-- –ß–∞—Ç -->
<div id="chat-screen" class="screen">
  <nav style="align-items:flex-start;">
    <div style="display:flex;gap:12px;align-items:center;">
      <button onclick="backToMain()"><i class="fa fa-arrow-left"></i></button>
      <div>
        <h2 id="chat-username" style="margin:0"></h2>
        <div id="chat-status" class="small-muted"></div>
        <div id="typing-status" class="typing-status"></div>
      </div>
    </div>
    <div style="display:flex;flex-direction:column;align-items:flex-end;">
      <div id="chat-last-updated" class="small-muted"></div>
    </div>
  </nav>
  <div class="messages" id="messages"></div>

  <div id="preview"></div>

  <div class="input-box">
    <!-- preview –±–ª–æ–∫–∞ –æ—Ç–≤–µ—Ç–∞ (–ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –≤—ã–±–æ—Ä–µ "–û—Ç–≤–µ—Ç–∏—Ç—å") -->
    <div id="reply-preview-container" style="display:none;">
      <div class="reply-preview" id="reply-preview">
        <div class="left">
          <i class="fa fa-reply"></i>
          <div>
            <div class="meta" id="reply-meta"></div>
            <div class="small-muted" id="reply-snippet"></div>
          </div>
        </div>
        <div style="display:flex;gap:6px;align-items:center;">
          <div class="cancel" id="reply-cancel" title="–û—Ç–º–µ–Ω–∏—Ç—å –æ—Ç–≤–µ—Ç"><i class="fa fa-times"></i></div>
        </div>
      </div>
    </div>

    <div class="input-row">
      <textarea id="msg-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>
      <button class="img-btn" onclick="chooseImage()"><i class="fa fa-image"></i></button>
      <button class="send-btn" onclick="sendMessage()"><i class="fa fa-paper-plane"></i></button>
    </div>
    <div id="preview"></div>
  </div>
</div>

<!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
<div id="settings-screen" class="screen">
  <nav><button onclick="backToMain()"><i class="fa fa-arrow-left"></i></button><h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2></nav>
  <div style="padding:12px"><div id="profile-info"></div><br>
    <button onclick="deleteAccount()" style="background:#c00">–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
    <button onclick="logout()" style="background:var(--bg-light)">–í—ã–π—Ç–∏</button></div>
</div>

<!-- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é -->
<div id="context-menu" class="context-menu">
  <button onclick="copyMessage()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
  <button onclick="confirmDelete()">–£–¥–∞–ª–∏—Ç—å</button>
  <button onclick="replyMessage()">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
</div>

<script>
/* ============ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Supabase / Uploadcare ============ */
const supabase = window.supabase.createClient(
  "https://zmewwzlzujsrhstjehrp.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InptZXd3emx6dWpzcmhzdGplaHJwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5NjM4MDksImV4cCI6MjA3MTUzOTgwOX0.kBBXwlCEl5szgK4vKgaPBhPOVYmoFzly2TXR-fI8D24"
);
uploadcare.start({ publicKey:"c12f2c3e134f56024db8" });

/* ============ –°–æ—Å—Ç–æ—è–Ω–∏–µ ============ */
let currentUser=null,currentChat=null,msgSubscription=null,chatSubscription=null;
let selectedMessageId=null,selectedSender=null,selectedImageUrl=null;
let replyToMessage=null; // {id, username, snippet}

/* ============ –£—Ç–∏–ª–∏—Ç—ã ============ */
function showScreen(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');}
function formatDateTimeISO(dt){ const d=new Date(dt); const dd=String(d.getDate()).padStart(2,'0'); const mm=String(d.getMonth()+1).padStart(2,'0'); const yyyy=d.getFullYear(); const hh=String(d.getHours()).padStart(2,'0'); const min=String(d.getMinutes()).padStart(2,'0'); return `${hh}:${min} ${dd}.${mm}.${yyyy}`; }
function formatTimeOnly(dt){ const d=new Date(dt); return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }

/* ============ –≠–∫—Ä–∞–Ω—ã ============ */
function showLogin(){showScreen('login-screen');}
function showRegister(){showScreen('register-screen');}
function showMain(){loadChats();showScreen('main-screen');}
function openSettings(){loadProfile();showScreen('settings-screen');}
function openSearch(){showScreen('search-screen');}
async function backToMain(){
  if(msgSubscription) await supabase.removeChannel(msgSubscription);
  if(chatSubscription) await supabase.removeChannel(chatSubscription);
  showMain();
}

/* ============ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è ============ */
async function signUp(){
  const email=document.getElementById('reg-email').value,password=document.getElementById('reg-password').value,username=document.getElementById('reg-username').value;
  const { data,error }=await supabase.auth.signUp({ email,password,options:{ data:{username} }});
  if(error){alert(error.message);return;}
  await supabase.from('profiles').insert([{ id:data.user.id,email,username,status:'–æ–Ω–ª–∞–π–Ω',typing:false }]);
  alert("–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ email –∏ –≤–æ–π–¥–∏—Ç–µ");showLogin();
}

async function signIn(){
  const email=document.getElementById('login-email').value,password=document.getElementById('login-password').value;
  const { data,error }=await supabase.auth.signInWithPassword({ email,password });
  if(error){alert(error.message);return;}
  currentUser=data.user;
  await supabase.from('profiles').update({status:'–æ–Ω–ª–∞–π–Ω'}).eq('id',currentUser.id);
  showMain();subscribeChats();
}

async function logout(){
  await supabase.from('profiles').update({status:`–±—ã–ª(–∞) –≤ ${new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})} ${new Date().toLocaleDateString()}`,typing:false}).eq('id',currentUser.id);
  await supabase.auth.signOut();currentUser=null;showLogin();
}

async function loadProfile(){
  const { data }=await supabase.from('profiles').select('*').eq('id',currentUser.id).single();
  document.getElementById('profile-info').innerText=`Username: ${data.username}\nEmail: ${data.email}\n–°—Ç–∞—Ç—É—Å: ${data.status}`;
}

async function deleteAccount(){ if(!confirm('–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç –Ω–∞–≤—Å–µ–≥–¥–∞?')) return; await supabase.from('profiles').delete().eq('id',currentUser.id); logout(); }

/* ============ –ß–∞—Ç—ã (—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –Ω–æ–≤–∏–∑–Ω–µ) ============ */
async function loadChats(){
  // –°–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î –ø–æ updated_at (–Ω–æ–≤–µ–µ —Å–≤–µ—Ä—Ö—É)
  const { data:chats }=await supabase.from('chats')
    .select('*')
    .or(`user1.eq.${currentUser.id},user2.eq.${currentUser.id}`)
    .order('updated_at',{ascending:false});
  const list=document.getElementById('chat-list');list.innerHTML='';
  if(!chats) return;
  for(const chat of chats){
    let chatName="",otherId=null,lastMsgText="",lastMsgImg=false,unreadCount=0,lastTime="";
    if(chat.user1===chat.user2){chatName="–ò–∑–±—Ä–∞–Ω–Ω–æ–µ";}
    else{ otherId=chat.user1===currentUser.id?chat.user2:chat.user1;
      const { data:profile }=await supabase.from('profiles').select('username,status,typing').eq('id',otherId).single();
      if(profile){
        chatName=profile.username;
        // –º–æ–∂–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å—Ç–∞—Ç—É—Å —Ä—è–¥–æ–º, –Ω–æ —á—Ç–æ–±—ã –Ω–µ –∑–∞–≥—Ä–æ–º–æ–∂–¥–∞—Ç—å, –æ—Å—Ç–∞–≤–∏–º –≤–Ω—É—Ç—Ä–∏ —ç–ª–µ–º–µ–Ω—Ç–∞
      }
    }
    // –±–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—Å–µ–¥–∂ (–µ—Å–ª–∏ –µ—Å—Ç—å)
    const { data:msgs }=await supabase.from('messages').select('*').eq('chat_id',chat.id).order('created_at',{ascending:false}).limit(1);
    if(msgs && msgs.length>0){ lastMsgText=msgs[0].content||""; lastMsgImg=!!msgs[0].image_url; lastTime=formatTimeOnly(msgs[0].created_at); }
    const { data:unread }=await supabase.from('messages').select('*').eq('chat_id',chat.id).eq('read',false).neq('sender',currentUser.id);
    unreadCount=unread?unread.length:0;
    const div=document.createElement('div');div.className='chat-item';
    const info=document.createElement('div');info.className='info';
    const name=document.createElement('div');name.innerText=chatName;
    const last=document.createElement('div');last.className='last';
    let msgTxt=(lastMsgImg?"üñº":"")+(lastMsgText?" "+lastMsgText:"");
    last.innerHTML=`<span style="overflow:hidden;white-space:nowrap;text-overflow:ellipsis;max-width:220px;display:inline-block">${msgTxt}</span><span>${lastTime}</span>`;
    info.appendChild(name);info.appendChild(last);
    div.appendChild(info);
    if(unreadCount>0){const badge=document.createElement('div');badge.className='unread-badge';badge.innerText=unreadCount;div.appendChild(badge);}
    div.onclick=()=>openChat(chat.id,chatName,otherId);
    list.appendChild(div);
  }
}

function subscribeChats(){ if(chatSubscription) supabase.removeChannel(chatSubscription); chatSubscription=supabase.channel('chats-r').on('postgres_changes',{event:'INSERT',schema:'public',table:'chats'},()=>loadChats()).subscribe(); }

/* ============ –°–æ–æ–±—â–µ–Ω–∏—è ============ */
async function openChat(chatId,otherName,otherId){
  currentChat=chatId;
  document.getElementById('chat-username').innerText=otherName;
  showScreen('chat-screen');
  await loadMessages();
  if(msgSubscription) supabase.removeChannel(msgSubscription);
  msgSubscription=supabase.channel('room-'+chatId)
    .on('postgres_changes',{event:'INSERT',schema:'public',table:'messages',filter:`chat_id=eq.${chatId}`},p=>renderMessage(p.new,true))
    .subscribe();
  await supabase.from('messages').update({read:true}).eq('chat_id',chatId).neq('sender',currentUser.id);
  // —Å–ª–µ–¥–∏–º –∑–∞ —Å—Ç–∞—Ç—É—Å–æ–º —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
  if(otherId){
    const ch = supabase.channel('status-'+otherId).on('postgres_changes',{event:'UPDATE',schema:'public',table:'profiles',filter:`id=eq.${otherId}`},p=>{
      document.getElementById('chat-status').innerText = prettyStatus(p.new);
      document.getElementById('typing-status').innerText = p.new.typing ? "–ø–µ—á–∞—Ç–∞–µ—Ç..." : "";
      document.getElementById('chat-last-updated').innerText = p.new.last_active ? formatDateTimeISO(p.new.last_active) : '';
    }).subscribe();
  }
}

function prettyStatus(profile){
  // profile: {status, typing, ...}
  if(profile.typing) return "–ø–µ—á–∞—Ç–∞–µ—Ç...";
  const st = profile.status || "";
  // –ü–æ–ø—Ä–æ–±—É–µ–º —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å "–±—ã–ª(–∞) –≤ HH:MM DD.MM.YYYY" –∏–ª–∏ "–æ–Ω–ª–∞–π–Ω"
  if(st.includes('–æ–Ω–ª–∞–π–Ω')) return '–æ–Ω–ª–∞–π–Ω';
  return st; // fallback: —Å—Ç—Ä–æ–∫–∞, –∫–æ—Ç–æ—Ä—É—é –¥–∞–ª –±—ç–∫–µ–Ω–¥
}

async function loadMessages(){
  const { data }=await supabase.from('messages').select('*').eq('chat_id',currentChat).order('created_at',{ascending:true});
  const box=document.getElementById('messages');box.innerHTML='';
  let insertedUnread=false;
  for(const msg of data || []){
    if(!msg.read && msg.sender!==currentUser.id && !insertedUnread){const sep=document.createElement('div');sep.className='unread-separator';sep.innerText='–ù–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ';box.appendChild(sep);insertedUnread=true;}
    renderMessage(msg,false);
  }
  box.scrollTop=box.scrollHeight;
}

function renderMessage(msg,scroll=true){
  const box=document.getElementById('messages');
  let div=document.getElementById('msg-'+msg.id);
  const isMe = msg.sender===currentUser.id;
  if(!div){
    div=document.createElement('div');div.id='msg-'+msg.id;div.className='msg '+(isMe?'me':'other');
    // store meta attributes for reply usage
    div.dataset.sender = msg.sender;
    div.dataset.content = msg.content || '';
    div.dataset.created = msg.created_at;
    div.oncontextmenu=(e)=>{ e.preventDefault(); showContextMenu(e,msg.id,msg.sender); };
    box.appendChild(div);
  }
  if(msg.is_deleted){ div.className='msg deleted'; div.innerText='–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ'; }
  else{
    let html="";
    // –ï—Å–ª–∏ –µ—Å—Ç—å reply_to ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤–Ω—É—Ç—Ä–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
    if(msg.reply_to){
      // –ø–æ–ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ–± –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏, –µ—Å–ª–∏ —Ç–æ—Ç –∂–µ —á–∞—Ç ‚Äî —á–∏—Ç–∞–µ–º DOM (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ)
      let orig = document.getElementById('msg-'+msg.reply_to);
      let rname = "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ";
      let rsnippet = "";
      if(orig){
        rname = orig.dataset.username || orig.dataset.sender || rname;
        rsnippet = (orig.dataset.content||"").split('\n')[0].slice(0,120);
      } else {
        // –µ—Å–ª–∏ DOM-–∞ –Ω–µ—Ç ‚Äî –ø–æ–ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–∑ –ë–î (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
        (async ()=>{
          const { data:om } = await supabase.from('messages').select('*').eq('id',msg.reply_to).single();
          if(om){
            const username = await getUsername(om.sender);
            const header = `<div class="reply-to">–û—Ç–≤–µ—Ç @${username}: ${ (om.content||'').split('\n')[0].slice(0,120) }</div>`;
            const container = document.getElementById('msg-'+msg.id);
            if(container) container.querySelector('.reply-to-temp')?.remove();
            if(container) container.insertAdjacentHTML('afterbegin', header);
          }
        })();
      }
      // –≤—Å—Ç–∞–≤–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ (–µ—Å–ª–∏ DOM –¥–æ—Å—Ç—É–ø–µ–Ω, —Ç–æ —Å—Ä–∞–∑—É)
      if(orig){
        const uname = orig.dataset.username || (orig.dataset.sender? ('user_'+orig.dataset.sender) : 'user');
        const snippet = rsnippet;
        html += `<div class="reply-to">–û—Ç–≤–µ—Ç @${uname}: ${snippet}</div>`;
      } else {
        // placeholder ‚Äî –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç—å –±—É–¥–µ—Ç –ø–æ–¥–≥—Ä—É–∂–µ–Ω–∞ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
        html += `<div class="reply-to reply-to-temp">–û—Ç–≤–µ—Ç ‚Äî –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è‚Ä¶</div>`;
      }
    }

    // –∫–æ–Ω—Ç–µ–Ω—Ç –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ. –í–ê–ñ–ù–û: –∑–∞–≥–æ–ª–æ–≤–æ–∫ "reply-to" –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å **–≤—ã—à–µ** –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è ‚Äî —Å–æ–±–ª—é–¥—ë–Ω.
    if(msg.content) html += `<div>${escapeHtml(msg.content)}</div>`;
    if(msg.image_url) html += `<img src="${msg.image_url}" class="msg-img">`;

    let ticks = isMe?'<span class="ticks">‚úî‚úî</span>':'';
    html += `<span class="time">${formatTimeOnly(msg.created_at)} ${ticks}</span>`;

    div.innerHTML = html;

    // –î–æ–±–∞–≤–∏–º meta-–¥–∞–Ω–Ω—ã–µ: username (–µ—Å–ª–∏ –ø–æ–ª—É—á–∏–º)
    (async ()=>{
      // –µ—Å–ª–∏ —É –Ω–∞—Å –µ—â—ë –Ω–µ—Ç dataset.username ‚Äî –ø–æ–ª—É—á–∏–º
      if(!div.dataset.username){
        const uname = await getUsername(msg.sender);
        div.dataset.username = uname || ('user_'+msg.sender);
      }
    })();
  }

  if(scroll){
    box.scrollTop = box.scrollHeight;
  }
}

/* –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–∞—è —ç–∫—Ä–∞–Ω–∏–∑–∞—Ü–∏—è HTML */
function escapeHtml(text){
  if(!text) return '';
  return text.replace(/[&<>"'`=\/]/g, function(s){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'})[s]; });
}

/* –ø–æ–ª—É—á–∏—Ç—å username –ø–æ id (–∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ) */
const usernameCache = {};
async function getUsername(userId){
  if(usernameCache[userId]) return usernameCache[userId];
  try{
    const { data } = await supabase.from('profiles').select('username').eq('id',userId).single();
    if(data && data.username){ usernameCache[userId] = data.username; return data.username; }
  }catch(e){}
  return null;
}

/* ============ –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è + –ø–æ–¥–¥–µ—Ä–∂–∫–∞ reply ============ */
async function sendMessage(){
  const text = document.getElementById('msg-input').value.trim();
  if(!text && !selectedImageUrl) return;
  const payload = {
    chat_id: currentChat,
    sender: currentUser.id,
    content: text||null,
    image_url: selectedImageUrl || null,
    reply_to: replyToMessage ? replyToMessage.id : null,
    read: false
  };
  await supabase.from('messages').insert([payload]);
  // –°–±—Ä–æ—Å UI
  document.getElementById('msg-input').value='';
  selectedImageUrl=null;
  document.getElementById('preview').innerHTML='';
  clearReplyPreview();
  // –û–±–Ω–æ–≤–∏–º —á–∞—Ç updated_at (—É–¥–æ–±–Ω–æ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏)
  await supabase.from('chats').update({ updated_at: new Date().toISOString() }).eq('id', currentChat);
  const box=document.getElementById('messages');box.scrollTop=box.scrollHeight;
}

function chooseImage(){ uploadcare.openDialog(null,{publicKey:"c12f2c3e134f56024db8"}).done(file=>{ file.done(info=>{ selectedImageUrl=info.cdnUrl; document.getElementById('preview').innerHTML=`<img src="${selectedImageUrl}">`; }); }); }

/* ============ –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é (–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å, —É–¥–∞–ª–∏—Ç—å, –æ—Ç–≤–µ—Ç–∏—Ç—å) ============ */
function showContextMenu(e,msgId,senderId){ selectedMessageId=msgId; selectedSender=senderId; const menu=document.getElementById('context-menu'); menu.style.left=e.pageX+'px'; menu.style.top=e.pageY+'px'; menu.style.display='flex'; }
function copyMessage(){ if(!selectedMessageId) return; const el=document.getElementById('msg-'+selectedMessageId); if(el) navigator.clipboard.writeText(el.innerText); selectedMessageId=null; document.getElementById('context-menu').style.display='none'; }
function confirmDelete(){ if(!selectedMessageId) return; supabase.from('messages').update({is_deleted:true}).eq('id',selectedMessageId).eq('sender',currentUser.id); selectedMessageId=null; document.getElementById('context-menu').style.display='none'; }
async function replyMessage(){ 
  if(!selectedMessageId) return;
  const el=document.getElementById('msg-'+selectedMessageId);
  // –≤–æ–∑—å–º—ë–º username/snippet
  let username = el?.dataset.username || await getUsername(el?.dataset.sender) || ('user_'+el?.dataset.sender);
  let snippet = (el?.dataset.content || '').split('\n')[0].slice(0,120);
  replyToMessage = { id: selectedMessageId, username, snippet };
  showReplyPreview();
  selectedMessageId=null;
  document.getElementById('context-menu').style.display='none';
}

/* ============ Preview –æ—Ç–≤–µ—Ç–∞ (–∫–Ω–æ–ø–∫–∞ –∫—Ä–µ—Å—Ç–∏–∫, –∫–ª–∏–∫ —Å–∫—Ä–æ–ª–ª–∏—Ç –∫ —Å–æ–æ–±—â–µ–Ω–∏—é) ============ */
function showReplyPreview(){
  if(!replyToMessage) return;
  const cont = document.getElementById('reply-preview-container');
  document.getElementById('reply-meta').innerText = `–û—Ç–≤–µ—Ç @${replyToMessage.username}`;
  document.getElementById('reply-snippet').innerText = replyToMessage.snippet;
  cont.style.display = 'block';
  // –∫–ª–∏–∫ –ø–æ preview: —Å–∫—Ä–æ–ª–ª–∏—Ç –∫ —Å–æ–æ–±—â–µ–Ω–∏—é
  document.getElementById('reply-preview').onclick = (e)=>{
    // –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Ñ–æ–∫—É—Å –≤ textarea
    if(!replyToMessage) return;
    const target = document.getElementById('msg-'+replyToMessage.id);
    if(target){
      target.scrollIntoView({behavior:'smooth',block:'center'});
      // –ø–æ–¥—Å–≤–µ—Ç–∫–∞
      target.classList.add('highlight');
      setTimeout(()=>target.classList.remove('highlight'), 2200);
    }
  };
  document.getElementById('reply-cancel').onclick = (e) => { e.stopPropagation(); clearReplyPreview(); };
  // –ø–æ–º–µ–Ω—è–µ–º placeholder
  document.getElementById('msg-input').placeholder = `–û—Ç–≤–µ—Ç: ${replyToMessage.snippet}`;
}

function clearReplyPreview(){
  replyToMessage = null;
  const cont = document.getElementById('reply-preview-container');
  cont.style.display = 'none';
  document.getElementById('msg-input').placeholder = '–°–æ–æ–±—â–µ–Ω–∏–µ...';
}

/* ============ –ü–∏—à–µ—Ç (typing) ============ */
document.getElementById('msg-input').addEventListener('input',async()=>{
  if(!currentUser) return;
  await supabase.from('profiles').update({typing:true,status:'–ø–µ—á–∞—Ç–∞–µ—Ç...'}).eq('id',currentUser.id);
  clearTimeout(window.typingTimeout);
  window.typingTimeout=setTimeout(async()=>{
    await supabase.from('profiles').update({typing:false,status:'–æ–Ω–ª–∞–π–Ω', last_active: new Date().toISOString()}).eq('id',currentUser.id);
  },1500);
});

/* ============ –°–µ—Å—Å–∏—è –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ ============ */
window.addEventListener('load',async()=>{
  const { data:{session}} = await supabase.auth.getSession();
  if(session){ currentUser=session.user; showMain(); subscribeChats(); }
});
window.addEventListener('beforeunload',()=>{
  if(currentUser) supabase.from('profiles').update({status:`–±—ã–ª(–∞) –≤ ${new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})} ${new Date().toLocaleDateString()}`,typing:false,last_active:new Date().toISOString()}).eq('id',currentUser.id);
});
document.addEventListener('visibilitychange',()=>{ if(document.hidden && currentUser) supabase.from('profiles').update({status:`–±—ã–ª(–∞) –≤ ${new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})} ${new Date().toLocaleDateString()}`,typing:false,last_active:new Date().toISOString()}).eq('id',currentUser.id); });
window.onclick=()=>{ document.getElementById('context-menu').style.display='none'; };

/* ============ –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ: –ø–æ–∏—Å–∫/—Å–æ–∑–¥–∞–Ω–∏–µ —á–∞—Ç–∞ ============ */
async function searchUser(){
  const username = document.getElementById('search-username').value.trim();
  if(!username) return alert('–í–≤–µ–¥–∏—Ç–µ username');
  const { data:user } = await supabase.from('profiles').select('*').eq('username',username).single();
  if(!user) return alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
  // –ø–æ—Å–º–æ—Ç—Ä–∏–º, –µ—Å—Ç—å –ª–∏ —á–∞—Ç
  const { data:existing } = await supabase.from('chats').select('*').or(`user1.eq.${currentUser.id},user2.eq.${currentUser.id}`);
  let found = existing?.find(c => (c.user1===user.id || c.user2===user.id));
  if(found){ openChat(found.id,user.username,user.id); return; }
  // —Å–æ–∑–¥–∞—ë–º —á–∞—Ç
  const { data:ch } = await supabase.from('chats').insert([{ user1: currentUser.id, user2: user.id, updated_at: new Date().toISOString() }]).select().single();
  openChat(ch.id, user.username, user.id);
}

/* ============ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –∫–ª—é—á–∞—Ö ============ */
console.warn("–í–ù–ò–ú–ê–ù–ò–ï: —Ç–µ–∫—É—â–∏–π –∫–æ–¥ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—É–±–ª–∏—á–Ω—ã–µ –∫–ª—é—á–∏/—Ç–æ–∫–µ–Ω—ã –≤ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–º JS. –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ —Ö—Ä–∞–Ω–∏—Ç–µ —Å–µ–∫—Ä–µ—Ç—ã –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ–º –º–µ—Å—Ç–µ (—Å–µ—Ä–≤–µ—Ä, env).");
</script>
</body>
</html>
