<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>MiniMessenger</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root { --bg:#0e0e0e; --bg-light:#1e1e1e; --accent:#0088cc; --text:#fff; --gray:#888; --radius:14px; }
    body { margin:0; font-family:sans-serif; background:var(--bg); color:var(--text);}
    .screen{display:none;flex-direction:column;height:100vh;}
    .active{display:flex;}
    input,button,textarea{border:none;border-radius:var(--radius);font-size:16px;}
    input,textarea{background:var(--bg-light);color:var(--text);padding:12px;}
    button{background:var(--accent);color:#fff;padding:12px;font-weight:bold;margin:6px 0;min-width:60px;}
    nav{display:flex;align-items:center;justify-content:space-between;padding:6px 10px;background:var(--bg);position:sticky;top:0;z-index:10;border-bottom:1px solid #222;}
    nav h2{margin:0;font-size:18px;}
    nav button{padding:6px 10px;border-radius:10px;font-size:13px;}
    .chat-list,.messages{flex:1;overflow-y:auto;}
    .chat-item{padding:14px;border-bottom:1px solid #222;cursor:pointer;display:flex;justify-content:space-between;align-items:center;}
    .badge{background:red;color:#fff;border-radius:50%;padding:4px 8px;font-size:12px;min-width:20px;text-align:center;}
    .msg{margin:6px 10px;padding:10px 14px;border-radius:var(--radius);max-width:75%;position:relative;border:1px solid #222;}
    .msg.me{background:var(--accent);margin-left:auto;}
    .msg.other{background:var(--bg-light);}
    .msg.deleted{font-style:italic;color:var(--gray);}
    .time{display:block;font-size:12px;margin-top:4px;text-align:right;}
    .me .time{color:#fff;} .other .time{color:var(--gray);}
    img.msg-img{max-width:100%;border-radius:var(--radius);margin-top:4px;}
    .input-box{display:flex;gap:6px;padding:8px;background:var(--bg);border-top:1px solid #222;position:sticky;bottom:0;}
    .input-box textarea{flex:1;min-height:44px;max-height:140px;}
    .send-btn,.img-btn{width:40px;height:40px;border-radius:50%;display:flex;justify-content:center;align-items:center;font-size:16px;background:var(--accent);color:#fff;}
    #preview img{max-width:120px;border-radius:var(--radius);margin:6px;}
    .context-menu{position:absolute;background:var(--bg-light);border:1px solid #333;border-radius:8px;display:none;flex-direction:column;z-index:1000;}
    .context-menu button{background:none;border:none;color:var(--text);padding:10px 14px;text-align:left;}
    .context-menu button:hover{background:#222;}
    .ticks{font-size:14px;margin-left:4px;}
    .unread-line{text-align:center;color:var(--gray);padding:6px;font-size:13px;}
  </style>
</head>
<body>
  <!-- Вход -->
  <div id="login-screen" class="screen active">
    <h2 style="padding:16px">Вход</h2>
    <div style="padding:16px">
      <input id="login-email" placeholder="Email"><br><br>
      <input id="login-password" type="password" placeholder="Пароль"><br><br>
      <button onclick="signIn()">Войти</button>
      <button style="background:var(--bg-light)" onclick="showRegister()">Создать аккаунт</button>
    </div>
  </div>

  <!-- Регистрация -->
  <div id="register-screen" class="screen">
    <h2 style="padding:16px">Регистрация</h2>
    <div style="padding:16px">
      <input id="reg-email" placeholder="Email"><br><br>
      <input id="reg-password" type="password" placeholder="Пароль"><br><br>
      <input id="reg-username" placeholder="Username"><br><br>
      <button onclick="signUp()">Зарегистрироваться</button>
      <button style="background:var(--bg-light)" onclick="showLogin()">Назад</button>
    </div>
  </div>

  <!-- Главный экран -->
  <div id="main-screen" class="screen">
    <nav><h2>Чаты</h2>
      <div>
        <button onclick="openSearch()"><i class="fa fa-plus"></i></button>
        <button onclick="openSettings()"><i class="fa fa-gear"></i></button>
      </div>
    </nav>
    <div class="chat-list" id="chat-list"></div>
  </div>

  <!-- Новый чат -->
  <div id="search-screen" class="screen">
    <nav><button onclick="backToMain()"><i class="fa fa-arrow-left"></i></button><h2>Новый чат</h2></nav>
    <div style="padding:16px"><input id="search-username" placeholder="Введите username"><br><br><button onclick="searchUser()">Создать чат</button></div>
  </div>

  <!-- Чат -->
  <div id="chat-screen" class="screen">
    <nav>
      <button onclick="backToMain()"><i class="fa fa-arrow-left"></i></button>
      <div><h2 id="chat-username"></h2><small id="chat-status" style="color:var(--gray)"></small></div>
    </nav>
    <div class="messages" id="messages"></div>
    <div id="preview"></div>
    <div class="input-box">
      <textarea id="msg-input" placeholder="Сообщение..." oninput="sendTyping()"></textarea>
      <button class="img-btn" onclick="chooseImage()"><i class="fa fa-image"></i></button>
      <button class="send-btn" onclick="sendMessage()"><i class="fa fa-paper-plane"></i></button>
    </div>
  </div>

  <!-- Настройки -->
  <div id="settings-screen" class="screen">
    <nav><button onclick="backToMain()"><i class="fa fa-arrow-left"></i></button><h2>Настройки</h2></nav>
    <div style="padding:16px"><div id="profile-info"></div><br>
      <button onclick="deleteAccount()" style="background:#c00">Удалить аккаунт</button>
      <button onclick="logout()" style="background:var(--bg-light)">Выйти</button></div>
  </div>

  <!-- Контекстное меню -->
  <div id="context-menu" class="context-menu">
    <button id="copy-btn" onclick="copyMessage()">Копировать</button>
    <button id="delete-btn" onclick="confirmDelete()">Удалить</button>
  </div>

<script>
const supabase = window.supabase.createClient(
  "https://zmewwzlzujsrhstjehrp.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
);

uploadcare.start({ publicKey:"c12f2c3e134f56024db8" });

let currentUser=null,currentChat=null,msgSubscription=null,chatSubscription=null,selectedMessageId=null,selectedSender=null,selectedImageUrl=null;

function showScreen(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');}
function showLogin(){showScreen('login-screen');}
function showRegister(){showScreen('register-screen');}
function showMain(){loadChats();showScreen('main-screen');}
function openSettings(){loadProfile();showScreen('settings-screen');}
function openSearch(){showScreen('search-screen');}
function backToMain(){if(msgSubscription)supabase.removeChannel(msgSubscription);showMain();}

async function signUp(){
  const email=document.getElementById('reg-email').value;
  const password=document.getElementById('reg-password').value;
  const username=document.getElementById('reg-username').value;
  const {data,error}=await supabase.auth.signUp({email,password});
  if(error){alert(error.message);return;}
  await supabase.from('profiles').insert([{id:data.user.id,username,status:'онлайн'}]);
  currentUser=data.user;showMain();
}
async function signIn(){
  const email=document.getElementById('login-email').value;
  const password=document.getElementById('login-password').value;
  const {data,error}=await supabase.auth.signInWithPassword({email,password});
  if(error){alert(error.message);return;}
  currentUser=data.user;
  await supabase.from('profiles').update({status:"онлайн"}).eq('id',currentUser.id);
  showMain();
}
async function logout(){
  await supabase.from('profiles').update({status:`был(а) в ${new Date().toLocaleTimeString()}`}).eq('id',currentUser.id);
  await supabase.auth.signOut();
  currentUser=null;showLogin();
}
async function loadProfile(){
  const {data:profile}=await supabase.from('profiles').select('*').eq('id',currentUser.id).single();
  document.getElementById('profile-info').innerText=`Email: ${currentUser.email}\nUsername: ${profile.username}\nСтатус: ${profile.status}`;
}
async function deleteAccount(){
  if(confirm("Удалить аккаунт?")){await supabase.from('profiles').delete().eq('id',currentUser.id);await supabase.auth.signOut();currentUser=null;showLogin();}
}
async function searchUser(){
  const username=document.getElementById('search-username').value;
  const {data:user}=await supabase.from('profiles').select('id').eq('username',username).single();
  if(!user){alert("Не найден");return;}
  const {data:chat}=await supabase.from('chats').insert([{user1:currentUser.id,user2:user.id}]).select().single();
  openChat(chat.id,username);
}
async function loadChats(){
  const { data:chats }=await supabase.from('chats').select('*').or(`user1.eq.${currentUser.id},user2.eq.${currentUser.id}`);
  const list=document.getElementById('chat-list');list.innerHTML='';
  let enriched=[];
  for(const chat of chats){
    let chatName="";let otherId=null;
    if(chat.user1===chat.user2){chatName="Избранное";}
    else{otherId=chat.user1===currentUser.id?chat.user2:chat.user1;const { data:profile }=await supabase.from('profiles').select('username,status').eq('id',otherId).single();if(profile)chatName=profile.username;}
    const { data:lastMsg }=await supabase.from('messages').select('*').eq('chat_id',chat.id).order('created_at',{ascending:false}).limit(1).maybeSingle();
    const { count:unread }=await supabase.from('messages').select('*',{count:"exact",head:true}).eq('chat_id',chat.id).eq('read',false).neq('sender',currentUser.id);
    enriched.push({chat,chatName,lastMsg,unread});
  }
  enriched.sort((a,b)=>new Date(b.lastMsg?.created_at||0)-new Date(a.lastMsg?.created_at||0));
  enriched.forEach(({chat,chatName,unread})=>{
    const div=document.createElement('div');div.className='chat-item';div.innerHTML=`<span>${chatName}</span>${unread?`<span class="badge">${unread}</span>`:""}`;div.onclick=()=>openChat(chat.id,chatName);list.appendChild(div);
  });
}
async function openChat(chatId,chatName){
  currentChat=chatId;showScreen('chat-screen');document.getElementById('chat-username').innerText=chatName;
  const {data:msgs}=await supabase.from('messages').select('*').eq('chat_id',chatId).order('created_at');
  const cont=document.getElementById('messages');cont.innerHTML='';
  let unreadAdded=false;
  msgs.forEach(m=>{
    if(!m.read&&m.sender!==currentUser.id&&!unreadAdded){cont.innerHTML+=`<div class="unread-line">Непрочитанные</div>`;unreadAdded=true;}
    cont.appendChild(renderMessage(m));
  });
  cont.scrollTop=cont.scrollHeight;
  await supabase.from('messages').update({read:true}).eq('chat_id',chatId).neq('sender',currentUser.id);
}
function renderMessage(msg){
  const div=document.createElement('div');div.className="msg "+(msg.sender===currentUser.id?"me":"other");
  if(msg.deleted){div.classList.add('deleted');div.innerText="Удалено";return div;}
  if(msg.text)div.innerText=msg.text;
  if(msg.image_url){const img=document.createElement('img');img.src=msg.image_url;img.className="msg-img";div.appendChild(img);}
  const time=document.createElement('span');time.className="time";time.innerText=new Date(msg.created_at).toLocaleTimeString();
  if(msg.sender===currentUser.id){
    if(currentChatName==="Избранное")time.innerHTML+=` <span class="ticks">✔✔</span>`;
    else time.innerHTML+=msg.read?` <span class="ticks">✔✔</span>`:` <span class="ticks">✔</span>`;
  }
  div.appendChild(time);
  return div;
}
function chooseImage(){
  const dialog=uploadcare.openDialog(null,{imagesOnly:true});
  dialog.done(file=>{
    file.done(info=>{
      selectedImageUrl=info.cdnUrl;
      const prev=document.getElementById('preview');prev.innerHTML=`<img src="${info.cdnUrl}">`;
    });
  });
}
async function sendMessage(){
  const text=document.getElementById('msg-input').value;
  if(!text&&!selectedImageUrl)return;
  const msg={chat_id:currentChat,sender:currentUser.id,text:text||null,image_url:selectedImageUrl,created_at:new Date().toISOString(),read:false};
  await supabase.from('messages').insert([msg]);
  document.getElementById('msg-input').value="";document.getElementById('preview').innerHTML="";selectedImageUrl=null;
  const cont=document.getElementById('messages');cont.scrollTop=cont.scrollHeight;
  await supabase.from('messages').update({read:true}).eq('chat_id',currentChat).neq('sender',currentUser.id);
}
function sendTyping(){
  supabase.from('messages').insert([{chat_id:currentChat,sender:currentUser.id,typing:true,created_at:new Date().toISOString()}]);
}
</script>
</body>
</html>
