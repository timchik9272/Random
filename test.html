<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>MiniMessenger</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
:root { --bg:#0e0e0e; --bg-light:#1e1e1e; --accent:#0088cc; --text:#fff; --gray:#888; --radius:14px;}
body{margin:0;font-family:sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}
.screen{display:none;flex-direction:column;height:100vh;}
.active{display:flex;}
input,textarea,button{border:none;border-radius:var(--radius);font-size:15px;}
input,textarea{background:var(--bg-light);color:var(--text);padding:10px;}
button{background:var(--accent);color:#fff;padding:10px 12px;font-weight:bold;margin:6px 0;}
nav{display:flex;align-items:center;gap:12px;padding:8px;background:var(--bg);position:sticky;top:0;z-index:10;border-bottom:1px solid #222;}
.chat-list,.messages{flex:1;overflow-y:auto;}
.chat-item{padding:12px;border-bottom:1px solid #222;cursor:pointer;display:flex;justify-content:space-between;align-items:center;}
.chat-item .info{display:flex;flex-direction:column;flex:1;}
.chat-item .last{display:flex;justify-content:space-between;align-items:center;margin-top:4px;font-size:13px;color:var(--gray);}
.unread-badge{background:var(--accent);color:#fff;border-radius:50%;min-width:22px;height:22px;display:flex;justify-content:center;align-items:center;font-size:12px;}
.msg{margin:6px 10px;padding:10px 14px;border-radius:var(--radius);max-width:75%;position:relative;border:1px solid #222;word-wrap:break-word;}
.msg.me{background:var(--accent);margin-left:auto;}
.msg.other{background:var(--bg-light);}
.msg.deleted{font-style:italic;color:var(--gray);}
.msg .reply-to{font-size:13px;color:var(--gray);margin-bottom:6px;border-left:2px solid var(--gray);padding-left:8px;cursor:pointer;display:block;}
.time{display:block;font-size:12px;margin-top:6px;text-align:right;}
.me .time{color:#fff;} .other .time{color:var(--gray);}
img.msg-img{max-width:100%;border-radius:var(--radius);margin-top:6px;display:block;}
.input-box{display:flex;flex-direction:column;gap:6px;padding:8px;background:var(--bg);border-top:1px solid #222;position:sticky;bottom:0;}
.input-row{display:flex;gap:6px;align-items:flex-end;}
.input-box textarea{flex:1;min-height:44px;max-height:140px;padding:12px;border-radius:12px;resize:none;}
.send-btn,.img-btn{width:44px;height:44px;border-radius:50%;display:flex;justify-content:center;align-items:center;font-size:16px;background:var(--accent);color:#fff;border:none;cursor:pointer;}
#preview img{max-width:140px;border-radius:var(--radius);margin:6px;}
.context-menu{position:absolute;background:var(--bg-light);border:1px solid #333;border-radius:8px;display:none;flex-direction:column;z-index:1000;}
.context-menu button{background:none;border:none;color:var(--text);padding:10px 14px;text-align:left;}
.context-menu button:hover{background:#222;}
.ticks{font-size:14px;margin-left:4px;}
.typing-status{font-size:12px;color:var(--gray);}
.unread-separator{text-align:center;color:var(--accent);font-size:13px;margin:10px 0;border-top:1px dashed var(--gray);border-bottom:1px dashed var(--gray);padding:4px 0;}
.reply-preview{display:flex;align-items:center;gap:8px;padding:8px;border-radius:10px;background:#111;margin-bottom:6px;border:1px solid #222;}
.reply-preview .meta{font-size:13px;color:var(--gray);flex:1;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;}
.reply-preview .meta strong{color:var(--gray);font-weight:600;margin-right:6px;}
.reply-preview .cancel{cursor:pointer;padding:6px;border-radius:8px;background:#222;}
.reply-preview .cancel:hover{background:#333;}
.reply-to:hover{background:rgba(255,255,255,0.02);border-radius:8px;padding:6px;}
@media (max-width:520px){
  .msg{max-width:86%;}
  nav h2{font-size:16px;margin:0;}
}
</style>
</head>
<body>

<!-- Вход -->
<div id="login-screen" class="screen active">
  <h2 style="padding:12px">Вход</h2>
  <div style="padding:12px">
    <input id="login-email" placeholder="Email"><br><br>
    <input id="login-password" type="password" placeholder="Пароль"><br><br>
    <button onclick="signIn()">Войти</button>
    <button style="background:var(--bg-light)" onclick="showRegister()">Создать аккаунт</button>
  </div>
</div>

<!-- Регистрация -->
<div id="register-screen" class="screen">
  <h2 style="padding:12px">Регистрация</h2>
  <div style="padding:12px">
    <input id="reg-email" placeholder="Email"><br><br>
    <input id="reg-password" type="password" placeholder="Пароль"><br><br>
    <input id="reg-username" placeholder="Username"><br><br>
    <button onclick="signUp()">Зарегистрироваться</button>
    <button style="background:var(--bg-light)" onclick="showLogin()">Назад</button>
  </div>
</div>

<!-- Главный экран -->
<div id="main-screen" class="screen">
  <nav><h2>Чаты</h2>
    <div>
      <button onclick="openSearch()"><i class="fa fa-plus"></i></button>
      <button onclick="openSettings()"><i class="fa fa-gear"></i></button>
    </div>
  </nav>
  <div class="chat-list" id="chat-list"></div>
</div>

<!-- Новый чат -->
<div id="search-screen" class="screen">
  <nav><button onclick="backToMain()"><i class="fa fa-arrow-left"></i></button><h2>Новый чат</h2></nav>
  <div style="padding:12px"><input id="search-username" placeholder="Введите username"><br><br><button onclick="searchUser()">Создать чат</button></div>
</div>

<!-- Чат -->
<div id="chat-screen" class="screen">
  <nav style="gap:12px;">
    <button onclick="backToMain()"><i class="fa fa-arrow-left"></i></button>
    <div style="display:flex;flex-direction:column;">
      <h2 id="chat-username" style="margin:0;"></h2>
      <div id="chat-status" style="color:var(--gray);font-size:13px;"></div>
      <div id="typing-status" class="typing-status"></div>
    </div>
  </nav>
  <div class="messages" id="messages"></div>
  <div id="preview"></div>
  <div id="reply-preview-container" style="padding:0 8px;display:none;">
    <div id="reply-preview" class="reply-preview">
      <div class="meta"><strong id="reply-username"></strong><span id="reply-text"></span></div>
      <div class="cancel" title="Отменить ответ" onclick="cancelReply()"><i class="fa fa-times"></i></div>
    </div>
  </div>
  <div class="input-box">
    <div class="input-row">
      <textarea id="msg-input" placeholder="Сообщение..."></textarea>
      <button class="img-btn" onclick="chooseImage()" title="Отправить картинку"><i class="fa fa-image"></i></button>
      <button class="send-btn" onclick="sendMessage()" title="Отправить"><i class="fa fa-paper-plane"></i></button>
    </div>
  </div>
</div>

<!-- Настройки -->
<div id="settings-screen" class="screen">
  <nav><button onclick="backToMain()"><i class="fa fa-arrow-left"></i></button><h2>Настройки</h2></nav>
  <div style="padding:12px"><div id="profile-info"></div><br>
    <button onclick="deleteAccount()" style="background:#c00">Удалить аккаунт</button>
    <button onclick="logout()" style="background:var(--bg-light)">Выйти</button></div>
</div>

<div id="context-menu" class="context-menu">
  <button onclick="copyMessage()">Копировать</button>
  <button onclick="confirmDelete()">Удалить</button>
  <button onclick="replyMessage()">Ответить</button>
</div>

<script>
// === Supabase / Uploadcare ===
const supabase = window.supabase.createClient("https://zmewwzlzujsrhstjehrp.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InptZXd3emx6dWpzcmhzdGplaHJwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5NjM4MDksImV4cCI6MjA3MTUzOTgwOX0.kBBXwlCEl5szgK4vKgaPBhPOVYmoFzly2TXR-fI8D24");
uploadcare.start({ publicKey:"c12f2c3e134f56024db8" });

let currentUser=null,currentChat=null,msgSubscription=null,chatSubscription=null;
let selectedMessageId=null,selectedSender=null,selectedImageUrl=null,replyToMessage=null;

/* --- Экраны --- */
function showScreen(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');}
function showLogin(){showScreen('login-screen');}
function showRegister(){showScreen('register-screen');}
function showMain(){loadChats();showScreen('main-screen');}
function openSettings(){loadProfile();showScreen('settings-screen');}
function openSearch(){showScreen('search-screen');}
function backToMain(){if(msgSubscription) supabase.removeChannel(msgSubscription);showMain();}

/* --- Аутентификация --- */
async function signUp(){
  const email=document.getElementById('reg-email').value,password=document.getElementById('reg-password').value,username=document.getElementById('reg-username').value;
  const { data,error }=await supabase.auth.signUp({ email,password,options:{ data:{username} }});
  if(error){alert(error.message);return;}
  await supabase.from('profiles').insert([{ id:data.user.id,email,username,status:'онлайн',typing:false }]);
  alert("Подтвердите email и войдите");showLogin();
}
async function signIn(){
  const email=document.getElementById('login-email').value,password=document.getElementById('login-password').value;
  const { data,error }=await supabase.auth.signInWithPassword({ email,password });
  if(error){alert(error.message);return;}
  currentUser=data.user;
  await supabase.from('profiles').update({status:'онлайн'}).eq('id',currentUser.id);
  showMain();subscribeChats();
}
async function logout(){
  await supabase.from('profiles').update({status:`был(а) в ${new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})} ${new Date().toLocaleDateString('ru-RU')}`,typing:false}).eq('id',currentUser.id);
  await supabase.auth.signOut();currentUser=null;showLogin();
}
async function loadProfile(){
  const { data }=await supabase.from('profiles').select('*').eq('id',currentUser.id).single();
  document.getElementById('profile-info').innerText=`Username: ${data.username}\nEmail: ${data.email}\nСтатус: ${data.status}`;
}
async function deleteAccount(){await supabase.from('profiles').delete().eq('id',currentUser.id);logout();}

/* --- Статус --- */
function formatStatus(profile){if(profile.typing) return 'печатает...';if(!profile.status) return '';return profile.status;}
async function getUsernameById(id){if(!id) return 'Unknown';const { data } = await supabase.from('profiles').select('username').eq('id',id).single();return data?.username || 'Unknown';}

/* --- Чаты --- */
async function loadChats(){
  const { data:chats }=await supabase.from('chats').select('*').or(`user1.eq.${currentUser.id},user2.eq.${currentUser.id}`);
  const list=document.getElementById('chat-list');list.innerHTML='';
  if(!chats) return;
  let chatData=[];
  for(const chat of chats){
    let otherId=chat.user1===currentUser.id?chat.user2:chat.user1;
    const { data:profile }=await supabase.from('profiles').select('username').eq('id',otherId).single();
    let chatName = profile?.username || 'Unknown';
    const { data:msgs }=await supabase.from('messages').select('*').eq('chat_id',chat.id).order('created_at',{ascending:false}).limit(1);
    let lastMsgText="",lastMsgImg=false,lastTime="";
    if(msgs && msgs.length>0){
      lastMsgText=msgs[0].content||"";
      lastMsgImg=!!msgs[0].image_url;
      const d=new Date(msgs[0].created_at);
      const today=new Date();
      if(d.toDateString()===today.toDateString()){lastTime=d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});}
      else{lastTime=d.toLocaleDateString('ru-RU');}
    }
    const { data:unread }=await supabase.from('messages').select('*').eq('chat_id',chat.id).eq('read',false).neq('sender',currentUser.id);
    const unreadCount=(unread||[]).length;
    chatData.push({chatId:chat.id,chatName,lastMsgText,lastMsgImg,lastTime,unreadCount,lastCreated:msgs[0]?.created_at||0,otherId});
  }
  chatData.sort((a,b)=>new Date(b.lastCreated)-new Date(a.lastCreated));
  for(const c of chatData){
    const div=document.createElement('div');div.className='chat-item';
    const info=document.createElement('div');info.className='info';
    const name=document.createElement('div');name.innerText=c.chatName;
    const last=document.createElement('div');last.className='last';
    let msgTxt=(c.lastMsgImg?"🖼":"")+(c.lastMsgText?" "+c.lastMsgText:"");
    last.innerHTML=`<span style="overflow:hidden;white-space:nowrap;text-overflow:ellipsis;display:inline-block;max-width:180px">${msgTxt}</span><span>${c.lastTime}</span>`;
    info.appendChild(name);info.appendChild(last);div.appendChild(info);
    if(c.unreadCount>0){const badge=document.createElement('div');badge.className='unread-badge';badge.innerText=c.unreadCount;div.appendChild(badge);}
    div.onclick=()=>openChat(c.chatId,c.chatName,c.otherId);
    list.appendChild(div);
  }
}
function subscribeChats(){if(chatSubscription) supabase.removeChannel(chatSubscription);chatSubscription=supabase.channel('chats-r').on('postgres_changes',{event:'INSERT',schema:'public',table:'chats'},()=>loadChats()).subscribe();}

/* --- Сообщения --- */
async function openChat(chatId,otherName,otherId){
  currentChat=chatId;
  document.getElementById('chat-username').innerText=otherName;
  showScreen('chat-screen');
  await loadMessages();
  if(msgSubscription) supabase.removeChannel(msgSubscription);
  msgSubscription=supabase.channel('room-'+chatId)
    .on('postgres_changes',{event:'INSERT',schema:'public',table:'messages',filter:`chat_id=eq.${chatId}`},p=>renderMessage(p.new,true))
    .subscribe();
  await supabase.from('messages').update({read:true}).eq('chat_id',chatId).neq('sender',currentUser.id);
  if(otherId){
    if(window.statusChannelOther) supabase.removeChannel(window.statusChannelOther);
    window.statusChannelOther = supabase.channel('status-'+otherId).on('postgres_changes',{event:'UPDATE',schema:'public',table:'profiles',filter:`id=eq.${otherId}`},p=>{
      const st = formatStatus(p.new);
      document.getElementById('chat-status').innerText=st;
      document.getElementById('typing-status').innerText = p.new.typing ? 'печатает...' : '';
    }).subscribe();
    const { data:profile } = await supabase.from('profiles').select('*').eq('id',otherId).single();
    if(profile) document.getElementById('chat-status').innerText = formatStatus(profile);
  }
}

/* --- Автопрокрутка к первому непрочитанному --- */
async function loadMessages(){
  const { data }=await supabase.from('messages').select('*').eq('chat_id',currentChat).order('created_at',{ascending:true});
  const box=document.getElementById('messages');box.innerHTML='';
  if(!data) return;
  let firstUnreadId=null;
  for(const msg of data){
    if(!msg.read && msg.sender!==currentUser.id && !firstUnreadId) firstUnreadId=msg.id;
    await renderMessage(msg,false);
  }
  if(firstUnreadId){
    const el=document.getElementById('msg-'+firstUnreadId);
    if(el){el.scrollIntoView({behavior:'smooth',block:'center'});el.style.boxShadow='0 0 0 2px rgba(0,136,204,0.12)';setTimeout(()=>{el.style.boxShadow='';},1400);}
  } else {box.scrollTop=box.scrollHeight;}
}

/* --- renderMessage --- */
async function renderMessage(msg,scroll=true){
  const box=document.getElementById('messages');
  let div=document.getElementById('msg-'+msg.id);
  const isMe = (msg.sender===currentUser.id);
  if(!div){div=document.createElement('div');div.id='msg-'+msg.id;div.className='msg '+(isMe?'me':'other');div.oncontextmenu=(e)=>{e.preventDefault();showContextMenu(e,msg.id,msg.sender);};box.appendChild(div);}
  else {div.className = 'msg ' + (isMe ? 'me' : 'other');}
  if(msg.is_deleted){div.className='msg deleted';div.innerText='Сообщение удалено';if(scroll) box.scrollTop=box.scrollHeight;return;}
  let htmlParts = [];
  if(msg.reply_to){
    try{
      const { data:orig } = await supabase.from('messages').select('*').eq('id',msg.reply_to).single();
      if(orig){
        const username = await getUsernameById(orig.sender);
        let snippet = orig.content && orig.content.trim().length>0 ? orig.content.trim().slice(0,120) : (orig.image_url ? '[изображение]' : '[сообщение]');
        const headerHTML = `<div class="reply-to" data-reply-id="${orig.id}" style="font-size:13px;color:var(--gray);border-left:2px solid var(--gray);padding-left:6px;">Ответ <strong>@${escapeHtml(username)}</strong>: ${escapeHtml(snippet)}</div>`;
        htmlParts.push(headerHTML);
      } else {htmlParts.push(`<div class="reply-to" style="font-size:13px;color:var(--gray)">Ответ: (сообщение удалено)</div>`);}
    }catch(e){htmlParts.push(`<div class="reply-to" style="font-size:13px;color:var(--gray)">Ответ</div>`);}
  }
  if(msg.content) htmlParts.push(`<div>${escapeHtml(msg.content)}</div>`);
  if(msg.image_url) htmlParts.push(`<img src="${msg.image_url}" class="msg-img">`);
  const ticks = isMe?'<span class="ticks">✔✔</span>':'';
  htmlParts.push(`<span class="time">${new Date(msg.created_at).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})} ${ticks}</span>`);
  div.innerHTML = htmlParts.join('');
  const replyElems = div.querySelectorAll('.reply-to');
  replyElems.forEach(el=>{
    const rid = el.getAttribute('data-reply-id');
    el.style.cursor = 'pointer';
    el.onclick = (ev)=>{
      ev.stopPropagation();
      if(rid){
        const target = document.getElementById('msg-'+rid);
        if(target){target.scrollIntoView({behavior:'smooth',block:'center'});target.style.boxShadow = '0 0 0 2px rgba(0,136,204,0.12)';setTimeout(()=>{target.style.boxShadow='';},1400);}
      }
    };
  });
  if(scroll){box.scrollTop = box.scrollHeight;}
}

/* --- Отправка сообщения --- */
async function sendMessage(){
  const text=document.getElementById('msg-input').value.trim();
  if(!text && !selectedImageUrl) return;
  const payload = {chat_id:currentChat,sender:currentUser.id,content:text||null,image_url:selectedImageUrl||null,reply_to: replyToMessage ? replyToMessage.id : null,read:false};
  await supabase.from('messages').insert([payload]);
  document.getElementById('msg-input').value='';selectedImageUrl=null;replyToMessage=null;document.getElementById('preview').innerHTML='';hideReplyPreview();
  const box=document.getElementById('messages');box.scrollTop=box.scrollHeight;
}
function chooseImage(){uploadcare.openDialog(null,{publicKey:"c12f2c3e134f56024db8"}).done(file=>{file.done(info=>{selectedImageUrl=info.cdnUrl;document.getElementById('preview').innerHTML=`<img src="${selectedImageUrl}">`;});});}

/* --- Контекст --- */
function showContextMenu(e,msgId,senderId){selectedMessageId=msgId;selectedSender=senderId;const menu=document.getElementById('context-menu');menu.style.left=e.pageX+'px';menu.style.top=e.pageY+'px';menu.style.display='flex';}
function copyMessage(){if(!selectedMessageId)return;const el=document.getElementById('msg-'+selectedMessageId);if(el)navigator.clipboard.writeText(el.innerText);selectedMessageId=null;document.getElementById('context-menu').style.display='none';}
function confirmDelete(){if(!selectedMessageId)return;supabase.from('messages').update({is_deleted:true}).eq('id',selectedMessageId).eq('sender',currentUser.id);selectedMessageId=null;document.getElementById('context-menu').style.display='none';}
async function replyMessage(){if(!selectedMessageId)return;document.getElementById('context-menu').style.display='none';const el=document.getElementById('msg-'+selectedMessageId);if(!el) return;const text = el.innerText.split('\n')[0].slice(0,180);const { data:msg } = await supabase.from('messages').select('*').eq('id',selectedMessageId).single();const uname = await getUsernameById(msg.sender);replyToMessage = { id: selectedMessageId, text: text, username: uname };showReplyPreview(replyToMessage);}
function showReplyPreview(replyObj){const container = document.getElementById('reply-preview-container');document.getElementById('reply-username').innerText = '@' + (replyObj.username || 'user');document.getElementById('reply-text').innerText = ' ' + (replyObj.text||'');container.style.display = 'block';const preview = document.getElementById('reply-preview');preview.onclick = (e) => {e.stopPropagation();const target = document.getElementById('msg-'+replyObj.id);if(target){target.scrollIntoView({behavior:'smooth',block:'center'});target.style.boxShadow = '0 0 0 2px rgba(0,136,204,0.12)';setTimeout(()=>{target.style.boxShadow='';},1400);} else {alert('Исходное сообщение не на этой странице.');}};}
function hideReplyPreview(){document.getElementById('reply-preview-container').style.display='none';document.getElementById('reply-preview').onclick = null;}
function cancelReply(){replyToMessage=null;hideReplyPreview();}

/* --- Печатает --- */
document.getElementById('msg-input').addEventListener('input',async()=>{
  if(!currentUser) return;
  await supabase.from('profiles').update({typing:true,status:'печатает...'}).eq('id',currentUser.id);
  clearTimeout(window.typingTimeout);
  window.typingTimeout=setTimeout(async()=>{await supabase.from('profiles').update({typing:false,status:'онлайн'}).eq('id',currentUser.id);},1500);
});

/* --- Отправка по Enter --- */
document.getElementById('msg-input').addEventListener('keydown',async (e)=>{
  if(e.key==='Enter' && !e.shiftKey){e.preventDefault();sendMessage();}
});

/* --- Сессия --- */
window.addEventListener('load',async()=>{
  const { data:{session}}=await supabase.auth.getSession();
  if(session){currentUser=session.user;showMain();subscribeChats();}
});
window.addEventListener('beforeunload',()=>{if(currentUser)supabase.from('profiles').update({status:`был(а) в ${new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})} ${new Date().toLocaleDateString('ru-RU')}`,typing:false}).eq('id',currentUser.id);});
document.addEventListener('visibilitychange',()=>{if(document.hidden&&currentUser)supabase.from('profiles').update({status:`был(а) в ${new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})} ${new Date().toLocaleDateString('ru-RU')}`,typing:false}).eq('id',currentUser.id);});
window.onclick=()=>{document.getElementById('context-menu').style.display='none';};

/* --- Хелпер --- */
function escapeHtml(text){const div=document.createElement('div');div.textContent=text;return div.innerHTML;}
</script>
</body>
</html>
