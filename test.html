<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>MiniMessenger — улучшено</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
:root { --bg:#0e0e0e; --bg-light:#1e1e1e; --accent:#0088cc; --text:#fff; --gray:#888; --radius:14px; --reply-bg:#17202a; --highlight:#2a4a5a; }
body{margin:0;font-family:sans-serif;background:var(--bg);color:var(--text);}
.screen{display:none;flex-direction:column;height:100vh;}
.active{display:flex;}
input,textarea,button{border:none;border-radius:var(--radius);font-size:15px;}
input,textarea{background:var(--bg-light);color:var(--text);padding:10px;}
button{background:var(--accent);color:#fff;padding:10px 12px;font-weight:bold;margin:6px 0;}
nav{display:flex;align-items:center;gap:12px;justify-content:space-between;padding:8px;background:var(--bg);position:sticky;top:0;z-index:10;border-bottom:1px solid #222;}
.chat-list,.messages{flex:1;overflow-y:auto;}
.chat-item{padding:12px;border-bottom:1px solid #222;cursor:pointer;display:flex;justify-content:space-between;align-items:center;}
.chat-item .info{display:flex;flex-direction:column;flex:1;}
.chat-item .last{display:flex;justify-content:space-between;align-items:center;margin-top:4px;font-size:13px;color:var(--gray);}
.unread-badge{background:var(--accent);color:#fff;border-radius:50%;min-width:22px;height:22px;display:flex;justify-content:center;align-items:center;font-size:12px;}
.msg{margin:6px 10px;padding:10px 14px;border-radius:var(--radius);max-width:75%;position:relative;border:1px solid #222;word-break:break-word;}
.msg.me{background:var(--accent);margin-left:auto;color:#fff;}
.msg.other{background:var(--bg-light);}
.msg.deleted{font-style:italic;color:var(--gray);background:transparent;border:0;padding:6px 10px;}
.msg .reply-to{font-size:12px;color:var(--accent);margin-bottom:6px;border-left:2px solid var(--accent);padding-left:8px;}
.reply-header{background:var(--reply-bg);padding:6px 8px;border-radius:10px;margin-bottom:8px;font-size:13px;display:flex;align-items:center;gap:8px;}
.reply-header span.small{font-size:12px;color:var(--gray);}
.time{display:block;font-size:12px;margin-top:6px;text-align:right;}
.me .time{color:#fff;} .other .time{color:var(--gray);}
img.msg-img{max-width:100%;border-radius:var(--radius);margin-top:6px;display:block;}
.input-box{display:flex;flex-direction:column;gap:6px;padding:8px;background:var(--bg);border-top:1px solid #222;position:sticky;bottom:0;}
.input-row{display:flex;gap:6px;}
.input-box textarea{flex:1;min-height:44px;max-height:140px;padding:10px;border-radius:12px;}
.send-btn,.img-btn{width:44px;height:44px;border-radius:50%;display:flex;justify-content:center;align-items:center;font-size:16px;background:var(--accent);color:#fff;border:0;}
#preview img{max-width:140px;border-radius:var(--radius);margin:6px;}
.context-menu{position:absolute;background:var(--bg-light);border:1px solid #333;border-radius:8px;display:none;flex-direction:column;z-index:1000;}
.context-menu button{background:none;border:none;color:var(--text);padding:10px 14px;text-align:left;}
.context-menu button:hover{background:#222;}
.ticks{font-size:14px;margin-left:4px;}
.typing-status{font-size:12px;color:var(--gray);}
.unread-separator{text-align:center;color:var(--accent);font-size:13px;margin:10px 0;border-top:1px dashed var(--gray);border-bottom:1px dashed var(--gray);padding:4px 0;}
.reply-preview{background:var(--reply-bg);padding:8px;border-radius:10px;display:flex;align-items:center;justify-content:space-between;gap:8px;}
.reply-preview .left{display:flex;gap:8px;align-items:center;}
.reply-preview .meta{font-size:13px;color:var(--text);max-width:75% ;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.reply-preview .cancel{cursor:pointer;padding:6px;border-radius:8px;background:#2a2a2a;}
.highlight{box-shadow:0 0 0 3px rgba(0,136,204,0.12);animation:flash 2s;}
@keyframes flash{0%{background:var(--highlight)}30%{background:transparent}60%{background:var(--highlight)}100%{background:transparent}}
.small-muted{font-size:12px;color:var(--gray);}
</style>
</head>
<body>

<!-- Вход -->
<div id="login-screen" class="screen active">
  <h2 style="padding:12px">Вход</h2>
  <div style="padding:12px">
    <input id="login-email" placeholder="Email"><br><br>
    <input id="login-password" type="password" placeholder="Пароль"><br><br>
    <button onclick="signIn()">Войти</button>
    <button style="background:var(--bg-light)" onclick="showRegister()">Создать аккаунт</button>
  </div>
</div>

<!-- Регистрация -->
<div id="register-screen" class="screen">
  <h2 style="padding:12px">Регистрация</h2>
  <div style="padding:12px">
    <input id="reg-email" placeholder="Email"><br><br>
    <input id="reg-password" type="password" placeholder="Пароль"><br><br>
    <input id="reg-username" placeholder="Username"><br><br>
    <button onclick="signUp()">Зарегистрироваться</button>
    <button style="background:var(--bg-light)" onclick="showLogin()">Назад</button>
  </div>
</div>

<!-- Главный экран -->
<div id="main-screen" class="screen">
  <nav><h2>Чаты</h2>
    <div>
      <button onclick="openSearch()"><i class="fa fa-plus"></i></button>
      <button onclick="openSettings()"><i class="fa fa-gear"></i></button>
    </div>
  </nav>
  <div class="chat-list" id="chat-list"></div>
</div>

<!-- Новый чат -->
<div id="search-screen" class="screen">
  <nav><button onclick="backToMain()"><i class="fa fa-arrow-left"></i></button><h2>Новый чат</h2></nav>
  <div style="padding:12px"><input id="search-username" placeholder="Введите username"><br><br><button onclick="searchUser()">Создать чат</button></div>
</div>

<!-- Чат -->
<div id="chat-screen" class="screen">
  <nav style="align-items:flex-start;">
    <div style="display:flex;gap:12px;align-items:center;">
      <button onclick="backToMain()"><i class="fa fa-arrow-left"></i></button>
      <div>
        <h2 id="chat-username" style="margin:0"></h2>
        <div id="chat-status" class="small-muted"></div>
        <div id="typing-status" class="typing-status"></div>
      </div>
    </div>
    <div style="display:flex;flex-direction:column;align-items:flex-end;">
      <div id="chat-last-updated" class="small-muted"></div>
    </div>
  </nav>
  <div class="messages" id="messages"></div>

  <div id="preview"></div>

  <div class="input-box">
    <!-- preview блока ответа (появляется при выборе "Ответить") -->
    <div id="reply-preview-container" style="display:none;">
      <div class="reply-preview" id="reply-preview">
        <div class="left">
          <i class="fa fa-reply"></i>
          <div>
            <div class="meta" id="reply-meta"></div>
            <div class="small-muted" id="reply-snippet"></div>
          </div>
        </div>
        <div style="display:flex;gap:6px;align-items:center;">
          <div class="cancel" id="reply-cancel" title="Отменить ответ"><i class="fa fa-times"></i></div>
        </div>
      </div>
    </div>

    <div class="input-row">
      <textarea id="msg-input" placeholder="Сообщение..."></textarea>
      <button class="img-btn" onclick="chooseImage()"><i class="fa fa-image"></i></button>
      <button class="send-btn" onclick="sendMessage()"><i class="fa fa-paper-plane"></i></button>
    </div>
    <div id="preview"></div>
  </div>
</div>

<!-- Настройки -->
<div id="settings-screen" class="screen">
  <nav><button onclick="backToMain()"><i class="fa fa-arrow-left"></i></button><h2>Настройки</h2></nav>
  <div style="padding:12px"><div id="profile-info"></div><br>
    <button onclick="deleteAccount()" style="background:#c00">Удалить аккаунт</button>
    <button onclick="logout()" style="background:var(--bg-light)">Выйти</button></div>
</div>

<!-- Контекстное меню -->
<div id="context-menu" class="context-menu">
  <button onclick="copyMessage()">Копировать</button>
  <button onclick="confirmDelete()">Удалить</button>
  <button onclick="replyMessage()">Ответить</button>
</div>

<script>
/* ============ Конфигурация Supabase / Uploadcare ============ */
const supabase = window.supabase.createClient(
  "https://zmewwzlzujsrhstjehrp.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InptZXd3emx6dWpzcmhzdGplaHJwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5NjM4MDksImV4cCI6MjA3MTUzOTgwOX0.kBBXwlCEl5szgK4vKgaPBhPOVYmoFzly2TXR-fI8D24"
);
uploadcare.start({ publicKey:"c12f2c3e134f56024db8" });

/* ============ Состояние ============ */
let currentUser=null,currentChat=null,msgSubscription=null,chatSubscription=null;
let selectedMessageId=null,selectedSender=null,selectedImageUrl=null;
let replyToMessage=null; // {id, username, snippet}

/* ============ Утилиты ============ */
function showScreen(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');}
function formatDateTimeISO(dt){ const d=new Date(dt); const dd=String(d.getDate()).padStart(2,'0'); const mm=String(d.getMonth()+1).padStart(2,'0'); const yyyy=d.getFullYear(); const hh=String(d.getHours()).padStart(2,'0'); const min=String(d.getMinutes()).padStart(2,'0'); return `${hh}:${min} ${dd}.${mm}.${yyyy}`; }
function formatTimeOnly(dt){ const d=new Date(dt); return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }

/* ============ Экраны ============ */
function showLogin(){showScreen('login-screen');}
function showRegister(){showScreen('register-screen');}
function showMain(){loadChats();showScreen('main-screen');}
function openSettings(){loadProfile();showScreen('settings-screen');}
function openSearch(){showScreen('search-screen');}
async function backToMain(){
  if(msgSubscription) await supabase.removeChannel(msgSubscription);
  if(chatSubscription) await supabase.removeChannel(chatSubscription);
  showMain();
}

/* ============ Аутентификация ============ */
async function signUp(){
  const email=document.getElementById('reg-email').value,password=document.getElementById('reg-password').value,username=document.getElementById('reg-username').value;
  const { data,error }=await supabase.auth.signUp({ email,password,options:{ data:{username} }});
  if(error){alert(error.message);return;}
  await supabase.from('profiles').insert([{ id:data.user.id,email,username,status:'онлайн',typing:false }]);
  alert("Подтвердите email и войдите");showLogin();
}

async function signIn(){
  const email=document.getElementById('login-email').value,password=document.getElementById('login-password').value;
  const { data,error }=await supabase.auth.signInWithPassword({ email,password });
  if(error){alert(error.message);return;}
  currentUser=data.user;
  await supabase.from('profiles').update({status:'онлайн'}).eq('id',currentUser.id);
  showMain();subscribeChats();
}

async function logout(){
  await supabase.from('profiles').update({status:`был(а) в ${new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})} ${new Date().toLocaleDateString()}`,typing:false}).eq('id',currentUser.id);
  await supabase.auth.signOut();currentUser=null;showLogin();
}

async function loadProfile(){
  const { data }=await supabase.from('profiles').select('*').eq('id',currentUser.id).single();
  document.getElementById('profile-info').innerText=`Username: ${data.username}\nEmail: ${data.email}\nСтатус: ${data.status}`;
}

async function deleteAccount(){ if(!confirm('Удалить аккаунт навсегда?')) return; await supabase.from('profiles').delete().eq('id',currentUser.id); logout(); }

/* ============ Чаты (сортировка по новизне) ============ */
async function loadChats(){
  // Сортируем на уровне БД по updated_at (новее сверху)
  const { data:chats }=await supabase.from('chats')
    .select('*')
    .or(`user1.eq.${currentUser.id},user2.eq.${currentUser.id}`)
    .order('updated_at',{ascending:false});
  const list=document.getElementById('chat-list');list.innerHTML='';
  if(!chats) return;
  for(const chat of chats){
    let chatName="",otherId=null,lastMsgText="",lastMsgImg=false,unreadCount=0,lastTime="";
    if(chat.user1===chat.user2){chatName="Избранное";}
    else{ otherId=chat.user1===currentUser.id?chat.user2:chat.user1;
      const { data:profile }=await supabase.from('profiles').select('username,status,typing').eq('id',otherId).single();
      if(profile){
        chatName=profile.username;
        // можно показывать статус рядом, но чтобы не загромождать, оставим внутри элемента
      }
    }
    // берем последний месседж (если есть)
    const { data:msgs }=await supabase.from('messages').select('*').eq('chat_id',chat.id).order('created_at',{ascending:false}).limit(1);
    if(msgs && msgs.length>0){ lastMsgText=msgs[0].content||""; lastMsgImg=!!msgs[0].image_url; lastTime=formatTimeOnly(msgs[0].created_at); }
    const { data:unread }=await supabase.from('messages').select('*').eq('chat_id',chat.id).eq('read',false).neq('sender',currentUser.id);
    unreadCount=unread?unread.length:0;
    const div=document.createElement('div');div.className='chat-item';
    const info=document.createElement('div');info.className='info';
    const name=document.createElement('div');name.innerText=chatName;
    const last=document.createElement('div');last.className='last';
    let msgTxt=(lastMsgImg?"🖼":"")+(lastMsgText?" "+lastMsgText:"");
    last.innerHTML=`<span style="overflow:hidden;white-space:nowrap;text-overflow:ellipsis;max-width:220px;display:inline-block">${msgTxt}</span><span>${lastTime}</span>`;
    info.appendChild(name);info.appendChild(last);
    div.appendChild(info);
    if(unreadCount>0){const badge=document.createElement('div');badge.className='unread-badge';badge.innerText=unreadCount;div.appendChild(badge);}
    div.onclick=()=>openChat(chat.id,chatName,otherId);
    list.appendChild(div);
  }
}

function subscribeChats(){ if(chatSubscription) supabase.removeChannel(chatSubscription); chatSubscription=supabase.channel('chats-r').on('postgres_changes',{event:'INSERT',schema:'public',table:'chats'},()=>loadChats()).subscribe(); }

/* ============ Сообщения ============ */
async function openChat(chatId,otherName,otherId){
  currentChat=chatId;
  document.getElementById('chat-username').innerText=otherName;
  showScreen('chat-screen');
  await loadMessages();
  if(msgSubscription) supabase.removeChannel(msgSubscription);
  msgSubscription=supabase.channel('room-'+chatId)
    .on('postgres_changes',{event:'INSERT',schema:'public',table:'messages',filter:`chat_id=eq.${chatId}`},p=>renderMessage(p.new,true))
    .subscribe();
  await supabase.from('messages').update({read:true}).eq('chat_id',chatId).neq('sender',currentUser.id);
  // следим за статусом собеседника
  if(otherId){
    const ch = supabase.channel('status-'+otherId).on('postgres_changes',{event:'UPDATE',schema:'public',table:'profiles',filter:`id=eq.${otherId}`},p=>{
      document.getElementById('chat-status').innerText = prettyStatus(p.new);
      document.getElementById('typing-status').innerText = p.new.typing ? "печатает..." : "";
      document.getElementById('chat-last-updated').innerText = p.new.last_active ? formatDateTimeISO(p.new.last_active) : '';
    }).subscribe();
  }
}

function prettyStatus(profile){
  // profile: {status, typing, ...}
  if(profile.typing) return "печатает...";
  const st = profile.status || "";
  // Попробуем распознать "был(а) в HH:MM DD.MM.YYYY" или "онлайн"
  if(st.includes('онлайн')) return 'онлайн';
  return st; // fallback: строка, которую дал бэкенд
}

async function loadMessages(){
  const { data }=await supabase.from('messages').select('*').eq('chat_id',currentChat).order('created_at',{ascending:true});
  const box=document.getElementById('messages');box.innerHTML='';
  let insertedUnread=false;
  for(const msg of data || []){
    if(!msg.read && msg.sender!==currentUser.id && !insertedUnread){const sep=document.createElement('div');sep.className='unread-separator';sep.innerText='Непрочитанные';box.appendChild(sep);insertedUnread=true;}
    renderMessage(msg,false);
  }
  box.scrollTop=box.scrollHeight;
}

function renderMessage(msg,scroll=true){
  const box=document.getElementById('messages');
  let div=document.getElementById('msg-'+msg.id);
  const isMe = msg.sender===currentUser.id;
  if(!div){
    div=document.createElement('div');div.id='msg-'+msg.id;div.className='msg '+(isMe?'me':'other');
    // store meta attributes for reply usage
    div.dataset.sender = msg.sender;
    div.dataset.content = msg.content || '';
    div.dataset.created = msg.created_at;
    div.oncontextmenu=(e)=>{ e.preventDefault(); showContextMenu(e,msg.id,msg.sender); };
    box.appendChild(div);
  }
  if(msg.is_deleted){ div.className='msg deleted'; div.innerText='Сообщение удалено'; }
  else{
    let html="";
    // Если есть reply_to — добавить заголовок внутри сообщения
    if(msg.reply_to){
      // попытаемся получить данные об оригинальном сообщении, если тот же чат — читаем DOM (если доступно)
      let orig = document.getElementById('msg-'+msg.reply_to);
      let rname = "неизвестно";
      let rsnippet = "";
      if(orig){
        rname = orig.dataset.username || orig.dataset.sender || rname;
        rsnippet = (orig.dataset.content||"").split('\n')[0].slice(0,120);
      } else {
        // если DOM-а нет — попытаемся получить из БД (асинхронно)
        (async ()=>{
          const { data:om } = await supabase.from('messages').select('*').eq('id',msg.reply_to).single();
          if(om){
            const username = await getUsername(om.sender);
            const header = `<div class="reply-to">Ответ @${username}: ${ (om.content||'').split('\n')[0].slice(0,120) }</div>`;
            const container = document.getElementById('msg-'+msg.id);
            if(container) container.querySelector('.reply-to-temp')?.remove();
            if(container) container.insertAdjacentHTML('afterbegin', header);
          }
        })();
      }
      // вставляем временно (если DOM доступен, то сразу)
      if(orig){
        const uname = orig.dataset.username || (orig.dataset.sender? ('user_'+orig.dataset.sender) : 'user');
        const snippet = rsnippet;
        html += `<div class="reply-to">Ответ @${uname}: ${snippet}</div>`;
      } else {
        // placeholder — подробность будет подгружена асинхронно
        html += `<div class="reply-to reply-to-temp">Ответ — загружается…</div>`;
      }
    }

    // контент и изображение. ВАЖНО: заголовок "reply-to" должен быть **выше** изображения — соблюдён.
    if(msg.content) html += `<div>${escapeHtml(msg.content)}</div>`;
    if(msg.image_url) html += `<img src="${msg.image_url}" class="msg-img">`;

    let ticks = isMe?'<span class="ticks">✔✔</span>':'';
    html += `<span class="time">${formatTimeOnly(msg.created_at)} ${ticks}</span>`;

    div.innerHTML = html;

    // Добавим meta-данные: username (если получим)
    (async ()=>{
      // если у нас ещё нет dataset.username — получим
      if(!div.dataset.username){
        const uname = await getUsername(msg.sender);
        div.dataset.username = uname || ('user_'+msg.sender);
      }
    })();
  }

  if(scroll){
    box.scrollTop = box.scrollHeight;
  }
}

/* вспомогательная безопасная экранизация HTML */
function escapeHtml(text){
  if(!text) return '';
  return text.replace(/[&<>"'`=\/]/g, function(s){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'})[s]; });
}

/* получить username по id (кеширование) */
const usernameCache = {};
async function getUsername(userId){
  if(usernameCache[userId]) return usernameCache[userId];
  try{
    const { data } = await supabase.from('profiles').select('username').eq('id',userId).single();
    if(data && data.username){ usernameCache[userId] = data.username; return data.username; }
  }catch(e){}
  return null;
}

/* ============ Отправка сообщения + поддержка reply ============ */
async function sendMessage(){
  const text = document.getElementById('msg-input').value.trim();
  if(!text && !selectedImageUrl) return;
  const payload = {
    chat_id: currentChat,
    sender: currentUser.id,
    content: text||null,
    image_url: selectedImageUrl || null,
    reply_to: replyToMessage ? replyToMessage.id : null,
    read: false
  };
  await supabase.from('messages').insert([payload]);
  // Сброс UI
  document.getElementById('msg-input').value='';
  selectedImageUrl=null;
  document.getElementById('preview').innerHTML='';
  clearReplyPreview();
  // Обновим чат updated_at (удобно для сортировки)
  await supabase.from('chats').update({ updated_at: new Date().toISOString() }).eq('id', currentChat);
  const box=document.getElementById('messages');box.scrollTop=box.scrollHeight;
}

function chooseImage(){ uploadcare.openDialog(null,{publicKey:"c12f2c3e134f56024db8"}).done(file=>{ file.done(info=>{ selectedImageUrl=info.cdnUrl; document.getElementById('preview').innerHTML=`<img src="${selectedImageUrl}">`; }); }); }

/* ============ Контекстное меню (копировать, удалить, ответить) ============ */
function showContextMenu(e,msgId,senderId){ selectedMessageId=msgId; selectedSender=senderId; const menu=document.getElementById('context-menu'); menu.style.left=e.pageX+'px'; menu.style.top=e.pageY+'px'; menu.style.display='flex'; }
function copyMessage(){ if(!selectedMessageId) return; const el=document.getElementById('msg-'+selectedMessageId); if(el) navigator.clipboard.writeText(el.innerText); selectedMessageId=null; document.getElementById('context-menu').style.display='none'; }
function confirmDelete(){ if(!selectedMessageId) return; supabase.from('messages').update({is_deleted:true}).eq('id',selectedMessageId).eq('sender',currentUser.id); selectedMessageId=null; document.getElementById('context-menu').style.display='none'; }
async function replyMessage(){ 
  if(!selectedMessageId) return;
  const el=document.getElementById('msg-'+selectedMessageId);
  // возьмём username/snippet
  let username = el?.dataset.username || await getUsername(el?.dataset.sender) || ('user_'+el?.dataset.sender);
  let snippet = (el?.dataset.content || '').split('\n')[0].slice(0,120);
  replyToMessage = { id: selectedMessageId, username, snippet };
  showReplyPreview();
  selectedMessageId=null;
  document.getElementById('context-menu').style.display='none';
}

/* ============ Preview ответа (кнопка крестик, клик скроллит к сообщению) ============ */
function showReplyPreview(){
  if(!replyToMessage) return;
  const cont = document.getElementById('reply-preview-container');
  document.getElementById('reply-meta').innerText = `Ответ @${replyToMessage.username}`;
  document.getElementById('reply-snippet').innerText = replyToMessage.snippet;
  cont.style.display = 'block';
  // клик по preview: скроллит к сообщению
  document.getElementById('reply-preview').onclick = (e)=>{
    // предотвращаем фокус в textarea
    if(!replyToMessage) return;
    const target = document.getElementById('msg-'+replyToMessage.id);
    if(target){
      target.scrollIntoView({behavior:'smooth',block:'center'});
      // подсветка
      target.classList.add('highlight');
      setTimeout(()=>target.classList.remove('highlight'), 2200);
    }
  };
  document.getElementById('reply-cancel').onclick = (e) => { e.stopPropagation(); clearReplyPreview(); };
  // поменяем placeholder
  document.getElementById('msg-input').placeholder = `Ответ: ${replyToMessage.snippet}`;
}

function clearReplyPreview(){
  replyToMessage = null;
  const cont = document.getElementById('reply-preview-container');
  cont.style.display = 'none';
  document.getElementById('msg-input').placeholder = 'Сообщение...';
}

/* ============ Пишет (typing) ============ */
document.getElementById('msg-input').addEventListener('input',async()=>{
  if(!currentUser) return;
  await supabase.from('profiles').update({typing:true,status:'печатает...'}).eq('id',currentUser.id);
  clearTimeout(window.typingTimeout);
  window.typingTimeout=setTimeout(async()=>{
    await supabase.from('profiles').update({typing:false,status:'онлайн', last_active: new Date().toISOString()}).eq('id',currentUser.id);
  },1500);
});

/* ============ Сессия и подключение при загрузке ============ */
window.addEventListener('load',async()=>{
  const { data:{session}} = await supabase.auth.getSession();
  if(session){ currentUser=session.user; showMain(); subscribeChats(); }
});
window.addEventListener('beforeunload',()=>{
  if(currentUser) supabase.from('profiles').update({status:`был(а) в ${new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})} ${new Date().toLocaleDateString()}`,typing:false,last_active:new Date().toISOString()}).eq('id',currentUser.id);
});
document.addEventListener('visibilitychange',()=>{ if(document.hidden && currentUser) supabase.from('profiles').update({status:`был(а) в ${new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})} ${new Date().toLocaleDateString()}`,typing:false,last_active:new Date().toISOString()}).eq('id',currentUser.id); });
window.onclick=()=>{ document.getElementById('context-menu').style.display='none'; };

/* ============ Вспомогательные: поиск/создание чата ============ */
async function searchUser(){
  const username = document.getElementById('search-username').value.trim();
  if(!username) return alert('Введите username');
  const { data:user } = await supabase.from('profiles').select('*').eq('username',username).single();
  if(!user) return alert('Пользователь не найден');
  // посмотрим, есть ли чат
  const { data:existing } = await supabase.from('chats').select('*').or(`user1.eq.${currentUser.id},user2.eq.${currentUser.id}`);
  let found = existing?.find(c => (c.user1===user.id || c.user2===user.id));
  if(found){ openChat(found.id,user.username,user.id); return; }
  // создаём чат
  const { data:ch } = await supabase.from('chats').insert([{ user1: currentUser.id, user2: user.id, updated_at: new Date().toISOString() }]).select().single();
  openChat(ch.id, user.username, user.id);
}

/* ============ Безопасность: предупреждение о ключах ============ */
console.warn("ВНИМАНИЕ: текущий код содержит публичные ключи/токены в клиентском JS. Для продакшена храните секреты в безопасном месте (сервер, env).");
</script>
</body>
</html>
