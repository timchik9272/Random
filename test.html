<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>MiniMessenger</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
:root { --bg:#0e0e0e; --bg-light:#1e1e1e; --accent:#0088cc; --text:#fff; --gray:#888; --radius:14px;}
body{margin:0;font-family:sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}
.screen{display:none;flex-direction:column;height:100vh;}
.active{display:flex;}
input,textarea,button{border:none;border-radius:var(--radius);font-size:15px;}
input,textarea{background:var(--bg-light);color:var(--text);padding:10px;}
button{background:var(--accent);color:#fff;padding:10px 12px;font-weight:bold;margin:6px 0;}
nav{display:flex;align-items:center;gap:12px;padding:8px;background:var(--bg);position:sticky;top:0;z-index:10;border-bottom:1px solid #222;}
.chat-list,.messages{flex:1;overflow-y:auto;}
.chat-item{padding:12px;border-bottom:1px solid #222;cursor:pointer;display:flex;justify-content:space-between;align-items:center;}
.chat-item .info{display:flex;flex-direction:column;flex:1;}
.chat-item .last{display:flex;justify-content:space-between;align-items:center;margin-top:4px;font-size:13px;color:var(--gray);}
.unread-badge{background:var(--accent);color:#fff;border-radius:50%;min-width:22px;height:22px;display:flex;justify-content:center;align-items:center;font-size:12px;}
.msg{margin:6px 10px;padding:10px 14px;border-radius:var(--radius);max-width:75%;position:relative;border:1px solid #222;word-wrap:break-word;}
.msg.me{background:var(--accent);margin-left:auto;}
.msg.other{background:var(--bg-light);}
.msg.deleted{font-style:italic;color:var(--gray);}
.msg .reply-to{font-size:12px;color:var(--accent);margin-bottom:6px;border-left:2px solid var(--accent);padding-left:8px;cursor:pointer;display:block;}
.time{display:block;font-size:12px;margin-top:6px;text-align:right;}
.me .time{color:#fff;} .other .time{color:var(--gray);}
img.msg-img{max-width:100%;border-radius:var(--radius);margin-top:6px;display:block;}
.input-box{display:flex;flex-direction:column;gap:6px;padding:8px;background:var(--bg);border-top:1px solid #222;position:sticky;bottom:0;}
.input-row{display:flex;gap:6px;align-items:flex-end;}
.input-box textarea{flex:1;min-height:44px;max-height:140px;padding:12px;border-radius:12px;}
.send-btn,.img-btn{width:44px;height:44px;border-radius:50%;display:flex;justify-content:center;align-items:center;font-size:16px;background:var(--accent);color:#fff;border:none;cursor:pointer;}
#preview img{max-width:140px;border-radius:var(--radius);margin:6px;}
.context-menu{position:absolute;background:var(--bg-light);border:1px solid #333;border-radius:8px;display:none;flex-direction:column;z-index:1000;}
.context-menu button{background:none;border:none;color:var(--text);padding:10px 14px;text-align:left;}
.context-menu button:hover{background:#222;}
.ticks{font-size:14px;margin-left:4px;}
.typing-status{font-size:12px;color:var(--gray);}
.unread-separator{text-align:center;color:var(--accent);font-size:13px;margin:10px 0;border-top:1px dashed var(--gray);border-bottom:1px dashed var(--gray);padding:4px 0;}
/* preview reply (above input) */
.reply-preview{display:flex;align-items:center;gap:8px;padding:8px;border-radius:10px;background:#111;margin-bottom:6px;border:1px solid #222;}
.reply-preview .meta{font-size:13px;color:var(--gray);flex:1;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;}
.reply-preview .meta strong{color:var(--accent);font-weight:600;margin-right:6px;}
.reply-preview .cancel{cursor:pointer;padding:6px;border-radius:8px;background:#222;}
.reply-preview .cancel:hover{background:#333;}
/* message reply header clickable style */
.reply-to:hover{background:rgba(255,255,255,0.02);border-radius:8px;padding:6px;}
/* small screens tweak */
@media (max-width:520px){
  .msg{max-width:86%;}
  nav h2{font-size:16px;margin:0;}
}
</style>
</head>
<body>

<!-- –í—Ö–æ–¥ -->
<div id="login-screen" class="screen active">
  <h2 style="padding:12px">–í—Ö–æ–¥</h2>
  <div style="padding:12px">
    <input id="login-email" placeholder="Email"><br><br>
    <input id="login-password" type="password" placeholder="–ü–∞—Ä–æ–ª—å"><br><br>
    <button onclick="signIn()">–í–æ–π—Ç–∏</button>
    <button style="background:var(--bg-light)" onclick="showRegister()">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
  </div>
</div>

<!-- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è -->
<div id="register-screen" class="screen">
  <h2 style="padding:12px">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
  <div style="padding:12px">
    <input id="reg-email" placeholder="Email"><br><br>
    <input id="reg-password" type="password" placeholder="–ü–∞—Ä–æ–ª—å"><br><br>
    <input id="reg-username" placeholder="Username"><br><br>
    <button onclick="signUp()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
    <button style="background:var(--bg-light)" onclick="showLogin()">–ù–∞–∑–∞–¥</button>
  </div>
</div>

<!-- –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω -->
<div id="main-screen" class="screen">
  <nav><h2>–ß–∞—Ç—ã</h2>
    <div>
      <button onclick="openSearch()"><i class="fa fa-plus"></i></button>
      <button onclick="openSettings()"><i class="fa fa-gear"></i></button>
    </div>
  </nav>
  <div class="chat-list" id="chat-list"></div>
</div>

<!-- –ù–æ–≤—ã–π —á–∞—Ç -->
<div id="search-screen" class="screen">
  <nav><button onclick="backToMain()"><i class="fa fa-arrow-left"></i></button><h2>–ù–æ–≤—ã–π —á–∞—Ç</h2></nav>
  <div style="padding:12px"><input id="search-username" placeholder="–í–≤–µ–¥–∏—Ç–µ username"><br><br><button onclick="searchUser()">–°–æ–∑–¥–∞—Ç—å —á–∞—Ç</button></div>
</div>

<!-- –ß–∞—Ç -->
<div id="chat-screen" class="screen">
  <nav style="gap:12px;">
    <button onclick="backToMain()"><i class="fa fa-arrow-left"></i></button>
    <div style="display:flex;flex-direction:column;">
      <h2 id="chat-username" style="margin:0;"></h2>
      <div id="chat-status" style="color:var(--gray);font-size:13px;"></div>
      <div id="typing-status" class="typing-status"></div>
    </div>
  </nav>
  <div class="messages" id="messages"></div>
  <div id="preview"></div>

  <!-- reply preview (visible while composing a reply) -->
  <div id="reply-preview-container" style="padding:0 8px;display:none;">
    <div id="reply-preview" class="reply-preview">
      <div class="meta"><strong id="reply-username"></strong><span id="reply-text"></span></div>
      <div class="cancel" title="–û—Ç–º–µ–Ω–∏—Ç—å –æ—Ç–≤–µ—Ç" onclick="cancelReply()"><i class="fa fa-times"></i></div>
    </div>
  </div>

  <div class="input-box">
    <div class="input-row">
      <textarea id="msg-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>
      <button class="img-btn" onclick="chooseImage()" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É"><i class="fa fa-image"></i></button>
      <button class="send-btn" onclick="sendMessage()" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å"><i class="fa fa-paper-plane"></i></button>
    </div>
  </div>
</div>

<!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
<div id="settings-screen" class="screen">
  <nav><button onclick="backToMain()"><i class="fa fa-arrow-left"></i></button><h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2></nav>
  <div style="padding:12px"><div id="profile-info"></div><br>
    <button onclick="deleteAccount()" style="background:#c00">–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
    <button onclick="logout()" style="background:var(--bg-light)">–í—ã–π—Ç–∏</button></div>
</div>

<!-- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é -->
<div id="context-menu" class="context-menu">
  <button onclick="copyMessage()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
  <button onclick="confirmDelete()">–£–¥–∞–ª–∏—Ç—å</button>
  <button onclick="replyMessage()">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
</div>

<script>
/* === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase / Uploadcare === */
const supabase = window.supabase.createClient(
  "https://zmewwzlzujsrhstjehrp.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InptZXd3emx6dWpzcmhzdGplaHJwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5NjM4MDksImV4cCI6MjA3MTUzOTgwOX0.kBBXwlCEl5szgK4vKgaPBhPOVYmoFzly2TXR-fI8D24"
);
uploadcare.start({ publicKey:"c12f2c3e134f56024db8" });

let currentUser=null,currentChat=null,msgSubscription=null,chatSubscription=null;
let selectedMessageId=null,selectedSender=null,selectedImageUrl=null,replyToMessage=null;

/* ----------- –≠–∫—Ä–∞–Ω—ã ----------- */
function showScreen(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');}
function showLogin(){showScreen('login-screen');}
function showRegister(){showScreen('register-screen');}
function showMain(){loadChats();showScreen('main-screen');}
function openSettings(){loadProfile();showScreen('settings-screen');}
function openSearch(){showScreen('search-screen');}
function backToMain(){if(msgSubscription) supabase.removeChannel(msgSubscription);showMain();}

/* ----------- –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è ----------- */
async function signUp(){
  const email=document.getElementById('reg-email').value,password=document.getElementById('reg-password').value,username=document.getElementById('reg-username').value;
  const { data,error }=await supabase.auth.signUp({ email,password,options:{ data:{username} }});
  if(error){alert(error.message);return;}
  await supabase.from('profiles').insert([{ id:data.user.id,email,username,status:'–æ–Ω–ª–∞–π–Ω',typing:false }]);
  alert("–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ email –∏ –≤–æ–π–¥–∏—Ç–µ");showLogin();
}

async function signIn(){
  const email=document.getElementById('login-email').value,password=document.getElementById('login-password').value;
  const { data,error }=await supabase.auth.signInWithPassword({ email,password });
  if(error){alert(error.message);return;}
  currentUser=data.user;
  await supabase.from('profiles').update({status:'–æ–Ω–ª–∞–π–Ω'}).eq('id',currentUser.id);
  showMain();subscribeChats();
}

async function logout(){
  await supabase.from('profiles').update({status:`–±—ã–ª(–∞) –≤ ${new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})} ${new Date().toLocaleDateString('ru-RU')}`,typing:false}).eq('id',currentUser.id);
  await supabase.auth.signOut();currentUser=null;showLogin();
}

async function loadProfile(){
  const { data }=await supabase.from('profiles').select('*').eq('id',currentUser.id).single();
  document.getElementById('profile-info').innerText=`Username: ${data.username}\nEmail: ${data.email}\n–°—Ç–∞—Ç—É—Å: ${data.status}`;
}

async function deleteAccount(){await supabase.from('profiles').delete().eq('id',currentUser.id);logout();}

/* ----------- –£—Ç–∏–ª–∏—Ç—ã ----------- */
function formatStatus(profile){
  // profile: {status, typing}
  if(profile.typing) return '–ø–µ—á–∞—Ç–∞–µ—Ç...';
  if(!profile.status) return '';
  // –µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å —Å–æ–¥–µ—Ä–∂–∏—Ç "–±—ã–ª(–∞) –≤" ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å, –Ω–æ –¥–æ–±–∞–≤–∏–º –¥–∞—Ç—É –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
  if(profile.status.startsWith('–±—ã–ª(–∞) –≤')) return profile.status;
  // –ª–∏–±–æ —Å—Ç–∞—Ç—É—Å —Ä–∞–≤–µ–Ω "–æ–Ω–ª–∞–π–Ω"
  return profile.status;
}

async function getUsernameById(id){
  if(!id) return 'Unknown';
  const { data } = await supabase.from('profiles').select('username').eq('id',id).single();
  return data?.username || 'Unknown';
}

/* ----------- –ß–∞—Ç—ã ----------- */
async function loadChats(){
  const { data:chats }=await supabase.from('chats').select('*').or(`user1.eq.${currentUser.id},user2.eq.${currentUser.id}`);
  const list=document.getElementById('chat-list');list.innerHTML='';
  if(!chats) return;
  // —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ updated_at (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
  chats.sort((a,b)=>new Date(b.updated_at || 0)-new Date(a.updated_at || 0));
  for(const chat of chats){
    let chatName="",otherId=null,lastMsgText="",lastMsgImg=false,unreadCount=0,lastTime="";
    if(chat.user1===chat.user2){chatName="–ò–∑–±—Ä–∞–Ω–Ω–æ–µ"; otherId=currentUser.id;}
    else{ otherId=chat.user1===currentUser.id?chat.user2:chat.user1;
      const { data:profile }=await supabase.from('profiles').select('username').eq('id',otherId).single();
      if(profile) chatName=profile.username;
    }
    const { data:msgs }=await supabase.from('messages').select('*').eq('chat_id',chat.id).order('created_at',{ascending:false}).limit(1);
    if(msgs && msgs.length>0){lastMsgText=msgs[0].content||"";lastMsgImg=!!msgs[0].image_url;lastTime=new Date(msgs[0].created_at).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});}
    const { data:unread }=await supabase.from('messages').select('*').eq('chat_id',chat.id).eq('read',false).neq('sender',currentUser.id);
    unreadCount=(unread||[]).length;
    const div=document.createElement('div');div.className='chat-item';
    const info=document.createElement('div');info.className='info';
    const name=document.createElement('div');name.innerText=chatName;
    const last=document.createElement('div');last.className='last';
    let msgTxt=(lastMsgImg?"üñº":"")+(lastMsgText?" "+lastMsgText:"");
    last.innerHTML=`<span style="overflow:hidden;white-space:nowrap;text-overflow:ellipsis;display:inline-block;max-width:180px">${msgTxt}</span><span>${lastTime}</span>`;
    info.appendChild(name);info.appendChild(last);
    div.appendChild(info);
    if(unreadCount>0){const badge=document.createElement('div');badge.className='unread-badge';badge.innerText=unreadCount;div.appendChild(badge);}
    div.onclick=()=>openChat(chat.id,chatName,otherId);
    list.appendChild(div);
  }
}

function subscribeChats(){if(chatSubscription) supabase.removeChannel(chatSubscription);chatSubscription=supabase.channel('chats-r').on('postgres_changes',{event:'INSERT',schema:'public',table:'chats'},()=>loadChats()).subscribe();}

/* ----------- –°–æ–æ–±—â–µ–Ω–∏—è ----------- */
async function openChat(chatId,otherName,otherId){
  currentChat=chatId;
  document.getElementById('chat-username').innerText=otherName;
  showScreen('chat-screen');
  await loadMessages();
  if(msgSubscription) supabase.removeChannel(msgSubscription);
  msgSubscription=supabase.channel('room-'+chatId)
    .on('postgres_changes',{event:'INSERT',schema:'public',table:'messages',filter:`chat_id=eq.${chatId}`},p=>renderMessage(p.new,true))
    .subscribe();
  await supabase.from('messages').update({read:true}).eq('chat_id',chatId).neq('sender',currentUser.id);
  // —Å–ª–µ–¥–∏–º –∑–∞ —Å—Ç–∞—Ç—É—Å–æ–º —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
  if(otherId){
    if(window.statusChannelOther) supabase.removeChannel(window.statusChannelOther);
    window.statusChannelOther = supabase.channel('status-'+otherId).on('postgres_changes',{event:'UPDATE',schema:'public',table:'profiles',filter:`id=eq.${otherId}`},p=>{
      const st = formatStatus(p.new);
      document.getElementById('chat-status').innerText=st;
      document.getElementById('typing-status').innerText = p.new.typing ? '–ø–µ—á–∞—Ç–∞–µ—Ç...' : '';
    }).subscribe();

    // –∑–∞–≥—Ä—É–∑–∏–º —Å—Ä–∞–∑—É –ø—Ä–æ—Ñ–∏–ª—å, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å
    const { data:profile } = await supabase.from('profiles').select('*').eq('id',otherId).single();
    if(profile) document.getElementById('chat-status').innerText = formatStatus(profile);
  }
}

async function loadMessages(){
  const { data }=await supabase.from('messages').select('*').eq('chat_id',currentChat).order('created_at',{ascending:true});
  const box=document.getElementById('messages');box.innerHTML='';
  let insertedUnread=false;
  if(!data) return;
  for(const msg of data){
    if(!msg.read && msg.sender!==currentUser.id && !insertedUnread){const sep=document.createElement('div');sep.className='unread-separator';sep.innerText='–ù–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ';box.appendChild(sep);insertedUnread=true;}
    // renderMessage –º–æ–∂–µ—Ç –±—ã—Ç—å async, –∂–¥—ë–º
    // eslint-disable-next-line no-await-in-loop
    await renderMessage(msg,false);
  }
  box.scrollTop=box.scrollHeight;
}

/*
  renderMessage: —Ç–µ–ø–µ—Ä—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è ‚Äî –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —è–≤–ª—è–µ—Ç—Å—è –æ—Ç–≤–µ—Ç–æ–º, –ø–æ–¥–≥—Ä—É–∂–∞–µ—Ç –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –∏–º—è –∞–≤—Ç–æ—Ä–∞,
  —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç reply header, –¥–µ–ª–∞–µ—Ç –µ–≥–æ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–º (–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –æ—Ä–∏–≥–∏–Ω–∞–ª—É).
*/
async function renderMessage(msg,scroll=true){
  const box=document.getElementById('messages');
  let div=document.getElementById('msg-'+msg.id);
  const isMe = (msg.sender===currentUser.id);
  if(!div){
    div=document.createElement('div');div.id='msg-'+msg.id;div.className='msg '+(isMe?'me':'other');
    div.oncontextmenu=(e)=>{e.preventDefault();showContextMenu(e,msg.id,msg.sender);};
    box.appendChild(div);
  } else {
    div.className = 'msg ' + (isMe ? 'me' : 'other');
  }

  if(msg.is_deleted){
    div.className='msg deleted';div.innerText='–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ';
    if(scroll) box.scrollTop=box.scrollHeight;
    return;
  }

  let htmlParts = [];
  // reply handling: –µ—Å–ª–∏ msg.reply_to ‚Äî –ø–æ–¥–≥—Ä—É–∂–∞—Ç—å –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ username
  if(msg.reply_to){
    try{
      // –ø–æ–ª—É—á–∏–º –æ—Ä–∏–≥–∏–Ω–∞–ª
      const { data:orig } = await supabase.from('messages').select('*').eq('id',msg.reply_to).single();
      if(orig){
        const username = await getUsernameById(orig.sender);
        // –ø–æ–¥–≥–æ—Ç–æ–≤–∏–º —Ç–µ–∫—Å—Ç-–æ–±—Ä–µ–∑–∫—É: –µ—Å–ª–∏ –µ—Å—Ç—å content ‚Äî –≤–∑—è—Ç—å –ø–µ—Ä–≤—ã–µ 80 —Å–∏–º–≤–æ–ª–æ–≤, –∏–Ω–∞—á–µ –º–µ—Ç–∫–∞ [–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ]
        let snippet = '';
        if(orig.content && orig.content.trim().length>0) snippet = orig.content.trim().slice(0,120);
        else if(orig.image_url) snippet = '[–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ]';
        else snippet = '[—Å–æ–æ–±—â–µ–Ω–∏–µ]';
        // reply header - –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–π
        const headerHTML = `<div class="reply-to" data-reply-id="${orig.id}">–û—Ç–≤–µ—Ç <strong>@${escapeHtml(username)}</strong>: ${escapeHtml(snippet)}</div>`;
        htmlParts.push(headerHTML);
      } else {
        // –µ—Å–ª–∏ –æ—Ä–∏–≥–∏–Ω–∞–ª –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
        htmlParts.push(`<div class="reply-to">–û—Ç–≤–µ—Ç: (—Å–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ)</div>`);
      }
    }catch(e){
      htmlParts.push(`<div class="reply-to">–û—Ç–≤–µ—Ç</div>`);
    }
  }

  if(msg.content) htmlParts.push(`<div>${escapeHtml(msg.content)}</div>`);
  if(msg.image_url) htmlParts.push(`<img src="${msg.image_url}" class="msg-img">`);

  const ticks = isMe?'<span class="ticks">‚úî‚úî</span>':'';
  htmlParts.push(`<span class="time">${new Date(msg.created_at).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})} ${ticks}</span>`);

  div.innerHTML = htmlParts.join('');

  // –µ—Å–ª–∏ –µ—Å—Ç—å reply-to –±–ª–æ–∫ ‚Äî –¥–æ–±–∞–≤–∏–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ (–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –æ—Ä–∏–≥–∏–Ω–∞–ª—É)
  const replyElems = div.querySelectorAll('.reply-to');
  replyElems.forEach(el=>{
    const rid = el.getAttribute('data-reply-id');
    el.style.cursor = 'pointer';
    el.onclick = (ev)=>{
      ev.stopPropagation();
      if(rid){
        // –µ—Å–ª–∏ –æ—Ä–∏–≥–∏–Ω–∞–ª –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ ‚Äî –ø—Ä–æ–ª–∏—Å—Ç–∞—Ç—å –¥–æ –Ω–µ–≥–æ
        const target = document.getElementById('msg-'+rid);
        if(target){
          target.scrollIntoView({behavior:'smooth',block:'center'});
          // –Ω–µ–±–æ–ª—å—à–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞
          target.style.boxShadow = '0 0 0 2px rgba(0,136,204,0.12)';
          setTimeout(()=>{target.style.boxShadow='';},1400);
        } else {
          // –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî –ø–æ–ø—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏ –ø–æ–¥—Å–≤–µ—Ç–∏—Ç—å (–∏–ª–∏ –ø—Ä–æ—Å—Ç–æ —É–≤–µ–¥–æ–º–∏–º)
          alert('–ò—Å—Ö–æ–¥–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –Ω–∞ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ.');
        }
      }
    };
  });

  if(scroll){
    box.scrollTop = box.scrollHeight;
  }
}

/* === –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è === */
async function sendMessage(){
  const text=document.getElementById('msg-input').value.trim();
  if(!text && !selectedImageUrl) return;
  const payload = {
    chat_id:currentChat,
    sender:currentUser.id,
    content:text||null,
    image_url:selectedImageUrl||null,
    reply_to: replyToMessage ? replyToMessage.id : null,
    read:false
  };
  await supabase.from('messages').insert([payload]);
  // –æ—á–∏—Å—Ç–∫–∞ UI
  document.getElementById('msg-input').value='';selectedImageUrl=null;replyToMessage=null;document.getElementById('preview').innerHTML='';
  hideReplyPreview();
  // –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ handled by renderMessage on subscription; –Ω–æ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π:
  const box=document.getElementById('messages');box.scrollTop=box.scrollHeight;
}

/* –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ */
function chooseImage(){uploadcare.openDialog(null,{publicKey:"c12f2c3e134f56024db8"}).done(file=>{file.done(info=>{selectedImageUrl=info.cdnUrl;document.getElementById('preview').innerHTML=`<img src="${selectedImageUrl}">`;});});}

/* ----------- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é  ----------- */
function showContextMenu(e,msgId,senderId){selectedMessageId=msgId;selectedSender=senderId;const menu=document.getElementById('context-menu');menu.style.left=e.pageX+'px';menu.style.top=e.pageY+'px';menu.style.display='flex';}
function copyMessage(){if(!selectedMessageId)return;const el=document.getElementById('msg-'+selectedMessageId);if(el)navigator.clipboard.writeText(el.innerText);selectedMessageId=null;document.getElementById('context-menu').style.display='none';}
function confirmDelete(){if(!selectedMessageId)return;supabase.from('messages').update({is_deleted:true}).eq('id',selectedMessageId).eq('sender',currentUser.id);selectedMessageId=null;document.getElementById('context-menu').style.display='none';}
async function replyMessage(){if(!selectedMessageId)return;document.getElementById('context-menu').style.display='none';
  const el=document.getElementById('msg-'+selectedMessageId);
  if(!el) return;
  // –ø–æ–ª—É—á–∏–º –∫–æ—Ä–æ—Ç–∫–∏–π —Ç–µ–∫—Å—Ç
  const text = el.innerText.split('\n')[0].slice(0,180);
  // —É–∑–Ω–∞–µ–º username –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –æ—Ä–∏–≥–∏–Ω–∞–ª–∞
  const { data:msg } = await supabase.from('messages').select('*').eq('id',selectedMessageId).single();
  const uname = await getUsernameById(msg.sender);
  replyToMessage = { id: selectedMessageId, text: text, username: uname };
  showReplyPreview(replyToMessage);
}

/* ----------- Reply preview UI (–≤–Ω–∏–∑—É, –ø–æ–∫–∞ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ) ----------- */
function showReplyPreview(replyObj){
  const container = document.getElementById('reply-preview-container');
  document.getElementById('reply-username').innerText = '@' + (replyObj.username || 'user');
  document.getElementById('reply-text').innerText = ' ' + (replyObj.text||'');
  container.style.display = 'block';
  // –∫–ª–∏–∫ –ø–æ –ø—Ä–µ–≤—å—é ‚Äî –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –∏—Å—Ö–æ–¥–Ω–æ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
  const preview = document.getElementById('reply-preview');
  preview.onclick = (e) => {
    e.stopPropagation();
    const target = document.getElementById('msg-'+replyObj.id);
    if(target){
      target.scrollIntoView({behavior:'smooth',block:'center'});
      target.style.boxShadow = '0 0 0 2px rgba(0,136,204,0.12)';
      setTimeout(()=>{target.style.boxShadow='';},1400);
    } else {
      alert('–ò—Å—Ö–æ–¥–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –Ω–∞ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ.');
    }
  };
}
function hideReplyPreview(){document.getElementById('reply-preview-container').style.display='none';document.getElementById('reply-preview').onclick = null;}
function cancelReply(){replyToMessage=null;hideReplyPreview();}

/* ----------- –ü–µ—á–∞—Ç–∞–µ—Ç (typing) ----------- */
document.getElementById('msg-input').addEventListener('input',async()=>{
  // –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å, —Å–æ–æ–±—â–∞–µ–º —á—Ç–æ –ø–µ—á–∞—Ç–∞–µ—Ç
  if(!currentUser) return;
  await supabase.from('profiles').update({typing:true,status:'–ø–µ—á–∞—Ç–∞–µ—Ç...'}).eq('id',currentUser.id);
  clearTimeout(window.typingTimeout);
  window.typingTimeout=setTimeout(async()=>{
    await supabase.from('profiles').update({typing:false,status:'–æ–Ω–ª–∞–π–Ω'}).eq('id',currentUser.id);
  },1500);
});

/* ----------- –°–µ—Å—Å–∏–∏ –∏ —ç–≤–µ–Ω—Ç—ã –≤–∏–¥–∏–º–æ—Å—Ç–∏ ----------- */
window.addEventListener('load',async()=>{
  const { data:{session}}=await supabase.auth.getSession();
  if(session){currentUser=session.user;showMain();subscribeChats();}
});
window.addEventListener('beforeunload',()=>{if(currentUser)supabase.from('profiles').update({status:`–±—ã–ª(–∞) –≤ ${new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})} ${new Date().toLocaleDateString('ru-RU')}`,typing:false}).eq('id',currentUser.id);});
document.addEventListener('visibilitychange',()=>{if(document.hidden&&currentUser)supabase.from('profiles').update({status:`–±—ã–ª(–∞) –≤ ${new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})} ${new Date().toLocaleDateString('ru-RU')}`,typing:false}).eq('id',currentUser.id);});
window.onclick=()=>{document.getElementById('context-menu').style.display='none';};

/* ----------- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ----------- */
// –ü—Ä–æ—Å—Ç–æ–π escape –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ —Ç–µ–∫—Å—Ç–∞ –≤ HTML
function escapeHtml(unsafe) {
  if(!unsafe && unsafe!==0) return '';
  return String(unsafe)
       .replace(/&/g, "&amp;")
       .replace(/</g, "&lt;")
       .replace(/>/g, "&gt;")
       .replace(/"/g, "&quot;")
       .replace(/'/g, "&#039;");
}

/* ----------- –£—Ç–∏–ª–∏—Ç—ã –ø–æ–∏—Å–∫–∞/—Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–∞ (–ø—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è) ----------- */
async function searchUser(){
  const username = document.getElementById('search-username').value.trim();
  if(!username) return alert('–í–≤–µ–¥–∏—Ç–µ username');
  const { data:user } = await supabase.from('profiles').select('*').ilike('username',username).limit(1).single();
  if(!user) return alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
  // –ø–æ–ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ —á–∞—Ç
  const { data:existing } = await supabase.from('chats').select('*').or(`user1.eq.${currentUser.id},user2.eq.${currentUser.id}`);
  // –ø—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞: —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π —á–∞—Ç –¥–ª—è –ø–∞—Ä—ã (–Ω–µ —É—á–∏—Ç—ã–≤–∞–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ)
  const { data:chat } = await supabase.from('chats').insert([{ user1: currentUser.id, user2: user.id }]).select().single();
  showMain();
  openChat(chat.id,user.username,user.id);
}

/* === –ö–æ–Ω–µ—Ü === */
</script>
</body>
</html>
