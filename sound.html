<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>üéµ –ú—É–∑—ã–∫–∞–ª—å–Ω–∞—è –ö–æ–º–Ω–∞—Ç–∞</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { margin:0; font-family:system-ui, sans-serif; background:#f0f2f7; overflow-x:hidden; }
    h1,h2 { text-align:center; }
    .screen { display:none; height:100vh; padding:1em; box-sizing:border-box; }
    .active { display:block; animation:fadeIn 0.6s ease; }
    @keyframes fadeIn { from{opacity:0; transform:translateY(20px);} to{opacity:1; transform:translateY(0);} }

    button {
      display:block; width:100%; margin:0.5em 0; padding:1em;
      font-size:18px; font-weight:600; color:white;
      background:linear-gradient(135deg,#6a5acd,#483d8b);
      border:none; border-radius:14px; box-shadow:0 4px 14px rgba(0,0,0,0.2);
      transition:all 0.25s ease;
    }
    button:hover { transform:translateY(-3px) scale(1.02); }
    button:active { transform:scale(0.96); opacity:0.85; }

    textarea, input[type=text] {
      width:100%; padding:0.8em; border:1px solid #ccc; border-radius:10px; margin:0.5em 0;
      font-size:15px; transition:all 0.2s;
    }
    textarea:focus, input:focus { border-color:#6a5acd; box-shadow:0 0 6px rgba(106,90,205,0.4); outline:none; }

    .library { margin-top:1em; max-height:45vh; overflow:auto; }
    .sound-item {
      background:white; border-radius:14px; padding:1em;
      margin:0.5em 0; box-shadow:0 2px 8px rgba(0,0,0,0.1);
      cursor:pointer; transform:scale(1); transition:transform 0.2s, background 0.3s;
      animation:slideIn 0.5s ease;
    }
    .sound-item:hover { background:#eef2ff; transform:scale(1.03); }
    @keyframes slideIn { from{opacity:0; transform:translateX(-40px);} to{opacity:1; transform:translateX(0);} }

    #qrcode { display:flex; justify-content:center; margin:1em 0; }

    #reader { width:100%; max-width:320px; margin:0 auto; }
  </style>
</head>
<body>

  <!-- –≠–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ -->
  <div id="screen-home" class="screen active">
    <h1>üé∂ –ú—É–∑—ã–∫–∞–ª—å–Ω–∞—è –ö–æ–º–Ω–∞—Ç–∞</h1>
    <button onclick="goTo('screen-create')">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
    <button onclick="goTo('screen-join')">–í–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É</button>
  </div>

  <!-- –≠–∫—Ä–∞–Ω —Å–æ–∑–¥–∞–Ω–∏—è -->
  <div id="screen-create" class="screen">
    <h2>–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</h2>
    <button id="startBtn">–°–æ–∑–¥–∞—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</button>
    <textarea id="offer" placeholder="–ö–æ–¥ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –≤—Ä—É—á–Ω—É—é"></textarea>
    <div id="qrcode"></div>
    <textarea id="answer" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ –æ—Ç–≤–µ—Ç"></textarea>
    <button id="setAnswerBtn">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ—Ç–≤–µ—Ç</button>
    <button onclick="goTo('screen-home')">‚¨Ö –ù–∞–∑–∞–¥</button>
  </div>

  <!-- –≠–∫—Ä–∞–Ω –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è -->
  <div id="screen-join" class="screen">
    <h2>–í–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É</h2>
    <textarea id="remote" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –∫–æ–¥ –æ—Ç —Å–æ–∑–¥–∞—Ç–µ–ª—è"></textarea>
    <button id="answerBtn">–°–æ–∑–¥–∞—Ç—å –æ—Ç–≤–µ—Ç</button>
    <textarea id="answerOut" placeholder="–ö–æ–¥-–æ—Ç–≤–µ—Ç"></textarea>
    <div id="reader"></div>
    <button onclick="startScan()">üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR</button>
    <button onclick="stopScan()">‚èπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∫–∞–Ω–µ—Ä</button>
    <button onclick="goTo('screen-home')">‚¨Ö –ù–∞–∑–∞–¥</button>
  </div>

  <!-- –≠–∫—Ä–∞–Ω –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
  <div id="screen-library" class="screen">
    <h2>üìö –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</h2>
    <input type="text" id="search" placeholder="–ü–æ–∏—Å–∫ –∑–≤—É–∫–∞...">
    <div class="library" id="library"></div>
    <audio id="remoteAudio" autoplay controls></audio>
  </div>

  <!-- QR –∏ WebRTC -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>

  <script>
    // –ó–≤—É–∫–∏ —Å Pixabay
    const sounds = [
      { name:"üëè –ê–ø–ª–æ–¥–∏—Å–º–µ–Ω—Ç—ã", url:"https://cdn.pixabay.com/download/audio/2022/03/15/audio_7e7f6898d5.mp3?filename=clapping-86112.mp3" },
      { name:"üòÇ –°–º–µ—Ö", url:"https://cdn.pixabay.com/download/audio/2021/08/04/audio_91b66a0413.mp3?filename=laugh-46306.mp3" },
      { name:"üìû –¢–µ–ª–µ—Ñ–æ–Ω–Ω—ã–π –∑–≤–æ–Ω–æ–∫", url:"https://cdn.pixabay.com/download/audio/2021/08/04/audio_1c2ac1699d.mp3?filename=classic-phone-ring-41691.mp3" },
      { name:"üîî –ö–æ–ª–æ–∫–æ–ª—å—á–∏–∫", url:"https://cdn.pixabay.com/download/audio/2022/03/15/audio_929927d0a2.mp3?filename=bell-86114.mp3" },
      { name:"üé∂ –°–ø–æ–∫–æ–π–Ω–∞—è –º–µ–ª–æ–¥–∏—è", url:"https://cdn.pixabay.com/download/audio/2021/08/09/audio_9a7d6d5c34.mp3?filename=soft-background-music-46542.mp3" },
      { name:"üö® –°–∏—Ä–µ–Ω–∞", url:"https://cdn.pixabay.com/download/audio/2021/08/04/audio_c09e1dc8c5.mp3?filename=police-siren-46307.mp3" },
      { name:"üîä –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ", url:"https://cdn.pixabay.com/download/audio/2022/03/15/audio_23b5cbfef3.mp3?filename=notification-86111.mp3" },
      { name:"üéµ –ì–∏—Ç–∞—Ä–∞", url:"https://cdn.pixabay.com/download/audio/2021/09/01/audio_01a2e7a37c.mp3?filename=relaxing-guitar-loop-4475.mp3" }
    ];

    let pc, dataChannel, audio=new Audio(), scanner;

    // –≠–∫—Ä–∞–Ω—ã
    function goTo(id){
      document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    // –†–µ–Ω–¥–µ—Ä –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
    function renderLibrary(filter=""){
      const lib=document.getElementById("library");
      lib.innerHTML="";
      sounds.filter(s=>s.name.toLowerCase().includes(filter.toLowerCase()))
        .forEach(sound=>{
          const div=document.createElement("div");
          div.className="sound-item";
          div.innerHTML=`<div>${sound.name}</div>`;
          div.onclick=()=>{
            audio.src=sound.url; audio.play();
            if(dataChannel&&dataChannel.readyState==="open"){ dataChannel.send(sound.url); }
          };
          lib.appendChild(div);
        });
    }
    document.getElementById("search").oninput=e=>renderLibrary(e.target.value);
    renderLibrary();

    // WebRTC
    async function initPeer(){
      pc=new RTCPeerConnection();
      dataChannel=pc.createDataChannel("sound");
      dataChannel.onmessage=(event)=>{ document.getElementById("remoteAudio").src=event.data; goTo("screen-library"); };
      pc.ondatachannel=(event)=>{ event.channel.onmessage=(ev)=>{ document.getElementById("remoteAudio").src=ev.data; goTo("screen-library"); }; };
    }

    function toShort(obj){ return btoa(JSON.stringify(obj)); }
    function fromShort(str){ return JSON.parse(atob(str)); }

    document.getElementById("startBtn").onclick=async()=>{
      await initPeer();
      const offer=await pc.createOffer();
      await pc.setLocalDescription(offer);
      const short=toShort(offer);
      document.getElementById("offer").value=short;
      document.getElementById("qrcode").innerHTML="";
      new QRCode(document.getElementById("qrcode"),{text:short,width:160,height:160});
    };

    document.getElementById("answerBtn").onclick=async()=>{
      await initPeer();
      const offer=fromShort(document.getElementById("remote").value.trim());
      await pc.setRemoteDescription(offer);
      const answer=await pc.createAnswer();
      await pc.setLocalDescription(answer);
      document.getElementById("answerOut").value=toShort(answer);
    };

    document.getElementById("setAnswerBtn").onclick=async()=>{
      const answer=fromShort(document.getElementById("answer").value.trim());
      await pc.setRemoteDescription(answer);
      alert("‚úÖ –ö–æ–º–Ω–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞, –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∑–≤—É–∫–∏!");
      goTo("screen-library");
    };

    // QR-—Å–∫–∞–Ω–µ—Ä
    function startScan(){
      scanner=new Html5Qrcode("reader");
      scanner.start({facingMode:"environment"},{fps:10,qrbox:250},
        (decoded)=>{
          document.getElementById("remote").value=decoded;
          stopScan();
          alert("üì• –ö–æ–¥ —Å—á–∏—Ç–∞–Ω, —Ç–µ–ø–µ—Ä—å –Ω–∞–∂–º–∏—Ç–µ ¬´–°–æ–∑–¥–∞—Ç—å –æ—Ç–≤–µ—Ç¬ª");
        },
        (err)=>{}
      );
    }
    function stopScan(){ if(scanner){ scanner.stop().then(()=>{scanner.clear();}); } }
  </script>
</body>
</html>
