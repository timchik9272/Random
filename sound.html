<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ú—É–∑—ã–∫–∞ –∏ –∑–≤—É–∫–∏ –º–µ–∂–¥—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞–º–∏</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: system-ui, sans-serif; background: #f2f4f8; margin: 0; padding: 1em; }
    h2 { text-align: center; margin-bottom: 1em; }
    button {
      display: block; width: 100%; margin: 0.5em 0; padding: 1em;
      font-size: 16px; font-weight: 600; color: white;
      background: linear-gradient(135deg, #4a90e2, #357ABD);
      border: none; border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      transition: transform 0.2s ease, opacity 0.2s ease;
    }
    button:active { transform: scale(0.97); opacity: 0.8; }
    textarea { width: 100%; height: 70px; margin: 0.5em 0; padding: 0.5em; border-radius: 8px; border: 1px solid #ccc; }
    #qrcode { display: flex; justify-content: center; margin: 1em 0; }
    .library { margin-top: 1em; }
    .sound-item {
      background: white; border-radius: 14px; padding: 1em;
      margin: 0.5em 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      cursor: pointer; transition: transform 0.2s ease, background 0.3s;
    }
    .sound-item:hover { transform: translateY(-2px); background: #eef5ff; }
    .sound-title { font-weight: 600; }
    input[type=text] {
      width: 100%; padding: 0.8em; margin: 0.5em 0;
      border: 1px solid #ccc; border-radius: 8px;
    }
    audio { width: 100%; margin-top: 1em; }
  </style>
</head>
<body>
  <h2>üéµ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–≤—É–∫–æ–≤</h2>

  <button id="startBtn">–°–æ–∑–¥–∞—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</button>
  <textarea id="offer" placeholder="–ö–æ–¥ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏"></textarea>
  <div id="qrcode"></div>

  <button id="answerBtn">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
  <textarea id="remote" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –∫–æ–¥ –æ—Ç –¥—Ä—É–≥–æ–≥–æ —Ç–µ–ª–µ—Ñ–æ–Ω–∞"></textarea>

  <button id="setAnswerBtn">–í—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç</button>
  <textarea id="answer" placeholder="–û—Ç–≤–µ—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ–±—Ä–∞—Ç–Ω–æ"></textarea>

  <h3>üìö –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</h3>
  <input type="text" id="search" placeholder="–ü–æ–∏—Å–∫ –∑–≤—É–∫–∞..." />
  <div class="library" id="library"></div>

  <audio id="remoteAudio" autoplay controls></audio>

  <!-- QR –∫–æ–¥ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script>
    const sounds = [
      { name: "üëè –ê–ø–ª–æ–¥–∏—Å–º–µ–Ω—Ç—ã", url: "https://cdn.pixabay.com/download/audio/2022/03/15/audio_7e7f6898d5.mp3?filename=clapping-86112.mp3" },
      { name: "üòÇ –°–º–µ—Ö", url: "https://cdn.pixabay.com/download/audio/2021/08/04/audio_91b66a0413.mp3?filename=laugh-46306.mp3" },
      { name: "üìû –ó–≤–æ–Ω–æ–∫", url: "https://cdn.pixabay.com/download/audio/2021/08/04/audio_1c2ac1699d.mp3?filename=classic-phone-ring-41691.mp3" },
      { name: "üîî –ö–æ–ª–æ–∫–æ–ª—å—á–∏–∫", url: "https://cdn.pixabay.com/download/audio/2022/03/15/audio_929927d0a2.mp3?filename=bell-86114.mp3" },
      { name: "üé∂ –ú–µ–ª–æ–¥–∏—è", url: "https://cdn.pixabay.com/download/audio/2021/08/09/audio_9a7d6d5c34.mp3?filename=soft-background-music-46542.mp3" }
    ];

    let pc, dataChannel, audio = new Audio();

    function renderLibrary(filter="") {
      const lib = document.getElementById("library");
      lib.innerHTML = "";
      sounds.filter(s => s.name.toLowerCase().includes(filter.toLowerCase()))
        .forEach(sound => {
          const div = document.createElement("div");
          div.className = "sound-item";
          div.innerHTML = `<div class="sound-title">${sound.name}</div>`;
          div.onclick = () => {
            audio.src = sound.url;
            audio.play();
            if (dataChannel && dataChannel.readyState === "open") {
              dataChannel.send(sound.url);
            }
          };
          lib.appendChild(div);
        });
    }

    document.getElementById("search").oninput = e => renderLibrary(e.target.value);
    renderLibrary();

    async function initPeer() {
      pc = new RTCPeerConnection();
      dataChannel = pc.createDataChannel("sound");
      dataChannel.onmessage = (event) => {
        document.getElementById("remoteAudio").src = event.data;
      };
      pc.ondatachannel = (event) => {
        event.channel.onmessage = (ev) => {
          document.getElementById("remoteAudio").src = ev.data;
        };
      };
    }

    function toShort(obj) {
      return btoa(JSON.stringify(obj));
    }
    function fromShort(str) {
      return JSON.parse(atob(str));
    }

    document.getElementById("startBtn").onclick = async () => {
      await initPeer();
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      const short = toShort(offer);
      document.getElementById("offer").value = short;
      document.getElementById("qrcode").innerHTML = "";
      new QRCode(document.getElementById("qrcode"), { text: short, width: 150, height: 150 });
    };

    document.getElementById("answerBtn").onclick = async () => {
      await initPeer();
      const offer = fromShort(document.getElementById("remote").value.trim());
      await pc.setRemoteDescription(offer);
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      document.getElementById("answer").value = toShort(answer);
    };

    document.getElementById("setAnswerBtn").onclick = async () => {
      const answer = fromShort(document.getElementById("remote").value.trim());
      await pc.setRemoteDescription(answer);
      alert("‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!");
    };
  </script>
</body>
</html>
