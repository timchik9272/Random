<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä —Å –≥–æ–ª–æ—Å–æ–≤—ã–º–∏ –∏ –≤–∏–¥–µ–æ-—Å–æ–æ–±—â–µ–Ω–∏—è–º–∏</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        .chat-container {
            width: 100%;
            max-width: 400px;
            border: 1px solid #ccc;
            border-radius: 8px;
            overflow: hidden;
        }
        .messages {
            height: 300px;
            padding: 10px;
            overflow-y: auto;
            background-color: #f9f9f9;
        }
        .input-area {
            display: flex;
            align-items: center;
            padding: 10px;
            border-top: 1px solid #ccc;
            background-color: #fff;
        }
        #message-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 20px;
            margin-right: 10px;
        }
        .send-button {
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: none; /* –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç */
        }
        .voice-button {
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            touch-action: manipulation; /* –î–ª—è –ª—É—á—à–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–∞—á–µ–π */
        }
        .hidden {
            display: none;
        }
        #video-preview {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background-color: #000;
            margin: 10px auto;
            object-fit: cover;
        }
        #recording-status {
            margin-top: 10px;
            color: red;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="messages" id="messages"></div>
        <div class="input-area">
            <input type="text" id="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
            <button id="send-button">‚û°Ô∏è</button>
            <button id="voice-button">üé§</button>
        </div>
    </div>

    <!-- –î–ª—è –≤–∏–¥–µ–æ-—Ä–µ–∂–∏–º–∞ -->
    <div id="video-mode" class="hidden">
        <video id="video-preview" autoplay playsinline></video>
        <button id="start-video">–ó–∞–ø–∏—Å–∞—Ç—å –∫—Ä—É–∂–æ–∫</button>
        <button id="stop-video">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
        <button id="cancel-video">–û—Ç–º–µ–Ω–∞</button>
    </div>

    <div id="recording-status" class="hidden">–ó–∞–ø–∏—Å—å –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ...</div>

    <script>
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const voiceButton = document.getElementById('voice-button');
        const messages = document.getElementById('messages');
        const videoMode = document.getElementById('video-mode');
        const videoPreview = document.getElementById('video-preview');
        const startVideoBtn = document.getElementById('start-video');
        const stopVideoBtn = document.getElementById('stop-video');
        const cancelVideoBtn = document.getElementById('cancel-video');
        const recordingStatus = document.getElementById('recording-status');

        let mediaRecorder;
        let audioChunks = [];
        let videoChunks = [];
        let isRecording = false;
        let touchStartTime;
        let pressTimer;
        let stream;

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–Ω–æ–ø–æ–∫ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–≤–æ–¥–∞
        function updateButtons() {
            if (messageInput.value.trim() === '') {
                sendButton.style.display = 'none';
                voiceButton.style.display = 'block';
            } else {
                sendButton.style.display = 'block';
                voiceButton.style.display = 'none';
            }
        }

        // –°–ª—É—à–∞—Ç–µ–ª—å –Ω–∞ –≤–≤–æ–¥
        messageInput.addEventListener('input', updateButtons);

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        sendButton.addEventListener('click', () => {
            if (messageInput.value.trim()) {
                addMessage(messageInput.value, 'text');
                messageInput.value = '';
                updateButtons();
            }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≥–æ–ª–æ—Å–æ–≤–æ–π –∫–Ω–æ–ø–∫–∏
        voiceButton.addEventListener('touchstart', handlePressStart);
        voiceButton.addEventListener('touchend', handlePressEnd);
        voiceButton.addEventListener('mousedown', handlePressStart); // –î–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞
        voiceButton.addEventListener('mouseup', handlePressEnd);

        function handlePressStart(e) {
            e.preventDefault();
            touchStartTime = Date.now();
            pressTimer = setTimeout(startVoiceRecording, 500); // –î–ª–∏–Ω–Ω–æ–µ –Ω–∞–∂–∞—Ç–∏–µ > 500ms
        }

        function handlePressEnd(e) {
            e.preventDefault();
            clearTimeout(pressTimer);
            const pressDuration = Date.now() - touchStartTime;
            if (pressDuration < 500 && !isRecording) {
                switchToVideoMode();
            } else if (isRecording) {
                stopVoiceRecording();
            }
        }

        // –ó–∞–ø–∏—Å—å –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ
        async function startVoiceRecording() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.start();
                isRecording = true;
                recordingStatus.classList.remove('hidden');
                audioChunks = [];
                mediaRecorder.addEventListener('dataavailable', e => audioChunks.push(e.data));
                mediaRecorder.addEventListener('stop', () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    addMessage(URL.createObjectURL(audioBlob), 'audio');
                    stream.getTracks().forEach(track => track.stop());
                    recordingStatus.classList.add('hidden');
                    isRecording = false;
                });
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É:', err);
            }
        }

        function stopVoiceRecording() {
            if (mediaRecorder) {
                mediaRecorder.stop();
            }
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤ —Ä–µ–∂–∏–º –∫—Ä—É–∂–æ—á–∫–∞ (–≤–∏–¥–µ–æ)
        async function switchToVideoMode() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                videoPreview.srcObject = stream;
                videoMode.classList.remove('hidden');
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ:', err);
            }
        }

        // –ó–∞–ø–∏—Å—å –≤–∏–¥–µ–æ-–∫—Ä—É–∂–∫–∞
        startVideoBtn.addEventListener('click', () => {
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.start();
            videoChunks = [];
            mediaRecorder.addEventListener('dataavailable', e => videoChunks.push(e.data));
            mediaRecorder.addEventListener('stop', () => {
                const videoBlob = new Blob(videoChunks, { type: 'video/webm' });
                addMessage(URL.createObjectURL(videoBlob), 'video');
            });
            startVideoBtn.style.display = 'none';
            stopVideoBtn.style.display = 'block';
        });

        stopVideoBtn.addEventListener('click', () => {
            mediaRecorder.stop();
            exitVideoMode();
        });

        cancelVideoBtn.addEventListener('click', exitVideoMode);

        function exitVideoMode() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            videoPreview.srcObject = null;
            videoMode.classList.add('hidden');
            startVideoBtn.style.display = 'block';
            stopVideoBtn.style.display = 'none';
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç
        function addMessage(content, type) {
            const msgDiv = document.createElement('div');
            if (type === 'text') {
                msgDiv.textContent = content;
            } else if (type === 'audio') {
                const audio = document.createElement('audio');
                audio.src = content;
                audio.controls = true;
                msgDiv.appendChild(audio);
            } else if (type === 'video') {
                const video = document.createElement('video');
                video.src = content;
                video.controls = true;
                video.style.borderRadius = '50%';
                video.style.width = '100px';
                video.style.height = '100px';
                msgDiv.appendChild(video);
            }
            messages.appendChild(msgDiv);
            messages.scrollTop = messages.scrollHeight;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        updateButtons();
    </script>
</body>
</html>
