<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<title>–ó–∞–≥—Ä—É–∑–∫–∞ –ú–µ–¥–∏–∞ –∏ –ö–æ—Ä–æ—Ç–∫–∞—è –°—Å—ã–ª–∫–∞</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
:root{--bg:#0e0e0e;--bg-light:#1e1e1e;--accent:#0088cc;--text:#fff;--gray:#888;--radius:14px;}
body{
    margin: 0;
    font-family: sans-serif;
    background: var(--bg);
    color: var(--text);
    height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 20px;
}
.container {
    background: var(--bg-light);
    padding: 30px;
    border-radius: var(--radius);
    max-width: 400px;
    width: 100%;
    text-align: center;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
}
button {
    border: none;
    border-radius: var(--radius);
    font-size: 16px;
    background: var(--accent);
    color: #fff;
    padding: 12px 20px;
    font-weight: bold;
    cursor: pointer;
    transition: background 0.3s ease;
    margin-bottom: 20px;
}
button:hover {
    background: #0077b3;
}
.result-box {
    text-align: left;
    margin-top: 20px;
    padding: 15px;
    border: 1px dashed var(--gray);
    border-radius: 8px;
    word-break: break-all;
}
.result-box strong {
    color: var(--accent);
    display: block;
    margin-bottom: 8px;
}
.hidden {
    display: none;
}
</style>
</head>
<body>

<div class="container">
  <h1>–ó–∞–≥—Ä—É–∑–∫–∞ –ú–µ–¥–∏–∞</h1>
  <button id="upload-btn" onclick="triggerImageUpload()">
    <i class="fa fa-upload"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å –§–æ—Ç–æ –∏–ª–∏ –í–∏–¥–µ–æ
  </button>
  <div id="loading-status" class="hidden">
    <p>–ó–∞–≥—Ä—É–∑–∫–∞... –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ.</p>
  </div>
  <div id="result-container" class="hidden">
    <div class="result-box">
      <strong>–î–ª–∏–Ω–Ω–∞—è (Uploadcare) —Å—Å—ã–ª–∫–∞:</strong>
      <p id="long-link"></p>
    </div>
    <div class="result-box">
      <strong>–ö–æ—Ä–æ—Ç–∫–∞—è —Å—Å—ã–ª–∫–∞:</strong>
      <p id="short-link"></p>
    </div>
    <button onclick="copyLink('short-link')"><i class="fa fa-copy"></i> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ö–æ—Ä–æ—Ç–∫—É—é –°—Å—ã–ª–∫—É</button>
  </div>
</div>

<input type="file" id="file-input" style="display:none;" accept="image/*,video/*">

<script>
// –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Supabase –∏ Uploadcare –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞
const SUPABASE_URL = "https://zmewwzlzujsrhstjehrp.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InptZXd3emx6dWpzcmhzdGplaHJwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5NjM4MDksImV4cCI6MjA3MTUzOTgwOX0.kBBXwlCEl5szgK4vKgaPBhPOVYmoFzly2TXR-fI8D24";
const uploadcarePublicKey = "c12f2c3e134f56024db8";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
uploadcare.start({ publicKey: uploadcarePublicKey });

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏
function triggerImageUpload(){
  document.getElementById('file-input').click();
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
document.getElementById('file-input').addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;

  // 1. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–≥—Ä—É–∑–∫–∏
  document.getElementById('loading-status').classList.remove('hidden');
  document.getElementById('result-container').classList.add('hidden');
  document.getElementById('upload-btn').disabled = true;

  // 2. –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –≤ Uploadcare
  uploadcare.fileFrom('object', file).done(info => {
    const uploadedUrl = info.cdnUrl;
    
    // 3. –°–æ–∑–¥–∞–Ω–∏–µ "—Ñ–∏–∫—Ç–∏–≤–Ω–æ–≥–æ" —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è ID (–∫–æ—Ä–æ—Ç–∫–æ–π —Å—Å—ã–ª–∫–∏)
    createShortLink(uploadedUrl);

  }).fail(error => {
    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤ Uploadcare: ' + error);
    resetUI();
  });
});

/**
 * –°–æ–∑–¥–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ-–∑–∞–≥–ª—É—à–∫—É –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ ID.
 * –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º ID —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∫ "–∫–æ—Ä–æ—Ç–∫—É—é —Å—Å—ã–ª–∫—É".
 * @param {string} longUrl URL –∏–∑ Uploadcare
 */
async function createShortLink(longUrl) {
    // –í–ê–ñ–ù–û: –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π chat_id (-1) –∏ sender_id (-1)
    // —á—Ç–æ–±—ã —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –ø–æ–ø–∞–ª–æ –≤ —Ä–µ–∞–ª—å–Ω—ã–µ —á–∞—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
    // –≠—Ç–æ–≥–æ chat_id –∏ sender_id –Ω–µ –¥–æ–ª–∂–Ω–æ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö `chats` –∏ `profiles`.
    // –í–ê–ñ–ù–û: –ß—Ç–æ–±—ã —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–ª–æ, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ Supabase RLS 
    // –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã `messages` —Ä–∞–∑—Ä–µ—à–µ–Ω INSERT –¥–ª—è –∞–Ω–æ–Ω–∏–º–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
    
    // –ó–∞–º–µ–Ω–∏–º sender –Ω–∞ null –∏ content –Ω–∞ –º–µ—Ç–∫—É, –∞ chat_id –Ω–∞ null.
    // –ï—Å–ª–∏ Supabase –Ω–µ —Ä–∞–∑—Ä–µ—à–∏—Ç –≤—Å—Ç–∞–≤–∏—Ç—å null –¥–ª—è sender/chat_id (–µ—Å–ª–∏ –ø–æ–ª—è NOT NULL), 
    // –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∑–∞–≥–ª—É—à–∫–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä, '00000000-0000-0000-0000-000000000000'
    const FAKE_SENDER_ID = '00000000-0000-0000-0000-000000000000'; // –ò—Å–ø–æ–ª—å–∑—É–µ–º UUID-–∑–∞–≥–ª—É—à–∫—É
    const FAKE_CHAT_ID = '00000000-0000-0000-0000-000000000000'; // –ò—Å–ø–æ–ª—å–∑—É–µ–º UUID-–∑–∞–≥–ª—É—à–∫—É
    
    try {
        const payload = {
            chat_id: FAKE_CHAT_ID,
            sender: FAKE_SENDER_ID, 
            content: 'üîó SHORTLINK_GENERATED_MEDIA', // –ú–µ—Ç–∫–∞ –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
            image_url: longUrl,
            read: true,
            is_deleted: true // –°—Ä–∞–∑—É –ø–æ–º–µ—á–∞–µ–º –∫–∞–∫ —É–¥–∞–ª–µ–Ω–Ω–æ–µ, —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª–æ 
        };
        
        const { data: inserted, error: insErr } = await supabase.from('messages')
            .insert([payload])
            .select('id') // –ü–æ–ª—É—á–∞–µ–º ID —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
            .single();

        if (insErr) throw insErr;

        const messageId = inserted.id; // –≠—Ç–æ –Ω–∞—à —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID

        // 4. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ—Ä–æ—Ç–∫–æ–π —Å—Å—ã–ª–∫–∏ 
        const shortLink = `${window.location.origin}/view/${messageId}`; 
        // –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –≠—Ç–æ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü–∞ 'view' 
        // –∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ. –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–∏–π –¥–æ–º–µ–Ω.

        // 5. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
        document.getElementById('long-link').innerText = longUrl;
        document.getElementById('short-link').innerText = messageId; // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–∞–º ID –∫–∞–∫ "–∫–æ—Ä–æ—Ç–∫—É—é —Å—Å—ã–ª–∫—É"
        
        document.getElementById('loading-status').classList.add('hidden');
        document.getElementById('result-container').classList.remove('hidden');

    } catch (e) {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–æ—Ä–æ—Ç–∫–æ–π —Å—Å—ã–ª–∫–∏ (Supabase): ' + e.message);
        console.error(e);
        resetUI();
    }
}

// –°–±—Ä–æ—Å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
function resetUI() {
  document.getElementById('loading-status').classList.add('hidden');
  document.getElementById('upload-btn').disabled = false;
}

// –§—É–Ω–∫—Ü–∏—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
function copyLink(elementId) {
    const text = document.getElementById(elementId).innerText;
    if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(() => {
            alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞: ' + text);
        }).catch(err => {
            console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é: ' + text);
        });
    } else {
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é: ' + text);
    }
}
</script>
</body>
</html>
