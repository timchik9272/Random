<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon VR 3D Menu</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; }
        /* Крестик по центру для удобства на обычных экранах */
        #crosshair {
            position: absolute; top: 50%; left: 50%; width: 10px; height: 10px;
            background: rgba(0, 255, 170, 0.8); border-radius: 50%;
            transform: translate(-50%, -50%); pointer-events: none; z-index: 999;
        }
    </style>
</head>
<body>

    <div id="crosshair"></div>

    <a-scene background="color: #050508" vr-mode-ui="enabled: true">
        
        <script>
            let score = 0;
            let time = 30;
            let isPlaying = false;
            let timerInterval;
            
            // Настройки
            let settings = {
                sens: 1.0,
                gyro: true,
                walk: false
            };

            // Патч для чувствительности тача (влияет только на свайпы пальцем)
            const lookControls = AFRAME.components['look-controls'].Component.prototype;
            const origOnTouchMove = lookControls.onTouchMove;
            lookControls.onTouchMove = function (evt) {
                if (!this.touchStarted || !this.data.touchEnabled) { return; }
                const touch = evt.touches[0];
                const canvas = this.el.sceneEl.canvas;
                let deltaY = 2 * Math.PI * (touch.pageY - this.touchStart.y) / canvas.clientHeight;
                let deltaX = 2 * Math.PI * (touch.pageX - this.touchStart.x) / canvas.clientWidth;
                
                deltaY *= settings.sens;
                deltaX *= settings.sens;
                
                this.pitchObject.rotation.x += deltaY * 0.5;
                this.yawObject.rotation.y += deltaX * 0.5;
                this.touchStart = { x: touch.pageX, y: touch.pageY };
            };

            // Управление игрой и 3D меню
            AFRAME.registerComponent('game-manager', {
                init: function () {
                    this.menuEl = document.querySelector('#vr-menu');
                    this.targetsEl = document.querySelector('#targets');
                    this.scoreText = document.querySelector('#hud-score');
                    this.timeText = document.querySelector('#hud-time');
                    this.gameOverText = document.querySelector('#game-over-text');
                    this.cameraEl = document.querySelector('#player-camera');

                    // Кнопка: Начать игру
                    document.querySelector('#btn-play').addEventListener('click', () => this.startGame());

                    // Кнопка: Чувствительность тача
                    const btnSens = document.querySelector('#btn-sens');
                    btnSens.addEventListener('click', () => {
                        settings.sens = settings.sens >= 2.0 ? 0.5 : settings.sens + 0.5;
                        btnSens.querySelector('a-text').setAttribute('value', `Touch Sens: ${settings.sens}x`);
                    });

                    // Кнопка: Гироскоп (ВКЛ/ВЫКЛ) - Помогает от тряски
                    const btnGyro = document.querySelector('#btn-gyro');
                    btnGyro.addEventListener('click', () => {
                        settings.gyro = !settings.gyro;
                        this.cameraEl.setAttribute('look-controls', `magicWindowTrackingEnabled: ${settings.gyro}`);
                        btnGyro.querySelector('a-text').setAttribute('value', `Gyro: ${settings.gyro ? 'ON' : 'OFF'}`);
                    });

                    // Кнопка: Ходьба в реальности (6DoF)
                    const btnWalk = document.querySelector('#btn-walk');
                    btnWalk.addEventListener('click', () => {
                        settings.walk = !settings.walk;
                        this.cameraEl.setAttribute('look-controls', `positionalTrackingEnabled: ${settings.walk}`);
                        btnWalk.querySelector('a-text').setAttribute('value', `Real Walk: ${settings.walk ? 'ON' : 'OFF'}`);
                    });
                },

                startGame: function () {
                    score = 0;
                    time = 30;
                    isPlaying = true;
                    this.updateHUD();
                    
                    // Скрываем меню, отключаем его кнопки
                    this.menuEl.setAttribute('scale', '0 0 0');
                    this.menuEl.setAttribute('position', '0 -10 0'); // Убираем из зоны видимости
                    this.gameOverText.setAttribute('visible', 'false');
                    this.targetsEl.innerHTML = ''; 
                    
                    for(let i=0; i<5; i++) this.spawnTarget();
                    
                    timerInterval = setInterval(() => {
                        time--;
                        this.updateHUD();
                        if (time <= 0) this.endGame();
                    }, 1000);
                },

                spawnTarget: function () {
                    if (!isPlaying) return;
                    let el = document.createElement('a-sphere');
                    el.setAttribute('radius', '0.5');
                    
                    let radius = 4 + Math.random() * 4;
                    let theta = Math.random() * Math.PI * 2;
                    let phi = Math.max(Math.PI / 4, Math.min(Math.PI * 0.6, Math.acos(2 * Math.random() - 1)));
                    let x = radius * Math.sin(phi) * Math.cos(theta);
                    let y = radius * Math.cos(phi);
                    let z = radius * Math.sin(phi) * Math.sin(theta);
                    
                    el.setAttribute('position', `${x} ${y} ${z}`);
                    el.setAttribute('class', 'clickable'); // Только объекты с этим классом ловят клики
                    
                    let colors = ['#ff0055', '#00ffaa', '#0088ff', '#ffaa00'];
                    el.setAttribute('color', colors[Math.floor(Math.random() * colors.length)]);
                    el.setAttribute('material', 'shader: flat');
                    el.setAttribute('animation', `property: position; dir: alternate; dur: ${1000 + Math.random()*1000}; easing: easeInOutSine; loop: true; to: ${x} ${y+1} ${z}`);
                    
                    el.addEventListener('click', () => {
                        if (!isPlaying) return;
                        score++;
                        this.updateHUD();
                        el.removeAttribute('animation');
                        el.setAttribute('animation__scale', 'property: scale; to: 0 0 0; dur: 150');
                        setTimeout(() => {
                            if (el.parentNode) el.parentNode.removeChild(el);
                            this.spawnTarget();
                        }, 150);
                    });
                    this.targetsEl.appendChild(el);
                },

                updateHUD: function () {
                    this.scoreText.setAttribute('value', `Score: ${score}`);
                    this.timeText.setAttribute('value', `Time: ${time}s`);
                },

                endGame: function () {
                    isPlaying = false;
                    clearInterval(timerInterval);
                    this.targetsEl.innerHTML = '';
                    
                    // Возвращаем меню
                    this.menuEl.setAttribute('scale', '1 1 1');
                    this.menuEl.setAttribute('position', '0 1.5 -3');
                    this.gameOverText.setAttribute('visible', 'true');
                    this.gameOverText.setAttribute('value', `GAME OVER\nScore: ${score}`);
                    
                    document.querySelector('#btn-play a-text').setAttribute('value', 'PLAY AGAIN');
                }
            });
        </script>

        <a-entity id="rig" position="0 0 0">
            <a-camera id="player-camera" look-controls="pointerLockEnabled: false; magicWindowTrackingEnabled: true; positionalTrackingEnabled: false">
                <a-text id="hud-score" position="-1.5 1 -2" value="" color="#0fa" scale="0.6 0.6 0.6" font="monoid"></a-text>
                <a-text id="hud-time" position="1 1 -2" value="" color="#fff" scale="0.6 0.6 0.6" font="monoid"></a-text>
                
                <a-entity cursor="fuse: false; rayOrigin: entity"
                          raycaster="objects: .clickable"
                          position="0 0 -1"
                          geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.02"
                          material="color: #fff; shader: flat; opacity: 0.5">
                </a-entity>
            </a-camera>
        </a-entity>

        <a-entity id="vr-menu" position="0 1.5 -3" game-manager>
            <a-text position="0 1.2 0" value="NEON VR SHOOTER" color="#0fa" align="center" width="6" font="monoid"></a-text>
            <a-text id="game-over-text" position="0 0.8 0" value="" color="#ff0055" align="center" width="5" visible="false" font="monoid"></a-text>

            <a-entity id="btn-play" class="clickable" position="0 0 0" geometry="primitive: plane; width: 2; height: 0.5" material="color: #0fa; shader: flat" animation__hover="property: scale; startEvents: mouseenter; endEvents: mouseleave; to: 1.05 1.05 1.05; dur: 100">
                <a-text value="START GAME" color="#000" align="center" position="0 0 0.01" width="4" font="monoid"></a-text>
            </a-entity>

            <a-entity id="btn-gyro" class="clickable" position="-1.1 -0.7 0" geometry="primitive: plane; width: 2; height: 0.4" material="color: #222; shader: flat; side: double">
                <a-text value="Gyro: ON" color="#fff" align="center" position="0 0 0.01" width="3"></a-text>
            </a-entity>

            <a-entity id="btn-walk" class="clickable" position="1.1 -0.7 0" geometry="primitive: plane; width: 2; height: 0.4" material="color: #222; shader: flat; side: double">
                <a-text value="Real Walk: OFF" color="#fff" align="center" position="0 0 0.01" width="3"></a-text>
            </a-entity>

            <a-entity id="btn-sens" class="clickable" position="0 -1.3 0" geometry="primitive: plane; width: 2.5; height: 0.4" material="color: #222; shader: flat; side: double">
                <a-text value="Touch Sens: 1x" color="#fff" align="center" position="0 0 0.01" width="3"></a-text>
            </a-entity>
        </a-entity>

        <a-plane position="0 0 0" rotation="-90 0 0" width="100" height="100" color="#0fa" material="wireframe: true; wireframeLinewidth: 2; opacity: 0.1"></a-plane>
        
        <a-entity id="targets"></a-entity>
        
    </a-scene>

</body>
</html>