<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>P2P –∑–≤–æ–Ω–æ–∫ —á–µ—Ä–µ–∑ —Ç–µ–∫—Å—Ç-–∫–æ–¥—ã</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: sans-serif; background:#111; color:#eee; text-align:center; margin:0; padding:10px; }
    h2 { margin: 15px 0; }
    video { width:90%; max-width:400px; margin:10px; border-radius:12px; background:#000; }
    button, select, textarea, input { margin:8px; padding:12px; font-size:14px; border-radius:10px; border:none; }
    button { background:#444; color:white; cursor:pointer; }
    button:hover { background:#666; }
    textarea { width:90%; height:120px; font-family:monospace; }
  </style>
</head>
<body>
  <h2>üìû P2P –∑–≤–æ–Ω–æ–∫ —á–µ—Ä–µ–∑ —Ç–µ–∫—Å—Ç-–∫–æ–¥—ã</h2>

  <select id="mode">
    <option value="videoaudio">–í–∏–¥–µ–æ + –ó–≤—É–∫</option>
    <option value="video">–¢–æ–ª—å–∫–æ –≤–∏–¥–µ–æ</option>
    <option value="audio">–¢–æ–ª—å–∫–æ –∑–≤—É–∫</option>
  </select>
  <br>
  <button id="createOffer">–°–æ–∑–¥–∞—Ç—å –∑–≤–æ–Ω–æ–∫</button>

  <h3>üì§ –ú–æ–π –∫–æ–¥:</h3>
  <textarea id="myCode" readonly></textarea>
  <button onclick="copyCode()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>

  <h3>üì• –í—Å—Ç–∞–≤—å—Ç–µ –∫–æ–¥ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞:</h3>
  <textarea id="otherCode"></textarea>
  <button id="applyCode">‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>

  <video id="localVideo" autoplay playsinline muted></video>
  <video id="remoteVideo" autoplay playsinline></video>

  <script>
    let pc, localStream;
    const localVideo = document.getElementById("localVideo");
    const remoteVideo = document.getElementById("remoteVideo");
    const myCode = document.getElementById("myCode");
    const otherCode = document.getElementById("otherCode");

    function encode(obj) {
      return btoa(JSON.stringify(obj));
    }
    function decode(str) {
      return JSON.parse(atob(str));
    }

    async function initConnection() {
      pc = new RTCPeerConnection({ iceServers: [{ urls: "stun:stun.l.google.com:19302" }] });
      pc.ontrack = e => remoteVideo.srcObject = e.streams[0];

      const mode = document.getElementById("mode").value;
      let constraints = {};
      if (mode === "videoaudio") constraints = { video:true, audio:true };
      if (mode === "video") constraints = { video:true, audio:false };
      if (mode === "audio") constraints = { video:false, audio:true };

      try {
        localStream = await navigator.mediaDevices.getUserMedia(constraints);
        localVideo.srcObject = localStream;
        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
      } catch (e) {
        alert("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É: " + e);
      }
    }

    document.getElementById("createOffer").onclick = async () => {
      await initConnection();
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      pc.onicegatheringstatechange = () => {
        if (pc.iceGatheringState === "complete") {
          myCode.value = encode(pc.localDescription);
        }
      };
    };

    document.getElementById("applyCode").onclick = async () => {
      const dataStr = otherCode.value.trim();
      if (!dataStr) return;
      try {
        const data = decode(dataStr);
        if (data.type === "offer") {
          await initConnection();
          await pc.setRemoteDescription(new RTCSessionDescription(data));
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          pc.onicegatheringstatechange = () => {
            if (pc.iceGatheringState === "complete") {
              myCode.value = encode(pc.localDescription);
            }
          };
        } else if (data.type === "answer") {
          await pc.setRemoteDescription(new RTCSessionDescription(data));
        }
      } catch(e) {
        alert("–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥: " + e);
      }
    };

    function copyCode() {
      myCode.select();
      document.execCommand("copy");
      alert("–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!");
    }
  </script>
</body>
</html>
