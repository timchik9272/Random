<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>P2P –∑–≤–æ–Ω–æ–∫ —á–µ—Ä–µ–∑ QR (–æ–Ω–ª–∞–π–Ω —Å–∫–∞–Ω–µ—Ä)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: sans-serif; background:#111; color:#eee; text-align:center; margin:0; }
    h2 { margin: 15px 0; }
    video { width:90%; max-width:400px; margin:10px; border-radius:12px; background:#000; }
    button, select { margin:8px; padding:12px 20px; font-size:16px; border:none; border-radius:10px; }
    button { background:#444; color:white; }
    button:hover { background:#666; }
    canvas { margin:10px auto; background:white; padding:10px; border-radius:12px; }
    #qrBox img { max-width: 80%; margin: 10px auto; display:block; }
    #scanView { display:none; }
    #scanCam { width:100%; max-width:400px; border-radius:12px; }
  </style>
</head>
<body>
  <h2>üìû P2P –∑–≤–æ–Ω–æ–∫ —á–µ—Ä–µ–∑ QR</h2>

  <select id="mode">
    <option value="videoaudio">–í–∏–¥–µ–æ + –ó–≤—É–∫</option>
    <option value="video">–¢–æ–ª—å–∫–æ –≤–∏–¥–µ–æ</option>
    <option value="audio">–¢–æ–ª—å–∫–æ –∑–≤—É–∫</option>
  </select>
  <br>
  <button id="createOffer">–°–æ–∑–¥–∞—Ç—å –∑–≤–æ–Ω–æ–∫</button>
  <button id="scanQR">–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR</button>

  <div id="qrBox"></div>

  <div id="scanView">
    <p>–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR-–∫–æ–¥ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞:</p>
    <video id="scanCam" autoplay playsinline></video>
    <canvas id="scanCanvas" hidden></canvas>
  </div>

  <video id="localVideo" autoplay playsinline muted></video>
  <video id="remoteVideo" autoplay playsinline></video>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsqr/1.4.0/jsQR.min.js"></script>
  <script>
    let pc, localStream;
    const localVideo = document.getElementById("localVideo");
    const remoteVideo = document.getElementById("remoteVideo");
    const qrBox = document.getElementById("qrBox");

    function encode(obj) {
      return btoa(JSON.stringify(obj));
    }
    function decode(str) {
      return JSON.parse(atob(str));
    }
    function showQR(data) {
      qrBox.innerHTML = "";
      const qr = qrcode(0, "M");
      qr.addData(data);
      qr.make();
      qrBox.innerHTML = qr.createImgTag(6);
    }

    async function initConnection() {
      pc = new RTCPeerConnection({ iceServers: [{ urls: "stun:stun.l.google.com:19302" }] });
      pc.ontrack = e => remoteVideo.srcObject = e.streams[0];
      pc.onicecandidate = () => { if (pc.localDescription) showQR(encode(pc.localDescription)); };

      const mode = document.getElementById("mode").value;
      let constraints = {};
      if (mode === "videoaudio") constraints = { video:true, audio:true };
      if (mode === "video") constraints = { video:true, audio:false };
      if (mode === "audio") constraints = { video:false, audio:true };

      localStream = await navigator.mediaDevices.getUserMedia(constraints);
      localVideo.srcObject = localStream;
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
    }

    document.getElementById("createOffer").onclick = async () => {
      await initConnection();
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
    };

    document.getElementById("scanQR").onclick = async () => {
      document.getElementById("scanView").style.display = "block";
      const cam = document.getElementById("scanCam");
      const stream = await navigator.mediaDevices.getUserMedia({ video:{facingMode:"environment"} });
      cam.srcObject = stream;
      scanLoop();
    };

    async function scanLoop() {
      const video = document.getElementById("scanCam");
      const canvas = document.getElementById("scanCanvas");
      const ctx = canvas.getContext("2d");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
      const code = jsQR(imageData.data, canvas.width, canvas.height);
      if (code) {
        handleQR(code.data);
        stopScan();
        return;
      }
      requestAnimationFrame(scanLoop);
    }

    function stopScan() {
      const video = document.getElementById("scanCam");
      const stream = video.srcObject;
      if (stream) stream.getTracks().forEach(t => t.stop());
      document.getElementById("scanView").style.display = "none";
    }

    async function handleQR(dataStr) {
      try {
        const data = decode(dataStr);
        if (data.type === "offer") {
          await initConnection();
          await pc.setRemoteDescription(new RTCSessionDescription(data));
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
        } else if (data.type === "answer") {
          await pc.setRemoteDescription(new RTCSessionDescription(data));
        }
      } catch(e) {
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–∑–±–æ—Ä–µ QR");
      }
    }
  </script>
</body>
</html>
