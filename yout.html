import yt_dlp
import os

def get_video_info(url):
    """–ü–æ–ª—É—á–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–∏–¥–µ–æ –±–µ–∑ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è"""
    try:
        ydl_opts = {'quiet': True, 'no_warnings': True}
        with yt_dlp.YoutubeDL(ydl_opts) as ydl:
            return ydl.extract_info(url, download=False)
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏: {e}")
        return None

def format_selector(ctx):
    """–§–∏–∫—Ç–∏–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–µ–ª–µ–∫—Ç–æ—Ä–∞, –ª–æ–≥–∏–∫–∞ –≤—ã–Ω–µ—Å–µ–Ω–∞ –≤ main"""
    return ctx

def get_sorted_formats(info):
    """
    –†–∞–∑–±–∏—Ä–∞–µ—Ç —Ñ–æ—Ä–º–∞—Ç—ã –∏ –≥—Ä—É–ø–ø–∏—Ä—É–µ—Ç –∏—Ö –ø–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—é.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª–æ–≤–∞—Ä—å —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π —Å –ª—É—á—à–∏–º –±–∏—Ç—Ä–µ–π—Ç–æ–º.
    """
    formats = info.get('formats', [])
    
    # –°–ª–æ–≤–∞—Ä—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ª—É—á—à–µ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
    # –ö–ª—é—á: –≤—ã—Å–æ—Ç–∞ (height), –ó–Ω–∞—á–µ–Ω–∏–µ: –æ–±—ä–µ–∫—Ç —Ñ–æ—Ä–º–∞—Ç–∞
    video_resolutions = {}
    
    for f in formats:
        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Ñ–æ—Ä–º–∞—Ç—ã –±–µ–∑ –≤–∏–¥–µ–æ
        if f.get('vcodec') == 'none':
            continue
            
        height = f.get('height')
        if not height:
            continue
            
        # –ï—Å–ª–∏ —Ç–∞–∫–æ–≥–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –µ—â–µ –Ω–µ—Ç –∏–ª–∏ —ç—Ç–æ—Ç —Ñ–æ—Ä–º–∞—Ç –ª—É—á—à–µ (–±–æ–ª—å—à–µ –±–∏—Ç—Ä–µ–π—Ç/fps)
        if height not in video_resolutions:
            video_resolutions[height] = f
        else:
            # –ü—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞: –µ—Å–ª–∏ —Ñ–∞–π–ª –±–æ–ª—å—à–µ (–∏–ª–∏ –±–∏—Ç—Ä–µ–π—Ç –≤—ã—à–µ), –±–µ—Ä–µ–º –µ–≥–æ
            curr_size = f.get('filesize') or f.get('filesize_approx') or 0
            best_size = video_resolutions[height].get('filesize') or video_resolutions[height].get('filesize_approx') or 0
            
            if curr_size > best_size:
                video_resolutions[height] = f
                
    # –ü—Ä–µ–≤—Ä–∞—â–∞–µ–º –≤ —Å–ø–∏—Å–æ–∫ –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º –æ—Ç –±–æ–ª—å—à–µ–≥–æ –∫ –º–µ–Ω—å—à–µ–º—É
    sorted_videos = sorted(video_resolutions.values(), key=lambda x: x['height'], reverse=True)
    return sorted_videos

def show_formats(video_formats):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã–µ –≤–∏–¥–µ–æ —Ñ–æ—Ä–º–∞—Ç—ã"""
    print("\nüìä –î–û–°–¢–£–ü–ù–´–ï –ö–ê–ß–ï–°–¢–í–ê –í–ò–î–ï–û:")
    print("-" * 60)
    
    for i, fmt in enumerate(video_formats):
        height = fmt.get('height')
        fps = fmt.get('fps')
        ext = fmt.get('ext')
        
        # –†–∞–∑–º–µ—Ä –º–æ–∂–µ—Ç –±—ã—Ç—å filesize –∏–ª–∏ filesize_approx
        size = fmt.get('filesize') or fmt.get('filesize_approx')
        if size:
            size_str = f"{size/(1024*1024):.1f}MB"
        else:
            size_str = "N/A"
            
        # –ü–æ–º–µ—Ç–∫–∞, –µ—Å–ª–∏ —ç—Ç–æ —Ç–æ–ª—å–∫–æ –≤–∏–¥–µ–æ (–±–µ–∑ –∑–≤—É–∫–∞ –≤ —Å–∞–º–æ–º –ø–æ—Ç–æ–∫–µ, –Ω–æ –º—ã —ç—Ç–æ –∏—Å–ø—Ä–∞–≤–∏–º –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏)
        note = " (Video only + Audio merge)" if fmt.get('acodec') == 'none' else ""
        
        print(f"  [{i+1}] {height}p @ {fps}fps | {ext.upper()} | ~{size_str}{note}")
        
    return video_formats

def progress_hook(d):
    """–•—É–∫ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞"""
    if d['status'] == 'downloading':
        percent = d.get('_percent_str', '0%').strip()
        speed = d.get('_speed_str', 'N/A')
        print(f'üì• –ó–∞–≥—Ä—É–∑–∫–∞: {percent} | –°–∫–æ—Ä–æ—Å—Ç—å: {speed}', end='\r')
    elif d['status'] == 'finished':
        print('\nüîÑ –û–±—Ä–∞–±–æ—Ç–∫–∞ / –°–∫–ª–µ–π–∫–∞ —Ñ–∞–π–ª–æ–≤...', end='\r')

def download_content(url, choices, selected_video_format=None, audio_quality='192'):
    """
    –°–∫–∞—á–∏–≤–∞–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç —Å –∂–µ—Å—Ç–∫–æ–π –ø—Ä–∏–≤—è–∑–∫–æ–π –∫ —Ñ–æ—Ä–º–∞—Ç—É
    """
    ydl_opts = {
        'outtmpl': '%(title)s.%(ext)s',
        'quiet': True,
        'no_warnings': True,
        'progress_hooks': [progress_hook],
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º ffmpeg –¥–ª—è —Å–∫–ª–µ–π–∫–∏ –≤–∏–¥–µ–æ –∏ –∞—É–¥–∏–æ
        'writethumbnail': 'thumbnail' in choices,
    }

    # --- –õ–û–ì–ò–ö–ê –í–´–ë–û–†–ê –§–û–†–ú–ê–¢–ê ---
    if 'video' in choices:
        if selected_video_format:
            # –°–ê–ú–û–ï –í–ê–ñ–ù–û–ï: –ú—ã –±–µ—Ä–µ–º ID –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –≤–∏–¥–µ–æ + –ª—É—á—à–µ–µ –∞—É–¥–∏–æ
            # –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ 480p –æ—Å—Ç–∞–Ω–µ—Ç—Å—è 480p, –Ω–æ —Å–æ –∑–≤—É–∫–æ–º
            vid_id = selected_video_format['format_id']
            ydl_opts['format'] = f"{vid_id}+bestaudio/best"
        else:
            # –ï—Å–ª–∏ –∞–≤—Ç–æ–≤—ã–±–æ—Ä - –ª—É—á—à–µ–µ –≤–∏–¥–µ–æ + –ª—É—á—à–µ–µ –∞—É–¥–∏–æ
            ydl_opts['format'] = "bestvideo+bestaudio/best"
        
        # –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä MP4 –∏–ª–∏ MKV –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
        ydl_opts['merge_output_format'] = 'mp4'

    elif 'audio' in choices:
        ydl_opts['format'] = 'bestaudio/best'
        ydl_opts['postprocessors'] = [{
            'key': 'FFmpegExtractAudio',
            'preferredcodec': 'mp3',
            'preferredquality': audio_quality,
        }]
    
    # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±–ª–æ–∂–∫–∏ –≤ —Ñ–∞–π–ª
    if 'thumbnail' in choices:
        # –î–ª—è –∞—É–¥–∏–æ —ç—Ç–æ —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –≤—ã—à–µ, –¥–ª—è –≤–∏–¥–µ–æ –¥–æ–±–∞–≤–ª—è–µ–º:
        if 'postprocessors' not in ydl_opts:
            ydl_opts['postprocessors'] = []
        ydl_opts['postprocessors'].append({'key': 'EmbedThumbnail'})

    try:
        print(f'\nüöÄ –ù–∞—á–∏–Ω–∞—é –∑–∞–≥—Ä—É–∑–∫—É...')
        with yt_dlp.YoutubeDL(ydl_opts) as ydl:
            ydl.download([url])
            print(f'\n‚úÖ –ì–æ—Ç–æ–≤–æ! –§–∞–π–ª—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –ø–∞–ø–∫–µ —Å–æ —Å–∫—Ä–∏–ø—Ç–æ–º.')
            return True
            
    except Exception as e:
        print(f'\n‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: {e}')
        print("üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω FFmpeg, –µ—Å–ª–∏ —Å–∫–∞—á–∏–≤–∞–µ—Ç–µ –≤—ã—Å–æ–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ.")
        return False

def main():
    print('=' * 60)
    print('üé¨ YOUTUBE DOWNLOADER (FIXED)')
    print('=' * 60)
    
    while True:
        url = input('\n–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É (–∏–ª–∏ "exit"): ').strip()
        if url.lower() in ['exit', 'quit']: break
        if not url.startswith('http'): continue
        
        print('\nüîç –ê–Ω–∞–ª–∏–∑ –≤–∏–¥–µ–æ...')
        info = get_video_info(url)
        if not info: continue
        
        print(f"üìå {info.get('title')}")
        
        # 1. –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –≤–∏–¥–µ–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
        available_videos = get_sorted_formats(info)
        
        print('\nüéØ –ß–¢–û –°–ö–ê–ß–ê–¢–¨?')
        print('  1. –í–∏–¥–µ–æ (–≤—ã–±—Ä–∞—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ)')
        print('  2. –ê—É–¥–∏–æ (MP3)')
        print('  3. –í–∏–¥–µ–æ (–ê–≤—Ç–æ - –ª—É—á—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ)')
        
        mode = input('–í–∞—à –≤—ã–±–æ—Ä: ').strip()
        
        choices = set()
        selected_fmt = None
        
        if mode == '2':
            choices.add('audio')
            print("üéµ –°–∫–∞—á–∏–≤–∞–µ–º –∞—É–¥–∏–æ...")
        else:
            choices.add('video')
            # –°–ø—Ä–∞—à–∏–≤–∞–µ–º –ø—Ä–æ –∫–∞—á–µ—Å—Ç–≤–æ
            if mode == '1':
                show_formats(available_videos)
                try:
                    idx = int(input('\n–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–º–µ—Ä –∫–∞—á–µ—Å—Ç–≤–∞: ')) - 1
                    if 0 <= idx < len(available_videos):
                        selected_fmt = available_videos[idx]
                        print(f"‚úÖ –í—ã–±—Ä–∞–Ω–æ: {selected_fmt['height']}p")
                    else:
                        print("‚ö†Ô∏è –ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä, –∫–∞—á–∞—é –ª—É—á—à–µ–µ.")
                except ValueError:
                    print("‚ö†Ô∏è –û—à–∏–±–∫–∞ –≤–≤–æ–¥–∞, –∫–∞—á–∞—é –ª—É—á—à–µ–µ.")
            else:
                print("‚úÖ –í—ã–±—Ä–∞–Ω —Ä–µ–∂–∏–º –∞–≤—Ç–æ (–ª—É—á—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ).")

        # –°–ø—Ä–∞—à–∏–≤–∞–µ–º –ø—Ä–æ –æ–±–ª–æ–∂–∫—É
        if input('–í—à–∏—Ç—å –æ–±–ª–æ–∂–∫—É? (y/n): ').lower() == 'y':
            choices.add('thumbnail')
            
        download_content(url, choices, selected_fmt)

if __name__ == "__main__":
    main()
